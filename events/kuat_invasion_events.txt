namespace = exe_invasion
#Gatekeeper, fire when Kuat destroyed. 
event = {
	id = exe_invasion.1
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		NOT = { any_country = { has_origin = origin_kuat_apocalyptic } }
		has_global_flag = kuat_spawned
		NOR = {
			has_global_flag = ban_exe_invasion
			has_global_flag = exe_invasion_seed
			exists = event_target:fallen_empire_kuat
		}
	}
	immediate = {
		set_timed_global_flag = { flag = exe_invasion_signs_cooldown days = 720 }
		random_system = {
			limit = { has_star_flag = Kuat_system }
			every_playable_country = {
				limit = {
					intel_level = { level >= high system = prev }
				}
				country_event = { id = exe_invasion.2 days = 1 random = 2 }
			}
		}
		set_global_flag = exe_invasion_seed
	}
}

#Notification: Tachyon signal. 
country_event = {
	id = exe_invasion.2
	title = "exe_invasion.2.name"
	desc = "exe_invasion.2.desc"
	diplomatic = yes
	picture_event_data = { room = satellite_in_orbit_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_sensor_ping
	location = root.capital_scope
	is_triggered_only = yes
	immediate = { set_country_flag = exe_invasion_2_fired }
	option = { name = "exe_invasion.2.a" }
}

#Energy readings. 
event = {
	id = exe_invasion.3
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		NOT = { any_country = { has_origin = origin_kuat_apocalyptic } }
		has_global_flag = exe_invasion_seed
		NOT = { has_global_flag = exe_invasion_signs_cooldown }
		NOT = { has_global_flag = exe_invasion_3_fired }
	}
	immediate = {
		set_global_flag = exe_invasion_3_fired
		set_timed_global_flag = { flag = exe_invasion_signs_cooldown days = 1800 }
		every_playable_country = { country_event = { id = exe_invasion.4 days = 1 random = 2 } }
	}
}

#Notification: Energy readings. 
country_event = {
	id = exe_invasion.4
	title = "exe_invasion.4.name"
	desc = {
		trigger = { has_country_flag = exe_invasion_2_fired }
		text = "exe_invasion.4.a.desc"
	}
	desc = {
		trigger = {
			NOT = { has_country_flag = exe_invasion_2_fired }
		}
		text = "exe_invasion.4.b.desc"
	}
	diplomatic = yes
	picture_event_data = {
		room = Eternal_Empire_room
	}
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_yellow_alert
	location = root.capital_scope
	is_triggered_only = yes
	option = { name = "exe_invasion.4.a" }
}

#Hyperspace echo. 
event = {
	id = exe_invasion.5
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		NOT = { any_country = { has_origin = origin_kuat_apocalyptic } }
		has_global_flag = exe_invasion_3_fired
		NOT = { has_global_flag = exe_invasion_signs_cooldown }
		NOT = { has_global_flag = exe_invasion_5_fired }
	}
	immediate = {
		set_global_flag = exe_invasion_5_fired
		set_timed_global_flag = { flag = exe_invasion_signs_cooldown days = 720 }
		every_playable_country = {
			country_event = { id = exe_invasion.6 days = 1 random = 2 }
			if = {
				limit = {
					any_system_within_border = {
						NOR = {
							has_star_flag = Kuat_system
							has_star_flag = Kuat_system_1
							has_star_flag = Kuat_system_2
							has_star_flag = Kuat_system_3
						}
						any_system_megastructure = { is_megastructure_type = exe_outer_gate }
					}
				}
				country_event = { id = exe_invasion.41 days = 4 random = 2 }
			}
		}
	}
}

#Notification: Hyperspace echo. 
country_event = {
	id = exe_invasion.6
	title = "exe_invasion.6.name"
	desc = "exe_invasion.6.desc"
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire2_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_sensor_ping
	location = root.capital_scope
	is_triggered_only = yes
	option = { name = "exe_invasion.6.a" }
}

#Approaching rim system. 
event = {
	id = exe_invasion.7
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		NOT = { any_country = { has_origin = origin_kuat_apocalyptic } }
		has_global_flag = exe_invasion_5_fired
		NOT = { has_global_flag = exe_invasion_signs_cooldown }
		NOT = { has_global_flag = exe_invasion_7_fired }
	}
	immediate = {
		set_global_flag = exe_invasion_7_fired
		set_timed_global_flag = { flag = exe_invasion_signs_cooldown days = 360 }
		every_playable_country = { country_event = { id = exe_invasion.8 days = 1 random = 2 } }
	}
}

#Notification: Approaching rim system. 
country_event = {
	id = exe_invasion.8
	title = "exe_invasion.8.name"
	desc = "exe_invasion.8.desc"
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire5_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_yellow_alert
	location = root.capital_scope
	is_triggered_only = yes
	option = { name = "exe_invasion.8.a" }
}

#Invasion begin. 
event = {
	id = exe_invasion.9
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		NOT = { any_country = { has_origin = origin_kuat_apocalyptic } }
		has_global_flag = exe_invasion_7_fired
		NOT = { has_global_flag = exe_invasion_signs_cooldown }
		NOT = { has_global_flag = exe_invasion_begin }
	}
	immediate = {
		set_global_flag = eternal_spawnd
		set_global_flag = exe_invasion_begin
		create_country = {
			name = "Eternal Empire"
			type = ag_kuat_invasion_country
			flag = {
				icon = {
					category = "exe_invasion"
					file = "ge_o.dds"
				}
				background = {
					category = "backgrounds"
					file = "00_solid.dds"
				}
				colors = { "red" "red" "null" "null" }
			}
			ignore_initial_colony_error = yes
		}
		last_created_country = {
			save_global_event_target_as = ag_kuat_invasion_country
			if = {
				limit = { has_global_flag = special_exe_invasion }
				set_country_flag = ag_kuat_invasion_special_country
			} else = { set_country_flag = ag_kuat_invasion_country }
			set_global_flag = has_ag_kuat_invasion_country
			set_graphical_culture = fallen_empire_kuat_01
			create_ship_design = { design = "NAME_EXE_Starbase" }
			add_ship_design = last_created_design
			add_modifier = { modifier = Elternal_creating }
		}
		if = {
			limit = { NOT = { has_global_flag = will_pay_for_the_starbase } }
			random_system = {
				limit = { has_star_flag = Kuat_system }
				random_system_planet = {
					limit = { is_primary_star = yes }
					planet_event = { id = exe_invasion.11 days = 1 }
					planet_event = { id = exe_invasion.11 days = 5 }
					planet_event = { id = exe_invasion.11 days = 25 }
					planet_event = { id = exe_invasion.11 days = 50 }
					planet_event = { id = exe_invasion.11 days = 100 }
					planet_event = { id = exe_invasion.11 days = 120 }
					planet_event = { id = exe_invasion.11 days = 140 }
					planet_event = { id = exe_invasion.11 days = 160 }
					planet_event = { id = exe_invasion.11 days = 180 }
					planet_event = { id = exe_invasion.11 days = 200 }
					planet_event = { id = exe_invasion.11 days = 220 }
					planet_event = { id = exe_invasion.11 days = 240 }
					planet_event = { id = exe_invasion.11 days = 260 }
				}
			}
		} else = {
			random_system = {
				limit = { has_star_flag = Kuat_system }
				random_system_planet = {
					limit = { is_primary_star = yes }
					planet_event = { id = exe_invasion.11 days = 1 }
					planet_event = { id = exe_invasion.11 days = 5 }
					planet_event = { id = exe_invasion.11 days = 25 }
					planet_event = { id = exe_invasion.11 days = 50 }
					planet_event = { id = exe_invasion.11 days = 100 }
					planet_event = { id = exe_invasion.11 days = 120 }
					planet_event = { id = exe_invasion.11 days = 140 }
					planet_event = { id = exe_invasion.11 days = 160 }
					planet_event = { id = exe_invasion.11 days = 180 }
					planet_event = { id = exe_invasion.11 days = 200 }
					planet_event = { id = exe_invasion.11 days = 220 }
					planet_event = { id = exe_invasion.11 days = 240 }
					planet_event = { id = exe_invasion.11 days = 260 }
					planet_event = { id = exe_invasion.11 days = 280 }
					planet_event = { id = exe_invasion.11 days = 300 }
					planet_event = { id = exe_invasion.11 days = 320 }
					planet_event = { id = exe_invasion.11 days = 340 }
					planet_event = { id = exe_invasion.11 days = 360 }
					planet_event = { id = exe_invasion.11 days = 380 }
					planet_event = { id = exe_invasion.11 days = 400 }
				}
			}
		}
		every_country = {
			limit = { NOT = { is_country_type = ag_kuat_invasion_country } }
			establish_communications_no_message = event_target:ag_kuat_invasion_country
			country_event = { id = exe_invasion.10 }
		}
		every_country = {
			limit = { has_special_project = exe_invasion_lock_outer_gate }
			abort_special_project = { type = exe_invasion_lock_outer_gate }
		}
		if = {
			limit = {
				NOT = {
					any_system = {
						NOR = {
							has_star_flag = Kuat_system
							has_star_flag = Kuat_system_1
							has_star_flag = Kuat_system_2
							has_star_flag = Kuat_system_3
						}
						any_system_megastructure = { is_megastructure_type = exe_outer_gate }
					}
				}
			}
			random_system = {
				limit = {
					NOR = {
						has_star_flag = guardian
						has_star_flag = lcluster
						has_star_flag = isolated_home_system
						has_star_flag = isolated_home_system_gate
						AND = {
							exists = space_owner
							space_owner = {
								is_country_type = fallen_empire
								is_country_type = awakened_fallen_empire
								is_ai = no
							}
						}
						any_neighbor_system = {
							OR = {
								AND = {
									exists = space_owner
									space_owner = {
										OR = {
											is_country_type = fallen_empire
											is_country_type = awakened_fallen_empire
											is_ai = no
										}
									}
								}
								has_star_flag = guardian
							}
						}
					}
				}
				save_event_target_as = exe_invasion_outer_gate_spawn_system
			}
			if = {
				limit = { exists = event_target:exe_invasion_outer_gate_spawn_system }
				ag_exe_spawn_outer_gate_fallback = yes
			} else = {
				random_system = {
					limit = {
						NOR = {
							has_star_flag = guardian
							has_star_flag = lcluster
							has_star_flag = isolated_home_system
							has_star_flag = isolated_home_system_gate
							AND = {
								exists = space_owner
								space_owner = {
									is_country_type = fallen_empire
									is_country_type = awakened_fallen_empire
									is_ai = no
								}
							}
						}
					}
					save_event_target_as = exe_invasion_outer_gate_spawn_system
				}
				if = {
					limit = { exists = event_target:exe_invasion_outer_gate_spawn_system }
					ag_exe_spawn_outer_gate_fallback = yes
				} else = {
					random_system = {
						limit = {
							NOR = {
								has_star_flag = guardian
								has_star_flag = lcluster
								has_star_flag = isolated_home_system
								has_star_flag = isolated_home_system_gate
								AND = {
									exists = space_owner
									space_owner = { is_ai = no }
								}
							}
						}
						save_event_target_as = exe_invasion_outer_gate_spawn_system
					}
					if = {
						limit = { exists = event_target:exe_invasion_outer_gate_spawn_system }
						ag_exe_spawn_outer_gate_fallback = yes
					} else = {
						random_system = {
							limit = {
								NOR = {
									has_star_flag = guardian
									has_star_flag = lcluster
									has_star_flag = isolated_home_system
									has_star_flag = isolated_home_system_gate
								}
							}
							save_event_target_as = exe_invasion_outer_gate_spawn_system
						}
						if = {
							limit = { exists = event_target:exe_invasion_outer_gate_spawn_system }
							ag_exe_spawn_outer_gate_fallback = yes
						} else = { random_system = { ag_exe_spawn_outer_gate_fallback = yes } }
					}
				}
			}
		}
	}
}

#Notification: Invasion begin. 
country_event = {
	id = exe_invasion.10
	title = "exe_invasion.10.name"
	desc = {
		trigger = { has_global_flag = will_pay_for_the_starbase }
		text = "exe_invasion.10.a.desc"
	}
	desc = {
		trigger = { NOT = { has_global_flag = will_pay_for_the_starbase } }
		text = "exe_invasion.10.desc"
	}
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire4_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_red_alert
	location = root.capital_scope
	is_triggered_only = yes
	immediate = {
		if = {
			limit = { has_global_flag = will_pay_for_the_starbase }
			every_system = {
				limit = { ag_is_invasion_system = yes }
				every_fleet_in_system = {
					limit = {
						any_owned_ship = {
							NOR = {
								is_ship_class = shipclass_starbase
								is_ship_class = shipclass_military_station
								is_ship_class = shipclass_observation_station
								is_ship_class = shipclass_research_station
								is_ship_class = shipclass_mining_station
							}
						}
						owner = { is_ai = no }
					}
					set_location = owner.capital_scope
				}
			}
			country_event = { id = exe_invasion.128 }
		} else = {
			every_system = {
				limit = { ag_is_invasion_system = yes }
				every_fleet_in_system = {
					limit = {
						any_owned_ship = {
							NOR = {
								is_ship_class = shipclass_starbase
								is_ship_class = shipclass_military_station
								is_ship_class = shipclass_observation_station
								is_ship_class = shipclass_research_station
								is_ship_class = shipclass_mining_station
							}
						}
						owner = { is_ai = no }
					}
					set_location = owner.capital_scope
				}
			}
		}
	}
	option = {
		name = "exe_invasion.10.a"
		begin_event_chain = { event_chain = ag_exe_invasion_chain }
	}
}

country_event = {
	id = exe_invasion.128
	hide_window = yes
	is_triggered_only = yes
	fire_only_once = yes
	trigger = {
		OR = {
			has_global_flag = difficult_exe_invasion
			has_global_flag = normal_exe_invasion
		}
	}
	immediate = { create_elternal_warbase = yes }
}

fleet_event = {
	id = exe_invasion.125
	hide_window = yes
	is_triggered_only = yes
	trigger = { exists = event_target:kuat_station_elternal }
	immediate = { 
		destroy_fleet = { target = this destroy_template = yes kill_leader = yes }
		solar_system = {
			remove_star_flag = eternal_starbase_megastructure_in_system
			set_star_class = sc_black_hole
			random_system_planet = {
				limit = { is_primary_star = yes }
				create_ambient_object = {
					type = kuat_elternal_explosion_object
					location = this
					duration = 30					
					use_3d_location = yes
					entity_offset = { min = 0 max = 0 }
					entity_offset_angle = { min = 0 max = 0 }
					entity_offset_height = { min = 0 max = 0 }				
					entity_scale_to_size = yes
					scale = 0.5
				}
				change_pc = pc_black_hole
				set_planet_size = 18
			}
			every_fleet_in_system = {
				limit = { NOT = { owner = { is_country_type = ag_kuat_invasion_country } } }
				destroy_fleet = { target = this destroy_template = yes kill_leader = yes }
			}
			random_ambient_object = {
				limit = { has_ambient_object_flag = space_storm_object }
				destroy_ambient_object = this
			}
		}
		every_playable_country = { country_event = { id = exe_invasion.126 } }
	}
}

country_event = {
	id = exe_invasion.126
	title = "exe_invasion.126.name"
	desc = "exe_invasion.126.desc"
	diplomatic = yes
	picture_event_data = { room = black_hole_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	fire_only_once = yes
	show_sound = event_red_alert
	is_triggered_only = yes
	option = { name = exe_invasion.126.a }
}

country_event = {
	id = exe_invasion.127
	title = "exe_invasion.127.name"
	desc = "exe_invasion.127.desc"
	diplomatic = yes
	picture_event_data = { room = black_hole_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_red_alert
	is_triggered_only = yes
	trigger = {
		fromfromfrom = {
			is_ship_size = exe_megastructure_starbase
			solar_system = { has_star_flag = eternal_starbase_megastructure_in_system }
		}
	}
	immediate = {
		fromfromfrom.solar_system = {
			remove_star_flag = eternal_starbase_megastructure_in_system
			random_system_planet = {
				limit = { is_primary_star = yes }
				change_pc = pc_black_hole
				create_ambient_object = {
					type = kuat_elternal_explosion_object
					location = this
					duration = 30					
					use_3d_location = yes
					entity_offset = { min = 0 max = 0 }
					entity_offset_angle = { min = 0 max = 0 }
					entity_offset_height = { min = 0 max = 0 }				
					entity_scale_to_size = yes
					scale = 0.5
				}
				set_planet_size = 18
			}
			set_star_class = sc_black_hole
			every_fleet_in_system = {
				limit = { NOT = { owner = { is_country_type = ag_kuat_invasion_country } } }
				destroy_fleet = { target = this destroy_template = yes kill_leader = yes }
			}
			random_ambient_object = {
				limit = { has_ambient_object_flag = space_storm_object }
				destroy_ambient_object = this
			}
		}
	}
	option = { name = exe_invasion.127.a }
}

#Invasion fleet arrived. 
planet_event = {
	id = exe_invasion.11
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = exe_invasion_begin
		NOT = { has_global_flag = exe_invasion_ended }
	}
	immediate = {
		event_target:ag_kuat_invasion_country = {
			change_variable = { which = ag_kuat_invasion_fleet_arrived value = 1 }
		}
		if = {
			limit = { has_global_flag = special_exe_invasion }
			create_normal_exe_invasion_ship = yes
		}
		else_if = {
			limit = { has_global_flag = difficult_exe_invasion }
			random_list = {
				75 = { create_difficult_exe_invasion_ship = yes }
				25 = { create_difficult_special_exe_invasion_ship = yes }
			}
		}
		else_if = {
			limit = { has_global_flag = normal_exe_invasion }
			create_normal_exe_invasion_ship = yes
		} 
		else = { create_easy_exe_invasion_ship = yes }
		every_country = {
			limit = { has_event_chain = ag_exe_invasion_chain }
			add_event_chain_counter = {
				event_chain = ag_exe_invasion_chain
				counter = ag_exe_invasion_fleet
				amount = 1
			}
		}
		event_target:ag_kuat_invasion_country = {
			if = {
				limit = {
					NOT = { has_global_flag = will_pay_for_the_starbase }
					check_variable = { which = ag_kuat_invasion_fleet_arrived value = 13 }
				}
				every_owned_fleet = {
					limit = { has_fleet_flag = ag_kuat_invasion_fleet }
					fleet_event = { id = exe_invasion.12 days = 1 random = 2 }
				}
				country_event = { id = exe_invasion.111 days = 30 }
				set_global_flag = can_win_the_fleet
			} 
			else_if = {
				limit = { 
					has_global_flag = will_pay_for_the_starbase
					check_variable = { which = ag_kuat_invasion_fleet_arrived value = 20 }
				}
				every_owned_fleet = {
					limit = { has_fleet_flag = ag_kuat_invasion_fleet }
					fleet_event = { id = exe_invasion.12 days = 1 random = 2 }
				}
				country_event = { id = exe_invasion.111 days = 30 }
				set_global_flag = can_win_the_fleet
			}
		}
	}
}

country_event = {
	id = exe_invasion.111
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		exists = event_target:ag_kuat_invasion_country
		is_country_type = ag_kuat_invasion_country
		has_global_flag = can_win_the_fleet
	}
	immediate = {
		if = {
			limit = { 
				NOT = { any_owned_fleet = { has_fleet_flag = ag_kuat_invasion_fleet } } 
			}
			random_system = {
				limit = { has_star_flag = Kuat_system }
				random_system_planet = {
					limit = { is_primary_star = yes }
					if = {
						limit = { has_global_flag = special_exe_invasion }
						create_normal_exe_invasion_ship = yes
					}
					else_if = {
						limit = { has_global_flag = difficult_exe_invasion }
						random_list = {
							75 = { create_difficult_exe_invasion_ship = yes }
							25 = { create_difficult_special_exe_invasion_ship = yes }
						}
					}
					else_if = {
						limit = { has_global_flag = normal_exe_invasion }
						create_normal_exe_invasion_ship = yes
					} 
					else = { create_easy_exe_invasion_ship = yes }
					every_country = {
						limit = { has_event_chain = ag_exe_invasion_chain }
						add_event_chain_counter = {
							event_chain = ag_exe_invasion_chain
							counter = ag_exe_invasion_fleet
							amount = 1
						}
					}
				}
			}
		}
		country_event = { id = exe_invasion.111 days = 30 }
	}
}

#Invasion fleet action. 
fleet_event = {
	id = exe_invasion.12
	hide_window = yes
	is_triggered_only = yes
	trigger = { exists = this }
	immediate = { ag_exe_invasion_fleet_action = yes }
}

#Invasion fleet action on win a space battle. 
country_event = {
	id = exe_invasion.13
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_country_type = ag_kuat_invasion_country
		fromfrom = { fleet = { has_fleet_flag = ag_kuat_invasion_fleet } }
		fromfromfrom = {
			OR = {
				is_ship_class = shipclass_starbase
				is_ship_class = shipclass_military
			}
		}
	}
	after = {
		fromfrom = {
			solar_system = {
				every_fleet_in_system = {
					limit = {
						exists = owner
						owner = { is_country_type = ag_kuat_invasion_country }
						has_fleet_flag = ag_kuat_invasion_fleet
					}
					clear_orders = yes
					clear_fleet_actions = this
					fleet_event = { id = exe_invasion.12 days = 3 random = 2 }
				}
			}
		}
	}
}

#Invasion fleet action on orbit planet. 
country_event = {
	id = exe_invasion.14
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_country_type = ag_kuat_invasion_country
		from = { has_fleet_flag = ag_kuat_invasion_fleet }
		fromfrom = {
			OR = {
				is_star = yes
				NOT = { exists = owner }
			}
		}
	}
	immediate = {
		from = {
			clear_orders = yes
			clear_fleet_actions = this
			fleet_event = { id = exe_invasion.12 days = 3 random = 2 }
		}
	}
}

#Reset invasion fleet action if two fleet in same system. 
fleet_event = {
	id = exe_invasion.15
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_fleet_flag = ag_kuat_invasion_fleet
		from = {
			NOR = {
				has_star_flag = Kuat_system
				has_star_flag = Kuat_system_1
				has_star_flag = Kuat_system_2
				has_star_flag = Kuat_system_3
				has_star_flag = ag_exe_invasion_gate_system
			}
			any_fleet_in_system = {
				NOT = { is_same_value = root }
				has_fleet_flag = ag_kuat_invasion_fleet
			}
		}
	}
	immediate = {
		clear_orders = yes
		clear_fleet_actions = this
		from = {
			random_neighbor_system = {
				random_system_planet = {
					limit = { is_primary_star = yes }
					prevprev = {
						auto_move_to_planet = {
							target = prev
							clear_auto_move_on_arrival = yes
						}
					}
				}
			}
		}
	}
}

#Check every month to prevent bugs.
event = {
	id = exe_invasion.16
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = exe_invasion_begin
		NOT = { has_global_flag = exe_invasion_ended }
		exists = event_target:ag_kuat_invasion_country
		event_target:ag_kuat_invasion_country = {
			any_owned_fleet = {
				exists = this
				is_fleet_idle = yes
				has_fleet_flag = ag_kuat_invasion_fleet
				NAND = {
					exists = orbit
					orbit = {
						NOT = { is_star = yes }
						exists = owner
						owner = { is_hostile = event_target:ag_kuat_invasion_country }
						exists = controller
						controller = { is_hostile = event_target:ag_kuat_invasion_country }
					}
				}
			}
		}
	}
	immediate = {
		event_target:ag_kuat_invasion_country = {
			every_owned_fleet = {
				limit = {
					exists = this
					is_fleet_idle = yes
					has_fleet_flag = ag_kuat_invasion_fleet
					NAND = {
						exists = orbit
						orbit = {
							NOT = { is_star = yes }
							exists = owner
							owner = { is_hostile = event_target:ag_kuat_invasion_country }
							exists = controller
							controller = { is_hostile = event_target:ag_kuat_invasion_country }
						}
					}
				}
				clear_orders = yes
				clear_fleet_actions = this
				fleet_event = { id = exe_invasion.12 days = 3 random = 2 }
			}
		}
	}
}

#Invasion fleet bombard a planet. 
planet_event = {
	id = exe_invasion.21
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = exe_invasion_begin
		NOT = { has_global_flag = exe_invasion_ended }
		OR = {
			planet_devastation >= 100
			AND = {
				num_pops < 2
				owner = { ag_is_common_country = yes }
			}
		}
		from = { is_country_type = ag_kuat_invasion_country }
	}
	immediate = {
		owner = { country_event = { id = exe_invasion.34 } }
		add_threat = { who = from amount = 2 }
		add_planet_devastation = -100
		if = {
			limit = { num_pops > 0 }
			every_owned_pop = { kill_pop = yes }
		}
		remove_all_buildings = yes
		remove_all_districts = yes
		clear_deposits = yes
		if = {
			limit = { is_colony = yes }
			destroy_colony = yes
		}
		if = {
			limit = {
				NOR = {
					ag_is_ringworld = yes
					is_planet_class = pc_habitat
					has_modifier = "holy_planet"
				}
			}
			change_pc = pc_broken
		}
		else_if = {
			limit = { ag_is_ringworld = yes }
			spawn_ringworld_cracker_effect = yes
			change_pc = pc_ringworld_habitable_damaged
			set_planet_entity = { entity = ringworld_habitable_damaged_entity }
		}
		else_if = {
			limit = { is_planet_class = pc_habitat }
			spawn_habitat_cracker_effect = yes
			remove_planet = yes
		}
		else_if = {
			limit = { has_modifier = "holy_planet" }
			change_pc = pc_shattered
			remove_modifier = "holy_planet"
			add_modifier = { modifier = "ag_shattered_holy_planet" }
		}
		every_country = {
			limit = {
				NOT = { is_same_value = event_target:ag_kuat_invasion_country }
				has_event_chain = ag_exe_invasion_chain
			}
			add_event_chain_counter = {
				event_chain = "ag_exe_invasion_chain"
				counter = "ag_exe_invasion_planet_destroyed"
				amount = 1
			}
		}
		solar_system = {
			every_fleet_in_system = {
				limit = {
					exists = owner
					owner = { is_country_type = ag_kuat_invasion_country }
					has_fleet_flag = ag_kuat_invasion_fleet
					OR = {
						AND = {
							exists = orbit
							orbit = { is_same_value = root }
						}
						AND = {
							is_fleet_idle = yes
							NAND = {
								exists = orbit
								orbit = {
									NOT = { is_star = yes }
									exists = owner
									owner = { is_hostile = event_target:ag_kuat_invasion_country }
								}
							}
						}
					}
				}
				clear_orders = yes
				clear_fleet_actions = this
				fleet_event = { id = exe_invasion.12 days = 1 random = 2 }
			}
		}	
	}
}

country_event = {
	id = exe_invasion.34
	title = "exe_invasion.21.name"
	desc = {
		trigger = { from = { ag_is_event_borderment_ringworld = no } }
		text = "exe_invasion.21.a.desc"
	}
	desc = {
		trigger = { from = { ag_is_ringworld = yes } }
		text = "exe_invasion.21.b.desc"
	}
	desc = {
		trigger = { from = { is_planet_class = pc_habitat } }
		text = "exe_invasion.21.c.desc"
	}
	desc = {
		trigger = { from = { ag_is_holy_world_planet = yes } }
		text = "exe_invasion.21.d.desc"
	}
	diplomatic = yes
	picture_event_data = { room = nuclear_explosion_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_super_explosion
	is_triggered_only = yes
	option = { name = "exe_invasion.21.a" }
}

#Invasion fleet killed counter. 
country_event = {
	id = exe_invasion.22
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_country_type = ag_kuat_invasion_country
	}
	immediate = {
		from = {
			add_event_chain_counter = {
				event_chain = ag_exe_invasion_chain
				counter = ag_exe_invasion_ship_kill_by_us
				amount = 1
			}
		}
		every_country = {
			limit = {
				has_event_chain = ag_exe_invasion_chain
				NOT = { is_same_value = from }
			}
			add_event_chain_counter = {
				event_chain = ag_exe_invasion_chain
				counter = ag_exe_invasion_ship_kill_by_other
				amount = 1
			}
		}
	}
}

#Invasion fleet victim counter.
country_event = {
	id = exe_invasion.23
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_country_type = ag_kuat_invasion_country
		from = { NOT = { is_country_type = ag_kuat_invasion_country } }
	}
	immediate = {
		every_country = {
			limit = {
				NOT = { is_same_value = event_target:ag_kuat_invasion_country }
				has_event_chain = ag_exe_invasion_chain
			}
			add_event_chain_counter = {
				event_chain = ag_exe_invasion_chain
				counter = ag_exe_invasion_victim
				amount = 1
			}
		}
	}
}

#An invasion fleet has been destroyed. 
country_event = {
	id = exe_invasion.31
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		from = { is_country_type = ag_kuat_invasion_country }
		fromfromfrom = { has_fleet_flag = ag_kuat_invasion_fleet }
	}
	immediate = {
		every_country = {
			limit = {
				has_event_chain = ag_exe_invasion_chain
			}
			add_event_chain_counter = {
				event_chain = ag_exe_invasion_chain
				counter = ag_exe_invasion_fleet
				amount = -1
			}
		}
	}
}

#All invasion fleet destroyed, invasion end. 
country_event = {
	id = exe_invasion.32
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		from = {
			is_country_type = ag_kuat_invasion_country
			NOT = {
				any_owned_fleet = {
					has_fleet_flag = ag_kuat_invasion_fleet
					NOT = { is_same_value = root.fromfromfrom }
				}
			}
		}
		fromfromfrom = { has_fleet_flag = ag_kuat_invasion_fleet }
		has_global_flag = can_win_the_fleet
	}
	immediate = {
		every_country = {
			limit = {
				NOT = { is_same_value = event_target:ag_kuat_invasion_country }
			}
			if = {
				limit = { NOT = { has_global_flag = special_exe_invasion } }
				country_event = { id = exe_invasion.33 }
			} else = { country_event = { id = exe_invasion.35 } }
		}
		add_threat = { who = root amount = 50 }
		set_global_flag = exe_invasion_ended
		from = { destroy_country = yes }
	}
}

#Notification: Invasion end. 
country_event = {
	id = exe_invasion.33
	title = "exe_invasion.33.name"
	desc = "exe_invasion.33.desc"
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire_room }
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	fire_only_once = yes
	show_sound = event_space_battle
	is_triggered_only = yes
	option = {
		name = "exe_invasion.33.a"
		hidden_effect = {
			if = {
				limit = {
					OR = {
						has_global_flag = difficult_exe_invasion
						has_global_flag = normal_exe_invasion
					}
				}
				set_global_flag = fire_the_kuat_return
			}
			end_event_chain = ag_exe_invasion_chain
		}
	}
}

country_event = {
	id = exe_invasion.35
	title = "exe_invasion.33.name"
	desc = "exe_invasion.35.desc"
	diplomatic = yes
	picture_event_data = {
		room = Eternal_Empire_room
	}
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	fire_only_once = yes
	show_sound = event_space_battle
	is_triggered_only = yes
	option = {
		name = "exe_invasion.33.b"
		hidden_effect = {
			end_event_chain = ag_exe_invasion_chain
			enable_special_project = {
				name = exe_invasion_lock_the_eclipse
				location = this.capital_scope
			}
		}
	}
}

#Special project to lock an outer gate. (if no outer gate, invasion will create a new outer gate. )
country_event = {
	id = exe_invasion.41
	title = "exe_invasion.41.name"
	desc = "exe_invasion.41.desc"
	diplomatic = yes
	picture_event_data = { room = drifting_gateway_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_mystic_reveal
	is_triggered_only = yes
	immediate = {
		random_system_within_border = {
			limit = {
				NOR = {
					has_star_flag = Kuat_system
					has_star_flag = Kuat_system_1
					has_star_flag = Kuat_system_2
					has_star_flag = Kuat_system_3
				}
				any_system_megastructure = { is_megastructure_type = exe_outer_gate }
			}
			random_system_megastructure = {
				limit = { is_megastructure_type = exe_outer_gate }
				save_event_target_as = exe_outer_gate_to_lock
			}
		}
	}
	option = {
		name = "exe_invasion.41.a"
		enable_special_project = {
			name = exe_invasion_lock_outer_gate
			location = event_target:exe_outer_gate_to_lock
			owner = root
		}
	}
	option = {
		name = "exe_invasion.41.b"
		add_resource = { influence = 50 }
	}
}

#Locked an outer gate. 
ship_event = {
	id = exe_invasion.42
	title = "exe_invasion.42.name"
	desc = "exe_invasion.42.desc"
	diplomatic = yes
	picture_event_data = { room = drifting_gateway_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_mystic_reveal
	is_triggered_only = yes
	immediate = {
		solar_system = {
			random_system_megastructure = {
				limit = { is_megastructure_type = exe_outer_gate }
				upgrade_megastructure_to = exe_outer_gate_locked
				finish_upgrade = yes
			}
		}
	}
	option = { name = "exe_invasion.42.a" }
}

#Spawn starbase
fleet_event = {
	id = exe_invasion.36
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = exe_invasion_begin
		NOT = { has_global_flag = exe_invasion_ended }
		has_fleet_flag = ag_kuat_invasion_fleet
	}
	immediate = {
		if = {
			limit = { exists = solar_system }
			solar_system = { if = {
				limit = {
					NOR = {
						any_ship_in_system = {
							is_ship_class = shipclass_starbase
							exists = owner
							owner = { is_same_value = event_target:ag_kuat_invasion_country }
						}
						any_ship_in_system = {
							exists = owner
							owner = { is_hostile = event_target:ag_kuat_invasion_country }
						}
						any_system_planet = {
							exists = owner
							owner = { is_hostile = event_target:ag_kuat_invasion_country }
						}
					}
				}
				create_starbase = {
					size = exe_starbase
					owner = event_target:ag_kuat_invasion_country
					module = "gun_battery"
					module = "gun_battery"
					module = "gun_battery"
					module = "gun_battery"
					module = "gun_battery"
					module = "gun_battery"
				} }
			}
		}
		fleet_event = { id = exe_invasion.36 days = 1 }
	}
}

#Invasion happen or not? 
country_event = {
	id = exe_invasion.1000
	title = "exe_invasion.1000.name"
	desc = "exe_invasion.1000.desc"
	picture_event_data = { room = kuat_council_fleet_room }
	show_sound = event_mystic_reveal
	diplomatic = yes
	custom_gui = "kuat_mod_settings_window"
	custom_gui_option = "kuat_mod_settings_option"
	is_triggered_only = yes
	option = {
		name = "exe_invasion.1000.a"
		default_hide_option = yes
	}
}

country_event = {
	id = exe_invasion.1002
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		create_fleet = {
			name = "Eternal Flagship"
			effect = {
				set_owner = prev
				create_ship = {	design = "Name_boss_eclipse_1" }
				set_location = prev.capital_scope
				set_fleet_stance = aggressive
				set_fleet_bombardment_stance = indiscriminate
			}
			settings = { is_boss = yes }
		}
	}
}

ship_event = {
	id = exe_invasion.1003
	hide_window = no
	title = "exe_invasion.1003.name"
	desc = "exe_invasion.1003.desc"
	diplomatic = yes
	picture_event_data = {
		room = fallen_empire_room
	}
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	is_triggered_only = yes
	immediate = {
		every_playable_country = {
			limit = { is_ai = no }
			country_event = { id = exe_invasion.1002 }
		}
	}
	option = { name = exe_invasion.1003.a }
}

#flagship protection difficult
country_event = {
	id = exe_invasion.116
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		from = {
			is_country_type = ag_kuat_invasion_country
			has_global_flag = difficult_exe_invasion
		}
	}
	immediate = {
		fromfrom = { 
			if = {
				limit = {
					NOT = { has_fleet_flag = has_Eternal_support }
					any_owned_ship = { ag_is_flagship_system_proection_true = yes }
				}
				set_fleet_modifier = { SUB = Eternal_support }
			}
		}
	}
}

country_event = {
	id = exe_invasion.117
	hide_window = yes
	is_triggered_only = yes
	trigger = { 
		is_country_type = ag_kuat_invasion_country
		fromfrom = { has_fleet_flag = ag_kuat_invasion_starbase }
	}
	immediate = {
		fromfrom = {
			if = {
				limit = { NOT = { has_fleet_flag = fire_for_once } }
				set_timed_fleet_flag = { flag = fire_for_once days = 1 }
				every_owned_ship = {
					limit = { is_ship_size = exe_megastructure_starbase }
					set_fleet_modifier = { SUB = Eternal_support }
					increase_ship_hp_effect_change = { DAYS = 15 }
					set_fromfromfrom_check_invsiable_time_flag = { DAYS = 15 }
				}
			}
		}
	}
} 

country_event = {
	id = exe_invasion.118
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		from = { is_country_type = ag_kuat_invasion_country }
		fromfrom = { has_fleet_flag = has_Eternal_support }
		OR = {
			has_global_flag = difficult_exe_invasion
			has_global_flag = special_exe_invasion
		}
	}
	immediate = { FROMFROM = { remove_fleet_flag = has_Eternal_support remove_modifier = Eternal_support } }
}

#FLEET INVISIABLE WITHOUT SPECIAL
ship_event = {
	id = exe_invasion.119
	hide_window = yes
	is_triggered_only = yes
	trigger = { has_ship_flag = is_invisiable_trigger }
	immediate = {
		while = {
			limit = { has_ship_flag = is_invisiable_trigger }
			repair_ship = yes
		}
		ship_event = { id = exe_invasion.119 days = 1 }
	}
}

country_event = {
	id = exe_invasion.120
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_ai = no
		NOT = { is_country_type = ag_kuat_invasion_country }
		from = { NOT = { has_country_flag = ag_kuat_invasion_country } }
	}
	immediate = {
		FROMFROM = { 
			if = {
				limit = { 
					count_owned_ship = {
						limit = {
							ag_is_flagship_system_proection_false = yes
						} 
						count = 1
					}
					NOT = { has_fleet_flag = fire_for_once }
				}
				set_timed_fleet_flag = { flag = fire_for_once days = 1 }
				if = {
					limit = { any_owned_ship = { is_ship_size = Annihilator } }
					increase_ship_hp_effect_change = { DAYS = 4 }
				}
				else_if = {
					limit = { any_owned_ship = { is_ship_size = eclipse } }
					increase_ship_hp_effect_change = { DAYS = 3 }
				}
				else_if = {
					limit = { any_owned_ship = { is_ship_size = knigjt_hammer_executor } }
					increase_ship_hp_effect_change = { DAYS = 3 }
				}
				else_if = {
					limit = { any_owned_ship = { is_ship_size = nebula_executor } }
					increase_ship_hp_effect_change = { DAYS = 2 }
				}
				else_if = {
					limit = { any_owned_ship = { is_ship_size = exe_megastructure_starbase } }
					increase_ship_hp_effect_change = { DAYS = 2 }
				}
				else_if = {
					limit = { any_owned_ship = { is_ship_size = nebula_dominance } }
					increase_ship_hp_effect_change = { DAYS = 1 }
				}
				else_if = {
					limit = { any_owned_ship = { is_ship_size = ag_delta_titan_1 } }
					increase_ship_hp_effect_change = { DAYS = 1 }
				}
				else_if = {
					limit = { any_owned_ship = { is_ship_size = ag_ancient_wandering_ship_1 } }
					increase_ship_hp_effect_change = { DAYS = 1 }
				}
				else_if = {
					limit = { any_owned_ship = { is_ship_size = ag_gamma_station_1 } }
					increase_ship_hp_effect_change = { DAYS = 1 }
				}
				else_if = {
					limit = { any_owned_ship = { is_ship_size = ag_zeta_titan } }
					increase_ship_hp_effect_change = { DAYS = 1 }
				}
				else_if = {
					limit = { any_owned_ship = { is_ship_size = ag_zeta_titan_psi } }
					increase_ship_hp_effect_change = { DAYS = 1 }
				} 
				else_if = {
					limit = { any_owned_ship = { is_ship_size = SWGS_Nemesis } }
					increase_ship_hp_effect_change = { DAYS = 1 }
				} 
				else_if = {
					limit = { any_owned_ship = { is_ship_size = SWGS_Lusankya } }
					increase_ship_hp_effect_change = { DAYS = 1 }
				} 
				else_if = {
					limit = { any_owned_ship = { is_ship_size = SWGS_EclipseII } }
					increase_ship_hp_effect_change = { DAYS = 1 }
				} 
			}
		}
	}
}

#Kuat and special eternal
country_event = {
	id = exe_invasion.121
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		OR = {
			has_country_flag = ag_kuat_invasion_special_country
			is_kuat_fallen_empire = yes
		}
	}
	immediate = {
		FROMFROM = { if = {
			limit = {
				NOT = { has_fleet_flag = has_Eternal_support }
				any_owned_ship = { ag_is_flagship_system_proection_false = yes } 
				root.fromfromfrom = { NOT = { has_fleet_flag = ship_firing_debuff_invisiable_protection } }
			}
			set_fleet_modifier = { SUB = Eternal_support }
			increase_ship_hp_effect_change = { DAYS = 5 }
			set_fromfromfrom_check_invsiable_time_flag = { DAYS = 5 }
		} }
	}
}

country_event = {
	id = exe_invasion.123
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_country_type = ag_kuat_invasion_country
		FROMFROM = { has_fleet_flag = has_Eternal_support }
	}
	immediate = { FROMFROM = { remove_modifier = Eternal_support remove_fleet_flag = has_Eternal_support } }
}

country_event = {
	id = exe_invasion.124
	hide_window = yes
	is_triggered_only = yes
	trigger = { FROMFROM = { has_fleet_flag = has_Eternal_submit } }
	immediate = { FROMFROM = { remove_modifier = Eternal_submit  remove_fleet_flag = has_Eternal_submit } }
}

# country_event = {
# 	id = exe_invasion.129
# 	hide_window = no
# 	title = "exe_invasion.129.name"
# 	desc = "exe_invasion.129.desc"
# 	diplomatic = yes
# 	picture_event_data = { room = exploding_ship_room }
# 	custom_gui = "kuat_event_m_window"
# 	custom_gui_option = "kuat_event_m_option"
# 	show_sound = event_space_battle
# 	is_triggered_only = yes
# 	trigger = { NOT = { has_country_flag = fire_once_leader } }
# 	immediate = { set_country_flag = fire_once_leader }
# 	option = { name = "exe_invasion.129.a" }
# }

#debug check modifier in eternal fleet
country_event = {
	id = exe_invasion.130
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = enable_modifer_check
		OR = {
			fromfrom = { 
				OR = {
					has_fleet_flag = ag_kuat_invasion_fleet
					has_fleet_flag = ag_kuat_invasion_starbase
				}  
			} 
			is_kuat_fallen_empire = yes
		}
	}
	immediate = { 
		fromfrom = {
			if = {
				limit = { 
					any_owned_ship = { NOT = { has_ship_flag = fire_for_once } }
					NOT = { has_fleet_flag = fire_for_once } 
				}
				set_timed_fleet_flag = { flag = fire_for_once days = 1 }
				random_owned_ship = {
					limit = { NOT = { has_ship_flag = fire_for_once } }
					set_ship_flag = fire_for_once
					set_eternal_fleet_mult_modifier = { 
						hull_regen_add_perc = ship_hull_regen_add_perc 
						shield_regen_add_perc = ship_shield_regen_add_perc 
						armor_regen_add_perc = ship_armor_regen_add_perc 
						hull_mult = ship_hull_mult
						armor_mult = ship_armor_mult
						shield_mult = ship_shield_mult
						weapon_range_mult = ship_weapon_range_mult
						weapon_damage_own = ship_weapon_damage
						shield_penetration_own = ship_shield_penetration_mult
						armor_penetration_own = ship_armor_penetration_mult
						weapon_type_energy = weapon_type_energy_weapon_damage_mult
						weapon_type_kinetic = weapon_type_kinetic_weapon_damage_mult
						weapon_type_explosive = weapon_type_explosive_weapon_damage_mult 
					}
				}
				fleet_event = { id = exe_invasion.1311 }
			}	
		}
		country_event = { id = exe_invasion.129 days = 1 } 
	}
}

fleet_event = {
	id = exe_invasion.1311
	hide_window = yes
	is_triggered_only = yes
	trigger = { is_in_combat = yes }
	immediate = {
		if = {
			limit = { any_owned_ship = { NOT = { has_ship_flag = fire_for_once } } }
			random_owned_ship = {
				limit = { NOT = { has_ship_flag = fire_for_once } }
				set_ship_flag = fire_for_once
				set_eternal_fleet_mult_modifier = { 
					hull_regen_add_perc = ship_hull_regen_add_perc 
					shield_regen_add_perc = ship_shield_regen_add_perc 
					armor_regen_add_perc = ship_armor_regen_add_perc 
					hull_mult = ship_hull_mult
					armor_mult = ship_armor_mult
					shield_mult = ship_shield_mult
					weapon_range_mult = ship_weapon_range_mult
					weapon_damage_own = ship_weapon_damage
					shield_penetration_own = ship_shield_penetration_mult
					armor_penetration_own = ship_armor_penetration_mult
					weapon_type_energy = weapon_type_energy_weapon_damage_mult
					weapon_type_kinetic = weapon_type_kinetic_weapon_damage_mult
					weapon_type_explosive = weapon_type_explosive_weapon_damage_mult 
				}
			}
			fleet_event = { id = exe_invasion.1311 }
		}	
	}
}

country_event = {
	id = exe_invasion.129
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = enable_modifer_check
		OR = {
			is_country_type = ag_kuat_invasion_country
			is_kuat_fallen_empire = yes
		}
	}
	immediate = {
		fire_on_action = {
			on_action = on_eternal_fleet_entering_battle
			scopes = {
				from = root.fromfrom
				fromfrom = root.fromfromfrom
				fromfromfrom = root.fromfromfromfrom
			}
		}
	}
}

country_event = {
	id = exe_invasion.131
	hide_window = yes
	is_triggered_only = yes
	trigger = { has_global_flag = enable_modifer_check }
	immediate = { 
		fromfromfrom = { 
			if = {
				limit = { 
					any_owned_ship = { NOT = { has_ship_flag = fire_for_once } }
					NOT = { has_fleet_flag = fire_for_once } 
				}
				set_timed_fleet_flag = { flag = fire_for_once days = 1 }
				random_owned_ship = {
					limit = { NOT = { has_ship_flag = fire_for_once } }
					set_ship_flag = fire_for_once
					if = {
						limit = { 
							ROOT = { is_country_type = ag_kuat_invasion_country } 
							has_global_flag = difficult_exe_invasion 
						}
						set_eternal_fleet_mult_modifier = { 
							shield_penetration = ship_shield_penetration_mult 
							armor_penetration = ship_armor_penetration_mult
							armor_damage = ship_armor_damage_mult
							shield_damage = ship_shield_damage_mult
							hull_damage = ship_hull_damage_mult
							weapon_damage = ship_weapon_damage
							tracking = ship_tracking_mult
						}
					} else = {
						set_eternal_fleet_mult_modifier = { 
							shield_penetration = ship_shield_penetration_mult 
							armor_penetration = ship_armor_penetration_mult
						}
					}
				}
				fleet_event = { id = exe_invasion.1312 }
			} 
		}
	}
}

fleet_event = {
	id = exe_invasion.1312
	hide_window = yes
	is_triggered_only = yes
	trigger = { is_in_combat = yes }
	immediate = {
		if = {
			limit = { any_owned_ship = { NOT = { has_ship_flag = fire_for_once } } }
			random_owned_ship = {
				limit = { NOT = { has_ship_flag = fire_for_once } }
				set_ship_flag = fire_for_once
				if = {
					limit = { 
						root.from = { is_country_type = ag_kuat_invasion_country } 
						has_global_flag = difficult_exe_invasion 
					}
					set_eternal_fleet_mult_modifier = { 
						shield_penetration = ship_shield_penetration_mult 
						armor_penetration = ship_armor_penetration_mult
						armor_damage = ship_armor_damage_mult
						shield_damage = ship_shield_damage_mult
						hull_damage = ship_hull_damage_mult
						weapon_damage = ship_weapon_damage
						tracking = ship_tracking_mult
					}
				} else = {
					set_eternal_fleet_mult_modifier = { 
						shield_penetration = ship_shield_penetration_mult 
						armor_penetration = ship_armor_penetration_mult
					}
				}
			}
			fleet_event = { id = exe_invasion.1312 }
		} 
	}
}

country_event = {
	id = exe_invasion.133
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_kuat_fallen_empire = no
		NOT = { is_country_type = ag_kuat_invasion_country }
		OR = {
			from = { is_kuat_fallen_empire = no }
			from = { NOT = { is_country_type = ag_kuat_invasion_country } }
		}
		fromfrom = { any_owned_ship = { has_component = EXE_STARBASE_MEAGASTRUCTRUE_AUX_2 } }
	}
	immediate = {
		fromfromfrom = { 
			if = {
				limit = { 
					NOT = { has_fleet_flag = fire_for_once } 
					any_owned_ship = { NOT = { has_ship_flag = fire_for_once } }
				}
				set_timed_fleet_flag = { flag = fire_for_once days = 1 }
				random_owned_ship = {
					limit = { NOT = { has_ship_flag = fire_for_once } }
					set_ship_flag = fire_for_once
					set_eternal_fleet_mult_modifier = { 
						shield_penetration = ship_shield_penetration_mult 
						armor_penetration = ship_armor_penetration_mult
					}
				}
				fleet_event = { id = exe_invasion.1331 }
			} 
		}
	}
}

fleet_event = {
	id = exe_invasion.1331
	hide_window = yes
	is_triggered_only = yes
	trigger = { is_in_combat = yes }
	immediate = {
		if = {
			limit = { any_owned_ship = { NOT = { has_ship_flag = fire_for_once } } }
			random_owned_ship = {
				limit = { NOT = { has_ship_flag = fire_for_once } }
				set_ship_flag = fire_for_once
				set_eternal_fleet_mult_modifier = { 
					shield_penetration = ship_shield_penetration_mult 
					armor_penetration = ship_armor_penetration_mult
				}
			}
			fleet_event = { id = exe_invasion.1331 }
		}
	}
}

country_event = {
	id = exe_invasion.132
	hide_window = yes
	is_triggered_only = yes
	trigger = { 
		OR = {
			fromfromfrom = { has_fleet_flag = has_combat_modifier } 
			fromfrom = { has_fleet_flag = has_combat_modifier } 
		}
	}
	immediate = { 
		fromfrom = {
			every_owned_ship = {
				remove_modifier = basic_ship_shield_penetration_mult 
				remove_modifier = basic_ship_armor_penetration_mult
				remove_modifier = basic_ship_armor_damage_mult
				remove_modifier = basic_ship_shield_damage_mult
				remove_modifier = basic_ship_hull_damage_mult
				remove_modifier = basic_ship_tracking_mult
				remove_modifier = basic_ship_weapon_damage
				remove_modifier = basic_ship_hull_regen_add_perc
				remove_modifier = basic_ship_armor_regen_add_perc
				remove_modifier = basic_ship_shield_regen_add_perc
				remove_modifier = basic_ship_hull_mult
				remove_modifier = basic_ship_armor_mult
				remove_modifier = basic_ship_shield_mult
				remove_modifier = basic_ship_weapon_range_mult
				remove_modifier = basical_weapon_type_energy_weapon_damage_mult
				remove_modifier = basical_weapon_type_explosive_weapon_damage_mult
				remove_modifier = basical_weapon_type_kinetic_weapon_damage_mult
				remove_eternal_fleet_mult_variable = {
					hull_regen_add_perc = ship_hull_regen_add_perc 
					shield_regen_add_perc = ship_shield_regen_add_perc 
					armor_regen_add_perc = ship_armor_regen_add_perc 
					hull_mult = ship_hull_mult
					armor_mult = ship_armor_mult
					shield_mult = ship_shield_mult
					weapon_range_mult = ship_weapon_range_mult
					shield_penetration = ship_shield_penetration_mult 
					shield_penetration_own = ship_shield_penetration_mult
					armor_penetration = ship_armor_penetration_mult
					armor_penetration_own = ship_armor_penetration_mult
					armor_damage = ship_armor_damage_mult
					shield_damage = ship_shield_damage_mult
					hull_damage = ship_hull_damage_mult
					weapon_damage = ship_weapon_damage
					weapon_damage_own = ship_weapon_damage
					tracking = ship_tracking_mult
					weapon_type_energy = weapon_type_energy_weapon_damage_mult
					weapon_type_kinetic = weapon_type_kinetic_weapon_damage_mult
					weapon_type_explosive = weapon_type_explosive_weapon_damage_mult 
				}
				remove_ship_flag = fire_for_once
			}
			remove_fleet_flag = has_combat_modifier
		}
		fromfromfrom = { 
			every_owned_ship = {
				remove_modifier = basic_ship_shield_penetration_mult 
				remove_modifier = basic_ship_armor_penetration_mult
				remove_modifier = basic_ship_armor_damage_mult
				remove_modifier = basic_ship_shield_damage_mult
				remove_modifier = basic_ship_hull_damage_mult
				remove_modifier = basic_ship_tracking_mult
				remove_modifier = basic_ship_weapon_damage
				remove_modifier = basic_ship_hull_regen_add_perc
				remove_modifier = basic_ship_armor_regen_add_perc
				remove_modifier = basic_ship_shield_regen_add_perc
				remove_modifier = basic_ship_hull_mult
				remove_modifier = basic_ship_armor_mult
				remove_modifier = basic_ship_shield_mult
				remove_modifier = basic_ship_weapon_range_mult
				remove_modifier = basical_weapon_type_energy_weapon_damage_mult
				remove_modifier = basical_weapon_type_explosive_weapon_damage_mult
				remove_modifier = basical_weapon_type_kinetic_weapon_damage_mult
				remove_eternal_fleet_mult_variable = {
					hull_regen_add_perc = ship_hull_regen_add_perc 
					shield_regen_add_perc = ship_shield_regen_add_perc 
					armor_regen_add_perc = ship_armor_regen_add_perc 
					hull_mult = ship_hull_mult
					armor_mult = ship_armor_mult
					shield_mult = ship_shield_mult
					weapon_range_mult = ship_weapon_range_mult
					shield_penetration = ship_shield_penetration_mult 
					shield_penetration_own = ship_shield_penetration_mult
					armor_penetration = ship_armor_penetration_mult
					armor_penetration_own = ship_armor_penetration_mult
					armor_damage = ship_armor_damage_mult
					shield_damage = ship_shield_damage_mult
					hull_damage = ship_hull_damage_mult
					weapon_damage = ship_weapon_damage
					weapon_damage_own = ship_weapon_damage
					tracking = ship_tracking_mult
					weapon_type_energy = weapon_type_energy_weapon_damage_mult
					weapon_type_kinetic = weapon_type_kinetic_weapon_damage_mult
					weapon_type_explosive = weapon_type_explosive_weapon_damage_mult 
				}
				remove_ship_flag = fire_for_once
			}
			remove_fleet_flag = has_combat_modifier
		} 
	}
}

#entering gateway WITHOUT SPECIAL
fleet_event = {
	id = exe_invasion.1987
	hide_window = yes
	is_triggered_only = yes
	trigger = { owner = { has_country_flag = ag_kuat_invasion_country } }
	immediate = {
		every_owned_ship = {
			set_timed_ship_flag = { flag = inviciable_time_for_gate days = 5 }
			ship_event = { id = exe_invasion.1988 }
		}
	}
}

ship_event = {
	id = exe_invasion.1988
	hide_window = yes
	is_triggered_only = yes
	trigger = { has_ship_flag = inviciable_time_for_gate }
	immediate = {
		while = {
			limit = { has_ship_flag = inviciable_time_for_gate }
			repair_ship = yes
		}
		ship_event = { id = exe_invasion.1988 days = 1 }
	}
}