namespace = exe_invasion
#Gatekeeper, fire when Kuat destroyed. 
event = {
	id = exe_invasion.1
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		NOR = { 
			any_country = { OR = { has_origin = origin_kuat_apocalyptic has_origin = origin_eternalthrone } } 
			has_global_flag = will_be_upgrade_starforge
		}
		has_global_flag = kuat_spawned
		NOR = {
			has_global_flag = exe_invasion_seed
			exists = event_target:fallen_empire_kuat
		}
	}
	immediate = {
		set_timed_global_flag = { flag = exe_invasion_signs_cooldown days = 360 }
		random_system = {
			limit = { has_star_flag = Kuat_system }
			every_playable_country = {
				limit = {
					intel_level = { level >= high system = prev }
				}
				country_event = { id = exe_invasion.2 days = 1 random = 2 }
			}
		} 
		set_global_flag = exe_invasion_seed
	}
}

#Notification: Tachyon signal. 
country_event = {
	id = exe_invasion.2
	title = "exe_invasion.2.name"
	desc = "exe_invasion.2.desc"
	diplomatic = yes
	picture_event_data = { room = satellite_in_orbit_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_sensor_ping
	location = root.capital_scope
	is_triggered_only = yes
	immediate = { set_country_flag = exe_invasion_2_fired }
	option = { name = "exe_invasion.2.a" }
}

#Energy readings. 
event = {
	id = exe_invasion.3
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		NOR = { 
			any_country = { OR = { has_origin = origin_kuat_apocalyptic has_origin = origin_eternalthrone } } 
			has_global_flag = will_be_upgrade_starforge
		}
		has_global_flag = exe_invasion_seed
		NOT = { has_global_flag = exe_invasion_signs_cooldown }
		NOT = { has_global_flag = exe_invasion_3_fired }
	}
	immediate = {
		set_global_flag = exe_invasion_3_fired
		set_timed_global_flag = { flag = exe_invasion_signs_cooldown days = 360 }
		every_playable_country = { country_event = { id = exe_invasion.4 days = 1 random = 2 } }
	}
}

#Notification: Energy readings. 
country_event = {
	id = exe_invasion.4
	title = "exe_invasion.4.name"
	desc = {
		trigger = { has_country_flag = exe_invasion_2_fired }
		text = "exe_invasion.4.a.desc"
	}
	desc = {
		trigger = {
			NOT = { has_country_flag = exe_invasion_2_fired }
		}
		text = "exe_invasion.4.b.desc"
	}
	diplomatic = yes
	picture_event_data = {
		room = Eternal_Empire_room
	}
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_yellow_alert
	location = root.capital_scope
	is_triggered_only = yes
	option = { name = "exe_invasion.4.a" }
}

#Hyperspace echo. 
event = {
	id = exe_invasion.5
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		NOR = { 
			any_country = { OR = { has_origin = origin_kuat_apocalyptic has_origin = origin_eternalthrone } } 
			has_global_flag = will_be_upgrade_starforge
		}
		has_global_flag = exe_invasion_3_fired
		NOT = { has_global_flag = exe_invasion_signs_cooldown }
		NOT = { has_global_flag = exe_invasion_5_fired }
	}
	immediate = {
		set_global_flag = exe_invasion_5_fired
		set_timed_global_flag = { flag = exe_invasion_signs_cooldown days = 360 }
		every_playable_country = {
			country_event = { id = exe_invasion.6 days = 1 random = 2 }
			if = {
				limit = {
					any_system_within_border = {
						NOR = {
							has_star_flag = Kuat_system
							has_star_flag = Kuat_system_1
							has_star_flag = Kuat_system_2
							has_star_flag = Kuat_system_3
						}
						any_system_megastructure = { is_megastructure_type = exe_outer_gate }
					}
				}
				country_event = { id = exe_invasion.41 days = 4 random = 2 }
			}
		}
	}
}

#Notification: Hyperspace echo. 
country_event = {
	id = exe_invasion.6
	title = "exe_invasion.6.name"
	desc = "exe_invasion.6.desc"
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire2_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_sensor_ping
	location = root.capital_scope
	is_triggered_only = yes
	option = { name = "exe_invasion.6.a" }
}

#Approaching rim system. 
event = {
	id = exe_invasion.7
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		NOR = { 
			any_country = { OR = { has_origin = origin_kuat_apocalyptic has_origin = origin_eternalthrone } } 
			has_global_flag = will_be_upgrade_starforge
		}
		has_global_flag = exe_invasion_5_fired
		NOT = { has_global_flag = exe_invasion_signs_cooldown }
		NOT = { has_global_flag = exe_invasion_7_fired }
	}
	immediate = {
		set_global_flag = exe_invasion_7_fired
		set_timed_global_flag = { flag = exe_invasion_signs_cooldown days = 360 }
		every_playable_country = { country_event = { id = exe_invasion.8 days = 1 random = 2 } }
	}
}

#Notification: Approaching rim system. 
country_event = {
	id = exe_invasion.8
	title = "exe_invasion.8.name"
	desc = "exe_invasion.8.desc"
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire5_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_yellow_alert
	location = root.capital_scope
	is_triggered_only = yes
	option = { name = "exe_invasion.8.a" }
}

#Invasion begin. 
event = {
	id = exe_invasion.9
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		NOR = { 
			any_country = { OR = { has_origin = origin_kuat_apocalyptic has_origin = origin_eternalthrone } } 
			has_global_flag = will_be_upgrade_starforge
		}
		has_global_flag = exe_invasion_7_fired
		NOT = { has_global_flag = exe_invasion_signs_cooldown }
		NOT = { has_global_flag = exe_invasion_begin }
	}
	immediate = {
		set_update_modifiers_batch = begin
		set_global_flag = eternal_spawnd
		set_global_flag = exe_invasion_begin
		create_country = {
			name = "Eternal Empire"
			type = ag_kuat_invasion_country
			flag = {
				icon = {
					category = "exe_invasion"
					file = "ge_o.dds"
				}
				background = {
					category = "backgrounds"
					file = "00_solid.dds"
				}
				colors = { "yellow" "black" "null" "null" }
			}
			ignore_initial_colony_error = yes
		}
		last_created_country = { if = {
			limit = { OR = {
				exists = event_target:wg_crisis_country
				exists = event_target:monolith_crisis_country
			} }
			set_faction_hostility = {
				target = event_target:monolith_crisis_country
				set_hostile = no set_friendly = yes
			} set_faction_hostility = {
				target = event_target:wg_crisis_country
				set_hostile = no set_friendly = yes
			} }
			save_global_event_target_as = ag_kuat_invasion_country
			set_country_flag = ag_kuat_invasion_country
			set_global_flag = has_ag_kuat_invasion_country
			set_graphical_culture = fallen_empire_kuat_01
			create_ship_design = { design = "NAME_EXE_Starbase" }
			add_ship_design = last_created_design
			create_ship_design = { design = "NAME_EXE_Starbase_Construction" }
			add_ship_design = last_created_design
			add_modifier = { modifier = Elternal_creating }
		}
		set_global_flag = eternal_fleet_debug_check
		random_system = {
			limit = { has_star_flag = Kuat_system }
			system_star = {
				planet_event = { id = exe_invasion.11 days = 10 }
				planet_event = { id = exe_invasion.11 days = 20 }
				planet_event = { id = exe_invasion.11 days = 30 }
				planet_event = { id = exe_invasion.11 days = 40 }
				planet_event = { id = exe_invasion.11 days = 50 }
				planet_event = { id = exe_invasion.11 days = 60 }
				planet_event = { id = exe_invasion.11 days = 70 }
				planet_event = { id = exe_invasion.11 days = 80 }
				planet_event = { id = exe_invasion.11 days = 90 }
				planet_event = { id = exe_invasion.11 days = 100 }
				planet_event = { id = exe_invasion.11 days = 120 }
				planet_event = { id = exe_invasion.11 days = 140 }
				planet_event = { id = exe_invasion.11 days = 160 }
				planet_event = { id = exe_invasion.11 days = 180 }
				planet_event = { id = exe_invasion.11 days = 220 }
				planet_event = { id = exe_invasion.11 days = 240 }
			}
		}
		every_country = {
			limit = { is_eternal_faction = no }
			establish_communications_no_message = event_target:ag_kuat_invasion_country
			country_event = { id = exe_invasion.10 }
		}
		every_country = {
			limit = { has_special_project = exe_invasion_lock_outer_gate }
			abort_special_project = { type = exe_invasion_lock_outer_gate }
		}
		if = {
			limit = {
				NOT = { any_system = {
					NOR = {
						has_star_flag = Kuat_system
						has_star_flag = Kuat_system_1
						has_star_flag = Kuat_system_2
						has_star_flag = Kuat_system_3
					}
					any_system_megastructure = { is_megastructure_type = exe_outer_gate }
				} }
			}
			random_system = {
				limit = {
					NOR = {
						has_star_flag = guardian
						has_star_flag = lcluster
						has_star_flag = isolated_home_system
						has_star_flag = isolated_home_system_gate
						AND = {
							exists = space_owner
							space_owner = {
								is_country_type = fallen_empire
								is_country_type = awakened_fallen_empire
								is_ai = no
							}
						}
						any_neighbor_system = { OR = {
							AND = {
								exists = space_owner
								space_owner = { OR = {
									is_country_type = fallen_empire
									is_country_type = awakened_fallen_empire
									is_ai = no
								} }
							}
							has_star_flag = guardian
						} }
					}
				}
				save_event_target_as = exe_invasion_outer_gate_spawn_system
			}
			if = {
				limit = { exists = event_target:exe_invasion_outer_gate_spawn_system }
				ag_exe_spawn_outer_gate_fallback = yes
			} 
			else = { random_system = {
				limit = { NOR = {
					has_star_flag = guardian
					has_star_flag = lcluster
					has_star_flag = isolated_home_system
					has_star_flag = isolated_home_system_gate
					AND = {
						exists = space_owner
						space_owner = {
							is_country_type = fallen_empire
							is_country_type = awakened_fallen_empire
							is_ai = no
						}
					}
				} }
				save_event_target_as = exe_invasion_outer_gate_spawn_system
			}
			if = {
				limit = { exists = event_target:exe_invasion_outer_gate_spawn_system }
				ag_exe_spawn_outer_gate_fallback = yes
			} 
			else = { random_system = {
				limit = { NOR = {
					has_star_flag = guardian
					has_star_flag = lcluster
					has_star_flag = isolated_home_system
					has_star_flag = isolated_home_system_gate
					AND = {
						exists = space_owner
						space_owner = { is_ai = no }
					}
				} }
				save_event_target_as = exe_invasion_outer_gate_spawn_system
			}
			if = {
				limit = { exists = event_target:exe_invasion_outer_gate_spawn_system }
				ag_exe_spawn_outer_gate_fallback = yes
			} 
			else = {
				random_system = {
					limit = { 	NOR = {
						has_star_flag = guardian
						has_star_flag = lcluster
						has_star_flag = isolated_home_system
						has_star_flag = isolated_home_system_gate
					} }
					save_event_target_as = exe_invasion_outer_gate_spawn_system
				}
				if = {
					limit = { exists = event_target:exe_invasion_outer_gate_spawn_system }
					ag_exe_spawn_outer_gate_fallback = yes
				} 
				else = { random_system = { ag_exe_spawn_outer_gate_fallback = yes } }
			} } }
		}
		event_target:kuat_system_fleet = { create_elternal_system_warbase = { DAYS = 400 } }
		set_update_modifiers_batch = end
	}
}

#Notification: Invasion begin. 
country_event = {
	id = exe_invasion.10
	title = "exe_invasion.10.name"
	desc = "exe_invasion.10.a.desc"
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire4_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_red_alert
	location = root.capital_scope
	is_triggered_only = yes
	immediate = {
		every_system = {
			limit = { kuat_is_invasion_system = yes }
			every_fleet_in_system = {
				if = {
					limit = { is_ship_class = shipclass_military }
					set_location = owner.capital_scope
				}
				else = { destroy_fleet = { target = this destroy_template = yes kill_leader = yes } }
			}
		}
	}
	option = {
		name = "exe_invasion.10.a"
		hidden_effect = { country_event = { id = exe_invasion.101 days = 1 } }
	}
}

country_event = {
	id = exe_invasion.101
	title = "exe_invasion.10.name"
	desc = "exe_invasion.101.desc"
	diplomatic = yes
	picture_event_data = { room = no_video_feed_room }
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	show_sound = event_red_alert
	location = root.capital_scope
	is_triggered_only = yes
	option = {
		name = exe_invasion.101.a
		ai_chance = { weight = 100 }
		hidden_effect = { begin_event_chain = { event_chain = ag_exe_invasion_chain } }
	}
}

fleet_event = {
	id = exe_invasion.125
	hide_window = yes
	is_triggered_only = yes
	trigger = { exists = event_target:kuat_station_elternal }
	immediate = { 
		set_update_modifiers_batch = begin
		destroy_fleet = { target = this destroy_template = yes kill_leader = yes }
		solar_system = {
			remove_star_flag = eternal_starbase_megastructure_in_system
			set_star_class = sc_black_hole
			star = {
				create_ambient_object = { type = "star_explosion" play_animation_once = yes location = this }
				last_created_ambient_object = { set_location = { target = prev distance = 0 angle = random } }
				create_ambient_object = { type = "destroyed_system" location = this }
				last_created_ambient_object = { set_ambient_object_flag = destroyed_system_effect set_location = { target = prev  distance = 0  angle = random  } }
				change_pc = pc_black_hole
				set_planet_size = 18
			}
			every_fleet_in_system = {
				limit = { owner = { is_eternal_faction = no } }
				destroy_fleet = { target = this destroy_template = yes kill_leader = yes }
			}
			random_ambient_object = {
				limit = { has_ambient_object_flag = space_storm_object }
				destroy_ambient_object = this
			}
		}
		every_playable_country = { country_event = { id = exe_invasion.126 } }
		set_update_modifiers_batch = end
	}
}

country_event = {
	id = exe_invasion.126
	title = "exe_invasion.126.name"
	desc = "exe_invasion.126.desc"
	diplomatic = yes
	picture_event_data = { room = black_hole_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	fire_only_once = yes
	show_sound = event_red_alert
	is_triggered_only = yes
	option = { name = exe_invasion.126.a }
}

country_event = {
	id = exe_invasion.127
	title = "exe_invasion.127.name"
	desc = "exe_invasion.127.desc"
	diplomatic = yes
	picture_event_data = { room = black_hole_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_red_alert
	is_triggered_only = yes
	trigger = {
		fromfromfrom = {
			is_ship_size = exe_megastructure_starbase
			solar_system = { has_star_flag = eternal_starbase_megastructure_in_system }
			fleet = { NOT = { has_fleet_flag = ag_kuat_invasion_starbase_disable } }
		}
	}
	immediate = {
		set_update_modifiers_batch = begin
		fromfromfrom.solar_system = {
			remove_star_flag = eternal_starbase_megastructure_in_system
			star = {
				create_ambient_object = { type = "star_explosion" play_animation_once = yes location = this }
				last_created_ambient_object = { set_location = { target = prev distance = 0 angle = random } }
				create_ambient_object = { type = "destroyed_system" location = this }
				last_created_ambient_object = { set_ambient_object_flag = destroyed_system_effect set_location = { target = prev  distance = 0  angle = random  } }
				change_pc = pc_black_hole
				set_planet_size = 18
			}
			set_star_class = sc_black_hole
			every_ship_in_system = {
				limit = { owner = { NOR = {
					is_same_value = root.from
					is_invisable_faction = no
				} } }
				clear_ship_repeatable_modifier = { multiply = 0.25 DAYS = 360 }
			}
			random_ambient_object = {
				limit = { has_ambient_object_flag = space_storm_object }
				destroy_ambient_object = this
			}
		}
		set_update_modifiers_batch = end
	}
	option = { name = exe_invasion.127.a }
}

#Invasion fleet arrived. 
planet_event = {
	id = exe_invasion.11
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = exe_invasion_begin
		NOT = { has_global_flag = exe_invasion_ended }
	}
	immediate = {
		event_target:ag_kuat_invasion_country = { change_variable = { which = ag_kuat_invasion_fleet_arrived value = 1 } }
		create_exe_invasion_fleet_detail = yes
		every_country = {
			limit = { has_event_chain = ag_exe_invasion_chain }
			add_event_chain_counter = { event_chain = ag_exe_invasion_chain counter = ag_exe_invasion_fleet amount = 1 }
		}
		event_target:ag_kuat_invasion_country = { if = {
			limit = { check_variable = { which = ag_kuat_invasion_fleet_arrived value = 16 } }
			every_owned_fleet = {
				limit = { has_fleet_flag = ag_kuat_invasion_fleet }
				fleet_event = { id = exe_invasion.12 days = 1 random = 2 }
			}
			country_event = { id = exe_invasion.111 days = 30 }
			set_global_flag = can_win_the_fleet
		} }
	}
}

country_event = {
	id = exe_invasion.111
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		exists = event_target:ag_kuat_invasion_country
		is_eternal_faction = yes
	}
	immediate = {
		if = {
			limit = {
				NOT = { any_owned_fleet = { has_fleet_flag = ag_kuat_invasion_fleet } } 
			}
			random_system = {
				limit = { has_star_flag = Kuat_system }
				system_star = { create_exe_invasion_fleet_detail = yes }
			}
			every_country = {
				limit = { has_event_chain = ag_exe_invasion_chain }
				add_event_chain_counter = {	event_chain = ag_exe_invasion_chain counter = ag_exe_invasion_fleet amount = 1 }
			}
		}
		country_event = { id = exe_invasion.111 days = 5 }
	}
}

#Invasion fleet action. 
fleet_event = {
	id = exe_invasion.12
	hide_window = yes
	is_triggered_only = yes
	trigger = { 
		exists = this 
		has_global_flag = exe_invasion_begin
		NOT = { has_global_flag = exe_invasion_ended }
	}
	immediate = { ag_exe_invasion_fleet_action = yes }
}

#Invasion fleet action on win a space battle. 
country_event = {
	id = exe_invasion.13
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = exe_invasion_begin
		NOT = { has_global_flag = exe_invasion_ended }
		is_eternal_faction = yes
		fromfrom = { fleet = { has_fleet_flag = ag_kuat_invasion_fleet } }
		fromfromfrom = {
			OR = {
				is_ship_class = shipclass_starbase
				is_ship_class = shipclass_military
			}
		}
	}
	after = {
		fromfrom = {
			solar_system = {
				every_fleet_in_system = {
					limit = {
						exists = owner
						owner = { is_eternal_faction = yes }
						has_fleet_flag = ag_kuat_invasion_fleet
					}
					clear_orders = yes
					clear_fleet_actions = this
					fleet_event = { id = exe_invasion.12 days = 3 random = 2 }
				}
			}
		}
	}
}

#Invasion fleet action on orbit planet. 
country_event = {
	id = exe_invasion.14
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = exe_invasion_begin
		NOT = { has_global_flag = exe_invasion_ended }
		is_eternal_faction = yes
		from = { has_fleet_flag = ag_kuat_invasion_fleet }
		fromfrom = { OR = { is_star = yes NOT = { exists = owner } } }
	}
	immediate = {
		from = {
			clear_orders = yes
			clear_fleet_actions = this
			fleet_event = { id = exe_invasion.12 days = 3 random = 2 }
		}
	}
}

#Reset invasion fleet action if two fleet in same system. 
fleet_event = {
	id = exe_invasion.15
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = exe_invasion_begin
		NOT = { has_global_flag = exe_invasion_ended }
		has_fleet_flag = ag_kuat_invasion_fleet
		from = {
			NOR = {
				kuat_is_kuat_system = yes
				has_star_flag = ag_exe_invasion_gate_system
			}
			any_fleet_in_system = {
				NOT = { is_same_value = root }
				has_fleet_flag = ag_kuat_invasion_fleet
			}
		}
	}
	immediate = {
		clear_orders = yes
		clear_fleet_actions = this
		from = { random_neighbor_system = {
			system_star = { root = { auto_move_to_planet = {
				target = prev
				clear_auto_move_on_arrival = yes
			} } }
		} }
	}
}

#Check every month to prevent bugs.
event = {
	id = exe_invasion.16
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = exe_invasion_begin
		NOT = { has_global_flag = exe_invasion_ended }
		exists = event_target:ag_kuat_invasion_country
		event_target:ag_kuat_invasion_country = {
			any_owned_fleet = {
				exists = this
				is_fleet_idle = yes
				has_fleet_flag = ag_kuat_invasion_fleet
				NAND = {
					exists = orbit
					orbit = {
						NOT = { is_star = yes }
						exists = owner
						owner = { is_hostile = event_target:ag_kuat_invasion_country }
						exists = controller
						controller = { is_hostile = event_target:ag_kuat_invasion_country }
					}
				}
			}
		}
	}
	immediate = {
		event_target:ag_kuat_invasion_country = {
			every_owned_fleet = {
				limit = {
					exists = this
					is_fleet_idle = yes
					has_fleet_flag = ag_kuat_invasion_fleet
					NAND = {
						exists = orbit
						orbit = {
							NOT = { is_star = yes }
							exists = owner
							owner = { is_hostile = event_target:ag_kuat_invasion_country }
							exists = controller
							controller = { is_hostile = event_target:ag_kuat_invasion_country }
						}
					}
				}
				clear_orders = yes
				clear_fleet_actions = this
				fleet_event = { id = exe_invasion.12 days = 3 random = 2 }
			}
		}
	}
}

#Invasion fleet bombard a planet. 
planet_event = {
	id = exe_invasion.21
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		exists = owner
		has_global_flag = exe_invasion_begin
		NOT = { has_global_flag = exe_invasion_ended }
		planet_devastation = 100
		from = { is_eternal_faction = yes }
	}
	immediate = {
		reset_planet = yes
		destroy_colony = yes
		owner = { country_event = { id = exe_invasion.34 } }
		if = {
			limit = { kuat_is_ringworld = yes }
			spawn_ringworld_cracker_effect = yes
			change_pc = pc_ringworld_habitable_damaged
			set_planet_entity = { entity = ringworld_habitable_damaged_entity }
		}
		else_if = {
			limit = { kuat_is_habitat = yes }
			spawn_habitat_cracker_effect = yes
			remove_planet = yes
		}
		else_if = {
			limit = { has_modifier = "holy_planet" }
			change_pc = pc_shattered
			remove_modifier = "holy_planet"
			add_modifier = { modifier = "ag_shattered_holy_planet" }
		}
		else = { change_pc = pc_broken }
		every_country = {
			limit = {
				NOT = { is_same_value = event_target:ag_kuat_invasion_country }
				has_event_chain = ag_exe_invasion_chain
			}
			add_event_chain_counter = {
				event_chain = "ag_exe_invasion_chain"
				counter = "ag_exe_invasion_planet_destroyed"
				amount = 1
			}
		}
		solar_system = {
			every_fleet_in_system = {
				limit = {
					exists = owner
					owner = { is_eternal_faction = yes }
					has_fleet_flag = ag_kuat_invasion_fleet
					OR = {
						AND = {
							exists = orbit
							orbit = { is_same_value = root }
						}
						AND = {
							is_fleet_idle = yes
							NAND = {
								exists = orbit
								orbit = {
									NOT = { is_star = yes }
									exists = owner
									owner = { is_hostile = event_target:ag_kuat_invasion_country }
								}
							}
						}
					}
				}
				clear_orders = yes
				clear_fleet_actions = this
				fleet_event = { id = exe_invasion.12 days = 5 random = 15 }
			}
		}	
	}
}

country_event = {
	id = exe_invasion.34
	title = "exe_invasion.21.name"
	desc = {
		trigger = { from = { kuat_is_event_borderment_ringworld = no } }
		text = "exe_invasion.21.a.desc"
	}
	desc = {
		trigger = { from = { kuat_is_ringworld = yes } }
		text = "exe_invasion.21.b.desc"
	}
	desc = {
		trigger = { from = { is_planet_class = pc_habitat } }
		text = "exe_invasion.21.c.desc"
	}
	desc = {
		trigger = { from = { kuat_is_holy_world_planet = yes } }
		text = "exe_invasion.21.d.desc"
	}
	diplomatic = yes
	picture_event_data = { room = nuclear_explosion_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_super_explosion
	is_triggered_only = yes
	option = { name = "exe_invasion.21.a" ai_chance = { weight = 100 } }
}

#Invasion fleet killed counter. 
country_event = {
	id = exe_invasion.22
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		NOT = { has_global_flag = exe_return_invasion_begin }
		is_eternal_faction = yes
	}
	immediate = {
		from = {
			add_event_chain_counter = {
				event_chain = ag_exe_invasion_chain
				counter = ag_exe_invasion_ship_kill_by_us
				amount = 1
			}
		}
		every_country = {
			limit = {
				has_event_chain = ag_exe_invasion_chain
				NOT = { is_same_value = from }
			}
			add_event_chain_counter = {
				event_chain = ag_exe_invasion_chain
				counter = ag_exe_invasion_ship_kill_by_other
				amount = 1
			}
		}
	}
}

#Invasion fleet victim counter.
country_event = {
	id = exe_invasion.23
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		NOT = { has_global_flag = exe_return_invasion_begin }
		is_eternal_faction = yes
		from = { is_eternal_faction = no }
	}
	immediate = {
		every_country = {
			limit = {
				NOT = { is_same_value = event_target:ag_kuat_invasion_country }
				has_event_chain = ag_exe_invasion_chain
			}
			add_event_chain_counter = {
				event_chain = ag_exe_invasion_chain
				counter = ag_exe_invasion_victim
				amount = 1
			}
		}
	}
}

#An invasion fleet has been destroyed. 
country_event = {
	id = exe_invasion.31
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		NOT = { has_global_flag = exe_return_invasion_begin }
		from = { is_eternal_faction = yes }
		fromfromfrom = { has_fleet_flag = ag_kuat_invasion_fleet }
	}
	immediate = {
		fromfromfrom = { if = {
			limit = { NOT = { has_fleet_flag = fire_only_once_temple } }
			set_timed_fleet_flag = { flag = fire_only_once_temple days = 1 }
			every_country = {
				limit = { has_event_chain = ag_exe_invasion_chain }
				add_event_chain_counter = { event_chain = ag_exe_invasion_chain counter = ag_exe_invasion_fleet amount = -1 }
			}
			event_target:global_event_country = { change_variable = { which = var_eternal_fleet_defeated value = 1 } }
		} }
	}
}

#All invasion fleet destroyed, invasion end. 
country_event = {
	id = exe_invasion.32
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		NOT = { has_global_flag = exe_return_invasion_begin }
		from = {
			is_eternal_faction = yes
			count_owned_fleet = {
				limit = {
					has_fleet_flag = ag_kuat_invasion_fleet
					NOT = { is_same_value = root.fromfromfrom }
				}
				count = 0
			}
		}
		fromfromfrom = { has_fleet_flag = ag_kuat_invasion_fleet }
		has_global_flag = can_win_the_fleet
		event_target:global_event_country = { check_variable = { which = var_eternal_fleet_defeated value >= 16 } }
	}
	immediate = {
		every_country = {
			limit = { NOR = { 
				is_same_value = event_target:ag_kuat_invasion_country 
				has_country_flag = trigger_ended_event_temple
			} }
			set_timed_country_flag = { flag = trigger_ended_event_temple days = 1 }
			if = {
				limit = { NOT = { has_global_flag = special_exe_invasion } }
				country_event = { id = exe_invasion.33 }
			} 
			else = { country_event = { id = exe_invasion.35 } }
		}
		add_threat = { who = root amount = 50 }
		set_global_flag = exe_invasion_ended
		remove_global_flag = eternal_fleet_debug_check
		remove_global_flag = ai_fighting_with_player_against_eternal
		from = { destroy_country = yes }
	}
}

#Notification: Invasion end. 
country_event = {
	id = exe_invasion.33
	title = "exe_invasion.33.name"
	desc = "exe_invasion.33.desc"
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire_room }
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	fire_only_once = yes
	show_sound = event_space_battle
	is_triggered_only = yes
	immediate = { 
		remove_global_flag = eternal_fleet_debug_check 
		remove_global_flag = ai_fighting_with_player_against_eternal
	}
	option = {
		name = "exe_invasion.33.a"
		hidden_effect = {
			if = {
				limit = { NOT = { has_origin = origin_eternalthrone } }
				set_global_flag = fire_the_kuat_return
			}
			end_event_chain = ag_exe_invasion_chain
		}
	}
}

country_event = {
	id = exe_invasion.35
	title = "exe_invasion.33.name"
	desc = "exe_invasion.35.desc"
	diplomatic = yes
	picture_event_data = {
		room = Eternal_Empire_room
	}
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	fire_only_once = yes
	show_sound = event_space_battle
	is_triggered_only = yes
	option = {
		name = "exe_invasion.33.b"
		hidden_effect = {
			end_event_chain = ag_exe_invasion_chain
			enable_special_project = {
				name = exe_invasion_lock_the_eclipse
				location = this.capital_scope
			}
		}
	}
}

event = {
	id = exe_invasion.37
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = eternal_fleet_debug_check
		NOT = { exists = event_target:ag_kuat_invasion_country }
		has_global_flag = exe_invasion_begin
		NOT = { has_global_flag = exe_invasion_ended }
	}
	immediate = {
		remove_global_flag = exe_invasion_begin
		remove_global_flag = can_win_the_fleet
		remove_global_flag = eternal_fleet_debug_check
		remove_global_flag = ai_fighting_with_player_against_eternal
		remove_global_flag = exe_invasion_signs_cooldown
		set_global_flag = exe_invasion_7_fired
	}
}

#Special project to lock an outer gate. (if no outer gate, invasion will create a new outer gate. )
country_event = {
	id = exe_invasion.41
	title = "exe_invasion.41.name"
	desc = "exe_invasion.41.desc"
	diplomatic = yes
	picture_event_data = { room = drifting_gateway_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_mystic_reveal
	is_triggered_only = yes
	immediate = {
		random_system_within_border = {
			limit = {
				NOR = {
					kuat_is_kuat_system = yes
					has_star_flag = kuat_military_base_system_home
				}
				any_system_megastructure = { is_megastructure_type = exe_outer_gate }
			}
			random_system_megastructure = {
				limit = { is_megastructure_type = exe_outer_gate }
				save_event_target_as = exe_outer_gate_to_lock
			}
		}
	}
	option = {
		name = "exe_invasion.41.a"
		enable_special_project = {
			name = exe_invasion_lock_outer_gate
			location = event_target:exe_outer_gate_to_lock
			owner = root
		}
	}
	option = {
		name = "exe_invasion.41.b"
		add_resource = { influence = 50 }
	}
}

#Locked an outer gate. 
ship_event = {
	id = exe_invasion.42
	title = "exe_invasion.42.name"
	desc = "exe_invasion.42.desc"
	diplomatic = yes
	picture_event_data = { room = drifting_gateway_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_mystic_reveal
	is_triggered_only = yes
	immediate = {
		solar_system = {
			random_system_megastructure = {
				limit = { is_megastructure_type = exe_outer_gate }
				upgrade_megastructure_to = exe_outer_gate_locked
				finish_upgrade = yes
			}
		}
	}
	option = { name = "exe_invasion.42.a" }
}

#Invasion happen or not? 
country_event = {
	id = exe_invasion.1000
	title = "exe_invasion.1000.name"
	desc = "exe_invasion.1000.desc"
	picture_event_data = { room = ancient_AI_room }
	show_sound = event_mystic_reveal
	diplomatic = yes
	custom_gui = "kuat_mod_settings_window"
	custom_gui_option = "kuat_mod_settings_option"
	is_triggered_only = yes
	trigger = { NOT = { has_origin = origin_kuat_apocalyptic } }
	option = {
		name = "exe_invasion.1000.a"
		default_hide_option = yes
	}
}

country_event = {
	id = exe_invasion.1002
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		create_ship_design = { design = Name_boss_crisis_EFS_3 }
		add_ship_design = last_created_design
	}
}

ship_event = {
	id = exe_invasion.1003
	hide_window = no
	title = "exe_invasion.1003.name"
	desc = "exe_invasion.1003.desc"
	diplomatic = yes
	picture_event_data = { room = fallen_empire_room }
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	is_triggered_only = yes
	immediate = { 
		owner = { set_country_flag = chossen_the_eternal_path } 
		owner = { reset_return_eternal_fleet = yes }
	}
	option = { 
		name = exe_invasion.1003.a 
		hidden_effect = { owner.capital_scope = { planet_event = { id = kuat_situation.9999 } } }
	}
}

#eclipse or eternal flagship lazer fixed
country_event = {
	id = exe_invasion.110
	hide_window = yes
	is_triggered_only = yes
	trigger = { fromfrom = { 
		any_owned_ship = { OR = { is_ship_size = eclipse is_ship_size = eternal_flagship } } 
	} }
	immediate = {
		FROMFROM = { if = {
			limit = { NOT = { has_fleet_flag = fire_only_once_temple_eclipse } }
			every_owned_ship = {
				limit = { 
					NOT = { has_ship_flag = random_list_superlazer_rate_placeholder }
					OR = { is_ship_size = eclipse is_ship_size = eternal_flagship } 
				}
				set_ship_flag = is_modifiering_superlazer
				ship_event = { id = exe_invasion.112 }
				set_timed_ship_flag = { flag = random_list_superlazer_rate_placeholder days = 1 }
			}
			set_timed_fleet_flag = { flag = fire_only_once_temple_eclipse days = 1 }
		} }
	}
}

ship_event = {
	id = exe_invasion.112
	hide_window = yes
	is_triggered_only = yes
	trigger = { has_ship_flag = is_modifiering_superlazer }
	immediate = {
		if = {
			limit = { is_in_combat = yes }
			set_standard_battle_superlazer_weapon_keeping_modifier = {
				PARAMATER1 = ship_fire_rate_mult
				PARAMATER2 = weapon_type_kuat_superlazer_scale_weapon_fire_rate_mult
			}
			set_ship_flag = fire_ship_var
			ship_event = { id = exe_invasion.112 days = 1 }
		}
		else = { clear_superlazer_system_fixed_ship = yes }
	}
}
#flagship protection difficult
country_event = {
	id = exe_invasion.116
	hide_window = yes
	is_triggered_only = yes
	trigger = { from = { OR = { is_eternal_faction = yes is_infinite_faction = yes } } }
	immediate = {
		set_update_modifiers_batch = begin
		fromfrom = { if = {
			limit = {	
				NOT = { has_fleet_flag = fire_only_once_temple }
				has_enable_flag_ship_system_true = yes
				has_enable_flag_ship_system_false = yes
			}
			every_owned_ship = {
				if = {
					limit = { kuat_is_flagship_system_protection = yes }
					set_ship_flag = is_invisiable_trigger
					eternal_increase_executor_power = { DAYS = -1 }
					ship_event = { id = exe_invasion.114 }
				}
				else_if = {
					limit = { kuat_is_flagship_system_protection = no }
					set_timed_ship_flag = { flag = is_invisiable_trigger days = 3 }
					eternal_increase_executor_power = { DAYS = 3 }
					ship_event = { id = exe_invasion.114 }
				}
			}
			set_timed_fleet_flag = { flag = fire_only_once_temple days = 1 }
		} }
		set_update_modifiers_batch = end
	}
}
ship_event = {
	id = exe_invasion.114
	hide_window = yes
	is_triggered_only = yes
	trigger = { has_ship_flag = is_invisiable_trigger }
	immediate = {
		if = {
			limit = { fleet = { has_enable_flag_ship_system_false = yes } is_in_combat = yes }
			repair_ship = yes ship_event = { id = exe_invasion.114 days = 1 }
		}
		else = { remove_executor_power = yes remove_ship_flag = is_invisiable_trigger }
	}
}
country_event = {
	id = exe_invasion.117
	hide_window = yes
	is_triggered_only = yes
	trigger = { 
		is_eternal_faction = yes
		fromfrom = { has_fleet_flag = ag_kuat_invasion_starbase }
	}
	immediate = {
		fromfrom = { if = {
			limit = { NOT = { has_fleet_flag = random_list_eternal_fleet_rate_placeholder } }
			if = {
				limit = { NOT = { has_fleet_flag = ag_kuat_invasion_starbase_disable } }
				set_fleet_flag = ag_kuat_invasion_starbase_disable
			}
			increase_ship_hp_effect_change = { DAYS = 6 }
			set_timed_fleet_flag = { flag = random_list_eternal_fleet_rate_placeholder days = 1 }
		} }
	}
} 

#FLEET INVISIABLE WITHOUT SPECIAL
ship_event = {
	id = exe_invasion.119
	hide_window = yes
	is_triggered_only = yes
	trigger = { has_ship_flag = is_invisiable_trigger }
	immediate = {
		if = {
			limit = { is_in_combat = yes }
			repair_ship = yes ship_event = { id = exe_invasion.119 days = 1 }
		}
		else = { remove_executor_power = yes remove_ship_flag = is_invisiable_trigger }
	}
}
country_event = {
	id = exe_invasion.120
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		OR = {
			AND = { is_player_country = yes is_invisable_faction = no }
			is_kuat_fallen_empire = yes 
		}
		from = { NOR = { is_eternal_faction = yes is_infinite_faction = yes } }
	}
	immediate = {
		set_update_modifiers_batch = begin
		FROMFROM = { if = {
			limit = { has_enable_flag_ship_system_true = yes }
			if = { limit = { kuat_is_flagship_size = { size = kuat_sector } } increase_ship_hp_effect_change = { DAYS = 7 } }
			else_if = { limit = { kuat_is_flagship_size = { size = Annihilator } } increase_ship_hp_effect_change = { DAYS = 7 } }
			else_if = { limit = { kuat_is_flagship_size = { size = eclipse } } increase_ship_hp_effect_change = { DAYS = 6 } }
			else_if = { limit = { kuat_is_flagship_size = { size = Vengeance } } increase_ship_hp_effect_change = { DAYS = 5 } }
			else_if = { limit = { kuat_is_flagship_size = { size = nebula_executor } } increase_ship_hp_effect_change = { DAYS = 5 } }
			else_if = { limit = { kuat_is_flagship_size = { size = knigjt_hammer_executor } } increase_ship_hp_effect_change = { DAYS = 5 } }
			else_if = { limit = { kuat_is_flagship_size = { size = nebula_dominance } } increase_ship_hp_effect_change = { DAYS = 5 } }
			else_if = { limit = { kuat_is_flagship_size = { size = X308_Balletor } } increase_ship_hp_effect_change = { DAYS = 4 } }
			else_if = { limit = { kuat_is_flagship_size = { size = X308_Titan } } increase_ship_hp_effect_change = { DAYS = 4 } }
			else_if = { limit = { kuat_is_flagship_size = { size = eternal_flagship } } increase_ship_hp_effect_change = { DAYS = 4 } } 
			else_if = { limit = { kuat_has_ship_flag = { flag = has_ag_flagship } } increase_ship_hp_effect_change = { DAYS = 3 } } 
		} }
		set_update_modifiers_batch = end
	}
}

country_event = {
	id = exe_invasion.123
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_infinite_faction = yes
		from = { is_invisable_faction = no is_ai = no }
	}
	immediate = { 
		fromfrom = { random_list = {
			1 = {
				modifier = {
					factor = 0
					root.fromfromfrom = { OR = {
						NOT = { is_ship_class = shipclass_military }
						kuat_is_kuat_ship = yes
					} }
				}
				root.fromfromfrom = { if = {
					limit = { kuat_is_kuat_ship = no is_ship_class = shipclass_military }
					save_event_target_as = infinite_faction_battle_duplicate_ship 
				} }
				if = {
					limit = { exists = event_target:infinite_faction_battle_duplicate_ship }
					fleet = { create_ship = { design = event_target:infinite_faction_battle_duplicate_ship } }
				}
			}
			1 = {
				modifier = {
					factor = 0
					root = { fromfromfrom.fleet = { OR = {
						has_fleet_flag = eternal_learned_leader 
						NOT = { exists = leader }
						AND = { exists = leader leader = { OR = { has_leader_flag = eternal_learned_leader NOT = { leader_class = admiral } } } }
					} } }
				}
				root = { fromfromfrom.fleet = {
					set_fleet_flag = eternal_learned_leader
					leader = { set_timed_leader_flag = { flag = eternal_learned_leader days = 180 } }
					prev = {
						clone_leader = { class = admiral target = prev.leader effect = { save_event_target_as = eternal_learned_leader_copy } }
						fromfrom.fleet = {
							if = {
								limit = { NOT = { has_fleet_flag = have_learned_leader } }
								if = { limit = { exists = leader } leader = { kill_leader = { show_notification = no } } }
								assign_leader = event_target:eternal_learned_leader_copy
								set_timed_fleet_flag = { flag = have_learned_leader days = 180 }
							}
							else = { owner = { random_owned_fleet = {
								limit = { NOT = { has_fleet_flag = have_learned_leader } }
								if = { limit = { exists = leader } leader = { kill_leader = { show_notification = no } } }
								assign_leader = event_target:eternal_learned_leader_copy
								set_timed_fleet_flag = { flag = have_learned_leader days = 180 }
							} } }
						}
					}
				} }
			}
		} }
	}
}

#debug for special component weapon destroyed
ship_event = {
	id = exe_invasion.124
	hide_window = yes
	is_triggered_only = yes
	trigger = { OR = {
		AND = { exists = this OR = {
			has_ship_flag = ag_kae_ge_primary_portal
			has_ship_flag = ag_kae_ge_secondary_portal
			has_ship_flag = enable_disable_starbase
		} }
		AND = { exists = owner owner = { OR = { is_eternal_faction = yes is_infinite_faction = yes } } is_ship_class = shipclass_military }
		AND = { exists = fleet fleet = { has_fleet_flag = has_kuat_disable_checkpoint } }
	} }
	immediate = { 
		if = {
			limit = { is_ship_class = shipclass_military exists = owner owner = { OR = { is_eternal_faction = yes is_infinite_faction = yes } } }
			repair_ship = yes set_disabled = no change_variable = { which = disable_time value = 1 }
		}
		if = {
			limit = { exists = fleet fleet = { has_fleet_flag = has_kuat_disable_checkpoint } }
			change_variable = { which = disable_time_checkpoint value = 1 }
			if = { limit = { check_variable = { which = disable_time_checkpoint value > 4 } } destroy_ship = this }
		}
		if = {
			limit = { exists = this has_ship_flag = enable_disable_starbase }
			if = { limit = { has_ship_flag = is_invisiable_trigger } repair_ship = yes set_disabled = no } 
			else = { repair_ship = yes set_disabled = no set_disable_at_health = -1 fleet = { remove_fleet_flag = ag_kuat_invasion_starbase_disable } }
		}
		if = {
			limit = { exists = this OR = { has_ship_flag = ag_kae_ge_primary_portal has_ship_flag = ag_kae_ge_secondary_portal } }
			if = {
				limit = { solar_system = { any_fleet_in_system = { OR = {
					has_fleet_flag = ag_kae_ge_secondary_portal_guradian
					has_fleet_flag = ag_kae_ge_primary_portal_guradian
				} } } }
				repair_ship = yes set_disabled = no
			} 
			else = { repair_ship = yes set_disabled = no set_disable_at_health = -1 }
		}
	}
}
fleet_event = {
	id = exe_invasion.145
	hide_window = yes
	is_triggered_only = yes
	trigger = { owner = { OR = { is_eternal_faction = yes is_infinite_faction = yes } } }
	immediate = {
		if = {
			limit = { is_in_combat = yes }
			if = {
				limit = { OR = {
					AND = {
						has_global_flag = enable_modifer_check
						OR = { has_global_flag = difficult_exe_invasion has_global_flag = ban_exe_invasion }
						owner = { is_eternal_guardian = no } 
						count_owned_ship = {
							count >= kuat_fleet_count_check_half
							limit = { check_variable = { which = disable_time value > 1 } check_variable = { which = combat_days value < 4 } }
						}
					}
					AND = { exists = solar_system solar_system = { kuat_is_repair_system = yes } }
				} }
				every_owned_ship = { set_variable = { which = combat_days value = 0 } set_variable = { which = disable_time value = 0 } }
			}
			else = { every_owned_ship = { limit = { check_variable = { which = combat_days value > 3 } } set_disable_at_health = -1 } }
			every_owned_ship = { change_variable = { which = combat_days value = 1 } }
			fleet_event = { id = exe_invasion.145 days = 1 }
		}
		else = { every_owned_ship = { clear_variable = combat_days clear_variable = disable_time set_disable_at_health = 0.01 } }
	}
}

#debug check modifier in eternal fleet FROMFROM
country_event = {
	id = exe_invasion.130
	hide_window = yes
	is_triggered_only = yes
	trigger = { is_invisable_faction = yes }
	immediate = {
		set_update_modifiers_batch = begin
		if = {
			limit = { from = { is_invisable_faction = no } }
			if = { 
				limit = { has_global_flag = kuat_impulse_mod_settings } 
				fromfrom = { set_fleet_flag = has_kuat_flagship_system_addon_repeatable } 
			}
			fromfromfrom = { every_owned_ship = { 
				if = { limit = { check_modifier_value = { modifier = ship_hull_mult value > 0.1 } } 
				clear_ship_modifier = { modifier = ship_hull_mult subtract = 0.1 DAYS = -1 } } 
				if = { limit = { check_modifier_value = { modifier = shipclass_military_hull_mult value > 0.1 } } 
				clear_ship_modifier = { modifier = shipclass_military_hull_mult subtract = 0.1 DAYS = -1 } } 
			} }
			if = {
				limit = { OR = { has_global_flag = ban_exe_invasion has_global_flag = difficult_exe_invasion } }
				kuat_copy_leader_learning_system = yes
			}
		}
		fromfrom = { 
			if = {
				limit = { 
					is_ship_class = shipclass_military
					owner = { OR = { is_eternal_faction = yes is_infinite_faction = yes } } NOT = {
					has_fleet_flag = random_list_eternal_fleet_rate_placeholder
				} }
				mult_half_variable = { WHICH = kuat_fleet_count_check VALUE = 0.97 }
				every_owned_ship = { 
					limit = { NOT = { is_variable_set = combat_days } is_ship_class = shipclass_military } 
					change_variable = { which = combat_days value = 1 } 
				}
				fleet_event = { id = exe_invasion.145 days = 1 }
				set_timed_fleet_flag = { flag = random_list_eternal_fleet_rate_placeholder days = 1 }
			}
			every_owned_ship = {  
				limit = { NOT = { has_ship_flag = random_list_eternal_fleet_rate_placeholder }  }
				set_ship_flag = is_modifiering 
				switch = {
					trigger = has_global_flag
					ban_exe_invasion = { ship_event = { id = exe_invasion.140 } }
					difficult_exe_invasion = { ship_event = { id = exe_invasion.137 } }
					normal_exe_invasion = { ship_event = { id = exe_invasion.143 } }
					easy_exe_invasion = { ship_event = { id = exe_invasion.144 } }
					default = { ship_event = { id = exe_invasion.144 } }
				}
				set_timed_ship_flag = { flag = random_list_eternal_fleet_rate_placeholder days = 1 }
			}
			set_fleet_flag = has_kuat_flagship_system
		}
		if = {
			limit = { 
				from = { is_invisable_faction = no } 
				has_global_flag = enable_modifer_check 
			}
			fromfromfrom = { 
				if = {
					limit = { 
						NOT = { has_fleet_flag = has_kuat_flagship_system }
						any_owned_ship = { kuat_is_flagship_system_protection = yes }
					}
					set_fleet_flag = has_kuat_flagship_system
				} 
				if = {
					limit = { NOT = { has_fleet_flag = has_kuat_disable_checkpoint } }
					every_owned_ship = { clear_variable = disable_time_checkpoint }
					set_fleet_flag = has_kuat_disable_checkpoint
				}
			}
			if = {
				limit = { ROOT = { is_eternal_faction = yes } }
				fromfromfrom = { every_owned_ship = { 
					limit = { NOT = { has_ship_flag = random_list_eternal_fleet_rate_placeholder }  }
					set_ship_flag = is_modifiering  
					switch = {
						trigger = has_global_flag
						ban_exe_invasion = { ship_event = { id = exe_invasion.136 } }
						difficult_exe_invasion = { ship_event = { id = exe_invasion.131 } }
						normal_exe_invasion = { ship_event = { id = exe_invasion.129 } }
						easy_exe_invasion= { ship_event = { id = exe_invasion.142 } }
						default = { ship_event = { id = exe_invasion.142 } }
					}
					set_timed_ship_flag = { flag = random_list_eternal_fleet_rate_placeholder days = 1 }
				} }
			}
			else_if = {  
				limit = { ROOT = { is_infinite_faction = yes } }
				fromfromfrom = { every_owned_ship = { 
					limit = { NOT = { has_ship_flag = random_list_eternal_fleet_rate_placeholder }  }
					set_ship_flag = is_modifiering ship_event = { id = exe_invasion.136 } 
					set_timed_ship_flag = { flag = random_list_eternal_fleet_rate_placeholder days = 1 }
				} }
			}
			else = { fromfromfrom = { every_owned_ship = { 
				limit = { NOT = { has_ship_flag = random_list_eternal_fleet_rate_placeholder }  }
				set_ship_flag = is_modifiering ship_event = { id = exe_invasion.142 } 
				set_timed_ship_flag = { flag = random_list_eternal_fleet_rate_placeholder days = 1 }
			} } }
		}
		set_update_modifiers_batch = end
	}
}

country_event = {
	id = exe_invasion.146
	hide_window = yes
	is_triggered_only = yes
	trigger = { fromfrom = { kuat_is_flagship_system_protection = yes } }
	immediate = { fromfrom = { fleet = { remove_fleet_flag = has_kuat_flagship_system } } }
}

#ban_exe_invasion: fromfrom
ship_event = {
	id = exe_invasion.140
	hide_window = yes
	is_triggered_only = yes
	trigger = { has_ship_flag = is_modifiering }
	immediate = {
		setup_invinciable_protection_pragram = {
			KEY = set_ban_eternal_fleet_mult_modifier
			ID = exe_invasion.140
		}
	}
}
#difficult_exe_invasion: fromfrom
ship_event = {
	id = exe_invasion.137
	hide_window = yes
	is_triggered_only = yes
	trigger = { has_ship_flag = is_modifiering }
	immediate = {
		setup_invinciable_protection_pragram = {
			KEY = set_difiicult_eternal_fleet_mult_modifier
			ID = exe_invasion.137
		}
	}
}
#normal_exe_invasion: fromfrom
ship_event = {
	id = exe_invasion.143
	hide_window = yes
	is_triggered_only = yes
	trigger = { has_ship_flag = is_modifiering }
	immediate = {
		setup_invinciable_protection_pragram = {
			KEY = set_normal_eternal_fleet_mult_modifier
			ID = exe_invasion.143
		}
	}
}
#easy_exe_invasion: fromfrom
ship_event = {
	id = exe_invasion.144
	hide_window = yes
	is_triggered_only = yes
	trigger = { has_ship_flag = is_modifiering }
	immediate = {
		setup_invinciable_protection_pragram = {
			KEY = set_easy_eternal_fleet_mult_modifier
			ID = exe_invasion.144
		}
	}
}

#ban_exe_invasion：fromfromfrom
ship_event = {
	id = exe_invasion.136
	hide_window = yes
	is_triggered_only = yes
	trigger = { has_ship_flag = is_modifiering }
	immediate = { 
		setup_invinciable_attacketion_pragram = {
			KEY = set_ban_eternal_fleet_mult_modifier
			RLEFR = yes  ID = exe_invasion.136
		}
	}
}
#difficult_exe_invasion：fromfromfrom
ship_event = {
	id = exe_invasion.131
	hide_window = yes
	is_triggered_only = yes
	trigger = { has_ship_flag = is_modifiering }
	immediate = { 
		setup_invinciable_attacketion_pragram = {
			KEY = set_difiicult_eternal_fleet_mult_modifier
			RLEFR = yes  ID = exe_invasion.131
		}
	}
}
#normal_exe_invasion: fromfromfrom
ship_event = {
	id = exe_invasion.129
	hide_window = yes
	is_triggered_only = yes
	trigger = { has_ship_flag = is_modifiering }
	immediate = { 
		setup_invinciable_attacketion_pragram = {
			KEY = set_normal_eternal_fleet_mult_modifier
			RLEFR = yes  ID = exe_invasion.129
		}
	}
}
#easy_exe_invasion and default: fromfromfrom
ship_event = {
	id = exe_invasion.142
	hide_window = yes
	is_triggered_only = yes
	trigger = { has_ship_flag = is_modifiering }
	immediate = { 
		setup_invinciable_attacketion_pragram = {
			KEY = set_easy_eternal_fleet_mult_modifier
			RLEFR = yes  ID = exe_invasion.142
		}
	}
}

#protector class star crusier system
country_event = {
	id = exe_invasion.133
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_invisable_faction = no
		from = { is_invisable_faction = no }
		fromfrom = { count_owned_ship = { limit = { has_component = EXE_STARBASE_MEAGASTRUCTRUE_AUX_2 } count = 96 } }
	}
	immediate = {
		fromfromfrom = { every_owned_ship = { 
			limit = { NOT = { has_ship_flag = random_list_eternal_fleet_rate_placeholder }  }
			set_ship_flag = is_modifiering ship_event = { id = exe_invasion.132 } 
			set_timed_ship_flag = { flag = random_list_eternal_fleet_rate_placeholder days = 1 }
		} }
		fromfrom = { every_owned_ship = { 
			limit = { NOT = { has_ship_flag = random_list_eternal_fleet_rate_placeholder }  }
			set_ship_flag = is_modifiering ship_event = { id = exe_invasion.134 } 
			set_timed_ship_flag = { flag = random_list_eternal_fleet_rate_placeholder days = 1 }
		} }
	}
}
ship_event = {
	id = exe_invasion.132
	hide_window = yes
	is_triggered_only = yes
	trigger = { has_ship_flag = is_modifiering }
	immediate = {
		setup_invinciable_attacketion_pragram = {
			KEY = set_easy_eternal_fleet_mult_modifier
			ID = exe_invasion.132
		}
	}
}
ship_event = {
	id = exe_invasion.134
	hide_window = yes
	is_triggered_only = yes
	trigger = { has_ship_flag = is_modifiering }
	immediate = {
		setup_invinciable_protection_pragram = {
			KEY = set_easy_eternal_fleet_mult_modifier
			ID = exe_invasion.134
		}
	}
}

#ORIGIN ETERNAL
country_event = {
	id = exe_invasion.135
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_invisable_faction = yes
		is_infinite_faction = no
		from = { is_invisable_faction = no }
	}
	immediate = {
		set_update_modifiers_batch = begin
		fromfromfrom = { every_owned_ship = {
			limit = { 
				NOT = { has_ship_flag = enable_random_list_effect }
				kuat_is_flagship_system_protection = no
				is_disabled = no is_in_combat = yes has_hp > 0
			}
			set_timed_ship_flag = { flag = enable_random_list_effect days = 1 }
			random_list = {
				100 = {
					modifier = {
						factor = 0.9
						event_target:global_event_country = { check_variable = { which = eternal_fleet_return_index value = 1 } }
					}
					modifier = {
						factor = 0.8
						event_target:global_event_country = { check_variable = { which = eternal_fleet_return_index value = 2 } }
					}
					modifier = {
						factor = 0.7
						event_target:global_event_country = { check_variable = { which = eternal_fleet_return_index value = 3 } }
					}
					modifier = {
						factor = 0.6
						event_target:global_event_country = { check_variable = { which = eternal_fleet_return_index value = 4 } }
					}
					modifier = {
						factor = 0.5
						event_target:global_event_country = { check_variable = { which = eternal_fleet_return_index value = 5 } }
					}
					modifier = {
						factor = 0.4
						event_target:global_event_country = { check_variable = { which = eternal_fleet_return_index value = 6 } }
					}
					modifier = {
						factor = 0.3
						event_target:global_event_country = { check_variable = { which = eternal_fleet_return_index value = 7 } }
					}
					modifier = {
						factor = 0.2
						event_target:global_event_country = { check_variable = { which = eternal_fleet_return_index value = 8 } }
					}
					modifier = {
						factor = 0.1
						event_target:global_event_country = { check_variable = { which = eternal_fleet_return_index value = 9 } }
					}
					modifier = {
						factor = 0.05
						event_target:global_event_country = { check_variable = { which = eternal_fleet_return_index value > 9 } }
					}
					modifier = { factor = 100 has_ship_flag = kuat_clear_ship_modifier_target }
				}
				# 200 Totally, 100 Available
				10 = {
					modifier = {
						factor = 0
						OR = {
							has_ship_flag = kuat_clear_ship_modifier_target
							owner = { is_invisable_faction = yes }
						}
					}
					clear_ship_repeatable_modifier = { multiply = 0.1 DAYS = 12 }
					set_timed_ship_flag = { flag = kuat_clear_ship_modifier_target days = 12 }
				}
				10 = {
					modifier = {
						factor = 0
						OR = {
							has_ship_flag = kuat_clear_ship_modifier_target
							owner = { is_invisable_faction = yes }
						}
					}
					clear_ship_repeatable_modifier = { multiply = 0.2 DAYS = 12 }
					set_timed_ship_flag = { flag = kuat_clear_ship_modifier_target days = 12 }
				}
				10 = {
					modifier = {
						factor = 0
						OR = {
							has_ship_flag = kuat_clear_ship_modifier_target
							owner = { is_invisable_faction = yes }
						}
					}
					clear_ship_repeatable_modifier = { multiply = 0.3 DAYS = 8 }
					set_timed_ship_flag = { flag = kuat_clear_ship_modifier_target days = 8 }
				}
				10 = {
					modifier = {
						factor = 0
						OR = {
							has_ship_flag = kuat_clear_ship_modifier_target
							owner = { is_invisable_faction = yes }
						}
					}
					clear_ship_repeatable_modifier = { multiply = 0.4 DAYS = 8 }
					set_timed_ship_flag = { flag = kuat_clear_ship_modifier_target days = 8 }
				}
				10 = {
					modifier = {
						factor = 0
						OR = {
							has_ship_flag = kuat_clear_ship_modifier_target
							owner = { is_invisable_faction = yes }
						}
					}
					clear_ship_repeatable_modifier = { multiply = 0.5 DAYS = 4 }
					set_timed_ship_flag = { flag = kuat_clear_ship_modifier_target days = 4 }
				}
				10 = {
					modifier = {
						factor = 0
						OR = {
							has_ship_flag = kuat_clear_ship_modifier_target
							owner = { is_invisable_faction = yes }
						}
					}
					clear_ship_repeatable_modifier = { multiply = 0.6 DAYS = 4 }
					set_timed_ship_flag = { flag = kuat_clear_ship_modifier_target days = 4 }
				}
				10 = {
					modifier = {
						factor = 0
						OR = {
							has_ship_flag = kuat_clear_ship_modifier_target
							owner = { is_invisable_faction = yes }
						}
					}
					clear_ship_repeatable_modifier = { multiply = 0.7 DAYS = 3 }
					set_timed_ship_flag = { flag = kuat_clear_ship_modifier_target days = 3 }
				}
				10 = {
					modifier = {
						factor = 0
						OR = {
							has_ship_flag = kuat_clear_ship_modifier_target
							owner = { is_invisable_faction = yes }
						}
					}
					clear_ship_repeatable_modifier = { multiply = 0.8 DAYS = 3 }
					set_timed_ship_flag = { flag = kuat_clear_ship_modifier_target days = 3 }
				}
				10 = {
					modifier = {
						factor = 0
						OR = {
							has_ship_flag = kuat_clear_ship_modifier_target
							owner = { is_invisable_faction = yes }
						}
					}
					clear_ship_repeatable_modifier = { multiply = 0.9 DAYS = 1 }
					set_timed_ship_flag = { flag = kuat_clear_ship_modifier_target days = 1 }
				}
				10 = {
					modifier = {
						factor = 0
						OR = {
							has_ship_flag = kuat_clear_ship_modifier_target
							owner = { is_invisable_faction = yes }
						}
					}
					clear_ship_repeatable_modifier = { multiply = 1.0 DAYS = 1 }
					set_timed_ship_flag = { flag = kuat_clear_ship_modifier_target days = 1 }
				}
			}
			reroll_random = yes
		} }
		set_update_modifiers_batch = end
	}
}
country_event = {
	id = exe_invasion.139
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_invisable_faction = yes
		is_infinite_faction = no
		from = { is_invisable_faction = no }
	}
	immediate = { 
		set_update_modifiers_batch = begin
		fromfromfrom.fleet = { every_owned_ship = {
			limit = { 
				kuat_is_flagship_system_protection = no
				is_disabled = no is_in_combat = yes has_hp > 0
			}
			random_list = {
				100 = {
					modifier = {
						factor = 0.9
						event_target:global_event_country = { check_variable = { which = eternal_fleet_return_index value = 1 } }
					}
					modifier = {
						factor = 0.8
						event_target:global_event_country = { check_variable = { which = eternal_fleet_return_index value = 2 } }
					}
					modifier = {
						factor = 0.7
						event_target:global_event_country = { check_variable = { which = eternal_fleet_return_index value = 3 } }
					}
					modifier = {
						factor = 0.6
						event_target:global_event_country = { check_variable = { which = eternal_fleet_return_index value = 4 } }
					}
					modifier = {
						factor = 0.5
						event_target:global_event_country = { check_variable = { which = eternal_fleet_return_index value = 5 } }
					}
					modifier = {
						factor = 0.4
						event_target:global_event_country = { check_variable = { which = eternal_fleet_return_index value = 6 } }
					}
					modifier = {
						factor = 0.3
						event_target:global_event_country = { check_variable = { which = eternal_fleet_return_index value = 7 } }
					}
					modifier = {
						factor = 0.2
						event_target:global_event_country = { check_variable = { which = eternal_fleet_return_index value = 8 } }
					}
					modifier = {
						factor = 0.1
						event_target:global_event_country = { check_variable = { which = eternal_fleet_return_index value = 9 } }
					}
					modifier = {
						factor = 0.05
						event_target:global_event_country = { check_variable = { which = eternal_fleet_return_index value > 9 } }
					}
					modifier = { factor = 100 has_ship_flag = kuat_clear_ship_modifier_target }
				}
				# 200 Totally, 100 Available
				10 = {
					modifier = {
						factor = 0
						OR = {
							has_ship_flag = kuat_clear_ship_modifier_target
							owner = { is_invisable_faction = yes }
						}
					}
					clear_ship_repeatable_modifier = { multiply = 0.1 DAYS = 12 }
					set_timed_ship_flag = { flag = kuat_clear_ship_modifier_target days = 12 }
				}
				10 = {
					modifier = {
						factor = 0
						OR = {
							has_ship_flag = kuat_clear_ship_modifier_target
							owner = { is_invisable_faction = yes }
						}
					}
					clear_ship_repeatable_modifier = { multiply = 0.2 DAYS = 12 }
					set_timed_ship_flag = { flag = kuat_clear_ship_modifier_target days = 12 }
				}
				10 = {
					modifier = {
						factor = 0
						OR = {
							has_ship_flag = kuat_clear_ship_modifier_target
							owner = { is_invisable_faction = yes }
						}
					}
					clear_ship_repeatable_modifier = { multiply = 0.3 DAYS = 8 }
					set_timed_ship_flag = { flag = kuat_clear_ship_modifier_target days = 8 }
				}
				10 = {
					modifier = {
						factor = 0
						OR = {
							has_ship_flag = kuat_clear_ship_modifier_target
							owner = { is_invisable_faction = yes }
						}
					}
					clear_ship_repeatable_modifier = { multiply = 0.4 DAYS = 8 }
					set_timed_ship_flag = { flag = kuat_clear_ship_modifier_target days = 8 }
				}
				10 = {
					modifier = {
						factor = 0
						OR = {
							has_ship_flag = kuat_clear_ship_modifier_target
							owner = { is_invisable_faction = yes }
						}
					}
					clear_ship_repeatable_modifier = { multiply = 0.5 DAYS = 4 }
					set_timed_ship_flag = { flag = kuat_clear_ship_modifier_target days = 4 }
				}
				10 = {
					modifier = {
						factor = 0
						OR = {
							has_ship_flag = kuat_clear_ship_modifier_target
							owner = { is_invisable_faction = yes }
						}
					}
					clear_ship_repeatable_modifier = { multiply = 0.6 DAYS = 4 }
					set_timed_ship_flag = { flag = kuat_clear_ship_modifier_target days = 4 }
				}
				10 = {
					modifier = {
						factor = 0
						OR = {
							has_ship_flag = kuat_clear_ship_modifier_target
							owner = { is_invisable_faction = yes }
						}
					}
					clear_ship_repeatable_modifier = { multiply = 0.7 DAYS = 3 }
					set_timed_ship_flag = { flag = kuat_clear_ship_modifier_target days = 3 }
				}
				10 = {
					modifier = {
						factor = 0
						OR = {
							has_ship_flag = kuat_clear_ship_modifier_target
							owner = { is_invisable_faction = yes }
						}
					}
					clear_ship_repeatable_modifier = { multiply = 0.8 DAYS = 3 }
					set_timed_ship_flag = { flag = kuat_clear_ship_modifier_target days = 3 }
				}
				10 = {
					modifier = {
						factor = 0
						OR = {
							has_ship_flag = kuat_clear_ship_modifier_target
							owner = { is_invisable_faction = yes }
						}
					}
					clear_ship_repeatable_modifier = { multiply = 0.9 DAYS = 1 }
					set_timed_ship_flag = { flag = kuat_clear_ship_modifier_target days = 1 }
				}
				10 = {
					modifier = {
						factor = 0
						OR = {
							has_ship_flag = kuat_clear_ship_modifier_target
							owner = { is_invisable_faction = yes }
						}
					}
					clear_ship_repeatable_modifier = { multiply = 1.0 DAYS = 1 }
					set_timed_ship_flag = { flag = kuat_clear_ship_modifier_target days = 1 }
				}
			}
			reroll_random = yes
		} }
		set_update_modifiers_batch = end
	}
}

# entering gateway WITHOUT SPECIAL
fleet_event = {
	id = exe_invasion.1987
	hide_window = yes
	is_triggered_only = yes
	trigger = { owner = { is_eternal_faction = yes } }
	immediate = { increase_ship_hp_effect_change = { DAYS = 7 } }
}

# message about leader clone
country_event = {
	id = exe_invasion.141
	title = "exe_invasion.141.name"
	desc = "exe_invasion.141.desc"
	diplomatic = yes
	picture_event_data = { room = ancient_AI_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_red_alert
	is_triggered_only = yes
	trigger = { NOT = { has_country_flag = fired_massege_leader } }
	option = { name = exe_invasion.141.a }
	option = { name = exe_invasion.141.b hidden_effect = { set_country_flag = fired_massege_leader } }
}

# Saving debug
event = {
	id = exe_invasion.9999
	hide_window = yes
	is_triggered_only = yes
	trigger = { always = yes  }
	immediate = { 
		set_update_modifiers_batch = begin
		every_galaxy_planet = {
			limit = { has_building = building_kuat_command_center_auto }
			if = {
				limit = { NOT = { num_pops = 5 } }
				set_variable = { which = planet_temple_return_pop value = trigger:num_pops }
				subtract_variable = { which = planet_temple_return_pop value = 5 }
				multiply_variable = { which = planet_temple_return_pop value = -1 }
				if = {
					limit = { check_variable = { which = planet_temple_return_pop value > 0 } }
					while = { 
						count = planet_temple_return_pop create_pop = { species = owner_main_species } 
						subtract_variable = { which = planet_production_array value = 1 }
					}
				}
				else_if = {
					limit = { check_variable = { which = planet_temple_return_pop value < 0 } }
					multiply_variable = { which = planet_temple_return_pop value = -1 }
					while = { 
						count = planet_temple_return_pop random_owned_pop = { kill_pop = yes } 
						change_variable = { which = planet_production_array value = 0.2 }
					}
				}
			}
			change_variable = { which = planet_production_array_pop_speed_total_dynamic value = planet_production_array_pop_speed_total }
			if = {
				limit = { check_variable = { which = planet_production_array_pop_speed_total_dynamic value > 1000 } }
				set_variable = { which = planet_production_array_pop_speed_total_dynamic value = 1000 }
			}
			set_variable = { which = planet_production_array value = trigger:years_passed }
			change_variable = { which = planet_production_array value = planet_production_array_pop_speed_total_dynamic }
			multiply_variable = { which = planet_production_array value = 0.1 }
			change_variable = { which = planet_production_array value = trigger:planet_size }
			change_variable = { which = planet_production_array value = planet_production_array_base }
			multiply_variable = { which = planet_production_array value = trigger:planet_size }
			multiply_variable = { which = planet_production_array value = 0.1 }
			if = { limit = { years_passed >= 100 } multiply_variable = { which = planet_production_array value = 1 } }
			else_if = { limit = { years_passed >= 90 } multiply_variable = { which = planet_production_array value = 0.9 } }
			else_if = { limit = { years_passed >= 80 } multiply_variable = { which = planet_production_array value = 0.8 } }
			else_if = { limit = { years_passed >= 70 } multiply_variable = { which = planet_production_array value = 0.7 } }
			else_if = { limit = { years_passed >= 60 } multiply_variable = { which = planet_production_array value = 0.6 } }
			else_if = { limit = { years_passed >= 50 } multiply_variable = { which = planet_production_array value = 0.5 } }
			else_if = { limit = { years_passed >= 40 } multiply_variable = { which = planet_production_array value = 0.3 } }
			else_if = { limit = { years_passed >= 30 } multiply_variable = { which = planet_production_array value = 0.2 } }
			else = { multiply_variable = { which = planet_production_array value = 0.1 } }
			floor_variable = planet_production_array
		}
		set_update_modifiers_batch = end
	}
}