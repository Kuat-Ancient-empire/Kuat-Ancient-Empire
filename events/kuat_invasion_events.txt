namespace = exe_invasion
#Gatekeeper, fire when Kuat destroyed. 
event = {
	id = exe_invasion.1
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		kuat_is_enable_eternal_invasion = yes
		NOR = {
			has_global_flag = exe_invasion_seed
			exists = event_target:fallen_empire_kuat
		}
	}
	immediate = {
		set_timed_global_flag = { flag = exe_invasion_signs_cooldown days = 360 }
		random_system = {
			limit = { has_star_flag = Kuat_system }
			every_playable_country = {
				limit = { intel_level = { level >= high system = prev } }
				country_event = { id = exe_invasion.2 days = 1 random = 2 }
			}
		} 
		set_global_flag = exe_invasion_seed
	}
}

#Notification: Tachyon signal. 
country_event = {
	id = exe_invasion.2
	title = "exe_invasion.2.name"
	desc = "exe_invasion.2.desc"
	diplomatic = yes
	picture_event_data = { room = satellite_in_orbit_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_sensor_ping
	location = root.capital_scope
	is_triggered_only = yes
	immediate = { set_country_flag = exe_invasion_2_fired }
	option = { name = "exe_invasion.2.a" }
}

#Energy readings. 
event = {
	id = exe_invasion.3
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		kuat_is_enable_eternal_invasion = yes

		has_global_flag = exe_invasion_seed
		NOT = { has_global_flag = exe_invasion_signs_cooldown }
		NOT = { has_global_flag = exe_invasion_3_fired }
	}
	immediate = {
		set_global_flag = exe_invasion_3_fired
		set_timed_global_flag = { flag = exe_invasion_signs_cooldown days = 360 }
		every_playable_country = { country_event = { id = exe_invasion.4 days = 1 random = 2 } }
	}
}

#Notification: Energy readings. 
country_event = {
	id = exe_invasion.4
	title = "exe_invasion.4.name"
	desc = {
		trigger = { has_country_flag = exe_invasion_2_fired }
		text = "exe_invasion.4.a.desc"
	}
	desc = {
		trigger = {
			NOT = { has_country_flag = exe_invasion_2_fired }
		}
		text = "exe_invasion.4.b.desc"
	}
	diplomatic = yes
	picture_event_data = {
		room = Eternal_Empire_room
	}
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_yellow_alert
	location = root.capital_scope
	is_triggered_only = yes
	option = { name = "exe_invasion.4.a" }
}

#Hyperspace echo. 
event = {
	id = exe_invasion.5
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		kuat_is_enable_eternal_invasion = yes

		has_global_flag = exe_invasion_3_fired
		NOT = { has_global_flag = exe_invasion_signs_cooldown }
		NOT = { has_global_flag = exe_invasion_5_fired }
	}
	immediate = {
		set_global_flag = exe_invasion_5_fired
		set_timed_global_flag = { flag = exe_invasion_signs_cooldown days = 360 }
		every_playable_country = {
			country_event = { id = exe_invasion.6 days = 1 random = 2 }
			if = {
				limit = {
					any_system_within_border = {
						NOR = {
							has_star_flag = Kuat_system
							has_star_flag = Kuat_system_1
							has_star_flag = Kuat_system_2
							has_star_flag = Kuat_system_3
						}
						any_system_megastructure = { is_megastructure_type = exe_outer_gate }
					}
				}
				country_event = { id = exe_invasion.41 days = 4 random = 2 }
			}
		}
	}
}

#Notification: Hyperspace echo. 
country_event = {
	id = exe_invasion.6
	title = "exe_invasion.6.name"
	desc = "exe_invasion.6.desc"
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire2_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_sensor_ping
	location = root.capital_scope
	is_triggered_only = yes
	option = { name = "exe_invasion.6.a" }
}

#Approaching rim system. 
event = {
	id = exe_invasion.7
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		kuat_is_enable_eternal_invasion = yes

		has_global_flag = exe_invasion_5_fired
		NOT = { has_global_flag = exe_invasion_signs_cooldown }
		NOT = { has_global_flag = exe_invasion_7_fired }
	}
	immediate = {
		set_global_flag = exe_invasion_7_fired
		set_timed_global_flag = { flag = exe_invasion_signs_cooldown days = 360 }
		every_playable_country = { country_event = { id = exe_invasion.8 days = 1 random = 2 } }
	}
}

#Notification: Approaching rim system. 
country_event = {
	id = exe_invasion.8
	title = "exe_invasion.8.name"
	desc = "exe_invasion.8.desc"
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire5_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_yellow_alert
	location = root.capital_scope
	is_triggered_only = yes
	option = { name = "exe_invasion.8.a" }
	after = { if = {
		limit = { any_country = { 
			is_fallen_empire = yes 
			has_communications = root
		}  }
		random_country = {
			limit = {
				is_fallen_empire = yes 
				has_communications = root
			}
			root = { country_event = { 
				id = kuat_fallen_mission_reaction.5 
				days = 1 random = 2 
				scopes = { from = prev } 
			} }
		}
	} }
}

#Invasion begin. 
event = {
	id = exe_invasion.9
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		kuat_is_enable_eternal_invasion = yes
		
		has_global_flag = exe_invasion_7_fired
		NOT = { has_global_flag = exe_invasion_signs_cooldown }
		NOT = { has_global_flag = exe_invasion_begin }
	}
	immediate = {
		set_crisis_sound = kuat_eternal_invasion_kotor_endar_spire
		set_update_modifiers_batch = begin
		set_global_flag = eternal_spawnd
		set_global_flag = exe_invasion_begin
		create_country = {
			name = "Name_Eternal_fleet"
			name_list = Eternal_Fleet_1
			type = eternal_fleet_country
			flag = {
				icon = {
					category = "exe_invasion"
					file = "ge_o.dds"
				}
				background = {
					category = "backgrounds"
					file = "00_solid.dds"
				}
				colors = { "yellow" "black" "null" "null" }
			}
			ignore_initial_colony_error = yes
		}
		last_created_country = { 
			if = {
				limit = { exists = event_target:return_kuat_awakening_country }
				set_faction_hostility = {
					target = event_target:return_kuat_awakening_country
					set_hostile = no set_friendly = yes
				} 
			}
			set_country_flag = protected_from_queen_storm
			save_global_event_target_as = eternal_fleet_country
			set_country_flag = eternal_fleet_country
			set_global_flag = has_eternal_fleet_country
			set_graphical_culture = fallen_empire_kuat_01
			create_ship_design = { design = "NAME_EXE_Starbase" }
			add_ship_design = last_created_design
			create_ship_design = { design = "NAME_EXE_Starbase_Construction" }
			add_ship_design = last_created_design
			add_modifier = { modifier = Elternal_creating }
			activate_fog_machine = eternal_invasion_dust
			fog_machine_auto_tracking = yes
		}
		set_global_flag = eternal_fleet_debug_check
		random_system = {
			limit = { has_star_flag = Kuat_system }
			system_star = {
				if = {
					limit = { has_global_flag = exe_second_invasion_begin }
					planet_event = { id = exe_invasion.11 days = 3 }
					planet_event = { id = exe_invasion.11 days = 6 }
					planet_event = { id = exe_invasion.11 days = 9 }
	
					planet_event = { id = exe_invasion.11 days = 12 }
					planet_event = { id = exe_invasion.11 days = 15 }
					planet_event = { id = exe_invasion.11 days = 18 }
	
					planet_event = { id = exe_invasion.11 days = 53 }
					planet_event = { id = exe_invasion.11 days = 56 }
					planet_event = { id = exe_invasion.11 days = 59 }
	
					planet_event = { id = exe_invasion.11 days = 62 }
					planet_event = { id = exe_invasion.11 days = 65 }
					planet_event = { id = exe_invasion.11 days = 68 }
	
					planet_event = { id = exe_invasion.11 days = 83 }
					planet_event = { id = exe_invasion.11 days = 85 }
					planet_event = { id = exe_invasion.11 days = 89 }
					
					planet_event = { id = exe_invasion.11 days = 95 }
				}
				else = {
					planet_event = { id = exe_invasion.11 days = 30 }
					planet_event = { id = exe_invasion.11 days = 40 }
					planet_event = { id = exe_invasion.11 days = 50 }

					planet_event = { id = exe_invasion.11 days = 70 }
					planet_event = { id = exe_invasion.11 days = 80 }
					planet_event = { id = exe_invasion.11 days = 90 }

					planet_event = { id = exe_invasion.11 days = 110 }
					planet_event = { id = exe_invasion.11 days = 120 }
					planet_event = { id = exe_invasion.11 days = 130 }

					planet_event = { id = exe_invasion.11 days = 150 }
					planet_event = { id = exe_invasion.11 days = 160 }
					planet_event = { id = exe_invasion.11 days = 170 }

					planet_event = { id = exe_invasion.11 days = 190 }
					planet_event = { id = exe_invasion.11 days = 200 }
					planet_event = { id = exe_invasion.11 days = 210 }
					
					planet_event = { id = exe_invasion.11 days = 240 }
				}
			}
		}
		every_country = {
			limit = { is_eternal_faction = no }
			establish_communications_no_message = event_target:eternal_fleet_country
			country_event = { id = exe_invasion.10 }
		}
		every_country = {
			limit = { has_special_project = exe_invasion_lock_outer_gate }
			abort_special_project = { type = exe_invasion_lock_outer_gate }
		}
		if = {
			limit = {
				NOT = { any_system = {
					NOR = {
						has_star_flag = Kuat_system
						has_star_flag = Kuat_system_1
						has_star_flag = Kuat_system_2
						has_star_flag = Kuat_system_3
					}
					any_system_megastructure = { is_megastructure_type = exe_outer_gate }
				} }
			}
			random_system = {
				limit = {
					NOR = {
						has_star_flag = guardian
						has_star_flag = lcluster
						AND = {
							exists = space_owner
							space_owner = {
								is_country_type = fallen_empire
								is_country_type = awakened_fallen_empire
								is_ai = no
							}
						}
						any_neighbor_system = { OR = {
							AND = {
								exists = space_owner
								space_owner = { OR = {
									is_country_type = fallen_empire
									is_country_type = awakened_fallen_empire
									is_ai = no
								} }
							}
							has_star_flag = guardian
						} }
					}
				}
				save_event_target_as = exe_invasion_outer_gate_spawn_system
			}
			if = {
				limit = { exists = event_target:exe_invasion_outer_gate_spawn_system }
				kuat_exe_spawn_outer_gate_fallback = yes
			} 
			else = { random_system = {
				limit = { NOR = {
					has_star_flag = guardian
					has_star_flag = lcluster
					AND = {
						exists = space_owner
						space_owner = {
							is_country_type = fallen_empire
							is_country_type = awakened_fallen_empire
							is_ai = no
						}
					}
				} }
				save_event_target_as = exe_invasion_outer_gate_spawn_system
			}
			if = {
				limit = { exists = event_target:exe_invasion_outer_gate_spawn_system }
				kuat_exe_spawn_outer_gate_fallback = yes
			} 
			else = { random_system = {
				limit = { NOR = {
					has_star_flag = guardian
					has_star_flag = lcluster
					AND = {
						exists = space_owner
						space_owner = { is_ai = no }
					}
				} }
				save_event_target_as = exe_invasion_outer_gate_spawn_system
			}
			if = {
				limit = { exists = event_target:exe_invasion_outer_gate_spawn_system }
				kuat_exe_spawn_outer_gate_fallback = yes
			} 
			else = {
				random_system = {
					limit = { 	NOR = {
						has_star_flag = guardian
						has_star_flag = lcluster
					} }
					save_event_target_as = exe_invasion_outer_gate_spawn_system
				}
				if = {
					limit = { exists = event_target:exe_invasion_outer_gate_spawn_system }
					kuat_exe_spawn_outer_gate_fallback = yes
				} 
				else = { random_system = { kuat_exe_spawn_outer_gate_fallback = yes } }
			} } }
		}
		set_update_modifiers_batch = end
	}
}

#Notification: Invasion begin. 
country_event = {
	id = exe_invasion.10
	title = "exe_invasion.10.name"
	desc = "exe_invasion.10.a.desc"
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire4_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_red_alert
	location = root.capital_scope
	is_triggered_only = yes
	immediate = {
		every_system = {
			limit = { kuat_is_invasion_system = yes }
			every_fleet_in_system = {
				if = {
					limit = { is_ship_class = shipclass_military }
					set_location = owner.capital_scope
				}
				else = { destroy_fleet = { target = this destroy_template = yes kill_leader = yes } }
			}
		}
	}
	option = {
		name = "exe_invasion.10.a"
		hidden_effect = { 
			if = {
				limit = { NOT = { has_global_flag = exe_second_invasion_begin } }
				country_event = { id = exe_invasion.101 days = 1 }
			}
			else_if = {
				limit = { has_global_flag = exe_second_invasion_begin }
				country_event = { id = exe_invasion.102 days = 1 }
			}
		}
	}
}

country_event = {
	id = exe_invasion.101
	title = "exe_invasion.101.name"
	desc = { trigger = {
		success_text = {
			NOR = {
				has_country_flag = fired_exe_invasion.101.b
				has_country_flag = fired_exe_invasion.101.c
			}
			text = "exe_invasion.101.desc"
		}
		success_text = {
			has_country_flag = fired_exe_invasion.101.b
			text = "exe_invasion.101.b.desc"
		}
		success_text = {
			has_country_flag = fired_exe_invasion.101.c
			text = "exe_invasion.101.c.desc"
		}
	} }
	diplomatic = yes
	picture_event_data = { 
		room = Eternal_Empire_room
		portrait = event_target:UTS02_LEADER
	}
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	show_sound = event_red_alert
	location = root.capital_scope
	is_triggered_only = yes
	immediate = {  
		if = {
			limit = { NOT = { has_event_chain = ag_exe_invasion_chain } }
			begin_event_chain = { event_chain = ag_exe_invasion_chain }
		}
	}
	option = {
		name = exe_invasion.101.b
		hidden_effect = { 
			set_country_flag = fired_exe_invasion.101.b
			remove_country_flag = fired_exe_invasion.101.c
			country_event = { id = exe_invasion.101 } 
		}
	}
	option = {
		name = exe_invasion.101.c
		hidden_effect = { 
			set_country_flag = fired_exe_invasion.101.c
			remove_country_flag = fired_exe_invasion.101.b
			country_event = { id = exe_invasion.101 } 
		}
	}
	option = { name = exe_invasion.101.a ai_chance = { weight = 100 } }
}

country_event = {
	id = exe_invasion.102
	title = "exe_invasion.102.name"
	desc = { trigger = {
		success_text = {
			NOR = {
				has_country_flag = fired_exe_invasion.102.b
				has_country_flag = fired_exe_invasion.102.c
			}
			text = "exe_invasion.102.desc"
		}
		success_text = {
			has_country_flag = fired_exe_invasion.102.b
			text = "exe_invasion.102.b.desc"
		}
		success_text = {
			has_country_flag = fired_exe_invasion.102.c
			text = "exe_invasion.102.c.desc"
		}
	} }
	diplomatic = yes
	picture_event_data = { 
		room = Eternal_Empire_room
		portrait = event_target:UTS02_LEADER
	}
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	show_sound = event_red_alert
	location = root.capital_scope
	is_triggered_only = yes
	immediate = {  
		if = {
			limit = { NOT = { has_event_chain = ag_exe_invasion_chain } }
			begin_event_chain = { event_chain = ag_exe_invasion_chain }
		}
	}
	option = {
		name = exe_invasion.102.b
		hidden_effect = { 
			set_country_flag = fired_exe_invasion.102.b
			remove_country_flag = fired_exe_invasion.102.c
			country_event = { id = exe_invasion.102 } 
		}
	}
	option = {
		name = exe_invasion.102.c
		hidden_effect = { 
			set_country_flag = fired_exe_invasion.102.c
			remove_country_flag = fired_exe_invasion.102.b
			country_event = { id = exe_invasion.102 } 
		}
	}
	option = { name = exe_invasion.102.a ai_chance = { weight = 100 } }
}

country_event = {
	id = exe_invasion.127
	title = "exe_invasion.127.name"
	desc = "exe_invasion.127.desc"
	diplomatic = yes
	picture_event_data = { room = black_hole_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_red_alert
	is_triggered_only = yes
	trigger = {
		NOT = { has_global_flag = exe_return_invasion_begin }
		fromfromfrom = {
			is_ship_size = exe_megastructure_starbase
			solar_system = { has_star_flag = eternal_starbase_megastructure_in_system }
		}
	}
	immediate = {
		fromfromfrom.solar_system = {
			remove_star_flag = eternal_starbase_megastructure_in_system
			set_star_class = sc_black_hole
			star = {
				create_ambient_object = { type = "star_explosion" play_animation_once = yes location = this }
				last_created_ambient_object = { set_location = { target = prev distance = 0 angle = random } }
				create_ambient_object = { type = "destroyed_system" location = this }
				last_created_ambient_object = { set_ambient_object_flag = destroyed_system_effect set_location = { target = prev  distance = 0  angle = random  } }
				change_pc = pc_black_hole
				set_planet_size = 18
			}
			set_variable_to_random_value = {
				which = exe_megastructure_starbase_explode
				min = 15 max = 99 rounded = yes
			}
			every_ship_in_system = {
				limit = { owner = { is_eternal_faction = no } }
				kuat_battle_kuat_damage_hp_percent = { value = prev.exe_megastructure_starbase_explode }
			}
			reroll_random = yes
			random_ambient_object = {
				limit = { has_ambient_object_flag = space_storm_object }
				destroy_ambient_object = this
			}
			clear_variable = exe_megastructure_starbase_explode
		}
	}
	option = { name = exe_invasion.127.a }
}

#Invasion fleet arrived. 
planet_event = {
	id = exe_invasion.11
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = exe_invasion_begin
		NOT = { has_global_flag = exe_invasion_ended }
	}
	immediate = {
		event_target:eternal_fleet_country = { change_variable = { which = ag_kuat_invasion_fleet_arrived value = 1 } }
		create_exe_invasion_fleet_detail = yes
		every_country = {
			limit = { has_event_chain = ag_exe_invasion_chain }
			add_event_chain_counter = { event_chain = ag_exe_invasion_chain counter = ag_exe_invasion_fleet amount = 1 }
		}
		event_target:eternal_fleet_country = { if = {
			limit = { check_variable = { which = ag_kuat_invasion_fleet_arrived value = 16 } }
			every_owned_fleet = {
				limit = { has_fleet_flag = ag_kuat_invasion_fleet is_fleet_idle = yes }
				fleet_event = { id = exe_invasion.12 days = 1 random = 2 }
			}
			country_event = { id = exe_invasion.111 days = 30 }
			set_global_flag = kuat_eternal_invasion_can_win_the_fleet
		} }
	}
}

country_event = {
	id = exe_invasion.111
	hide_window = yes
	is_triggered_only = yes
	trigger = { exists = event_target:eternal_fleet_country }
	immediate = {
		if = {
			limit = {
				NOT = { any_owned_fleet = { has_fleet_flag = ag_kuat_invasion_fleet } } 
			}
			random_system = {
				limit = { has_star_flag = Kuat_system }
				system_star = { create_exe_invasion_fleet_detail = yes }
			}
			every_country = {
				limit = { has_event_chain = ag_exe_invasion_chain }
				add_event_chain_counter = {	event_chain = ag_exe_invasion_chain counter = ag_exe_invasion_fleet amount = 1 }
			}
		}
		country_event = { id = exe_invasion.111 days = 5 }
	}
}

#Invasion fleet action. 
fleet_event = {
	id = exe_invasion.12
	hide_window = yes
	is_triggered_only = yes
	trigger = { 
		exists = this 
		has_global_flag = exe_invasion_begin
		NOT = { has_global_flag = exe_invasion_ended }
	}
	immediate = { kuat_exe_invasion_fleet_action = { TYPE = ag_kuat OWNER = eternal_fleet_country } }
}

#Invasion fleet action on win a space battle. 
country_event = {
	id = exe_invasion.13
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = exe_invasion_begin
		NOT = { has_global_flag = exe_invasion_ended }
		is_eternal_faction = yes
		fromfrom = { fleet = { has_fleet_flag = ag_kuat_invasion_fleet } }
		fromfromfrom = {
			OR = {
				is_ship_class = shipclass_starbase
				is_ship_class = shipclass_military
			}
		}
	}
	immediate = {
		fromfrom = {
			clear_orders = yes
			clear_fleet_actions = this
			kuat_exe_invasion_fleet_action = { TYPE = ag_kuat OWNER = eternal_fleet_country }
		}
	}
}

#Invasion fleet action on orbit planet. 
country_event = {
	id = exe_invasion.14
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = exe_invasion_begin
		NOT = { has_global_flag = exe_invasion_ended }
		is_eternal_faction = yes
		from = { has_fleet_flag = ag_kuat_invasion_fleet }
		fromfrom = { OR = { is_star = yes NOT = { exists = owner } } }
	}
	immediate = {
		from = {
			clear_orders = yes
			clear_fleet_actions = this
			kuat_exe_invasion_fleet_action = { TYPE = ag_kuat OWNER = eternal_fleet_country }
		}
	}
}

#Reset invasion fleet action if two fleet in same system. 
fleet_event = {
	id = exe_invasion.15
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = exe_invasion_begin
		NOT = { has_global_flag = exe_invasion_ended }
		has_fleet_flag = ag_kuat_invasion_fleet
		from = {
			NOR = {
				kuat_is_kuat_system = yes
				has_star_flag = kuat_military_base_local_home
				has_star_flag = kuat_military_sublocal_home
			}
			any_fleet_in_system = {
				NOT = { is_same_value = root }
				has_fleet_flag = ag_kuat_invasion_fleet
			}
		}
	}
	immediate = {
		clear_orders = yes
		clear_fleet_actions = this
		from = { random_neighbor_system = {
			system_star = { root = { auto_move_to_planet = {
				target = prev
				clear_auto_move_on_arrival = yes
			} } }
		} }
	}
}

#Check every month to prevent bugs.
event = {
	id = exe_invasion.16
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = exe_invasion_begin
		NOT = { has_global_flag = exe_invasion_ended }
		exists = event_target:eternal_fleet_country
		event_target:eternal_fleet_country = {
			any_owned_fleet = {
				exists = this
				is_fleet_idle = yes
				has_fleet_flag = ag_kuat_invasion_fleet
				NAND = {
					exists = orbit
					orbit = {
						NOT = { is_star = yes }
						exists = owner
						owner = { is_hostile = event_target:eternal_fleet_country }
						exists = controller
						controller = { is_hostile = event_target:eternal_fleet_country }
					}
				}
			}
		}
	}
	immediate = {
		event_target:eternal_fleet_country = {
			every_owned_fleet = {
				limit = {
					exists = this
					is_fleet_idle = yes
					has_fleet_flag = ag_kuat_invasion_fleet
					NAND = {
						exists = orbit
						orbit = {
							NOT = { is_star = yes }
							exists = owner
							owner = { is_hostile = event_target:eternal_fleet_country }
							exists = controller
							controller = { is_hostile = event_target:eternal_fleet_country }
						}
					}
				}
				clear_orders = yes
				clear_fleet_actions = this
				kuat_exe_invasion_fleet_action = { TYPE = ag_kuat OWNER = eternal_fleet_country }
			}
		}
	}
}

#Invasion fleet bombard a planet. 
planet_event = {
	id = exe_invasion.21
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		exists = owner
		has_global_flag = exe_invasion_begin
		NOT = { has_global_flag = exe_invasion_ended }
		planet_devastation = 100
		from = { is_eternal_faction = yes }
	}
	immediate = {
		reset_planet = yes
		destroy_colony = yes
		if = {
			limit = { exists = owner }
			owner = { country_event = { id = exe_invasion.34 } }
		}
		if = {
			limit = { kuat_is_ringworld = yes }
			spawn_ringworld_cracker_effect = yes
			change_pc = pc_ringworld_habitable_damaged
			set_planet_entity = { entity = ringworld_habitable_damaged_entity }
		}
		else_if = {
			limit = { kuat_is_habitat = yes }
			spawn_habitat_cracker_effect = yes
			remove_planet = yes
		}
		else_if = {
			limit = { has_modifier = "holy_planet" }
			change_pc = pc_shattered
			remove_modifier = "holy_planet"
			add_modifier = { modifier = "ag_shattered_holy_planet" }
		}
		else = { change_pc = pc_broken }
		every_country = {
			limit = {
				NOT = { is_same_value = event_target:eternal_fleet_country }
				has_event_chain = ag_exe_invasion_chain
			}
			add_event_chain_counter = {
				event_chain = "ag_exe_invasion_chain"
				counter = "ag_exe_invasion_planet_destroyed"
				amount = 1
			}
		}
		# solar_system = {
		# 	every_fleet_in_system = {
		# 		limit = {
		# 			exists = owner
		# 			owner = { is_eternal_faction = yes }
		# 			has_fleet_flag = ag_kuat_invasion_fleet
		# 			OR = {
		# 				AND = { exists = orbit orbit = { is_same_value = root } }
		# 				AND = {
		# 					is_fleet_idle = yes
		# 					NAND = {
		# 						exists = orbit
		# 						orbit = {
		# 							NOT = { is_star = yes }
		# 							exists = owner
		# 							owner = { is_hostile = event_target:eternal_fleet_country }
		# 						}
		# 					}
		# 				}
		# 			}
		# 		}
		# 		clear_orders = yes
		# 		clear_fleet_actions = this
		# 		fleet_event = { id = exe_invasion.12 days = 5 random = 15 }
		# 	}
		# }	
	}
}

country_event = {
	id = exe_invasion.34
	title = "exe_invasion.21.name"
	desc = {
		trigger = { from = { kuat_is_event_borderment_ringworld = no } }
		text = "exe_invasion.21.a.desc"
	}
	desc = {
		trigger = { from = { kuat_is_ringworld = yes } }
		text = "exe_invasion.21.b.desc"
	}
	desc = {
		trigger = { from = { is_planet_class = pc_habitat } }
		text = "exe_invasion.21.c.desc"
	}
	desc = {
		trigger = { from = { kuat_is_holy_world_planet = yes } }
		text = "exe_invasion.21.d.desc"
	}
	diplomatic = yes
	picture_event_data = { room = nuclear_explosion_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_super_explosion
	is_triggered_only = yes
	option = { name = "exe_invasion.21.a" ai_chance = { weight = 100 } }
}

#Invasion fleet killed counter. 
country_event = {
	id = exe_invasion.22
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		NOT = { has_global_flag = exe_return_invasion_begin }
		is_eternal_faction = yes
	}
	immediate = {
		from = {
			add_event_chain_counter = {
				event_chain = ag_exe_invasion_chain
				counter = ag_exe_invasion_ship_kill_by_us
				amount = 1
			}
		}
		every_country = {
			limit = {
				has_event_chain = ag_exe_invasion_chain
				NOT = { is_same_value = from }
			}
			add_event_chain_counter = {
				event_chain = ag_exe_invasion_chain
				counter = ag_exe_invasion_ship_kill_by_other
				amount = 1
			}
		}
	}
}

#Invasion fleet victim counter.
country_event = {
	id = exe_invasion.23
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		NOT = { has_global_flag = exe_return_invasion_begin }
		is_eternal_faction = yes
		from = { is_eternal_faction = no }
	}
	immediate = {
		every_country = {
			limit = {
				NOT = { is_same_value = event_target:eternal_fleet_country }
				has_event_chain = ag_exe_invasion_chain
			}
			add_event_chain_counter = {
				event_chain = ag_exe_invasion_chain
				counter = ag_exe_invasion_victim
				amount = 1
			}
		}
	}
}

#An invasion fleet has been destroyed. 
country_event = {
	id = exe_invasion.31
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		NOT = { has_global_flag = exe_return_invasion_begin }
		from = { is_eternal_faction = yes }
		fromfromfrom = { has_fleet_flag = ag_kuat_invasion_fleet }
	}
	immediate = {
		fromfromfrom = { if = {
			limit = { NOT = { has_fleet_flag = fire_only_once_temple } }
			set_timed_fleet_flag = { flag = fire_only_once_temple days = 1 }
			every_country = {
				limit = { has_event_chain = ag_exe_invasion_chain }
				add_event_chain_counter = { event_chain = ag_exe_invasion_chain counter = ag_exe_invasion_fleet amount = -1 }
			}
			event_target:global_event_country = { change_variable = { which = var_eternal_fleet_defeated value = 1 } }
		} }
	}
}

#All invasion fleet destroyed, invasion end. 
country_event = {
	id = exe_invasion.32
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		NOT = { has_global_flag = exe_return_invasion_begin }
		from = {
			is_eternal_faction = yes
			count_owned_fleet = {
				limit = {
					has_fleet_flag = ag_kuat_invasion_fleet
					NOT = { is_same_value = root.fromfromfrom }
				}
				count = 0
			}
		}
		fromfromfrom = { has_fleet_flag = ag_kuat_invasion_fleet }
		has_global_flag = kuat_eternal_invasion_can_win_the_fleet
		event_target:global_event_country = { check_variable = { which = var_eternal_fleet_defeated value >= 16 } }
	}
	immediate = {
		every_country = {
			limit = { NOR = { 
				is_same_value = event_target:eternal_fleet_country 
				has_country_flag = trigger_ended_event_temple
				is_same_value = root
			} }
			set_timed_country_flag = { flag = trigger_ended_event_temple days = 1 }
			country_event = { id = exe_invasion.35 scopes = { from = root } }
		}
		if = {
			limit = { is_ai = no NOT = { has_country_flag = trigger_ended_event_temple_1 } }
			country_event = { id = exe_invasion.36 }
			set_timed_country_flag = { flag = trigger_ended_event_temple_1 days = 1 }
			kuat_create_toasto_message = { KEY = kuat_find_memory_cluds TARGET = this RECIPIENT = this }
			if = {
				limit = { 
					NOT = { has_global_flag = special_exe_invasion }
					kuat_is_enable_apocalyptic_origin = yes 
				}
				country_event = { id = kuat_diplomatic.16 days = 10 random = 20 }
			}
			else_if = {
				limit = {  
					has_global_flag = special_exe_invasion
					kuat_is_enable_apocalyptic_origin = yes
				}
				country_event = { id = kuat_diplomatic.19 days = 10 random = 20 }
			}
		}
		add_threat = { who = root amount = 50 }
		set_global_flag = exe_invasion_ended
		remove_global_flag = eternal_fleet_debug_check
		remove_global_flag = ai_fighting_with_player_against_eternal
		stop_crisis_sound = yes
		from = { destroy_country = yes }
	}
}

#Notification: Invasion end. 
country_event = {
	id = exe_invasion.35
	title = "exe_invasion.33.name"
	desc = "exe_invasion.36.desc"
	diplomatic = yes
	picture_event_data = {
		room = Eternal_Empire_room
	}
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	show_sound = event_space_battle
	is_triggered_only = yes
	immediate = { if = {
		limit = { from = { is_ai = no } }
		random_country = {
			limit = { is_ai = no }
			if = {
				limit = { has_global_flag = special_exe_invasion }
				end_event_chain = ag_exe_invasion_chain
				enable_special_project = {
					name = exe_invasion_lock_the_eclipse
					location = this.capital_scope
				}
			}
			else = {
				if = {
					limit = { kuat_is_enable_shadow_origin = yes }
					set_global_flag = fire_the_kuat_return
				}
				end_event_chain = ag_exe_invasion_chain
			}
		}
	} }
	option = { name = "exe_invasion.33.b" }
}

#Notification: Invasion end. 
country_event = {
	id = exe_invasion.36
	title = "exe_invasion.33.name"
	desc = {
		trigger = {
			success_text = {
				has_global_flag = special_exe_invasion
				text = "exe_invasion.35.desc"
			}
			success_text = {
				NOT = { has_global_flag = special_exe_invasion }
				text = "exe_invasion.33.desc"
			}
		}
	}
	diplomatic = yes
	picture_event_data = {
		room = Eternal_Empire_room
	}
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	show_sound = event_space_battle
	is_triggered_only = yes
	immediate = { 
		if = {
			limit = { NOT = { has_global_flag = special_exe_invasion } }
			remove_global_flag = eternal_fleet_debug_check 
			remove_global_flag = ai_fighting_with_player_against_eternal
		}
	}
	option = {
		name = "exe_invasion.33.b"
		trigger = {
			has_global_flag = special_exe_invasion
		}
		hidden_effect = {
			end_event_chain = ag_exe_invasion_chain
			enable_special_project = {
				name = exe_invasion_lock_the_eclipse
				location = this.capital_scope
			}
		}
	}
	option = {
		name = "exe_invasion.33.a"
		trigger = {
			NOT = { has_global_flag = special_exe_invasion }
		}
		hidden_effect = {
			if = {
				limit = { kuat_is_enable_shadow_origin = yes }
				set_global_flag = fire_the_kuat_return
			}
			end_event_chain = ag_exe_invasion_chain
		}
	}
}

event = {
	id = exe_invasion.37
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = eternal_fleet_debug_check
		NOT = { exists = event_target:eternal_fleet_country }
		has_global_flag = exe_invasion_begin
		NOT = { has_global_flag = exe_invasion_ended }
	}
	immediate = {
		remove_global_flag = exe_invasion_begin
		remove_global_flag = kuat_eternal_invasion_can_win_the_fleet
		remove_global_flag = eternal_fleet_debug_check
		remove_global_flag = ai_fighting_with_player_against_eternal
		remove_global_flag = exe_invasion_signs_cooldown
		set_global_flag = exe_invasion_7_fired
	}
}

#Special project to lock an outer gate. (if no outer gate, invasion will create a new outer gate. )
country_event = {
	id = exe_invasion.41
	title = "exe_invasion.41.name"
	desc = "exe_invasion.41.desc"
	diplomatic = yes
	picture_event_data = { room = drifting_gateway_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_mystic_reveal
	is_triggered_only = yes
	immediate = {
		random_system_within_border = {
			limit = {
				NOR = {
					kuat_is_kuat_system = yes
					has_star_flag = kuat_military_base_system_home
				}
				any_system_megastructure = { is_megastructure_type = exe_outer_gate }
			}
			random_system_megastructure = {
				limit = { is_megastructure_type = exe_outer_gate }
				save_global_event_target_as = exe_outer_gate_to_lock
			}
		}
	}
	option = {
		name = "exe_invasion.41.a"
		enable_special_project = {
			name = exe_invasion_lock_outer_gate
			location = event_target:exe_outer_gate_to_lock
			owner = root
		}
	}
	option = {
		name = "exe_invasion.41.b"
		add_resource = { influence = 50 }
	}
}

#Locked an outer gate. 
ship_event = {
	id = exe_invasion.42
	title = "exe_invasion.42.name"
	desc = "exe_invasion.42.desc"
	diplomatic = yes
	picture_event_data = { room = drifting_gateway_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_mystic_reveal
	is_triggered_only = yes
	trigger = { exists = event_target:exe_outer_gate_to_lock }
	immediate = {
		event_target:exe_outer_gate_to_lock = {
			solar_system = { spawn_megastructure = {
				type = exe_outer_gate_locked
				coords_from = prev
			} }
			remove_megastructure = this
		}
	}
	option = { name = "exe_invasion.42.a" }
}

#Invasion happen or not? 
country_event = {
	id = exe_invasion.1000
	title = "exe_invasion.1000.name"
	desc = {
		trigger = {
			success_text = {
				kuat_is_enable_shadow_origin = yes
				text = "exe_invasion.1000.shadow.desc"
			}
			success_text = {
				kuat_is_enable_eternal_origin = yes
				text = "exe_invasion.1000.eternal.desc"
			}
			success_text = {
				NOR = {
					kuat_is_enable_eternal_origin = yes
					kuat_is_enable_shadow_origin = yes
				}
				text = "exe_invasion.1000.none.desc"
			}
			success_text = {
				NOT = { has_global_flag = kuat_settings_first_fired }
				text = "exe_invasion.1000.desc"
			}
			success_text = {
				has_global_flag = kuat_settings_first_fired
				text = "exe_invasion.1000.succes.desc"
			}
		}
	}
	picture_event_data = { room = ancient_AI_room }
	show_sound = event_mystic_reveal
	diplomatic = yes
	custom_gui = "kuat_mod_settings_window"
	custom_gui_option = "kuat_mod_settings_option"
	is_triggered_only = yes
	trigger = { is_player_country = yes }
	immediate = { if = {
		limit = { NOT = { has_global_flag = kuat_settings_first_fired } }
		set_global_flag = easy_exe_invasion 
		set_global_flag = enable_animal_trigger
		set_global_flag = kuat_impulse_mod_settings_disable
		set_global_flag = enable_ftl_ship_animation
		event_target:global_event_country = { 
			set_variable = { which = exe_invasion_difficult_global_var value = 1 } 
			if = {
				limit = { has_global_flag = kuat_impulse_mod_settings }
				multiply_variable = { which = exe_invasion_difficult_global_var value = 1 }
			}
			set_variable = { which = kuat_dynamic_modifier_var value = 1 }
		}
		if = {
			limit = {  
				NOR = {
					has_origin = origin_kuat_shadow
					has_origin = origin_eternalthrone
					has_origin = origin_parit
					has_origin = origin_kuat_apocalyptic
				}
				is_gestalt = no
				is_multiplayer = no
			}
			random_list = {
				1 = { 
					set_country_flag = has_origin_kuat_shadow 
					remove_country_flag = has_origin_kuat_eternal 
				}
				1 = { 
					modifier = {
						set = 0
						has_origin = origin_kuat_apocalyptic
					}
					set_country_flag = has_origin_kuat_eternal 
					remove_country_flag = has_origin_kuat_shadow 
				}
				1 = { 
					modifier = {
						set = 0
						has_origin = origin_kuat_apocalyptic
					}
					no_events = yes 
				}
			}
		}
	} }
	option = {
		name = "exe_invasion.1000.a"
		default_hide_option = yes
		hidden_effect = { if = {
			limit = { NOT = { has_global_flag = kuat_settings_first_fired } }
			event_target:global_event_country = { country_event = { id = executor_build.0 } }
			set_global_flag = kuat_settings_first_fired
			if = {
				limit = { kuat_is_enable_eternal_origin = yes }
				if = {
					limit = { exists = event_target:CHECK_UTS01_LEADER }
					clear_global_event_target = UTS01_LEADER
					random_galaxy_species = {
						limit = { is_same_value = event_target:CHECK_UTS01_LEADER }
						save_global_event_target_as = UTS01_LEADER
					}
				}
				else = { kuat_Uts01_create_faction_species = yes }
			}
			if = {
				limit = { always = yes }
				if = {
					limit = { exists = event_target:CHECK_ETERNAL_LEADER }
					clear_global_event_target = ETERNAL_LEADER
					random_galaxy_species = {
						limit = { is_same_value = event_target:CHECK_ETERNAL_LEADER }
						save_global_event_target_as = ETERNAL_LEADER
					}
				}
				else = { kuat_kae_create_faction_species = yes }
			}
			else_if = {
				limit = { kuat_is_enable_shadow_origin = yes }
				if = {
					limit = { exists = event_target:CHECK_UTS02_LEADER }
					clear_global_event_target = UTS02_LEADER
					random_galaxy_species = {
						limit = { is_same_value = event_target:CHECK_UTS02_LEADER }
						save_global_event_target_as = UTS02_LEADER
					}
				}
				else = { kuat_Uts02_create_faction_species = yes }
			}
		} }
	}
}

country_event = {
	id = exe_invasion.1002
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		create_ship_design = { design = Name_boss_crisis_EFS_3 }
		add_ship_design = last_created_design
	}
}

country_event = {
	id = exe_invasion.1003
	title = "exe_invasion.1003.name"
	desc = "exe_invasion.1003.desc"
	diplomatic = yes
	picture_event_data = { room = fallen_empire_room }
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	is_triggered_only = yes
	immediate = { 
		set_country_flag = chossen_the_eternal_path 
		reset_return_eternal_fleet = yes
	}
	option = { 
		name = exe_invasion.1003.a 
		hidden_effect = { capital_scope = { planet_event = { id = kuat_situation.9999 } } }
	}
}

country_event = {
	id = exe_invasion.1004
	hide_window = no
	is_triggered_only = yes
	title = executor_build.808.title
	desc = {
		trigger = {
			success_text = {
				NOR = {
					has_country_flag = exe_invasion.1004.A.1
					has_country_flag = exe_invasion.1004.A.2
					has_country_flag = exe_invasion.1004.A.3
					has_country_flag = exe_invasion.1004.A.4
				}
				text = exe_invasion.1004.desc
			}
			success_text = {
				has_country_flag = exe_invasion.1004.A.1
				text = exe_invasion.1004.1.desc
			}
			success_text = {
				has_country_flag = exe_invasion.1004.A.2
				text = exe_invasion.1004.2.desc
			}
			success_text = {
				has_country_flag = exe_invasion.1004.A.3
				text = exe_invasion.1004.3.desc
			}
			success_text = {
				has_country_flag = exe_invasion.1004.A.4
				text = exe_invasion.1004.4.desc
			}
		}
	}
	diplomatic = yes
	picture_event_data = { 
		room = fallen_empire_room 
		portrait = root.ruler
	}
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	trigger = { NOT = { has_country_flag = fire_once_setting } }
	immediate = { every_playable_country = { if = {
		limit = { NOT = { has_event_chain = kuat_mission_6_chain } }
		begin_event_chain = { event_chain = kuat_mission_6_chain target = this }
	} } }
	option = {
		name = exe_invasion.1004.A
		hidden_effect = { 
			remove_country_flag = exe_invasion.1004.A.1
			remove_country_flag = exe_invasion.1004.A.2
			remove_country_flag = exe_invasion.1004.A.3
			remove_country_flag = exe_invasion.1004.A.4			
			country_event = { id = exe_invasion.1004 } 
		}
	}
	option = {
		name = exe_invasion.1004.A.1
		hidden_effect = { 
			remove_country_flag = exe_invasion.1004.A.2
			remove_country_flag = exe_invasion.1004.A.3
			remove_country_flag = exe_invasion.1004.A.4
			set_country_flag = exe_invasion.1004.A.1
			country_event = { id = exe_invasion.1004 } 
		}
	}
	option = {
		name = exe_invasion.1004.A.2
		hidden_effect = { 
			remove_country_flag = exe_invasion.1004.A.1
			remove_country_flag = exe_invasion.1004.A.3
			remove_country_flag = exe_invasion.1004.A.4
			set_country_flag = exe_invasion.1004.A.2
			country_event = { id = exe_invasion.1004 } 
		}
	}
	option = {
		name = exe_invasion.1004.A.3
		hidden_effect = { 
			remove_country_flag = exe_invasion.1004.A.1
			remove_country_flag = exe_invasion.1004.A.2
			remove_country_flag = exe_invasion.1004.A.4
			set_country_flag = exe_invasion.1004.A.3
			country_event = { id = exe_invasion.1004 } 
		}
	}
	option = {
		name = exe_invasion.1004.A.4
		hidden_effect = { 
			remove_country_flag = exe_invasion.1004.A.1
			remove_country_flag = exe_invasion.1004.A.2
			remove_country_flag = exe_invasion.1004.A.3
			set_country_flag = exe_invasion.1004.A.4
			country_event = { id = exe_invasion.1004 } 
		}
	}
	option = {
		name = exe_invasion.1004.B
		hidden_effect = { set_country_flag = fire_once_setting }
	}
}

# #eclipse or eternal flagship lazer fixed
# country_event = {
# 	id = exe_invasion.110
# 	hide_window = yes
# 	is_triggered_only = yes
# 	trigger = {  
# 		fromfrom = { any_owned_ship = { OR = { 
# 			is_ship_size = eclipse 
# 			is_ship_size = eternal_flagship 
# 		} } }
# 		is_player_country = yes from = { is_invisable_faction = no }
# 	}
# 	immediate = {
# 		FROMFROM = { if = {
# 			limit = { NOT = { has_fleet_flag = fire_only_once_temple_eclipse } }
# 			every_owned_ship = {
# 				limit = { 
# 					NOT = { has_ship_flag = random_list_superlazer_rate_placeholder }
# 					OR = { has_component = EE_SUPERLASER has_component = EXE_SUPERLASER } 
# 				}
# 				set_ship_flag = is_modifiering_superlazer
# 				ship_event = { id = exe_invasion.112 }
# 				set_timed_ship_flag = { flag = random_list_superlazer_rate_placeholder days = 1 }
# 			}
# 			set_timed_fleet_flag = { flag = fire_only_once_temple_eclipse days = 1 }
# 		} }
# 	}
# }

# ship_event = {
# 	id = exe_invasion.112
# 	hide_window = yes
# 	is_triggered_only = yes
# 	trigger = { has_ship_flag = is_modifiering_superlazer }
# 	immediate = {
# 		if = {
# 			limit = { is_in_combat = yes }
# 			kuat_battle_set_standard_battle_superlazer_weapon_keeping_modifier = {
# 				PARAMATER1 = ship_fire_rate_mult
# 				PARAMATER2 = weapon_type_kuat_superlazer_scale_weapon_fire_rate_mult
# 			}
# 			ship_event = { id = exe_invasion.112 days = 1 }
# 		}
# 		else = { kuat_battle_clear_superlazer_system_fixed_ship = yes }
# 	}
# }
#flagship protection difficult
country_event = {
	id = exe_invasion.116
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_player_country = yes 
		fromfrom = {
			NOT = { has_fleet_flag = kuat_fleet_checkpoint }
			has_enable_flag_ship_system_true = yes
			has_enable_flag_ship_system_false = yes
		} 
	}
	immediate = {
		#旗舰机制
		fromfrom = {  
			if = {
				limit = { kuat_is_flagship_size = { SIZE = Drift_Flagship } }
				set_fleet_flag = kuat_has_Drift_Flagship_fleet
			}
			if = {
				limit = { kuat_is_flagship_size = { SIZE = Spt_Flagship } }
				set_fleet_flag = kuat_has_Spt_Flagship_fleet
			}
			if = {
				limit = { kuat_is_flagship_size = { SIZE = Infinite_Mothership } }
				set_fleet_flag = kuat_has_Infinite_Flagship_fleet
			}
			if = {
				limit = { 
					kuat_is_flagship_size = { SIZE = nebula_executor }
					kuat_is_flagship_size = { SIZE = knight_hammer_executor }
				}
				set_fleet_flag = kuat_has_Executor_Flagship_fleet
			}
			if = {
				limit = { 
					OR = {
						kuat_is_flagship_size = { SIZE = kuat_legator }
						kuat_is_flagship_size = { SIZE = Annihilator }
					}
					kuat_is_flagship_size = { SIZE = X308_Balletor }
				}
				set_fleet_flag = kuat_has_artellary_Flagship_fleet
			}
			if = {
				limit = { 
					OR = {
						kuat_is_flagship_size = { SIZE = kuat_sector }
						kuat_is_flagship_size = { SIZE = Vengeance }
					}
					kuat_is_flagship_size = { SIZE = X308_Tyrant }
				}
				set_fleet_flag = kuat_has_Missle_Flagship_fleet
			}
			if = {
				limit = { 
					kuat_is_flagship_size = { SIZE = nebula_dominance }
					kuat_is_flagship_size = { SIZE = X308_Titan }
				}
				set_fleet_flag = kuat_has_stricraft_Flagship_fleet
				if = {
					limit = { NOT = { is_variable_set = kuat_has_stricraft_Flagship_fleet_limited } }
					set_variable = { which = kuat_has_stricraft_Flagship_fleet_limited value = trigger:num_ships }
				}
			}
			if = {
				limit = { kuat_is_flagship_size = { SIZE = kuat_compellor } }
				every_owned_ship = {
					limit = { kuat_is_kuat_ship = yes }
					kuat_battle_eternal_increase_executor_power = { DAYS = -1 TYPE = cp }
					set_ship_flag = kuat_executor_checkpoint
				}
			}
			else = {
				every_owned_ship = {
					limit = { kuat_is_kuat_ship = yes }
					kuat_battle_eternal_increase_executor_power = { DAYS = -1 TYPE = ee }
					set_ship_flag = kuat_executor_checkpoint
				}
			}
			set_fleet_flag = kuat_fleet_checkpoint
			fleet_event = { id = exe_invasion.114 }
		}
	}
}
country_event = {
	id = exe_invasion.117
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		OR = { is_player_country = yes is_invisable_faction = yes }
		fromfrom = {
			has_enable_flag_ship_system_true = yes
			has_enable_flag_ship_system_false = yes
		}
		NOT = { has_country_flag = kuat_flagship_system_repeatable_modifer_temple_@this }
	}
	immediate = {
		#循环修正优化
		if = {
			limit = { NOT = { has_country_flag = kuat_flagship_system_repeatable_modifer_temple_@this } }
			set_country_flag = kuat_flagship_system_repeatable_modifer_temple_@this
			country_event = { id = exe_invasion.133 }
		}
		from = { if = {
			limit = { NOT = { has_country_flag = kuat_flagship_system_repeatable_modifer_temple_@this } }
			set_country_flag = kuat_flagship_system_repeatable_modifer_temple_@this
			country_event = { id = exe_invasion.133 }
		} }
	}
}

fleet_event = {
	id = exe_invasion.114
	hide_window = yes
	is_triggered_only = yes
	trigger = { has_fleet_flag = kuat_fleet_checkpoint }
	immediate = {
		if = {
			limit = { 
				has_enable_flag_ship_system_true = yes
				has_enable_flag_ship_system_false = yes 
				is_in_combat = yes 
			}
			every_owned_ship = { 
				limit = { has_ship_flag = kuat_executor_checkpoint }
				kuat_battle_clear_ship_at_health = { REPAIR = yes } 
			} 
			fleet_event = { id = exe_invasion.114 days = 5 }
		}
		else = { 
			kuat_battle_remove_executor_power_fleet = yes 
			remove_fleet_flag = kuat_fleet_checkpoint 
			remove_fleet_flag = kuat_has_Spt_Flagship_fleet
			remove_fleet_flag = kuat_has_Drift_Flagship_fleet
			remove_fleet_flag = kuat_has_Infinite_Flagship_fleet
			remove_fleet_flag = kuat_has_Executor_Flagship_fleet
			remove_fleet_flag = kuat_has_artellary_Flagship_fleet
			remove_fleet_flag = kuat_has_Missle_Flagship_fleet
			remove_fleet_flag = kuat_has_stricraft_Flagship_fleet
			clear_variable = kuat_has_stricraft_Flagship_fleet_limited
			every_owned_ship = { 
				limit = { has_ship_flag = kuat_executor_checkpoint }
				remove_ship_flag = kuat_executor_checkpoint 
			} 
		}
	}
}

#FLEET INVISIABLE WITHOUT SPECIAL
ship_event = {
	id = exe_invasion.119
	hide_window = yes
	is_triggered_only = yes
	trigger = { has_ship_flag = kuat_executor_checkpoint }
	immediate = {
		if = {
			limit = { is_in_combat = yes }
			kuat_battle_clear_ship_at_health = { REPAIR = yes }
			ship_event = { id = exe_invasion.119 days = 60 }
		}
		else = { kuat_battle_remove_executor_power = yes remove_ship_flag = kuat_executor_checkpoint }
	}
}

#exe_invasion.121
country_event = {
	id = exe_invasion.121
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		exists = fromfromfrom
		fromfromfrom = { has_ship_flag = kuat_battle_disable_ship_at_health }
	}
	immediate = { if = { limit = { exists = fromfromfrom }
		fromfromfrom = {
			save_event_target_as = kuat_battle_disable_ship_at_health_ship
			if = { 
				limit = { exists = fleet }
				fleet = { create_ship = { 
					design = event_target:kuat_battle_disable_ship_at_health_ship 
					effect = { 
						copy_flags_and_variables_from = event_target:kuat_battle_disable_ship_at_health_ship 
						if = {
							limit = { root.from = { is_galatic_empire = yes } }
							switch = {
								trigger = is_ship_class
								shipclass_military = { kuat_battle_disable_ship_at_health = { FLAG = enable_kuat_ship_inital Disable_health = 0.01 WHICH = KUAT_SHIP_HEALTH_VAR HEALTH = value:kuat_dynamic_exist_life_times } }
								shipclass_starbase = { kuat_battle_disable_ship_at_health = { FLAG = enable_disable_starbase Disable_health = 0.01 WHICH = STARBASE_HEALTH_VAR HEALTH = value:kuat_dynamic_exist_life_times } }
							}
						}
						else_if = {
							limit = { root.from = { is_eternal_faction = yes } }
							switch = {
								trigger = is_ship_class
								shipclass_military = { kuat_battle_disable_ship_at_health = { FLAG = enable_Eternal_ship_inital Disable_health = 0.01 WHICH = ETERNAL_SHIP_HEALTH_VAR HEALTH = value:kuat_dynamic_exist_life_times } }
								shipclass_starbase = { kuat_battle_disable_ship_at_health = { FLAG = enable_disable_starbase Disable_health = 0.01 WHICH = STARBASE_HEALTH_VAR HEALTH = value:kuat_dynamic_exist_life_times } }
							}
						}
						else_if = {
							limit = { root.from = { is_infinite_faction = yes } }
							switch = {
								trigger = is_ship_class
								shipclass_military = { kuat_battle_disable_ship_at_health = { FLAG = enable_Infinite_ship_inital Disable_health = 0.01 WHICH = INFINITE_SHIP_HEALTH_VAR HEALTH = value:kuat_dynamic_exist_life_times } }
							}
						}
						else_if = {
							limit = { root.from = { is_kuat_contractor_faction = yes } }
							switch = {
								trigger = is_ship_class
								shipclass_military = { kuat_battle_disable_ship_at_health = { FLAG = enable_drft_ship_inital Disable_health = 0.01 WHICH = DRFT_SHIP_HEALTH_VAR HEALTH = value:kuat_dynamic_exist_life_times } }
								shipclass_starbase = { kuat_battle_disable_ship_at_health = { FLAG = enable_disable_starbase Disable_health = 0.01 WHICH = STARBASE_HEALTH_VAR HEALTH = value:kuat_dynamic_exist_life_times } }
							}
						}
						else = {
							switch = {
								trigger = is_ship_class
								shipclass_military = { kuat_battle_disable_ship_at_health = { FLAG = enable_kuat_none_ship_inital Disable_health = 0.01 WHICH = KUAT_NONE_SHIP_HEALTH_VAR HEALTH = value:kuat_dynamic_exist_life_times } }
								shipclass_starbase = { kuat_battle_disable_ship_at_health = { FLAG = enable_disable_starbase Disable_health = 0.01 WHICH = STARBASE_HEALTH_VAR HEALTH = value:kuat_dynamic_exist_life_times } }
							}
						}
					}
				} }
			}
		}
	} }
}

country_event = {
	id = exe_invasion.123
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		exists = fromfrom
		OR = {
			is_infinite_faction = yes
			is_kuat_contractor_faction = yes
		}
		from = { is_invisable_faction = no is_player_country = yes }
		fromfrom.fleet = { 
			any_owned_ship = { OR = {
				is_ship_size = Infinite_Mothership
				is_ship_size = Drift_Flagship
				is_ship_size = Spt_Flagship
			} }
			check_variable = { which = count_infinite_faction_battle_duplicate_ship value < value:kuat_invasion_fleet_prec_value|MAX|100| }
		}
		fromfrom = { NOT = { has_ship_flag = temple_infinite_faction_battle_duplicate_ship } }
	}
	immediate = { fromfrom = {  
		if = {
			limit = { ROOT = { is_infinite_faction = yes } }
			fleet = { 
				random_list = {
					1 = { create_ship = { design = Name_boss_crisis_IC_0 } }
					2 = { create_ship = { design = Name_boss_crisis_IC_1 } }
					3 = { create_ship = { design = Name_boss_crisis_IC_2 } }
					4 = { create_ship = { design = Name_boss_crisis_IC_3 } }
				}
				change_variable = { which = count_infinite_faction_battle_duplicate_ship value = 1 }
			}
		}
		else_if = {
			limit = { ROOT = { is_country_type = kuat_contractor_hostile } }
			fleet = {
				random_list = {
					1 = { create_ship = { design = Name_boss_crisis_DB_0 } }
					2 = { create_ship = { design = Name_boss_crisis_DC_0 } }
				}
				change_variable = { which = count_infinite_faction_battle_duplicate_ship value = 1 }
			}
		}
		else_if = {
			limit = { ROOT = { is_country_type = kuat_contractor_support } }
			fleet = {
				random_list = {
					1 = { create_ship = { design = Name_boss_crisis_SP_1 } }
					2 = { create_ship = { design = Name_boss_crisis_SPC_1 } }
				}
				change_variable = { which = count_infinite_faction_battle_duplicate_ship value = 1 }
			}
		}
		set_timed_ship_flag = { flag = temple_infinite_faction_battle_duplicate_ship days = 1 }
	} }
}

country_event = {
	id = exe_invasion.126
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_player_country = yes
		exists = fromfrom.fleet
		fromfrom.fleet = { 
			has_fleet_flag = kuat_has_stricraft_Flagship_fleet 
			check_variable = { which = kuat_has_stricraft_Flagship_fleet_limited value > 0 }
			check_variable_arithmetic = { which = trigger:num_ships value < kuat_has_stricraft_Flagship_fleet_limited }
		}
		fromfrom = { NOT = { has_ship_flag = temple_dominence_faction_battle_duplicate_ship } }
	}
	immediate = { fromfrom = {
		if = {
			limit = { exists = fleet }
			fleet = { random_list = {
				1 = { create_ship = { design = Name_boss_crisis_HIGH_EMPIRE_BOSS } }
				1 = { create_ship = { design = Name_criss_boss_Horriwer_BOSS } }
				1 = { create_ship = { design = Name_criss_boss_Cavelry_BOSS } }
			} }
		}
		set_timed_ship_flag = { flag = temple_dominence_faction_battle_duplicate_ship days = 5 }
	} }
}

#debug for special component weapon destroyed
ship_event = {
	id = exe_invasion.124
	hide_window = yes
	is_triggered_only = yes
	trigger = { OR = {
		AND = { 
			exists = from.owner
			from.owner = { is_invisable_faction = yes } 
			is_ship_class = shipclass_habitat_station 
		}
		has_ship_flag = kuat_battle_disable_ship_at_health
	} }
	immediate = { 
		if = {
			limit = { 
				exists = from.owner
				from.owner = { is_invisable_faction = yes } 
				is_ship_class = shipclass_habitat_station 
			}
			kuat_battle_kuat_remove_starbase_station = yes
		}
		else_if = {
			limit = { has_ship_flag = enable_disable_starbase }
			if = {
				limit = { kuat_exist_disable_type = no }
				kuat_battle_clear_ship_at_health = { REPAIR = yes INVERT_DISABLE = set_disabled }
			}
			else_if = { 
				limit = { kuat_exist_disable_type = yes check_variable = { which = STARBASE_HEALTH_VAR value > 0 } } 
				kuat_battle_clear_ship_at_health = { REPAIR = yes INVERT_DISABLE = set_disabled WHICH = STARBASE_HEALTH_VAR RELOAD = yes }
			} 
			else = { kuat_battle_clear_ship_at_health = { REPAIR = yes INVERT_DISABLE = set_disabled Disable_health = -1 } }
		}
		else_if = {
			limit = { has_ship_flag = enable_drft_ship_inital owner = { is_kuat_contractor_faction = yes } }
			if = {
				limit = { kuat_exist_disable_type = no }
				kuat_battle_clear_ship_at_health = { REPAIR = yes INVERT_DISABLE = set_disabled }
			}
			else_if = { 
				limit = { kuat_exist_disable_type = yes check_variable = { which = DRFT_SHIP_HEALTH_VAR value > 0 } } 
				kuat_battle_clear_ship_at_health = { REPAIR = yes INVERT_DISABLE = set_disabled WHICH = DRFT_SHIP_HEALTH_VAR RELOAD = yes }
			} 
			else = { kuat_battle_clear_ship_at_health = { REPAIR = yes INVERT_DISABLE = set_disabled Disable_health = -1 } }
		}
		else_if = {
			limit = { has_ship_flag = enable_kuat_ship_inital owner = { is_galatic_empire = yes } }
			if = {
				limit = { kuat_exist_disable_type = no }
				kuat_battle_clear_ship_at_health = { REPAIR = yes INVERT_DISABLE = set_disabled }
			}
			else_if = { 
				limit = { kuat_exist_disable_type = yes check_variable = { which = KUAT_SHIP_HEALTH_VAR value > 0 } } 
				kuat_battle_clear_ship_at_health = { REPAIR = yes INVERT_DISABLE = set_disabled WHICH = KUAT_SHIP_HEALTH_VAR RELOAD = yes }
			} 
			else = { kuat_battle_clear_ship_at_health = { REPAIR = yes INVERT_DISABLE = set_disabled Disable_health = -1 } }
		}
		else_if = {
			limit = { has_ship_flag = enable_Infinite_ship_inital owner = { is_infinite_faction = yes } }
			if = {
				limit = { kuat_exist_disable_type = no }
				kuat_battle_clear_ship_at_health = { REPAIR = yes INVERT_DISABLE = set_disabled }
			}
			else_if = { 
				limit = { kuat_exist_disable_type = yes check_variable = { which = INFINITE_SHIP_HEALTH_VAR value > 0 } } 
				kuat_battle_clear_ship_at_health = { REPAIR = yes INVERT_DISABLE = set_disabled WHICH = INFINITE_SHIP_HEALTH_VAR RELOAD = yes }
			} 
			else = { kuat_battle_clear_ship_at_health = { REPAIR = yes INVERT_DISABLE = set_disabled Disable_health = -1 } }
		}
		else_if = {
			limit = { has_ship_flag = enable_Eternal_ship_inital owner = { is_eternal_faction = yes } }
			if = {
				limit = { exists = solar_system solar_system = { kuat_is_repair_system = yes } }
				kuat_battle_clear_ship_at_health = { REPAIR = yes INVERT_DISABLE = set_disabled }
			}
			else_if = {
				limit = { exists = solar_system solar_system = { kuat_is_repair_system = no } }
				if = {
					limit = { kuat_exist_disable_type = no }
					kuat_battle_clear_ship_at_health = { REPAIR = yes INVERT_DISABLE = set_disabled }
				} 
				else_if = { 
					limit = { kuat_exist_disable_type = yes check_variable = { which = ETERNAL_SHIP_HEALTH_VAR value > 0 } } 
					kuat_battle_clear_ship_at_health = { REPAIR = yes INVERT_DISABLE = set_disabled WHICH = ETERNAL_SHIP_HEALTH_VAR RELOAD = yes }
				}
				else = { kuat_battle_clear_ship_at_health = { REPAIR = yes INVERT_DISABLE = set_disabled Disable_health = -1 } }
			}
		}
		else_if = {
			limit = { has_ship_flag = enable_kuat_none_ship_inital owner = { is_player_country = yes } }
			if = {
				limit = { kuat_exist_disable_type = no }
				kuat_battle_clear_ship_at_health = { REPAIR = yes INVERT_DISABLE = set_disabled }
			}
			else_if = { 
				limit = { kuat_exist_disable_type = yes check_variable = { which = KUAT_NONE_SHIP_HEALTH_VAR value > 0 } } 
				kuat_battle_clear_ship_at_health = { REPAIR = yes INVERT_DISABLE = set_disabled WHICH = KUAT_NONE_SHIP_HEALTH_VAR RELOAD = yes }
			} 
			else = { kuat_battle_clear_ship_at_health = { REPAIR = yes INVERT_DISABLE = set_disabled Disable_health = -1 } }
		}
		else = { kuat_battle_clear_ship_at_health = { REPAIR = yes INVERT_DISABLE = set_disabled Disable_health = -1 } }
	}
}

#debug check modifier in eternal fleet FROMFROM
country_event = {
	id = exe_invasion.130
	hide_window = yes
	is_triggered_only = yes
	trigger = { 
		is_invisable_faction = yes 
		from = { OR = { is_player_country = yes is_invisable_faction = yes } }
		fromfrom = { NAND = { root = { OR = { is_eternal_faction = yes is_galatic_empire = yes } } is_ship_size = exe_starbase } }
	}
	immediate = {
		if = {
			limit = { 
				is_kuat_contractor_faction = yes 
				from = { is_invisable_faction = no }
				fromfrom = { has_fleet_flag = kuat_contractor_defenced_fleet }
			}
			kuat_contractor_randomlist_battle_duplcate_ship = yes
		}
		if = {
			limit = { from = { is_invisable_faction = no } }
			fromfromfrom = {
				if = {
					limit = { NOT = { has_fleet_flag = kuat_is_modifiering_fleet_repeatable } }
					if = {
						limit = { check_modifier_value = { modifier = ship_hull_mult value > 0 } }
						kuat_battle_clear_ship_modifier = { modifier = ship_hull_mult DAYS = -1 }
					}
					if = {
						limit = { check_modifier_value = { modifier = shipclass_military_hull_mult value > 0 } }
						kuat_battle_clear_ship_modifier = { modifier = shipclass_military_hull_mult DAYS = -1 }
					}
					set_fleet_flag = kuat_is_modifiering_fleet_repeatable
				}
			}
		}
		if = {
			limit = { 
				is_invisable_faction = yes
				has_global_flag = kuat_non_legacy_trigger_eternal_return 
			}
			fromfromfrom = { every_owned_ship = {
				limit = { NOT = { has_ship_flag = kuat_runing_kuat_non_legacy_trigger_eternal_return } }
				set_ship_flag = kuat_runing_kuat_non_legacy_trigger_eternal_return
				kuat_battle_clear_ship_repeatable_modifier = { multiply = -6 DAYS = 60 }
			}  }
		}
		#旗舰标识
		if = {
			limit = { is_invisable_faction = yes }
			fromfrom = {
				remove_fleet_flag = kuat_battle_anti_ai_damage_fleet
				set_fleet_flag = has_kuat_flagship_system
				set_fleet_flag = has_kuat_subflagship_system
			}
		}
		if = {
			limit = { from = { is_invisable_faction = no } }
			fromfromfrom = { kuat_battle_flagship_intial = yes }
		}
		#动态引入
		if = {
			limit = { is_eternal_faction = yes }
			fromfrom = {
				if = {  
					limit = { NOT = { has_fleet_flag = is_modifiering_fleet } }
					set_fleet_flag = is_modifiering_fleet
					if = {
						limit = { NOT = { has_global_flag = kuat_non_legacy_trigger_eternal_return } }
						switch = {
							trigger = has_global_flag
							kuat_set_forcetrigger_order_enable_crisis_eve_system = { fleet_event = { id = exe_invasion.138 } }
							default = { fleet_event = { id = exe_invasion.140 } }
						}
					}
					else = { fleet_event = { id = exe_invasion.144 } }
				}
			}
			if = {
				limit = { from = { is_invisable_faction = no } }
				fromfromfrom = { if = {
					limit = {
						ROOT = { is_eternal_faction = yes }
						NOT = { has_fleet_flag = is_modifiering_fleet }
					}
					set_fleet_flag = is_modifiering_fleet
					if = {
						limit = { NOT = { has_global_flag = kuat_non_legacy_trigger_eternal_return } }
						switch = {
							trigger = has_global_flag
							kuat_set_forcetrigger_order_enable_crisis_eve_system = { fleet_event = { id = exe_invasion.147 } }
							default = { fleet_event = { id = exe_invasion.136 } }
						}
					}
					else = { fleet_event = { id = exe_invasion.142 } }
				} }
			}
		}
		if = {
			limit = { is_infinite_faction = yes }
			fromfrom = {
				if = {  
					limit = { NOT = { has_fleet_flag = is_modifiering_fleet } }
					set_fleet_flag = is_modifiering_fleet
					if = {
						limit = { NOT = { has_global_flag = kuat_non_legacy_trigger_eternal_return } }
						switch = {
							trigger = has_global_flag
							kuat_set_forcetrigger_order_enable_crisis_eve_system = { fleet_event = { id = exe_invasion.138 } }
							default = { fleet_event = { id = exe_invasion.137 } }
						}
					}
					else = { fleet_event = { id = exe_invasion.144 } }
				}
			}
			if = {
				limit = { from = { is_invisable_faction = no } }
				fromfromfrom = { if = {
					limit = {
						ROOT = { is_infinite_faction = yes }
						NOT = { has_fleet_flag = is_modifiering_fleet }
					}
					set_fleet_flag = is_modifiering_fleet
					if = {
						limit = { NOT = { has_global_flag = kuat_non_legacy_trigger_eternal_return } }
						switch = {
							trigger = has_global_flag
							kuat_set_forcetrigger_order_enable_crisis_eve_system = { fleet_event = { id = exe_invasion.147 } }
							default = { fleet_event = { id = exe_invasion.131 } }
						}
					}
					else = { fleet_event = { id = exe_invasion.142 } }
				} }
			}
		}
		if = {
			limit = { is_kuat_contractor_faction = yes }
			fromfrom = {
				if = {  
					limit = { NOT = { has_fleet_flag = is_modifiering_fleet } }
					set_fleet_flag = is_modifiering_fleet
					if = {
						limit = { NOT = { has_global_flag = kuat_non_legacy_trigger_eternal_return } }
						switch = {
							trigger = has_global_flag
							kuat_set_forcetrigger_order_enable_crisis_eve_system = { fleet_event = { id = exe_invasion.138 } }
							default = { fleet_event = { id = exe_invasion.143 } }
						}
					}
					else = { fleet_event = { id = exe_invasion.144 } }
				}
			}
			if = {
				limit = { from = { is_invisable_faction = no } }
				fromfromfrom = { if = {
					limit = {
						ROOT = { is_kuat_contractor_faction = yes }
						NOT = { has_fleet_flag = is_modifiering_fleet }
					}
					set_fleet_flag = is_modifiering_fleet
					if = {
						limit = { NOT = { has_global_flag = kuat_non_legacy_trigger_eternal_return } }
						switch = {
							trigger = has_global_flag
							kuat_set_forcetrigger_order_enable_crisis_eve_system = { fleet_event = { id = exe_invasion.147 } }
							default = { fleet_event = { id = exe_invasion.129 } }
						}
					}
					else = { fleet_event = { id = exe_invasion.142 } }
				} }
			}
		}
		if = {
			limit = { is_galatic_empire = yes }
			fromfrom = {
				if = {  
					limit = { NOT = { has_fleet_flag = is_modifiering_fleet } }
					set_fleet_flag = is_modifiering_fleet
					if = {
						limit = { NOT = { has_global_flag = kuat_non_legacy_trigger_eternal_return } }
						fleet_event = { id = exe_invasion.138 }
					}
					else = { fleet_event = { id = exe_invasion.144 } }
				}
			}
			if = {
				limit = { from = { is_invisable_faction = no } }
				fromfromfrom = { if = {
					limit = {
						ROOT = { is_galatic_empire = yes }
						NOT = { has_fleet_flag = is_modifiering_fleet }
					}
					set_fleet_flag = is_modifiering_fleet
					if = {
						limit = { NOT = { has_global_flag = kuat_non_legacy_trigger_eternal_return } }
						fleet_event = { id = exe_invasion.147 }
					}
					else = { fleet_event = { id = exe_invasion.142 } }
				} }
			}
		}
		#补给区
		if = {
			limit = { 
				is_invisable_faction = yes
				from = { is_invisable_faction = no is_ai = no }
				fromfrom = { NOR = {
					is_ship_class = shipclass_colonizer
					is_ship_class = shipclass_constructor
					is_ship_class = shipclass_transport
					is_ship_class = shipclass_science_ship
				} }
				OR = {
					has_global_flag = difficult_exe_invasion
					has_global_flag = ban_exe_invasion
				}
				fromfromfrom = { OR = {
					is_ship_class = shipclass_military
					is_ship_class = shipclass_military_special
				} }
				NOT = { has_global_flag = kuat_set_forcetrigger_order_enable_crisis_eve_system }
			}
			country_event = {
				id = exe_invasion.132 days = 1 
				scopes = { from = root.from fromfrom = root.fromfrom fromfromfrom = root.fromfromfrom }
			}
		}
	}
}
country_event = {
	id = exe_invasion.150
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_invisable_faction = yes 
		from = { NOR = { is_player_country = yes is_invisable_faction = yes } }
		fromfrom = { root = { OR = { is_eternal_faction = yes is_galatic_empire = yes } } is_ship_size = exe_starbase }
	}
	immediate = {
		fromfrom = { if = {
			limit = { NOT = { has_fleet_flag = kuat_battle_anti_ai_damage_fleet } }
			set_fleet_flag = kuat_battle_anti_ai_damage_fleet
		} }
		fromfromfrom = {  
			every_owned_ship = {
				random_list = {
					1 = { set_variable = { which = kuat_anti_ai_damage_hp_percent value = 50 } }
					1 = { set_variable = { which = kuat_anti_ai_damage_hp_percent value = 60 } }
					1 = { set_variable = { which = kuat_anti_ai_damage_hp_percent value = 70 } }
					1 = { set_variable = { which = kuat_anti_ai_damage_hp_percent value = 80 } }
					1 = { set_variable = { which = kuat_anti_ai_damage_hp_percent value = 90 } }
				}
				reroll_random = yes
				random_list = {
					1 = { change_variable = { which = kuat_anti_ai_damage_hp_percent value = 1 } }
					1 = { change_variable = { which = kuat_anti_ai_damage_hp_percent value = 2 } }
					1 = { change_variable = { which = kuat_anti_ai_damage_hp_percent value = 3 } }
					1 = { change_variable = { which = kuat_anti_ai_damage_hp_percent value = 4 } }
					1 = { change_variable = { which = kuat_anti_ai_damage_hp_percent value = 5 } }
					1 = { change_variable = { which = kuat_anti_ai_damage_hp_percent value = 6 } }
					1 = { change_variable = { which = kuat_anti_ai_damage_hp_percent value = 7 } }
					1 = { change_variable = { which = kuat_anti_ai_damage_hp_percent value = 8 } }
					1 = { change_variable = { which = kuat_anti_ai_damage_hp_percent value = 9 } }
				}
				kuat_battle_kuat_damage_hp_percent = { value = kuat_anti_ai_damage_hp_percent }
				clear_variable = kuat_anti_ai_damage_hp_percent
			}
		}
	}
}

country_event = {
	id = exe_invasion.132
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		fromfromfrom = { if = {
			limit = { NOT = { has_fleet_flag = random_list_flagship_checksum_placeholder } }
			if = {
				limit = { 
					has_enable_flag_ship_system_true = yes 
					exists = solar_system
					solar_system = { has_kuat_support_modifier_star_flag = yes }
				}
				#初始化检查
				solar_system = { if = {
					limit = { NOT = { is_variable_set = kuat_support_battle_add_variable } }
					set_variable = { which = kuat_support_battle_add_variable value = value:kuat_system_support_variable } 
					prev = { 
						every_owned_ship = { kuat_battle_remove_repetable_modifier_iep = yes }
						kuat_battle_kuat_star_flagship_base_fleet_clear_calculation = { ID = 1 }
						kuat_battle_kuat_star_flagship_base_fleet_clear_calculation = { ID = 2 }
						kuat_battle_kuat_star_flagship_base_fleet_clear_calculation = { ID = 4 }
					}
					system_event = { id = exe_invasion.2502 days = 3 }
				} }
				#运算
				inline_script = { script = kuat_battle_event/kuat_exe_invasion_base_effect_checksum ID_3 = 4 ID_2 = 2 ID_1 = 1 }
			}
			else_if = {
				limit = { 
					has_enable_flag_ship_system_true = yes 
					exists = solar_system
					solar_system = { has_kuat_support_modifier_star_flag = no }
				}
				if = {
					limit = { NOT = { is_variable_set = kuat_star_flagship_nonsupport_battle_times } }
					set_variable = { which = kuat_star_flagship_nonsupport_battle_times value = value:kuat_star_flagship_nonsupport_field_battle_times }
				}
				if = {
					limit = {
						check_variable = { which = kuat_star_flagship_nonsupport_battle_times value >= 4 }
						NOT = { has_fleet_flag = kuat_star_flagship_nonsupport_battle_times_sutrat_placeholder }
						kuat_fleet_cap_TRIGGER_occupy_4 = yes
					}
					every_owned_ship = { kuat_battle_flagship_clear_ship_repeatable_modifier = { multiply = -1 DAYS = 30 } }
					subtract_variable = { which = kuat_star_flagship_nonsupport_battle_times value = 4 }
					set_fleet_flag = kuat_star_flagship_nonsupport_battle_times_sutrat_placeholder
				}
				else_if = {
					limit = {
						check_variable = { which = kuat_star_flagship_nonsupport_battle_times value >= 2 }
						NOT = { has_fleet_flag = kuat_star_flagship_nonsupport_battle_times_sutrat_placeholder }
						kuat_fleet_cap_TRIGGER_occupy_2 = yes
					}
					every_owned_ship = { kuat_battle_flagship_clear_ship_repeatable_modifier = { multiply = -0.75 DAYS = 30 } }
					subtract_variable = { which = kuat_star_flagship_nonsupport_battle_times value = 2 }
					set_fleet_flag = kuat_star_flagship_nonsupport_battle_times_sutrat_placeholder
				}
				else_if = {
					limit = {
						check_variable = { which = kuat_star_flagship_nonsupport_battle_times value >= 1 }
						NOT = { has_fleet_flag = kuat_star_flagship_nonsupport_battle_times_sutrat_placeholder }
						kuat_fleet_cap_TRIGGER_occupy_1 = yes
					}
					every_owned_ship = { kuat_battle_flagship_clear_ship_repeatable_modifier = { multiply = -0.50 DAYS = 30 } }
					subtract_variable = { which = kuat_star_flagship_nonsupport_battle_times value = 1 }
					set_fleet_flag = kuat_star_flagship_nonsupport_battle_times_sutrat_placeholder
				}
				else = {
					if = {
						limit = {  
							closest_system = {
								use_bypasses = yes
								has_kuat_support_modifier_star_flag = yes
							}
						}
						closest_system = {
							use_bypasses = yes
							limit = { has_kuat_support_modifier_star_flag = yes }
							prev = { set_location = prev.star }
						}
					}
					else = { set_location = owner.capital_star }
					every_owned_ship = { kuat_battle_flagship_clear_ship_repeatable_modifier = { multiply = 1 DAYS = 60 } }
				}
				fleet_event = { id = exe_invasion.2503 days = 60 }
			}
			else_if = {
				limit = { has_enable_flag_ship_system_true = no exists = solar_system }
				if = {
					limit = { NOT = { is_variable_set = kuat_star_flagship_nonsupport_battle_times } }
					set_variable = { which = kuat_star_flagship_nonsupport_battle_times value = value:kuat_star_flagship_nonsupport_field_battle_times }
				}
				if = {
					limit = {
						check_variable = { which = kuat_star_flagship_nonsupport_battle_times value >= 4 }
						NOT = { has_fleet_flag = kuat_star_flagship_nonsupport_battle_times_sutrat_placeholder }
					}
					every_owned_ship = { kuat_battle_flagship_clear_ship_repeatable_modifier = { multiply = -1 DAYS = 30 } }
					subtract_variable = { which = kuat_star_flagship_nonsupport_battle_times value = 4 }
					set_fleet_flag = kuat_star_flagship_nonsupport_battle_times_sutrat_placeholder
				}
				else = {
					if = {
						limit = {  
							closest_system = {
								use_bypasses = yes
								has_kuat_support_modifier_star_flag = yes
							}
						}
						closest_system = {
							use_bypasses = yes
							limit = { has_kuat_support_modifier_star_flag = yes }
							prev = { set_location = prev.star }
						}
					}
					else = { set_location = owner.capital_star }
					every_owned_ship = { kuat_battle_clear_ship_repeatable_modifier = { multiply = 1 DAYS = 60 } }
				}
				fleet_event = { id = exe_invasion.2503 days = 60 }
			}
			set_timed_fleet_flag = { flag = random_list_flagship_checksum_placeholder days = 1 }
		} }
	}
}

country_event = {
	id = exe_invasion.133
	hide_window = yes
	is_triggered_only = yes
	trigger = { has_country_flag = kuat_flagship_system_repeatable_modifer_temple_@this }
	immediate = {
		if = {
			limit = { any_owned_fleet = { is_in_combat = yes } }
			kuat_battle_random_list_eternal_fleet_rate = yes
			country_event = { id = exe_invasion.133 days = 5 }
			set_country_flag = kuat_is_modifiering
		}
		else = {
			kuat_battle_remove_repeatable_modifier_base_and_change_base = yes
			kuat_battle_remove_all_ship_modifier_change_basic_variable = yes
			remove_country_flag = kuat_flagship_system_repeatable_modifer_temple_@this
			remove_country_flag = kuat_is_modifiering
		}
	}
}

country_event = {
	id = exe_invasion.146
	hide_window = yes
	is_triggered_only = yes
	trigger = { fromfrom = { kuat_is_flagship = yes } }
	immediate = { fromfrom = { 
		if = {
			limit = { 
				is_ship_size = Drift_Flagship
				fleet = { count_owned_ship = {
					count = 0
					limit = { NOT = { is_same_value = prevprev } is_ship_size = Drift_Flagship }
				} }
			}
			fleet = { remove_fleet_flag = kuat_has_Drift_Flagship_fleet } 
		}
		if = {
			limit = { 
				is_ship_size = Spt_Flagship
				fleet = { count_owned_ship = {
					count = 0
					limit = { NOT = { is_same_value = prevprev } is_ship_size = Spt_Flagship }
				} }
			}
			fleet = { remove_fleet_flag = kuat_has_Spt_Flagship_fleet } 
		}
		if = {
			limit = { 
				is_ship_size = Infinite_Mothership
				fleet = { count_owned_ship = {
					count = 0
					limit = { NOT = { is_same_value = prevprev } is_ship_size = Infinite_Mothership }
				} }
			}
			fleet = { remove_fleet_flag = kuat_has_Infinite_Flagship_fleet } 
		}
		if = {
			limit = { 
				OR = { is_ship_size = nebula_executor is_ship_size = knight_hammer_executor }
				fleet = { count_owned_ship = {
					count = 0
					limit = { NOT = { is_same_value = prevprev } OR = { is_ship_size = nebula_executor is_ship_size = knight_hammer_executor } }
				} }
			}
			fleet = { remove_fleet_flag = kuat_has_Executor_Flagship_fleet } 
		}
		if = {
			limit = { 
				OR = { is_ship_size = kuat_legator is_ship_size = Annihilator is_ship_size = X308_Balletor }
				fleet = { count_owned_ship = {
					count = 0
					limit = { NOT = { is_same_value = prevprev } OR = { is_ship_size = kuat_legator is_ship_size = Annihilator is_ship_size = X308_Balletor } }
				} }
			}
			fleet = { remove_fleet_flag = kuat_has_artellary_Flagship_fleet } 
		}
		if = {
			limit = { 
				OR = { is_ship_size = kuat_sector is_ship_size = Vengeance is_ship_size = X308_Tyrant }
				fleet = { count_owned_ship = {
					count = 0
					limit = { NOT = { is_same_value = prevprev } OR = { is_ship_size = kuat_sector is_ship_size = Vengeance is_ship_size = X308_Tyrant } }
				} }
			}
			fleet = { remove_fleet_flag = kuat_has_Missle_Flagship_fleet } 
		}
		if = {
			limit = { 
				OR = { is_ship_size = nebula_dominance is_ship_size = X308_Titan }
				fleet = { count_owned_ship = {
					count = 0
					limit = { NOT = { is_same_value = prevprev } OR = { is_ship_size = nebula_dominance is_ship_size = X308_Titan } }
				} }
			}
			fleet = { 
				remove_fleet_flag = kuat_has_stricraft_Flagship_fleet 
				clear_variable = kuat_has_stricraft_Flagship_fleet_limited
			} 
		}
		if = {
			limit = { OR = {
				has_global_flag = difficult_exe_invasion
				has_global_flag = ban_exe_invasion
			} }
			if = {
				limit = { 
					kuat_is_flagship_system_protection = yes 
					fleet = { count_owned_ship = {
						count = 0
						limit = { NOT = { is_same_value = prevprev } kuat_is_flagship_system_protection = yes }
					} }
				}
				fleet = { remove_fleet_flag = has_kuat_flagship_system } 
			}
			else_if = {
				limit = { 
					kuat_is_sub_flagship_system_protection = yes 
					fleet = { count_owned_ship = {
						count = 0
						limit = { NOT = { is_same_value = prevprev } kuat_is_sub_flagship_system_protection = yes }
					} }
				}
				fleet = { remove_fleet_flag = has_kuat_subflagship_system }
			}
		}
	} }
}

#eternal
fleet_event = { inline_script = { 
	script = kuat_battle_event/kuat_exe_invasion_battle 
	TYPE = kuat_battle_setup_invinciable_protection_pragram 
	ID = exe_invasion.140 KEY = kuat_battle_set_need_flagship_eternal_fleet_mult_modifier 		
} }
fleet_event = { inline_script = { 
	script = kuat_battle_event/kuat_exe_invasion_battle 
	TYPE = kuat_battle_setup_invinciable_attacketion_pragram 
	ID = exe_invasion.136 KEY = kuat_battle_set_need_flagship_eternal_fleet_mult_modifier 		
} }

#none eternal
fleet_event = { inline_script = { 
	script = kuat_battle_event/kuat_exe_invasion_battle 
	TYPE = kuat_battle_setup_invinciable_protection_pragram 
	ID = exe_invasion.144 KEY = kuat_battle_set_easy_eternal_fleet_mult_modifier 		
} }
fleet_event = { inline_script = { 
	script = kuat_battle_event/kuat_exe_invasion_battle 
	TYPE = kuat_battle_setup_invinciable_attacketion_pragram 
	ID = exe_invasion.142 KEY = kuat_battle_set_easy_eternal_fleet_mult_modifier 		
} }

#infinite
fleet_event = { inline_script = { 
	script = kuat_battle_event/kuat_exe_invasion_battle 
	TYPE = kuat_battle_setup_invinciable_protection_pragram 
	ID = exe_invasion.137 KEY = kuat_battle_set_need_flagship_infinite_fleet_mult_modifier 
} }
fleet_event = { inline_script = { 
	script = kuat_battle_event/kuat_exe_invasion_battle 
	TYPE = kuat_battle_setup_invinciable_attacketion_pragram 
	ID = exe_invasion.131 KEY = kuat_battle_set_need_flagship_infinite_fleet_mult_modifier 
} }

#contractor
fleet_event = { inline_script = { 
	script = kuat_battle_event/kuat_exe_invasion_battle 
	TYPE = kuat_battle_setup_invinciable_protection_pragram 
	ID = exe_invasion.143 KEY = kuat_battle_set_not_need_flagship_contractor_fleet_mult_modifier 	
} }
fleet_event = { inline_script = { 
	script = kuat_battle_event/kuat_exe_invasion_battle 
	TYPE = kuat_battle_setup_invinciable_attacketion_pragram 
	ID = exe_invasion.129 KEY = kuat_battle_set_not_need_flagship_contractor_fleet_mult_modifier 	
} }

#kuat standard
fleet_event = { inline_script = { 
	script = kuat_battle_event/kuat_exe_invasion_battle 
	TYPE = kuat_battle_setup_invinciable_protection_pragram 
	ID = exe_invasion.138 KEY = kuat_battle_set_standard_crisis_fleet_mult_modifier 
} }
fleet_event = { inline_script = { 
	script = kuat_battle_event/kuat_exe_invasion_battle 
	TYPE = kuat_battle_setup_invinciable_attacketion_pragram 
	ID = exe_invasion.147 KEY = kuat_battle_set_standard_crisis_fleet_mult_modifier 
} }

#ORIGIN ETERNAL
country_event = {
	id = exe_invasion.135
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_invisable_faction = yes
		from = { is_invisable_faction = no }
	}
	immediate = {
		fromfromfrom = { every_owned_ship = {
			limit = { 
				NOT = { has_ship_flag = enable_random_list_effect }
				kuat_is_flagship = no
				is_disabled = no is_in_combat = yes has_hp > 0
			}
			set_timed_ship_flag = { flag = enable_random_list_effect days = 1 }
			kuat_battle_kuat_invinciable_battle_random_effect = yes
		} }
	}
}
country_event = {
	id = exe_invasion.139
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = kuat_impulse_mod_settings
		is_invisable_faction = yes
		from = { is_invisable_faction = no }
	}
	immediate = { 
		fromfromfrom.fleet = { every_owned_ship = {
			limit = { 
				kuat_is_flagship = no
				is_disabled = no is_in_combat = yes has_hp > 0
			}
			kuat_battle_kuat_invinciable_battle_random_effect = yes
		} }
	}
}

# message about leader clone
country_event = {
	id = exe_invasion.141
	title = "exe_invasion.141.name"
	desc = "exe_invasion.141.desc"
	diplomatic = yes
	picture_event_data = { room = ancient_AI_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_red_alert
	is_triggered_only = yes
	trigger = { NOT = { has_country_flag = fired_massege_leader } }
	option = { name = exe_invasion.141.a }
	option = { name = exe_invasion.141.b hidden_effect = { set_country_flag = fired_massege_leader } }
}

# Saving debug
event = {
	id = exe_invasion.9999
	hide_window = yes
	is_triggered_only = yes
	trigger = { any_country = { has_country_flag = solarpunk_country } }
	immediate = { every_country = { limit = { has_country_flag = solarpunk_country } destroy_country = yes } }
}

#leader skill
country_event = {
	id = exe_invasion.2500
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_player_country = yes
		fromfrom = { kuat_exist_fleet_leader = { 
			TRUE_FLAG = SOP_eddy KEY = has_trait
			TRAIT1 = leader_trait_commander_SOP_eddy_1
			TRAIT2 = leader_trait_commander_SOP_eddy_2
			TRAIT3 = leader_trait_commander_SOP_eddy_3
		} }
	}
	immediate = {
		fromfrom = {  
			if = {
				limit = { kuat_exist_fleet_leader = { 
					TRAIT = leader_trait_commander_SOP_eddy_1
					FAIL_FLAG = kuat_level_improve_cool_down
				} }
				every_owned_ship = {
					limit = { NOT = { has_ship_flag = kuat_runing_leader_trait_commander_SOP_eddy_1 } }
					set_timed_ship_flag = { flag = kuat_runing_leader_trait_commander_SOP_eddy_1 days = 30 }
					kuat_battle_clear_ship_repeatable_modifier = { multiply = -10 DAYS = 30 }
				} 
				leader = { set_timed_leader_flag = { flag = kuat_level_improve_cool_down days = 30 } }
			}
			if = {
				limit = { 
					kuat_exist_fleet_leader = { 
						TRUE_FLAG = SOP_eddy
						TRAIT = leader_trait_commander_SOP_eddy_2 
					}
					has_enable_flag_ship_system_true = no
					root.from = { is_invisable_faction = no }
				}
				kuat_battle_increase_ship_hp_effect_change = { DAYS = 30 TYPE = kt }
			}
		}	
	}
}

system_event = {
	id = exe_invasion.2502
	hide_window = yes
	is_triggered_only = yes
	trigger = { is_variable_set = kuat_support_battle_add_variable }
	immediate = {
		if = {
			limit = { 
				any_fleet_in_system = {
					exists = owner
					owner = { is_ai = no }
					is_in_combat = yes
					has_enable_flag_ship_system_true = yes 
				}
			}
			system_event = { id = exe_invasion.2502 days = 3 }
			switch = {
				trigger = has_star_flag
				kuat_super_flagship_4_enough_support = { inline_script = { script = kuat_battle_event/kuat_exe_support_checksum ID = 4 } }
				kuat_super_flagship_2_enough_support = { inline_script = { script = kuat_battle_event/kuat_exe_support_checksum ID = 2 } }
				kuat_super_flagship_1_enough_support = { inline_script = { script = kuat_battle_event/kuat_exe_support_checksum ID = 1 } }
			}
		}
		else = { kuat_battle_kuat_star_flagship_clear_all_caculation = yes }
	}
}

fleet_event = {
	id = exe_invasion.2503
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_variable_set = kuat_star_flagship_nonsupport_battle_times
		check_variable = { 
			which = kuat_star_flagship_nonsupport_battle_times 
			value < value:kuat_star_flagship_nonsupport_field_battle_times 
		}
	}
	immediate = {
		if = {
			limit = { 
				is_in_combat = no
				exists = solar_system 
				solar_system = { has_kuat_support_modifier_star_flag = yes }
			}
			create_message = {
				type = kuat_fleet_suppilyment_reloaded
				localization = kuat_fleet_suppilyment_reloaded_desc
				variable = {
					type = name
					localization = KUAT_FLEET_NAME
					scope = root
				}
				target = root
				recipient = root.owner
				days = 30
			}
			set_variable = { which = kuat_star_flagship_nonsupport_battle_times value = value:kuat_star_flagship_nonsupport_field_battle_times }
			every_owned_ship = { kuat_battle_remove_repetable_modifier_iep = yes }
		}
		fleet_event = { id = exe_invasion.2503 days = 60 }
	}
}