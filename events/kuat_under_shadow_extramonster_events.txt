#任务清单
#// 流浪者危机 //
#// 0.流浪者舰船当前进度：10/10

#// 1.完成流浪者（流浪者）危机的对应配置，将本文件内的TODO基本配置完毕（星系√，恒星√，特殊计划√，星系特效√，局势√，刷兵脚本配置√，舰船行为脚本配置√等）√
#// 2.完成流浪者危机（流浪者）的对应文本资料（局势的前奏√，危机的过程文案）√

#// 3.危机刷新机制 √
#// 4.危机初始化 √

#// 5.危机结算机制 √
#// 6.危机流程 √

#// 7.危机机制1：采用无限帝国设计，享有无限帝国机制使用权 √
#// 8.危机机制2：每轰炸毁一个星球，刷新一个舰队√
#// 9.危机机制3：流浪者舰船均拥有多次复活次数 √
#// 10.危机机制4：防卫舰队在交战时将会复制玩家进攻舰队的10%-30%,概率均为1/10,且必定复制1艘√



namespace = kuat_extramonster
#Notification: Approaching rim system. #通知：危机前奏，通知后危机生成
country_event = { 
	id = kuat_extramonster.8
	title = "kuat_extramonster.8.name"
	desc = "kuat_extramonster.8.desc"
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire5_room }
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	show_sound = event_yellow_alert
	location = root.capital_scope
	is_triggered_only = yes
	immediate = { 
		set_global_flag = kuat_extramonster_7_fired 
		set_update_modifiers_batch = begin
		random_system = {
			limit = { has_star_flag = myst_system_5 }
			star = {
				create_ambient_object = { type = "star_explosion" play_animation_once = yes location = this }
				last_created_ambient_object = { set_location = { target = prev distance = 0 angle = random } }
				create_ambient_object = { type = "destroyed_system" location = this }
				last_created_ambient_object = { set_ambient_object_flag = destroyed_system_effect set_location = { target = prev  distance = 0  angle = random  } }
				set_planet_entity = { entity = starforge_avoid_entity }
				set_planet_size = -1
			}
			every_system_planet = {
				limit = { is_star = no }
				destroy_colony = yes
				remove_planet = yes
			}
			isolate_system = yes
			every_fleet_in_system = { destroy_fleet = this }
			set_star_flag = ag_no_jump_in_system
			add_modifier = { modifier = Kuat_contractor_F_faclitlty_Forbidden }
			star = { create_ambient_object = { type = "kuat_plague_storm_1" location = this } }
		}
		set_update_modifiers_batch = end
	}
	option = { name = "kuat_extramonster.8.a" }
}

#Invasion begin.  on_monthly
event = {
	id = kuat_extramonster.9
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = kuat_extramonster_7_fired
		NOT = { has_global_flag = kuat_extramonster_begin }
	}
	immediate = {
		set_update_modifiers_batch = begin
		set_global_flag = kuat_extramonster_begin
		create_country = {
			name = "Name_Kuat_Contractor"
			name_list = Eternal_Fleet
			type = kuat_contractor_hostile
			flag = {
				icon = {
					category = "Drft"
					file = "Logo_faction_drifters.dds"
				}
				background = {
					category = "backgrounds"
					file = "00_solid.dds"
				}
				colors = { "green" "black" "null" "null" }
			}
			ignore_initial_colony_error = yes
		}
		last_created_country = {
			save_global_event_target_as = kuat_contractor_hostile
			add_ship_design = last_created_design
			add_modifier = { modifier = Elternal_creating }
		}
		while = { count = 6 random_system = {
			limit = {
				is_star_class = sc_kuat_white_hole
				NOT = { has_star_flag = kuat_white_hole_star_in_system }
			}
			kuat_contractor_create_elternal_system_warbase = yes
			system_star = { 
				planet_event = { id = kuat_extramonster.11 days = 10 }
				planet_event = { id = kuat_extramonster.11 days = 20 }
				planet_event = { id = kuat_extramonster.11 days = 30 }
				planet_event = { id = kuat_extramonster.11 days = 40 }
				planet_event = { id = kuat_extramonster.11 days = 50 }
			}
			event_target:global_event_country = { change_variable = { which = kuat_white_hole_var value = 1 } }
			system_event = { id = kuat_extramonster.24 days = 180 }
			set_star_flag = kuat_white_hole_star
			set_timed_star_flag = { flag = kuat_white_hole_star_in_system days = 30 }
		} }
		every_country = {
			limit = { NOT = { is_kuat_contractor_faction = yes } }
			establish_communications_no_message = event_target:kuat_contractor_hostile
			country_event = { id = kuat_extramonster.10 }
		}
		every_country = {
			limit = { is_ai = no }
			country_event = { id = kuat_extramonster.25 days = 5 }
		}
		set_update_modifiers_batch = end
	}
}

#Notification: Extra crisis begin.#通知：危机向银河宣告发生（通知事件）
country_event = {
	id = kuat_extramonster.10
	title = "kuat_extramonster.10.name"
	desc = "kuat_extramonster.10.a.desc"
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire4_room }
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	show_sound = event_red_alert
	location = root.capital_scope
	is_triggered_only = yes
	option = {
		name = "kuat_extramonster.10.a"
		hidden_effect = { country_event = { id = kuat_extramonster.102 days = 1 } }
	}
}

#Notification: Extra crisis talking. #外交：流浪者发表通告
country_event = {
	id = kuat_extramonster.102
	title = "kuat_extramonster.102.name"
	desc = { trigger = {
		success_text = {
			NOR = {
				has_country_flag = fired_kuat_extramonster.102.b
				has_country_flag = fired_kuat_extramonster.102.c
			}
			text = "kuat_extramonster.102.desc"
		}
		success_text = {
			has_country_flag = fired_kuat_extramonster.102.b
			text = "kuat_extramonster.102.b.desc"
		}
		success_text = {
			has_country_flag = fired_kuat_extramonster.102.c
			text = "kuat_extramonster.102.c.desc"
		}
	} }
	diplomatic = yes
	picture_event_data = { room = no_video_feed_room }
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	show_sound = event_red_alert
	location = root.capital_scope
	is_triggered_only = yes
	immediate = {  
		begin_event_chain = { event_chain = kuat_contractor_exe_invasion_chain }
	}
	option = {
		name = kuat_extramonster.102.b
		hidden_effect = { 
			set_country_flag = fired_kuat_extramonster.102.b
			remove_country_flag = fired_kuat_extramonster.102.c
			country_event = { id = kuat_extramonster.102 } 
		}
	}
	option = {
		name = kuat_extramonster.102.c
		hidden_effect = { 
			set_country_flag = fired_kuat_extramonster.102.c
			remove_country_flag = fired_kuat_extramonster.102.b
			country_event = { id = kuat_extramonster.102 } 
		}
	}
	option = { name = kuat_extramonster.102.a ai_chance = { weight = 100 } }
}

#Invasion fleet arrived. 
planet_event = {
	id = kuat_extramonster.11
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = kuat_extramonster_begin
		NOT = { has_global_flag = kuat_extramonster_ended }
	}
	immediate = {
		set_update_modifiers_batch = begin
		kuat_contractor_create_retrun_invasion_fleet_detail = yes
		every_country = {
			limit = { has_event_chain = kuat_contractor_exe_invasion_chain }
			add_event_chain_counter = { 
				event_chain = kuat_contractor_exe_invasion_chain 
				counter = kuat_contractor_exe_invasion_fleet amount = 1 
			}
		}
		event_target:kuat_contractor_hostile = { every_owned_fleet = {
			limit = { has_fleet_flag = kuat_contractor_invasion_fleet is_fleet_idle = yes }
			fleet_event = { id = kuat_extramonster.12 days = 1 random = 2 }
		} }
		set_update_modifiers_batch = end
	}
}

#white hole convertion rainforcement
system_event = {
	id = kuat_extramonster.24
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		exists = event_target:kuat_contractor_hostile
		NOT = { has_star_flag = kuat_white_hole_rainforce_disable }
	}
	immediate = {
		system_star = { kuat_contractor_create_retrun_invasion_fleet_detail = yes }
		every_country = {
			limit = { has_event_chain = kuat_contractor_exe_invasion_chain }
			add_event_chain_counter = { 
				event_chain = kuat_contractor_exe_invasion_chain 
				counter = kuat_contractor_exe_invasion_fleet amount = 1 
			}
		}
		system_event = { id = kuat_extramonster.24 days = 360 random = 360 }
	}
}

#Notification: white hole convertion #流浪者开始建设恒星那什么器
country_event = {
	id = kuat_extramonster.25
	title = "kuat_extramonster.25.title"
	desc = "kuat_extramonster.25.desc"
	diplomatic = yes
	picture_event_data = { room = ancient_AI_room }
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	show_sound = event_wind_ruins
	is_triggered_only = yes
	trigger = { NOT = { has_event_chain = kuat_contractor_exe_invasion_chain } }
	option = { name = kuat_extramonster.25.a }
}

#Invasion fleet action.  attack player
fleet_event = {
	id = kuat_extramonster.12
	hide_window = yes
	is_triggered_only = yes
	trigger = { 
		exists = this 
		has_global_flag = kuat_extramonster_begin
		NOT = { has_global_flag = kuat_extramonster_ended }
	}
	immediate = { kuat_contractor_exe_invasion_fleet_action = yes } 
}

#Invasion fleet action on win a space battle. 
country_event = { 
	id = kuat_extramonster.13
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = kuat_extramonster_begin
		NOT = { has_global_flag = kuat_extramonster_ended }
		is_kuat_contractor_faction = yes
		fromfrom = { fleet = { has_fleet_flag = kuat_contractor_invasion_fleet } }
		fromfromfrom = { OR = {
			is_ship_class = shipclass_starbase
			is_ship_class = shipclass_military
		} }
	}
	after = {
		fromfrom = {
			solar_system = {
				every_fleet_in_system = {
					limit = {
						exists = owner
						owner = { is_kuat_contractor_faction = yes }
						has_fleet_flag = kuat_contractor_invasion_fleet
					}
					clear_orders = yes
					clear_fleet_actions = this
					fleet_event = { id = kuat_extramonster.12 days = 3 random = 2 }
				}
			}
		}
	}
}

#Invasion fleet action on orbit planet. 
country_event = { 
	id = kuat_extramonster.14
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = kuat_extramonster_begin
		NOT = { has_global_flag = kuat_extramonster_ended }
		is_kuat_contractor_faction = yes
		from = { has_fleet_flag = kuat_contractor_invasion_fleet }
		fromfrom = { OR = {
			is_star = yes
			NOT = { exists = owner }
		} }
	}
	immediate = {
		from = {
			clear_orders = yes
			clear_fleet_actions = this
			fleet_event = { id = kuat_extramonster.12 days = 3 random = 2 }
		}
	}
}

#Reset invasion fleet action if two fleet in same system. 
fleet_event = {
	id = kuat_extramonster.15
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = kuat_extramonster_begin
		NOT = { has_global_flag = kuat_extramonster_ended }
		has_fleet_flag = kuat_contractor_invasion_fleet
		from = {
			NOR = {
				kuat_is_kuat_system = yes
				has_star_flag = kuat_military_base_local_home
				has_star_flag = kuat_military_sublocal_home
			}
			any_fleet_in_system = {
				NOT = { is_same_value = root }
				has_fleet_flag = kuat_contractor_invasion_fleet
			}
		}
	}
	immediate = {
		clear_orders = yes
		clear_fleet_actions = this
		from = {
			random_neighbor_system = {
				system_star = { root = { auto_move_to_planet = { target = prev clear_auto_move_on_arrival = yes } } }
			}
		}
	}
}

#Check every month to prevent bugs.
event = {
	id = kuat_extramonster.16
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = kuat_extramonster_begin
		NOT = { has_global_flag = kuat_extramonster_ended }
		exists = event_target:kuat_contractor_hostile
		event_target:kuat_contractor_hostile = {
			any_owned_fleet = {
				exists = this
				is_fleet_idle = yes
				has_fleet_flag = kuat_contractor_invasion_fleet
				NAND = {
					exists = orbit
					orbit = {
						NOT = { is_star = yes }
						exists = owner
						owner = { is_hostile = event_target:kuat_contractor_hostile }
						exists = controller
						controller = { is_hostile = event_target:kuat_contractor_hostile }
					}
				}
			}
		}
	}
	immediate = {
		event_target:kuat_contractor_hostile = {
			every_owned_fleet = {
				limit = {
					exists = this
					is_fleet_idle = yes
					has_fleet_flag = kuat_contractor_invasion_fleet
					NAND = {
						exists = orbit
						orbit = {
							NOT = { is_star = yes }
							exists = owner
							owner = { is_hostile = event_target:kuat_contractor_hostile }
							exists = controller
							controller = { is_hostile = event_target:kuat_contractor_hostile }
						}
					}
				}
				clear_orders = yes
				clear_fleet_actions = this
				fleet_event = { id = kuat_extramonster.12 days = 3 random = 2 }
			}
		}
	}
}

#Invasion fleet bombard a planet. counter
planet_event = {
	id = kuat_extramonster.21
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		exists = owner
		has_global_flag = kuat_extramonster_begin
		NOT = { has_global_flag = kuat_extramonster_ended }
		planet_devastation = 100
		from = { is_kuat_contractor_faction = yes }
	}
	immediate = { 
		reset_planet = yes
		destroy_colony = yes
		owner = { country_event = { id = kuat_extramonster.34 } } 
		every_country = {
			limit = {
				NOT = { is_same_value = event_target:kuat_contractor_hostile }
				has_event_chain = kuat_contractor_exe_invasion_chain
			}
			add_event_chain_counter = { event_chain = kuat_contractor_exe_invasion_chain counter = kuat_contractor_exe_invasion_planet_destroyed amount = 1 }
			if = {
				limit = { has_event_chain = kuat_contractor_exe_invasion_chain }
				add_event_chain_counter = { event_chain = kuat_contractor_exe_invasion_chain counter = kuat_contractor_exe_invasion_planet_destroyed amount = 1 }
			}
		}
		planet_event = { id = kuat_extramonster.11 }
		solar_system = {
			every_fleet_in_system = {
				limit = {
					exists = owner
					owner = { is_kuat_contractor_faction = yes }
					has_fleet_flag = kuat_contractor_invasion_fleet
					OR = {
						AND = { exists = orbit orbit = { is_same_value = root } }
						AND = {
							is_fleet_idle = yes
							NAND = {
								exists = orbit
								orbit = {
									NOT = { is_star = yes }
									exists = owner
									owner = { is_hostile = event_target:kuat_contractor_hostile }
								}
							}
						}
					}
				}
				clear_orders = yes
				clear_fleet_actions = this
				fleet_event = { id = kuat_extramonster.12 days = 1 random = 2 }
			}
		}	
	}
}

#Notification: bombarment #星球被轰炸转化为舰队
country_event = {
	id = kuat_extramonster.34
	title = "kuat_extramonster.21.name"
	desc = "kuat_extramonster.21.a.desc"
	diplomatic = yes
	picture_event_data = { room = nuclear_explosion_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_super_explosion
	is_triggered_only = yes
	option = { name = "kuat_extramonster.21.a" ai_chance = { weight = 100 } }
}

#Invasion fleet killed counter. 
country_event = {
	id = kuat_extramonster.22
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = kuat_extramonster_begin
		is_kuat_contractor_faction = yes
	}
	immediate = {
		from = {
			add_event_chain_counter = { event_chain = kuat_contractor_exe_invasion_chain counter = kuat_contractor_exe_invasion_ship_kill_by_us amount = 1 }
			if = {
				limit = { has_event_chain = kuat_contractor_exe_invasion_chain }
				add_event_chain_counter = { event_chain = kuat_contractor_exe_invasion_chain counter = kuat_contractor_exe_invasion_ship_kill_by_us amount = 1 }
			}
		}
		every_country = {
			limit = {
				has_event_chain = kuat_contractor_exe_invasion_chain
				NOT = { is_same_value = from }
			}
			add_event_chain_counter = { event_chain = kuat_contractor_exe_invasion_chain counter = kuat_contractor_exe_invasion_ship_kill_by_other amount = 1 }
			if = {
				limit = { has_event_chain = kuat_contractor_exe_invasion_chain }
				add_event_chain_counter = { event_chain = kuat_contractor_exe_invasion_chain counter = kuat_contractor_exe_invasion_ship_kill_by_other amount = 1 }
			}
		}
	}
}

#Invasion fleet victim counter. 
country_event = {
	id = kuat_extramonster.23
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = kuat_extramonster_begin
		is_kuat_contractor_faction = yes
		from = { NOT = { is_kuat_contractor_faction = yes } }
	}
	immediate = {
		every_country = {
			limit = {
				NOT = { is_same_value = event_target:kuat_contractor_hostile }
				has_event_chain = kuat_contractor_exe_invasion_chain
			}
			add_event_chain_counter = { event_chain = kuat_contractor_exe_invasion_chain counter = kuat_contractor_exe_invasion_victim amount = 1 }
			if = {
				limit = { has_event_chain = kuat_contractor_exe_invasion_chain }
				add_event_chain_counter = { event_chain = kuat_contractor_exe_invasion_chain counter = kuat_contractor_exe_invasion_victim amount = 1 }
			}
		}
		from = { change_variable = { which = eternal_bornus_var value = 1 } }
	}
}

#An invasion fleet has been destroyed.  counter
country_event = {
	id = kuat_extramonster.31
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = kuat_extramonster_begin
		from = { is_kuat_contractor_faction = yes }
		fromfromfrom = { has_fleet_flag = kuat_contractor_invasion_fleet }
	}
	immediate = {
		fromfromfrom = { if = {
			limit = { NOT = { has_fleet_flag = fire_only_once_temple } }
			set_timed_fleet_flag = { flag = fire_only_once_temple days = 1 }
			every_country = {
				limit = { has_event_chain = kuat_contractor_exe_invasion_chain }
				add_event_chain_counter = { event_chain = kuat_contractor_exe_invasion_chain counter = kuat_contractor_exe_invasion_fleet amount = -1 }
			}
			event_target:global_event_country = { change_variable = { which = count_destroy_exm_kuat_fleet value = 1 } }
		} }
	}
}

#第一个白洞设施可以进行研究的通知事件，尽量写多点这个
country_event = {
	id = kuat_extramonster.33
	title = "kuat_extramonster.33.name"
	desc = "kuat_extramonster.33.desc"
	diplomatic = yes
	picture_event_data = { room = ancient_databank_room }
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	show_sound = event_red_alert
	fire_only_once = yes
	location = event_target:kuat_white_hole_star
	trigger = {
		is_ai = no
		has_global_flag = kuat_extramonster_begin
		NOT = { has_global_flag = kuat_extramonster_ended }
		exists = event_target:kuat_contractor_hostile
		any_system = {
			has_star_flag = kuat_white_hole_star
			has_star_flag = kuat_white_hole_rainforce_attack_active
			NOT = { has_star_flag = kuat_white_hole_rainforce_disable }
		}
		event_target:global_event_country = { 
			check_variable = { which = kuat_white_hole_var value > 0 }
			check_variable = { which = count_destroy_exm_kuat_fleet value > 30 } 
		}
		NOT = { is_variable_set = kuat_white_hole_star_enable }
		NOT = { has_global_flag = kuat_white_hole_star_unlock_temple }
		NOT = { has_special_project = exe_rebuild_control_whitehole_facility }
	}
	mean_time_to_happen = { months = 3 }
	immediate = { 
		set_global_flag = kuat_white_hole_star_unlock_temple 
		random_system = {
			limit = {
				has_star_flag = kuat_white_hole_star
				has_star_flag = kuat_white_hole_rainforce_attack_active
				NOT = { has_star_flag = kuat_white_hole_rainforce_disable }
			}
			save_event_target_as = kuat_white_hole_star
		}
	}
	option = {
		name = "kuat_extramonster.33.a"
		enable_special_project = {
			name = exe_rebuild_control_whitehole_facility
			owner = root location = event_target:kuat_white_hole_star
		}
	}
}

#第二个白洞设施可以进行研究的通知事件，尽量写多点这个
country_event = {
	id = kuat_extramonster.331
	title = "kuat_extramonster.331.name"
	desc = "kuat_extramonster.331.desc"
	diplomatic = yes
	fire_only_once = yes
	picture_event_data = { room = ancient_databank_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_red_alert
	location = event_target:kuat_white_hole_star
	trigger = {
		is_ai = no
		has_global_flag = kuat_extramonster_begin
		NOT = { has_global_flag = kuat_extramonster_ended }
		exists = event_target:kuat_contractor_hostile
		any_system = {
			has_star_flag = kuat_white_hole_star
			has_star_flag = kuat_white_hole_rainforce_attack_active
			NOT = { has_star_flag = kuat_white_hole_rainforce_disable }
		}
		event_target:global_event_country = { 
			check_variable = { which = kuat_white_hole_var value > 0 }
			check_variable = { which = count_destroy_exm_kuat_fleet value > 40 } 
		}
		check_variable = { which = kuat_white_hole_star_enable value = 1 }
		NOT = { has_global_flag = kuat_white_hole_star_unlock_temple }
		NOT = { has_special_project = exe_rebuild_control_whitehole_facility }
	}
	mean_time_to_happen = { months = 3 }
	immediate = { 
		set_global_flag = kuat_white_hole_star_unlock_temple 
		random_system = {
			limit = {
				has_star_flag = kuat_white_hole_star
				has_star_flag = kuat_white_hole_rainforce_attack_active
				NOT = { has_star_flag = kuat_white_hole_rainforce_disable }
			}
			save_event_target_as = kuat_white_hole_star
		}
	}
	option = {
		name = "kuat_extramonster.331.a"
		enable_special_project = {
			name = exe_rebuild_control_whitehole_facility
			owner = root location = event_target:kuat_white_hole_star
		}
	}
}

##第三个白洞设施可以进行研究的通知事件，尽量写多点这个
country_event = {
	id = kuat_extramonster.332
	title = "kuat_extramonster.332.name"
	desc = "kuat_extramonster.332.desc"
	diplomatic = yes
	picture_event_data = { room = ancient_databank_room }
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	show_sound = event_red_alert
	fire_only_once = yes
	location = event_target:kuat_white_hole_star
	trigger = {
		is_ai = no
		has_global_flag = kuat_extramonster_begin
		NOT = { has_global_flag = kuat_extramonster_ended }
		exists = event_target:kuat_contractor_hostile
		any_system = {
			has_star_flag = kuat_white_hole_star
			has_star_flag = kuat_white_hole_rainforce_attack_active
			NOT = { has_star_flag = kuat_white_hole_rainforce_disable }
		}
		event_target:global_event_country = { 
			check_variable = { which = kuat_white_hole_var value > 0 }
			check_variable = { which = count_destroy_exm_kuat_fleet value > 50 } 
		}
		check_variable = { which = kuat_white_hole_star_enable value = 2 }
		NOT = { has_global_flag = kuat_white_hole_star_unlock_temple }
		NOT = { has_special_project = exe_rebuild_control_whitehole_facility }
	}
	mean_time_to_happen = { months = 3 }
	immediate = { 
		set_global_flag = kuat_white_hole_star_unlock_temple 
		random_system = {
			limit = {
				has_star_flag = kuat_white_hole_star
				has_star_flag = kuat_white_hole_rainforce_attack_active
				NOT = { has_star_flag = kuat_white_hole_rainforce_disable }
			}
			save_event_target_as = kuat_white_hole_star
		}
	}
	option = {
		name = "kuat_extramonster.332.a"
		enable_special_project = {
			name = exe_rebuild_control_whitehole_facility
			owner = root location = event_target:kuat_white_hole_star
		}
	}
}

##第四个白洞设施可以进行研究的通知事件，尽量写多点这个
country_event = {
	id = kuat_extramonster.333
	title = "kuat_extramonster.333.name"
	desc = "kuat_extramonster.333.desc"
	diplomatic = yes
	picture_event_data = { room = ancient_databank_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_red_alert
	fire_only_once = yes
	location = event_target:kuat_white_hole_star
	trigger = {
		is_ai = no
		has_global_flag = kuat_extramonster_begin
		NOT = { has_global_flag = kuat_extramonster_ended }
		exists = event_target:kuat_contractor_hostile
		any_system = {
			has_star_flag = kuat_white_hole_star
			has_star_flag = kuat_white_hole_rainforce_attack_active
			NOT = { has_star_flag = kuat_white_hole_rainforce_disable }
		}
		event_target:global_event_country = { 
			check_variable = { which = kuat_white_hole_var value > 0 }
			check_variable = { which = count_destroy_exm_kuat_fleet value > 30 } 
		}
		check_variable = { which = kuat_white_hole_star_enable value = 3 }
		NOT = { has_global_flag = kuat_white_hole_star_unlock_temple }
		NOT = { has_special_project = exe_rebuild_control_whitehole_facility }
	}
	mean_time_to_happen = { months = 3 }
	immediate = { 
		set_global_flag = kuat_white_hole_star_unlock_temple 
		random_system = {
			limit = {
				has_star_flag = kuat_white_hole_star
				has_star_flag = kuat_white_hole_rainforce_attack_active
				NOT = { has_star_flag = kuat_white_hole_rainforce_disable }
			}
			save_event_target_as = kuat_white_hole_star
		}
	}
	option = {
		name = "kuat_extramonster.333.a"
		enable_special_project = {
			name = exe_rebuild_control_whitehole_facility
			owner = root location = event_target:kuat_white_hole_star
		}
	}
}

##第五个白洞设施可以进行研究的通知事件，尽量写多点这个
country_event = {
	id = kuat_extramonster.334
	title = "kuat_extramonster.334.name"
	desc = "kuat_extramonster.334.desc"
	diplomatic = yes
	picture_event_data = { room = ancient_databank_room }
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	show_sound = event_red_alert
	fire_only_once = yes
	location = event_target:kuat_white_hole_star
	trigger = {
		is_ai = no
		has_global_flag = kuat_extramonster_begin
		NOT = { has_global_flag = kuat_extramonster_ended }
		exists = event_target:kuat_contractor_hostile
		any_system = {
			has_star_flag = kuat_white_hole_star
			has_star_flag = kuat_white_hole_rainforce_attack_active
			NOT = { has_star_flag = kuat_white_hole_rainforce_disable }
		}
		event_target:global_event_country = { 
			check_variable = { which = kuat_white_hole_var value > 0 }
			check_variable = { which = count_destroy_exm_kuat_fleet value > 70 } 
		}
		check_variable = { which = kuat_white_hole_star_enable value = 4 }
		NOT = { has_global_flag = kuat_white_hole_star_unlock_temple }
		NOT = { has_special_project = exe_rebuild_control_whitehole_facility }
	}
	mean_time_to_happen = { months = 3 }
	immediate = { 
		set_global_flag = kuat_white_hole_star_unlock_temple 
		random_system = {
			limit = {
				has_star_flag = kuat_white_hole_star
				has_star_flag = kuat_white_hole_rainforce_attack_active
				NOT = { has_star_flag = kuat_white_hole_rainforce_disable }
			}
			save_event_target_as = kuat_white_hole_star
		}
	}
	option = {
		name = "kuat_extramonster.334.a"
		enable_special_project = {
			name = exe_rebuild_control_whitehole_facility
			owner = root location = event_target:kuat_white_hole_star
		}
	}
}

##最后一个白洞设施可以进行研究的通知事件，尽量写多点这个
country_event = {
	id = kuat_extramonster.335
	title = "kuat_extramonster.335.name"
	desc = "kuat_extramonster.335.desc"
	diplomatic = yes
	picture_event_data = { room = ancient_databank_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_red_alert
	fire_only_once = yes
	location = event_target:kuat_white_hole_star
	trigger = {
		is_ai = no
		has_global_flag = kuat_extramonster_begin
		NOT = { has_global_flag = kuat_extramonster_ended }
		exists = event_target:kuat_contractor_hostile
		any_system = {
			has_star_flag = kuat_white_hole_star
			has_star_flag = kuat_white_hole_rainforce_attack_active
			NOT = { has_star_flag = kuat_white_hole_rainforce_disable }
		}
		event_target:global_event_country = { 
			check_variable = { which = kuat_white_hole_var value > 0 }
			check_variable = { which = count_destroy_exm_kuat_fleet value > 80 } 
		}
		check_variable = { which = kuat_white_hole_star_enable value = 5 }
		NOT = { has_global_flag = kuat_white_hole_star_unlock_temple }
		NOT = { has_special_project = exe_rebuild_control_whitehole_facility }
	}
	mean_time_to_happen = { months = 3 }
	immediate = { 
		set_global_flag = kuat_white_hole_star_unlock_temple 
		random_system = {
			limit = {
				has_star_flag = kuat_white_hole_star
				has_star_flag = kuat_white_hole_rainforce_attack_active
				NOT = { has_star_flag = kuat_white_hole_rainforce_disable }
			}
			save_event_target_as = kuat_white_hole_star
		}
	}
	option = {
		name = "kuat_extramonster.335.a"
		enable_special_project = {
			name = exe_rebuild_control_whitehole_facility
			owner = root location = event_target:kuat_white_hole_star
		}
	}
}

#special project finished
ship_event = {
	id = kuat_extramonster.37
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		exists = owner
		owner = { is_player_country = yes }
		has_global_flag = kuat_extramonster_begin
		NOT = { has_global_flag = kuat_extramonster_ended }
		exists = solar_system
		solar_system = {
			has_star_flag = kuat_white_hole_star
			NOT = { has_star_flag = kuat_white_hole_rainforce_disable }
		}
	}
	immediate = {
		solar_system = {
			set_star_class = sc_black_hole
			star = {
				create_ambient_object = { type = "star_explosion" play_animation_once = yes location = this }
				last_created_ambient_object = { set_location = { target = prev distance = 0 angle = random } }
				create_ambient_object = { type = "destroyed_system" location = this }
				last_created_ambient_object = { set_ambient_object_flag = destroyed_system_effect set_location = { target = prev  distance = 0  angle = random  } }
				change_pc = pc_black_hole
			}
			set_star_flag = kuat_white_hole_rainforce_disable
		}
		owner = {
			change_variable = { which = kuat_white_hole_star_enable value = 1 }
			country_event = { id = kuat_extramonster.39 }
		}
	}
}

#Notificaton: White hole is eliminate 通知：白洞被关闭转化的集成外交事件
country_event = {
	id = kuat_extramonster.39
	title = "kuat_extramonster.39.title"
	desc = {
		trigger = { check_variable = { which = kuat_white_hole_star_enable value = 1 } }
		text = "kuat_extramonster.39.a.desc"
	}
	desc = {
		trigger = { check_variable = { which = kuat_white_hole_star_enable value = 2 } }
		text = "kuat_extramonster.39.b.desc"
	}
	desc = {
		trigger = { check_variable = { which = kuat_white_hole_star_enable value = 3 } }
		text = "kuat_extramonster.39.c.desc"
	}
	desc = {
		trigger = { check_variable = { which = kuat_white_hole_star_enable value = 4 } }
		text = "kuat_extramonster.39.d.desc"
	}
	desc = {
		trigger = { check_variable = { which = kuat_white_hole_star_enable value = 5 } }
		text = "kuat_extramonster.39.e.desc"
	}
	desc = {
		trigger = { check_variable = { which = kuat_white_hole_star_enable value = 6 } }
		text = "kuat_extramonster.39.f.desc"
	}
	diplomatic = yes
	picture_event_data = { room = no_video_feed_room }
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	show_sound = event_wind_ruins
	is_triggered_only = yes
	trigger = { 
		is_player_country = yes
		has_global_flag = kuat_extramonster_begin
		NOT = { has_global_flag = kuat_extramonster_ended }
	}

	#1
	option = { 
		name = kuat_extramonster.39.a.1 
		trigger = { check_variable = { which = kuat_white_hole_star_enable value = 1 } }
		response_text = kuat_extramonster.39.a.1.resp
	}

	#2
	option = { 
		name = kuat_extramonster.39.b.1
		trigger = { check_variable = { which = kuat_white_hole_star_enable value = 2 } } 
		response_text = kuat_extramonster.39.b.1.resp
	}

	#3
	option = { 
		name = kuat_extramonster.39.c.1 
		trigger = { check_variable = { which = kuat_white_hole_star_enable value = 3 } }
		response_text = kuat_extramonster.39.c.1.resp
	}

	#4
	option = { 
		name = kuat_extramonster.39.d.1 
		trigger = { check_variable = { which = kuat_white_hole_star_enable value = 4 } }
		response_text = kuat_extramonster.39.d.1.resp 
	}

	#5
	option = { 
		name = kuat_extramonster.39.e.1
		trigger = { check_variable = { which = kuat_white_hole_star_enable value = 5 } }
		response_text = kuat_extramonster.39.e.1.resp 
	}

	#6
	option = { 
		name = kuat_extramonster.39.f.1
		trigger = { check_variable = { which = kuat_white_hole_star_enable value = 6 } }
		response_text = kuat_extramonster.39.f.1.resp 
	}

	after = {
		remove_global_flag = kuat_white_hole_star_unlock_temple
	}
}

#A defense fleet destroyed, white hole research enable.  
country_event = {
	id = kuat_extramonster.301
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = kuat_extramonster_begin
		from = { is_kuat_contractor_faction = yes }
		fromfromfrom = { 
			has_fleet_flag = kuat_contractor_defenced_fleet
			exists = solar_system
			solar_system = {
				has_star_flag = kuat_white_hole_star
				NOR = { 
					has_star_flag = kuat_white_hole_rainforce_disable 
					has_star_flag = kuat_white_hole_rainforce_attack_active
				}
			}
		}
	}
	immediate = {
		every_country = {
			limit = { NOR = { 
				is_same_value = event_target:kuat_contractor_hostile 
				has_country_flag = trigger_ended_event_temple
			} }
			set_timed_country_flag = { flag = trigger_ended_event_temple days = 1 }
			country_event = { id = kuat_extramonster.302 }
		}
		fromfromfrom.solar_system = {
			set_star_flag = kuat_white_hole_rainforce_attack_active
		}
	}
}

#Notification: Invasion end.  白洞星系被攻破，白洞允许进行转化研究
country_event = {
	id = kuat_extramonster.302
	title = "kuat_extramonster.302.name"
	desc = "kuat_extramonster.302.desc"
	diplomatic = yes
	picture_event_data = { room = huge_monument_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_wind_ruins
	is_triggered_only = yes
	option = { 
		name = "kuat_extramonster.302.b" 
		ai_chance = { weight = 5 }
	}
}

#All invasion fleet destroyed, invasion end.  
country_event = {
	id = kuat_extramonster.30
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = kuat_extramonster_begin
		from = {
			is_kuat_contractor_faction = yes
			count_owned_fleet = {
				limit = { 
					has_fleet_flag = kuat_contractor_invasion_fleet 
					NOT = { is_same_value = root.fromfromfrom } 
				}
				count = 0
			}
		}
		fromfromfrom = { has_fleet_flag = kuat_contractor_invasion_fleet }
		has_global_flag = kuat_extra_contractor_wined_target
	}
	immediate = {
		every_country = {
			limit = { NOR = { 
				is_same_value = event_target:kuat_contractor_hostile 
				has_country_flag = trigger_ended_event_temple
			} }
			set_timed_country_flag = { flag = trigger_ended_event_temple days = 1 }
			country_event = { id = kuat_extramonster.35 }
		}
		add_threat = { who = root amount = 50 }
		set_global_flag = kuat_extramonster_ended
		from = { destroy_country = yes }
	}
}

#Notification: Invasion end create award.  #白洞设施完全关闭，允许关闭F设施星门，获得奖品
country_event = {
	id = kuat_extramonster.35
	title = "kuat_extramonster.35.name"
	desc = "kuat_extramonster.35.desc"
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire_room }
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	show_sound = event_wind_ruins
	is_triggered_only = yes
	option = { 
		name = "kuat_extramonster.35.b" 
		ai_chance = { weight = 5 }
		enable_special_project = {
			name = kuat_contractor_return_invasion_reward_project
			owner = root location = capital_star
		}
	}
}

#after crisis #TODO #关闭F星域以后，流浪者外交事件
country_event = {
	id = kuat_extramonster.38
	title = "kuat_extramonster.38.title"
	desc = {
		trigger = { has_country_flag = fire_once_contact }
		text = "kuat_extramonster.38.fdesc"
	}
	desc = {
		trigger = { NOT = { has_country_flag = fire_once_contact } }
		text = "kuat_extramonster.38.desc"
	}
	diplomatic = yes
	picture_event_data = { room = no_video_feed_room }
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	show_sound = event_wind_ruins
	is_triggered_only = yes
	trigger = { NOT = { has_event_chain = kuat_contractor_exe_invasion_chain } }
	option = { 
		name = kuat_extramonster.38.a 
		is_dialog_only = yes
		hidden_effect = { set_country_flag = fire_once_contact }
		response_text = kuat_extramonster.38.a.resp 
	}
	option = { 
		name = kuat_extramonster.38.b 
		is_dialog_only = yes
		hidden_effect = { set_country_flag = fire_once_contact }
		response_text = kuat_extramonster.38.b.resp 
	}
	option = { 
		name = kuat_extramonster.38.c 
		is_dialog_only = yes
		hidden_effect = { set_country_flag = fire_once_contact }
		response_text = kuat_extramonster.38.c.resp 
	}
	option = { 
		name = kuat_extramonster.38.d 
		is_dialog_only = yes
		hidden_effect = { set_country_flag = fire_once_contact }
		response_text = kuat_extramonster.38.d.resp 
	}
	option = { 
		name = kuat_extramonster.38.e
		hidden_effect = { 
			remove_country_flag = fire_once_contact 
			end_event_chain = kuat_contractor_exe_invasion_chain
			set_update_modifiers_batch = begin
			random_system = {
				limit = { has_star_flag = myst_system_5 }
				every_system_megastructure = { remove_megastructure = this }
				star = {
					create_ambient_object = { type = "star_explosion" play_animation_once = yes location = this }
					last_created_ambient_object = { set_location = { target = prev distance = 0 angle = random } }
					create_ambient_object = { type = "destroyed_system" location = this }
					last_created_ambient_object = { set_ambient_object_flag = destroyed_system_effect set_location = { target = prev  distance = 0  angle = random  } }
					set_planet_entity = { entity = starforge_avoid_entity }
					set_planet_size = -1
				}
				remove_modifier = Kuat_contractor_F_faclitlty_Forbidden
				every_system_ambient_object = { destroy_ambient_object = this }
			}
			create_ship_design = { design = Name_boss_crisis_DB_3 }
			add_ship_design = last_created_design
			create_ship_design = { design = Name_boss_crisis_DC_3 }
			add_ship_design = last_created_design
			set_update_modifiers_batch = end
		}
	}
	after = { win = yes }
}