namespace = ag_kae_ge_invasion

#######################################################
###			Galactic Empire Invasion Events			###
###				 Code by Aether Ghost				###
###					    2022-03				        ###
#######################################################

# Flag, Variables, Event Targets and other stuff:
# ag_kae_e_area_system													(Star Flag, Global Eventarget E区域唯一标识。)
# ag_kae_e_area_guardian												(Country Flag & Global Event Target & Country Type, E区域守卫。)
# ag_kae_e_habitable_segment											(Planet Flag & Global Event Target, E区域可殖民的环。)
# ag_kae_ring_struct_1 ~ ag_kae_ring_struct_11							(Planet Flags, E区域其他环区段。)
# ag_kae_e_area_arc_site_project_completed								(Country Flag, 挖完E区域的坟。)
# ag_kae_e_area_gateway_project_completed								(Country Flag, 研究完E区域星门。)
# ag_kae_no_ge_invasion_crisis											(Global Flag, 禁止天灾发生。)
# ag_kae_ge_invasion_begin												(Global Flag, 天灾已开始，天灾结束后不会被移除。)
# ag_kae_ge_invasion_ended												(Global Flag, 天灾已结束。)
# ag_kae_ge_invasion_num_portals										(event_target:global_event_country 的变量, 已生成的传送门数量。)
# ag_kae_ge_invasion_num_portals_destroyed								(event_target:global_event_country 的变量, 已被摧毁的传送门数量。)
# ag_kae_ge_invasion_country											(Country Flag & Global Event Target & Country Type, 天灾国家，轰炸修改game_rules。)
# ag_kae_ge_primary_portal												(Fleet Flag, 主传送门。)
# ag_kae_ge_secondary_portal											(Fleet Flag, 其他传送门。)
# ag_kae_ge_assault_fleet												(Fleet Flag, 在外面进攻的舰队。)
# ag_kae_portal_system													(Star Flag, 其他传送门的星系统一标识。)
# ag_kae_portal_system_1 ~ ag_kae_portal_system_6						(Star Flag, 其他传送门的星系带序号的标识。)
# ag_kae_ge_invasion_killer												(Country Flag, 打败天灾的国家。)
# ag_kae_ge_invasion_portal												(Bypass)

# Static Variables:
@ag_kae_e_area_delayed_hostility_time = 30								# 进入星系后要求离开的时间。
@ag_kae_ge_invasion_warning_delay_time = 360							# 天灾前兆每次警告通知的间隔。
@ag_kae_ge_invasion_warning_delay_random = 360							# 天灾前兆每次警告通知的间隔随机值。
@ag_kae_ge_invasion_primary_portal_num_initial_assault_fleets = 20		# 天灾主传送门自带的舰队数量。
@ag_kae_ge_invasion_secondary_portal_delay_time = 180					# 天灾传送门刷新间隔。
@ag_kae_ge_invasion_secondary_portal_delay_random = 180					# 天灾传送门刷新间隔随机值。
@ag_kae_ge_invasion_reinforcement_time = 180							# 天灾援军生成间隔。
@ag_kae_ge_invasion_reinforcement_random = 120							# 天灾援军生成间隔随机值。

####################################
##	Stage 1: Pre Contact Events	  ##
##			Event ID: 1xx	      ##
####################################
# Ethernal System Tale
country_event = {
	id = ag_kae_ge_invasion.100
	title = "ag_kae_ge_invasion.100.title"
	desc = "ag_kae_ge_invasion.100.desc"
	diplomatic = yes
	picture_event_data = {
		portrait = root.ruler
		room = Eternal_Empire_room
	}
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	show_sound = event_wind_ruins
	is_triggered_only = yes
	option = { 
		name = ag_kae_ge_invasion.100.a 
		is_dialog_only = yes
		response_text = ag_kae_ge_invasion.100.a.resp 
	}
	option = { 
		name = ag_kae_ge_invasion.100.c 
		is_dialog_only = yes
		response_text = ag_kae_ge_invasion.100.c.resp 
	}
	option = { 
		name = ag_kae_ge_invasion.100.e
		response_text = ag_kae_ge_invasion.100.e.resp 
	}
}

# Spawn System.
country_event = {
    id = ag_kae_ge_invasion.101
    hide_window = yes
	fire_only_once = yes
	mean_time_to_happen = { years = 5 }
	trigger = { has_country_flag = eternal_origin_legacy_event_over }
	immediate = {
		random_system_within_border = {
			limit = { NOT = { any_system_planet = { is_capital = yes } } }
			save_event_target_as = ag_kae_target_system
		}
		if = {
			limit = { NOT = { exists = event_target:ag_kae_target_system } }
			random_system_within_border = { save_event_target_as = ag_kae_target_system }
			if = {
				limit = { NOT = { exists = event_target:ag_kae_target_system } }
				random_system = { save_event_target_as = ag_kae_target_system }
			}
		}
		event_target:ag_kae_target_system = {
			spawn_system = {
				min_distance >= 20
				max_distance <= 50
				initializer = "ag_kae_e_area_init"
				hyperlane = yes
			}
		}
		random_system = {
			limit = { has_star_flag = ag_kae_e_area_system }
			save_global_event_target_as = ag_kae_e_area_system
		}
		country_event = { id = ag_kae_ge_invasion.102 days = 2 random = 5 }
		every_playable_country = {
			limit = { NOT = { is_same_value = root } }
			country_event = { id = ag_kae_ge_invasion.103 days = 7 random = 7 }
		}
	}
}
country_event = {
	id = ag_kae_ge_invasion.102
	title = "ag_kae_ge_invasion.102.name"
	desc = "ag_kae_ge_invasion.102.desc"
	picture_event_data = { room = satellite_in_orbit_room }
	show_sound = event_sensor_ping
	location = event_target:ag_kae_target_system
	diplomatic = yes
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	is_triggered_only = yes
	immediate = { country_event = { id = ag_kae_ge_invasion.100 days = 1 random = 2 } }
	option = { name = "ag_kae_ge_invasion.102.a" }
}
country_event = {
	id = ag_kae_ge_invasion.103
	title = "ag_kae_ge_invasion.103.name"
	desc = "ag_kae_ge_invasion.103.desc"
	picture_event_data = { room = satellite_in_orbit_room }
	show_sound = event_sensor_ping
	location = event_target:ag_kae_target_system
	diplomatic = yes
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	is_triggered_only = yes
	option = { name = "ag_kae_ge_invasion.103.a" }
}

# on_entering_system_fleet, Entering system events.
fleet_event = {
	id = ag_kae_ge_invasion.110
	title = "ag_kae_ge_invasion.110.name"
	desc = "ag_kae_ge_invasion.110.desc"
	picture_event_data = { room = ag_event_ship_in_orbit_room }
	show_sound = event_yellow_alert
	location = from
	diplomatic = yes
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"

	is_triggered_only = yes
	trigger = {
		exists = owner
		from = { has_star_flag = ag_kae_e_area_system }
		owner = { NOT = { has_country_flag = ag_kae_ge_invasion_110_fired } }
	}
	immediate = {
		owner = {
			set_country_flag = ag_kae_ge_invasion_110_fired
			if = {
				limit = { NOT = { has_communications = event_target:ag_kae_e_area_guardian } }
				establish_communications_no_message = event_target:ag_kae_e_area_guardian
			}
		}
	}

	option = {
		name = "ag_kae_ge_invasion.110.a"
		hidden_effect = { owner = { country_event = { id = ag_kae_ge_invasion.111 } } }
	}
	option = {
		name = "ag_kae_ge_invasion.110.b"
		hidden_effect = { owner = { if = {
			limit = { NOT = { is_hostile = event_target:ag_kae_e_area_guardian } }
			set_country_flag = ag_kae_is_hostile_to_@event_target:ag_kae_e_area_guardian
			set_faction_hostility = {
				target = event_target:ag_kae_e_area_guardian
				set_hostile = yes set_neutral = no set_friendly = no
			}
		} } }
	}
}
# Warning event.
country_event = {
	id = ag_kae_ge_invasion.111
	title = "ag_kae_ge_invasion.111.name"
	desc = "ag_kae_ge_invasion.111.desc"
	picture_event_data = { room = no_video_feed_room }
	show_sound = event_default
	location = fromfrom.star
	diplomatic = yes
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"

	is_triggered_only = yes
	immediate = { set_country_flag = ag_kae_e_area_delayed_hostility_@root }

	option = {
		name = "ag_kae_ge_invasion.111.a"
		is_dialog_only = yes
		response_text = "ag_kae_ge_invasion.111.a.response"
	}
	option = {
		name = "ag_kae_ge_invasion.111.b"
		is_dialog_only = yes
		response_text = "ag_kae_ge_invasion.111.b.response"
	}
	option = {
		name = "ag_kae_ge_invasion.111.c"
		response_text = "ag_kae_ge_invasion.111.c.response"
		hidden_effect = { country_event = { id = ag_kae_ge_invasion.112 days = @ag_kae_e_area_delayed_hostility_time } }
	}
	option = {
		name = "ag_kae_ge_invasion.111.d"
		response_text = "ag_kae_ge_invasion.111.d.response"
		hidden_effect = { if = {
			limit = { NOT = { is_hostile = event_target:ag_kae_e_area_guardian } }
			set_country_flag = ag_kae_is_hostile_to_@event_target:ag_kae_e_area_guardian
			set_faction_hostility = {
				target = event_target:ag_kae_e_area_guardian
				set_hostile = yes set_neutral = no set_friendly = no
			}
		} }
	}
}
# Failed to leave the system.
country_event = {
	id = ag_kae_ge_invasion.112
	title = "ag_kae_ge_invasion.112.name"
	desc = "ag_kae_ge_invasion.112.desc"
	picture_event_data = { room = no_video_feed_room }
	show_sound = event_default
	location = fromfromfrom.star
	diplomatic = yes
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	
	is_triggered_only = yes
	trigger = {
		root = { NOT = { is_hostile = event_target:ag_kae_e_area_guardian } }
		event_target:ag_kae_e_area_system = { any_ship_in_system = {
			exists = owner
			owner = { is_same_value = root }
		} }
	}

	option = {
		name = "ag_kae_ge_invasion.112.a"
		response_text = "ag_kae_ge_invasion.112.a.response"
		hidden_effect = { if = {
			limit = { NOT = { is_hostile = event_target:ag_kae_e_area_guardian } }
			set_country_flag = ag_kae_is_hostile_to_@event_target:ag_kae_e_area_guardian
			set_faction_hostility = {
				target = event_target:ag_kae_e_area_guardian
				set_hostile = yes set_neutral = no set_friendly = no
			}
		} }
	}
}
# on_entering_system_fleet, Entering system again.
fleet_event = {
	id = ag_kae_ge_invasion.113
	title = "ag_kae_ge_invasion.113.name"
	desc = "ag_kae_ge_invasion.113.desc"
	picture_event_data = { room = no_video_feed_room }
	show_sound = event_default
	location = fromfromfrom.star
	diplomatic = yes
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	
	is_triggered_only = yes
	trigger = {
		exists = owner
		from = { has_star_flag = ag_kae_e_area_system }
		owner = {
			has_country_flag = ag_kae_ge_invasion_110_fired
			has_country_flag = ag_kae_e_area_delayed_hostility_@root
			NOT = { is_hostile = event_target:ag_kae_e_area_guardian }
		}
	}
	immediate = { owner = {
		set_country_flag = ag_kae_is_hostile_to_@event_target:ag_kae_e_area_guardian
		set_faction_hostility = {
			target = event_target:ag_kae_e_area_guardian
			set_hostile = yes
			set_neutral = no
			set_friendly = no
		}
	} }

	option = {
		name = "ag_kae_ge_invasion.113.a"
		response_text = "ag_kae_ge_invasion.113.a.response"
	}
}
# on_entering_battle, Attack guardian.
country_event = {
	id = ag_kae_ge_invasion.114
	title = "ag_kae_ge_invasion.114.name"
	desc = "ag_kae_ge_invasion.114.desc"
	picture_event_data = { room = no_video_feed_room }
	show_sound = event_default
	location = fromfromfrom.star
	diplomatic = yes
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	
	is_triggered_only = yes
	trigger = {
		from = { is_same_value = event_target:ag_kae_e_area_guardian }
		NOT = { has_country_flag = ag_kae_is_hostile_to_@from }
	}
	immediate = { set_country_flag = ag_kae_is_hostile_to_@from }

	option = {
		name = "ag_kae_ge_invasion.114.a"
		response_text = "ag_kae_ge_invasion.114.a.response"
	}
}

# Eternal Systme Tale
country_event = {
	id = ag_kae_ge_invasion.115
	title = "ag_kae_ge_invasion.115.title"
	desc = "ag_kae_ge_invasion.115.desc"
	diplomatic = yes
	picture_event_data = {
		portrait = root.ruler
		room = Eternal_Empire_room
	}
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	show_sound = event_wind_ruins
	is_triggered_only = yes
	option = { 
		name = ag_kae_ge_invasion.115.a 
		is_dialog_only = yes
		response_text = ag_kae_ge_invasion.115.a.resp 
	}
	option = { 
		name = ag_kae_ge_invasion.115.c 
		is_dialog_only = yes
		response_text = ag_kae_ge_invasion.115.c.resp 
	}
	option = { 
		name = ag_kae_ge_invasion.115.e
		response_text = ag_kae_ge_invasion.115.e.resp 
	}
}

# Guardian destroyed
country_event = {
	id = ag_kae_ge_invasion.120
	title = "ag_kae_ge_invasion.120.name"
	desc = "ag_kae_ge_invasion.120.desc"
	picture_event_data = { room = Eternal_Empire_room }
	show_sound = event_space_battle
	location = event_target:ag_kae_target_system
	diplomatic = yes
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	
	fire_only_once = yes
	is_triggered_only = yes
	trigger = {
		NOT = { has_country_flag = ag_kae_ge_invasion_120_fired }
		from = {
			is_same_value = event_target:ag_kae_e_area_guardian
			count_controlled_ship = { count < 1 }
		}
	}
	immediate = {
		set_country_flag = ag_kae_ge_invasion_120_fired
		every_playable_country = {
			limit = { NOR = {
				is_same_value = root
				is_same_value = root.from
			} }
			country_event = { id = ag_kae_ge_invasion.121 days = 1 random = 2 }
		}
		fromfrom.solar_system = { save_event_target_as = ag_kae_target_system }
	}

	option = {
		name = "ag_kae_ge_invasion.120.a"
		event_target:ag_kae_e_habitable_segment = { create_archaeological_site = ag_kae_e_area_site }
		hidden_effect = { set_country_flag = ag_kae_e_area_site_flag }
	}
}
country_event = {
	id = ag_kae_ge_invasion.121
	title = "ag_kae_ge_invasion.121.name"
	desc = "ag_kae_ge_invasion.121.desc"
	picture_event_data = { room = Eternal_Empire_room }
	show_sound = event_mystic_reveal
	location = event_target:ag_kae_target_system
	diplomatic = yes
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	is_triggered_only = yes
	immediate = { country_event = { id = ag_kae_ge_invasion.115 days = 1 random = 1 } }
	option = { name = "ag_kae_ge_invasion.121.a" }
}
# Archaeological Site Events.
# Stage 1.
fleet_event = {
	id = ag_kae_ge_invasion.122
	title = "ag_kae_ge_invasion.122.name"
	desc = "ag_kae_ge_invasion.122.desc"
	picture = GFX_evt_city_ruins
	show_sound = event_ghost_town
	archaeology = yes
	is_triggered_only = yes
	immediate = { from = { set_site_progress_locked = yes } }
	after = { from = { set_site_progress_locked = no } }
	option = {
		name = "ag_kae_ge_invasion.122.a"
		leader = { add_experience = 50 }
	}
}
# Stage 2.
fleet_event = {
	id = ag_kae_ge_invasion.123
	title = "ag_kae_ge_invasion.123.name"
	desc = "ag_kae_ge_invasion.123.desc"
	picture = GFX_evt_excavation_team
	show_sound = event_dig_site
	archaeology = yes
	is_triggered_only = yes
	immediate = { from = { set_site_progress_locked = yes } }
	after = { from = { set_site_progress_locked = no } }
	option = {
		name = "ag_kae_ge_invasion.123.a"
		leader = { add_experience = 50 }
	}
}
# Stage 3.
fleet_event = {
	id = ag_kae_ge_invasion.124
	title = "ag_kae_ge_invasion.124.name"
	desc = "ag_kae_ge_invasion.124.desc"
	picture = GFX_evt_clones
	show_sound = event_dig_site
	archaeology = yes
	is_triggered_only = yes
	immediate = { from = { set_site_progress_locked = yes } }
	after = { from = { set_site_progress_locked = no } }
	option = {
		name = "ag_kae_ge_invasion.124.a"
		small_artifact_reward = yes
	}
}
# Stage 4.
fleet_event = {
	id = ag_kae_ge_invasion.125
	title = "ag_kae_ge_invasion.125.name"
	desc = "ag_kae_ge_invasion.125.desc"
	picture = GFX_evt_ancient_databank
	show_sound = event_finding_loot
	archaeology = yes
	is_triggered_only = yes
	immediate = { from = { set_site_progress_locked = yes } }
	after = { from = { set_site_progress_locked = no } }
	option = {
		name = "ag_kae_ge_invasion.125.a"
		small_artifact_reward = yes
	}
}
# Stage 5.
fleet_event = {
	id = ag_kae_ge_invasion.126
	title = "ag_kae_ge_invasion.126.name"
	desc = "ag_kae_ge_invasion.126.desc"
	picture = GFX_evt_archaeological_dig
	show_sound = event_mystic_reveal
	archaeology = yes
	is_triggered_only = yes
	immediate = { from = { set_site_progress_locked = yes } }
	after = { from = { set_site_progress_locked = no } }
	option = {
		name = "ag_kae_ge_invasion.126.a"
		leader = { add_experience = 200 }
		owner.capital_scope = { enable_special_project = {
			name = "ag_kae_e_area_arc_site_project"
			owner = root.owner
			location = this
		} }
	}
}
# Stage 6.
fleet_event = {
	id = ag_kae_ge_invasion.127
	title = "ag_kae_ge_invasion.127.name"
	desc = "ag_kae_ge_invasion.127.desc"
	picture = GFX_evt_collapsing_roof
	show_sound = event_collapsing_ruins
	archaeology = yes
	is_triggered_only = yes
	immediate = {
		from = { set_site_progress_locked = yes }
		owner = { set_country_flag = ag_kae_e_area_arc_site_completed }
	}
	after = { from = { set_site_progress_locked = no } }
	option = {
		name = "ag_kae_ge_invasion.127.a"
		medium_artifact_reward = yes
		event_target:ag_kae_e_habitable_segment = {
			change_pc = pc_ringworld_habitable_damaged
			set_planet_entity = { picture = pc_ringworld_habitable_damaged }
		}
	}
}

# Special project completed.
country_event = {
	id = ag_kae_ge_invasion.130
	title = "ag_kae_ge_invasion.130.name"
	desc = "ag_kae_ge_invasion.130.desc"
	show_sound = event_dyson_sphere_build_complete
	location = capital_scope.solar_system.star
	diplomatic = yes
	picture_event_data = {
		portrait = root.ruler
		room = Eternal_Empire_room
	}
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	is_triggered_only = yes
	immediate = { set_country_flag = ag_kae_e_area_arc_site_project_completed }
	option = { name = "ag_kae_ge_invasion.130.a" }
}
country_event = {
	id = ag_kae_ge_invasion.131
	title = "ag_kae_ge_invasion.131.name"
	desc = "ag_kae_ge_invasion.131.desc"
	picture_event_data = { room = drifting_gateway_room }
	show_sound = event_mystic_reveal
	location = event_target:ag_kae_target_system
	diplomatic = yes
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"

	fire_only_once = yes
	mean_time_to_happen = { years = 3 }
	trigger = { has_country_flag = ag_kae_e_area_arc_site_completed }
	immediate = {
		random_system = {
			limit = { has_star_flag = ag_kae_e_area_system }
			save_event_target_as = ag_kae_target_system
			random_system_ambient_object = {
				limit = { is_ambient_object_type = kuat_gateway_disbale_entity_object }
				save_event_target_as = ag_kae_target_object
			}
		}
	}

	option = {
		name = "ag_kae_ge_invasion.131.a"
		event_target:ag_kae_target_object = { enable_special_project = {
			name = "ag_kae_e_area_gateway_project"
			owner = root
			location = this
		} }
	}
}
country_event = {
	id = ag_kae_ge_invasion.132
	title = "ag_kae_ge_invasion.132.name"
	desc = "ag_kae_ge_invasion.132.desc"
	picture_event_data = { room = drifting_gateway_room }
	show_sound = event_dyson_sphere_build_complete
	location = from.solar_system
	diplomatic = yes
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	is_triggered_only = yes
	immediate = {
		set_country_flag = ag_kae_e_area_gateway_project_completed
		event_target:global_event_country = {
			set_variable = { which = ag_kae_ge_invasion_warning_counter value = 0 }
			country_event = { id = ag_kae_ge_invasion.201 days = @ag_kae_ge_invasion_warning_delay_time random = @ag_kae_ge_invasion_warning_delay_random }
		}
		country_event = { id = ag_kae_ge_invasion.133 days = 1 random = 2 }
	}
	option = { name = "ag_kae_ge_invasion.132.a" }
}

# Eternal Systme Tale
country_event = {
	id = ag_kae_ge_invasion.133
	title = "ag_kae_ge_invasion.133.title"
	desc = "ag_kae_ge_invasion.133.desc"
	diplomatic = yes
	picture_event_data = {
		portrait = root.ruler
		room = Eternal_Empire_room
	}
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	show_sound = event_wind_ruins
	is_triggered_only = yes
	option = { 
		name = ag_kae_ge_invasion.133.a 
		is_dialog_only = yes
		response_text = ag_kae_ge_invasion.133.a.resp 
	}
	option = { 
		name = ag_kae_ge_invasion.133.e
		response_text = ag_kae_ge_invasion.133.e.resp 
	}
}

####################################
##	   Stage 2: Crisis Events	  ##
##			Event ID: 2xx	      ##
####################################
# Warning events.
# Noti spawner.
country_event = {
    id = ag_kae_ge_invasion.201
    hide_window = yes
	is_triggered_only = yes
	immediate = {
		if = {
			limit = { check_variable = { which = ag_kae_ge_invasion_warning_counter value = 0 } }
			every_playable_country = { country_event = { id = ag_kae_ge_invasion.202 days = 30 random = 30 } }
			change_variable = { which = ag_kae_ge_invasion_warning_counter value = 1 }
			country_event = { id = ag_kae_ge_invasion.201 days = @ag_kae_ge_invasion_warning_delay_time random = @ag_kae_ge_invasion_warning_delay_random }
		}
		else_if = {
			limit = { check_variable = { which = ag_kae_ge_invasion_warning_counter value = 1 } }
			every_playable_country = { country_event = { id = ag_kae_ge_invasion.203 days = 30 random = 30 } }
			change_variable = { which = ag_kae_ge_invasion_warning_counter value = 1 }
			country_event = { id = ag_kae_ge_invasion.201 days = @ag_kae_ge_invasion_warning_delay_time random = @ag_kae_ge_invasion_warning_delay_random }
		}
		else_if = {
			limit = { check_variable = { which = ag_kae_ge_invasion_warning_counter value = 2 } }
			every_playable_country = { country_event = { id = ag_kae_ge_invasion.204 days = 30 random = 30 } }
			change_variable = { which = ag_kae_ge_invasion_warning_counter value = 1 }
			country_event = { id = ag_kae_ge_invasion.201 days = @ag_kae_ge_invasion_warning_delay_time random = @ag_kae_ge_invasion_warning_delay_random }
		}
		else_if = {
			limit = { check_variable = { which = ag_kae_ge_invasion_warning_counter value = 3 } }
			every_playable_country = { country_event = { id = ag_kae_ge_invasion.205 days = 30 random = 30 } }
			change_variable = { which = ag_kae_ge_invasion_warning_counter value = 1 }
			country_event = { id = ag_kae_ge_invasion.201 days = @ag_kae_ge_invasion_warning_delay_time random = @ag_kae_ge_invasion_warning_delay_random }
		}
		else_if = {
			limit = { always = yes }
			every_playable_country = { country_event = { id = ag_kae_ge_invasion.206 days = 30 random = 30 } }
			clear_variable = ag_kae_ge_invasion_warning_counter
		}
	}
}
# Notifications.
country_event = {
	id = ag_kae_ge_invasion.202
	title = "ag_kae_ge_invasion.202.name"
	desc = "ag_kae_ge_invasion.202.desc"
	diplomatic = yes
	picture_event_data = { room = satellite_in_orbit_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_sensor_ping
	location = root.capital_scope
	is_triggered_only = yes
	option = { name = "ag_kae_ge_invasion.202.a" }
}
country_event = {
	id = ag_kae_ge_invasion.203
	title = "ag_kae_ge_invasion.203.name"
	desc = "ag_kae_ge_invasion.203.desc"
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_yellow_alert
	location = root.capital_scope
	is_triggered_only = yes
	option = { name = "ag_kae_ge_invasion.203.a" }
}
country_event = {
	id = ag_kae_ge_invasion.204
	title = "ag_kae_ge_invasion.204.name"
	desc = "ag_kae_ge_invasion.204.desc"
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire2_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_sensor_ping
	location = root.capital_scope
	is_triggered_only = yes
	option = { name = "ag_kae_ge_invasion.204.a" }
}
country_event = {
	id = ag_kae_ge_invasion.205
	title = "ag_kae_ge_invasion.205.name"
	desc = "ag_kae_ge_invasion.205.desc"
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire5_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_yellow_alert
	location = root.capital_scope
	is_triggered_only = yes
	option = { name = "ag_kae_ge_invasion.205.a" }
}
country_event = {
	id = ag_kae_ge_invasion.206
	title = "ag_kae_ge_invasion.206.name"
	desc = "ag_kae_ge_invasion.206.desc"
	diplomatic = yes
	picture_event_data = { room = satellite_in_orbit_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_yellow_alert
	location = root.capital_scope
	is_triggered_only = yes
	option = {
		name = "ag_kae_ge_invasion.206.a"
		hidden_effect = { country_event = { id = ag_kae_ge_invasion.207 } }
	}
	option = {
		name = "ag_kae_ge_invasion.206.b"
		hidden_effect = { if = {
			limit = { has_origin = origin_eternalthrone NOT = { has_global_flag = ag_kae_ge_invasion_207_mutex } }
			set_global_flag = ag_kae_ge_invasion_207_mutex
			event_target:global_event_country = {
				country_event = { id = ag_kae_ge_invasion.211 days = 30 random = 30 }
			}
		} }
	}
}
# Communications.
country_event = {
	id = ag_kae_ge_invasion.207
	title = "ag_kae_ge_invasion.207.name"
	desc = "ag_kae_ge_invasion.207.desc"
	picture_event_data = { room = no_video_feed_room }
	show_sound = event_default
	location = root.capital_scope
	diplomatic = yes
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	is_triggered_only = yes

	option = {
		name = "ag_kae_ge_invasion.207.a"
		response_text = "ag_kae_ge_invasion.207.a.response"
		trigger = { NOT = { has_global_flag = ag_kae_ge_invasion_207_mutex } }
		hidden_effect = { if = {
			limit = { has_origin = origin_eternalthrone NOT = { has_global_flag = ag_kae_ge_invasion_207_mutex } }
			set_global_flag = ag_kae_ge_invasion_207_mutex
			event_target:global_event_country = { country_event = { id = ag_kae_ge_invasion.211 days = 30 random = 30 } }
			country_event = { id = ag_kae_ge_invasion.209 days = 1 random = 1 }
		} }
	}
	option = {
		name = "ag_kae_ge_invasion.207.b"
		response_text = "ag_kae_ge_invasion.207.b.response"
		trigger = { NOT = { has_global_flag = ag_kae_ge_invasion_207_mutex } }
		hidden_effect = { if = {
			limit = { has_origin = origin_eternalthrone NOT = { has_global_flag = ag_kae_ge_invasion_207_mutex } }
			set_global_flag = ag_kae_ge_invasion_207_mutex
			country_event = { id = ag_kae_ge_invasion.208 days = 30 random = 30 }
			set_global_flag = ag_kae_no_ge_invasion_crisis
			country_event = { id = ag_kae_ge_invasion.210 days = 1 random = 1 }
		} }
	}
	option = {
		name = "ag_kae_ge_invasion.207.c"
		trigger = { OR = { NOT = { has_origin = origin_eternalthrone } has_global_flag = ag_kae_ge_invasion_207_mutex } }
		default_hide_option = yes
	}
}
country_event = {
	id = ag_kae_ge_invasion.208
	title = "ag_kae_ge_invasion.208.name"
	desc = "ag_kae_ge_invasion.208.desc"
	diplomatic = yes
	picture_event_data = { room = satellite_in_orbit_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_sensor_ping
	location = root.capital_scope
	is_triggered_only = yes
	option = { name = "ag_kae_ge_invasion.208.a" }
}

# Eternal Systme Tale
country_event = {
	id = ag_kae_ge_invasion.209
	title = "ag_kae_ge_invasion.209.title"
	desc = "ag_kae_ge_invasion.209.desc"
	diplomatic = yes
	picture_event_data = {
		portrait = root.ruler
		room = Eternal_Empire_room
	}
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	show_sound = event_wind_ruins
	is_triggered_only = yes
	immediate = {
		set_country_flag = ag_kae_ge_invasion_209_mutex
		event_target:eternal_support_country = {
			set_country_type = eternal_support_guadian
			set_faction_hostility = {
				target = root
				set_friendly = yes set_hostile = no set_neutral = no
			}
			set_faction_hostility = {
				target = event_target:ag_kae_ge_invasion_country
				set_hostile = yes set_friendly = no set_neutral = no
			}
			every_controlled_fleet = {
				limit = { NOT = { has_fleet_flag = eternal_support_country_starbase } }
				set_fleet_flag = eternal_support_guadian_fleet
				fleet_event = { id = ag_kae_ge_invasion.218 days = 180 }
				prev = { change_variable = { which = fleet_id value = 1 } } 
				set_variable = { which = fleet_id value = prev.fleet_id } 
				solar_system = { set_variable = { which = kuat_fleet_id value = prev.fleet_id } }
			}
		}
	}
	option = { 
		name = ag_kae_ge_invasion.209.e
		response_text = ag_kae_ge_invasion.209.e.resp 
	}
}

# Eternal Systme Tale
country_event = {
	id = ag_kae_ge_invasion.210
	title = "ag_kae_ge_invasion.210.title"
	desc = "ag_kae_ge_invasion.210.desc"
	diplomatic = yes
	picture_event_data = {
		portrait = root.ruler
		room = Eternal_Empire_room
	}
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	show_sound = event_wind_ruins
	is_triggered_only = yes

	immediate = {
		event_target:eternal_support_country = { destroy_country = yes }
	}

	option = { 
		name = ag_kae_ge_invasion.210.e
		response_text = ag_kae_ge_invasion.210.e.resp 
	}
}

# Crisis Begins.
# Spawn Portals.
country_event = {
    id = ag_kae_ge_invasion.211
    hide_window = yes
	is_triggered_only = yes
	trigger = { NOT = { has_global_flag = ag_kae_no_ge_invasion_crisis } }
	immediate = {
		set_global_flag = ag_kae_ge_invasion_begin
		if = { limit = { exists = event_target:ag_kae_portal_system } clear_global_event_target = ag_kae_portal_system }
		if = { limit = { NOT = { is_variable_set = ag_kae_ge_invasion_num_portals_destroyed } } set_variable = { which = ag_kae_ge_invasion_num_portals_destroyed value = 0 } }
		if = {
			limit = { NOT = { is_variable_set = ag_kae_ge_invasion_num_portals } }
			set_variable = { which = ag_kae_ge_invasion_num_portals value = 1 }
			random_system = {
				limit = { has_star_flag = ag_kae_e_area_system }
				isolate_system = yes
				create_country = {
					name = "Name_ag_kae_ge_invasion_country"
					type = ag_kae_ge_invasion_country
					flag = {
						icon = {
							category = "Kuat"
							file = "Kuat_flags_01.dds"
						}
						background = {
							category = "backgrounds"
							file = "00_solid.dds"
						}
						colors = { "blue" "blue" "null" "null" }
					}
					effect = {
						set_graphical_culture = fallen_empire_kuat_01
						set_country_flag = ag_kae_ge_invasion_country
						save_global_event_target_as = ag_kae_ge_invasion_country
						country_event = { id = ag_kae_ge_invasion.233 days = @ag_kae_ge_invasion_reinforcement_time random = @ag_kae_ge_invasion_reinforcement_random }
					}
				}
				ag_kae_ge_invasion_starbase_spawn = yes
				star = {
					ag_kae_ge_invasion_primary_portal_spawn = yes
					ag_kae_ge_invasion_primary_portal_guradian_spawn = yes
					while = {
						count = @ag_kae_ge_invasion_primary_portal_num_initial_assault_fleets
						ag_kae_ge_invasion_assault_fleet_spawn = yes
					}
				}
			}
			ag_kae_ge_invasion_create_secondary_portal_system = yes
			every_country = {
				limit = { NOT = { is_same_value = event_target:ag_kae_ge_invasion_country } }
				country_event = { id = ag_kae_ge_invasion.212 days = 1 random = 2 }
			}
			country_event = { id = ag_kae_ge_invasion.211 days = @ag_kae_ge_invasion_secondary_portal_delay_time random = @ag_kae_ge_invasion_secondary_portal_delay_random }
		}
		else_if = {
			limit = { check_variable = { which = ag_kae_ge_invasion_num_portals value = 2 } }
			ag_kae_ge_invasion_create_secondary_portal_system = yes
			every_country = {
				limit = { NOT = { is_same_value = event_target:ag_kae_ge_invasion_country } }
				country_event = { id = ag_kae_ge_invasion.213 days = 1 random = 2 }
			}
			country_event = { id = ag_kae_ge_invasion.211 days = @ag_kae_ge_invasion_secondary_portal_delay_time random = @ag_kae_ge_invasion_secondary_portal_delay_random }
		}
		else_if = {
			limit = { check_variable = { which = ag_kae_ge_invasion_num_portals value = 3 } }
			ag_kae_ge_invasion_create_secondary_portal_system = yes
			every_country = {
				limit = { NOT = { is_same_value = event_target:ag_kae_ge_invasion_country } }
				country_event = { id = ag_kae_ge_invasion.215 days = 1 random = 2 }
			}
			country_event = { id = ag_kae_ge_invasion.211 days = @ag_kae_ge_invasion_secondary_portal_delay_time random = @ag_kae_ge_invasion_secondary_portal_delay_random }
		}
		else_if = {
			limit = { check_variable = { which = ag_kae_ge_invasion_num_portals value = 4 } }
			ag_kae_ge_invasion_create_secondary_portal_system = yes
			every_country = {
				limit = { NOT = { is_same_value = event_target:ag_kae_ge_invasion_country } }
				country_event = { id = ag_kae_ge_invasion.215 days = 1 random = 2 }
			}
			country_event = { id = ag_kae_ge_invasion.211 days = @ag_kae_ge_invasion_secondary_portal_delay_time random = @ag_kae_ge_invasion_secondary_portal_delay_random }
		}
		else_if = {
			limit = { check_variable = { which = ag_kae_ge_invasion_num_portals value = 5 } }
			ag_kae_ge_invasion_create_secondary_portal_system = yes
			every_country = {
				limit = { NOT = { is_same_value = event_target:ag_kae_ge_invasion_country } }
				country_event = { id = ag_kae_ge_invasion.216 days = 1 random = 2 }
			}
			country_event = { id = ag_kae_ge_invasion.211 days = @ag_kae_ge_invasion_secondary_portal_delay_time random = @ag_kae_ge_invasion_secondary_portal_delay_random }
		}
		else_if = {
			limit = { always = yes }
			ag_kae_ge_invasion_create_secondary_portal_system = yes
			every_country = {
				limit = { NOT = { is_same_value = event_target:ag_kae_ge_invasion_country } }
				country_event = { id = ag_kae_ge_invasion.217 days = 1 random = 2 }
			}
		}
	}
}
country_event = {
	id = ag_kae_ge_invasion.212
	title = "ag_kae_ge_invasion.212.name"
	desc = "ag_kae_ge_invasion.212.desc"
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire2_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_red_alert
	location = root.capital_scope
	is_triggered_only = yes
	option = {
		name = "ag_kae_ge_invasion.212.a"
		if = {
			limit = { NOT = { has_event_chain = "ag_kae_ge_invasion_chain" } }
			begin_event_chain = { event_chain = "ag_kae_ge_invasion_chain" target = root }
		}
		create_point_of_interest = {
			id = ag_kae_ge_invasion_secondary_portal_poi_1
			name = ag_kae_ge_invasion_secondary_portal_poi
			desc = ag_kae_ge_invasion_secondary_portal_poi_desc
			event_chain = "ag_kae_ge_invasion_chain"
			location = event_target:ag_kae_portal_system.star
		}
		hidden_effect = { add_event_chain_counter = { event_chain = "ag_kae_ge_invasion_chain" counter = ag_kae_ge_invasion_portal amount = 2 } }
	}
}
country_event = {
	id = ag_kae_ge_invasion.213
	title = "ag_kae_ge_invasion.213.name"
	desc = "ag_kae_ge_invasion.213.desc"
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire2_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_red_alert
	location = root.capital_scope
	is_triggered_only = yes
	option = {
		name = "ag_kae_ge_invasion.213.a"
		if = {
			limit = { NOT = { has_event_chain = "ag_kae_ge_invasion_chain" } }
			begin_event_chain = { event_chain = "ag_kae_ge_invasion_chain" target = root }
			hidden_effect = { add_event_chain_counter = { event_chain = "ag_kae_ge_invasion_chain" counter = ag_kae_ge_invasion_portal amount = 2 } }
		}
		create_point_of_interest = {
			id = ag_kae_ge_invasion_secondary_portal_poi_2
			name = ag_kae_ge_invasion_secondary_portal_poi
			desc = ag_kae_ge_invasion_secondary_portal_poi_desc
			event_chain = "ag_kae_ge_invasion_chain"
			location = event_target:ag_kae_portal_system.star
		}
		hidden_effect = { add_event_chain_counter = { event_chain = "ag_kae_ge_invasion_chain" counter = ag_kae_ge_invasion_portal amount = 1 } }
	}
}
country_event = {
	id = ag_kae_ge_invasion.214
	title = "ag_kae_ge_invasion.214.name"
	desc = "ag_kae_ge_invasion.214.desc"
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire2_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_red_alert
	location = root.capital_scope
	is_triggered_only = yes
	option = {
		name = "ag_kae_ge_invasion.214.a"
		if = {
			limit = { NOT = { has_event_chain = "ag_kae_ge_invasion_chain" } }
			begin_event_chain = { event_chain = "ag_kae_ge_invasion_chain" target = root }
			hidden_effect = { add_event_chain_counter = { event_chain = "ag_kae_ge_invasion_chain" counter = ag_kae_ge_invasion_portal amount = 3 } }
		}
		create_point_of_interest = {
			id = ag_kae_ge_invasion_secondary_portal_poi_3
			name = ag_kae_ge_invasion_secondary_portal_poi
			desc = ag_kae_ge_invasion_secondary_portal_poi_desc
			event_chain = "ag_kae_ge_invasion_chain"
			location = event_target:ag_kae_portal_system.star
		}
		hidden_effect = { add_event_chain_counter = { event_chain = "ag_kae_ge_invasion_chain" counter = ag_kae_ge_invasion_portal amount = 1 } }
	}
}
country_event = {
	id = ag_kae_ge_invasion.215
	title = "ag_kae_ge_invasion.215.name"
	desc = "ag_kae_ge_invasion.215.desc"
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire2_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_red_alert
	location = root.capital_scope
	is_triggered_only = yes
	option = {
		name = "ag_kae_ge_invasion.215.a"
		if = {
			limit = { NOT = { has_event_chain = "ag_kae_ge_invasion_chain" } }
			begin_event_chain = { event_chain = "ag_kae_ge_invasion_chain" target = root }
			hidden_effect = { add_event_chain_counter = { event_chain = "ag_kae_ge_invasion_chain" counter = ag_kae_ge_invasion_portal amount = 4 } }
		}
		create_point_of_interest = {
			id = ag_kae_ge_invasion_secondary_portal_poi_4
			name = ag_kae_ge_invasion_secondary_portal_poi
			desc = ag_kae_ge_invasion_secondary_portal_poi_desc
			event_chain = "ag_kae_ge_invasion_chain"
			location = event_target:ag_kae_portal_system.star
		}
		hidden_effect = { add_event_chain_counter = { event_chain = "ag_kae_ge_invasion_chain" counter = ag_kae_ge_invasion_portal amount = 1 } }
	}
}
country_event = {
	id = ag_kae_ge_invasion.216
	title = "ag_kae_ge_invasion.216.name"
	desc = "ag_kae_ge_invasion.216.desc"
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire2_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_red_alert
	location = root.capital_scope
	is_triggered_only = yes
	option = {
		name = "ag_kae_ge_invasion.216.a"
		if = {
			limit = { NOT = { has_event_chain = "ag_kae_ge_invasion_chain" } }
			begin_event_chain = { event_chain = "ag_kae_ge_invasion_chain" target = root }
			hidden_effect = { add_event_chain_counter = { event_chain = "ag_kae_ge_invasion_chain" counter = ag_kae_ge_invasion_portal amount = 5 } }
		}
		create_point_of_interest = {
			id = ag_kae_ge_invasion_secondary_portal_poi_5
			name = ag_kae_ge_invasion_secondary_portal_poi
			desc = ag_kae_ge_invasion_secondary_portal_poi_desc
			event_chain = "ag_kae_ge_invasion_chain"
			location = event_target:ag_kae_portal_system.star
		}
		hidden_effect = { add_event_chain_counter = { event_chain = "ag_kae_ge_invasion_chain" counter = ag_kae_ge_invasion_portal amount = 1 } }
	}
}
country_event = {
	id = ag_kae_ge_invasion.217
	title = "ag_kae_ge_invasion.217.name"
	desc = "ag_kae_ge_invasion.217.desc"
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire2_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_red_alert
	location = root.capital_scope
	is_triggered_only = yes
	option = {
		name = "ag_kae_ge_invasion.217.a"
		if = {
			limit = { NOT = { has_event_chain = "ag_kae_ge_invasion_chain" } }
			begin_event_chain = { event_chain = "ag_kae_ge_invasion_chain" target = root }
			hidden_effect = { add_event_chain_counter = { event_chain = "ag_kae_ge_invasion_chain" counter = ag_kae_ge_invasion_portal amount = 6 } }
		}
		create_point_of_interest = {
			id = ag_kae_ge_invasion_secondary_portal_poi_6
			name = ag_kae_ge_invasion_secondary_portal_poi
			desc = ag_kae_ge_invasion_secondary_portal_poi_desc
			event_chain = "ag_kae_ge_invasion_chain"
			location = event_target:ag_kae_portal_system.star
		}
		hidden_effect = { add_event_chain_counter = { event_chain = "ag_kae_ge_invasion_chain" counter = ag_kae_ge_invasion_portal amount = 1 } }
	}
}

# Eternal Guardian Action
fleet_event = {
	id = ag_kae_ge_invasion.218
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		exists = this
		exists = event_target:ag_kae_ge_invasion_country
		has_fleet_flag = eternal_support_guadian_fleet
		owner = { is_country_type = eternal_support_guadian }
	}
	immediate = {
		queue_actions = {
			repeat = {
				effect = {
					id = ag_kae_ge_invasion.218.e0
					if = {
						limit = { count_system = { limit = { check_variable = { which = eternal_guardian_fleet_id value > 0 } } count = all } }
						every_system = { set_variable = { which = eternal_guardian_fleet_id value = 0 } clear_variable = eternal_guardian_fleet_id }
					}
					if = {
						limit = { has_fleet_flag = eternal_findout_path }
						if = {
							limit = {
								NOT = { any_system = {
									NOT = { has_star_flag = ag_kae_e_area_system }
									ROOT = { can_access_system = PREV }
									any_fleet_in_system = {
										exists = owner
										owner = { is_same_value = event_target:ag_kae_ge_invasion_country }
									}
								} }
							}
							random_system = {
								limit = {
									NOT = { has_star_flag = ag_kae_e_area_system }
									any_fleet_in_system = {
										exists = owner
										owner = { is_same_value = event_target:ag_kae_ge_invasion_country }
									}
									closest_system = { min_steps = 1 }
								}
								random_system_planet = { ROOT = { set_location = { target = PREV distance = 5 angle = random } } }
							}
						} remove_fleet_flag = eternal_findout_path
					}
				}
				find_closest_system = {
					trigger = {
						id = ag_kae_ge_invasion.218.t1
						NOT = { has_star_flag = ag_kae_e_area_system }
						any_fleet_in_system = {
							exists = owner
							owner = { is_same_value = event_target:ag_kae_ge_invasion_country }
						}
						ROOT = { can_access_system = prev }
						check_variable = { which = eternal_guardian_fleet_id value < 1 }
					}
					found_system = {
						effect = {
							id = ag_kae_ge_invasion.218.e1
							set_variable = { which = eternal_guardian_fleet_id value = root.owner.fleet_id }
						}
						move_to = this 
						wait = 15
					}					
					failed = {
						find_closest_system = {
							trigger = {
								id = ag_kae_ge_invasion.218.t9
								ROOT = { can_access_system = prev }
								NOT = { has_star_flag = ag_kae_e_area_system }
								check_variable = { which = eternal_guardian_fleet_id value < 1 }
							}
							found_system = {
								effect = {
									id = ag_kae_ge_invasion.218.t91
									set_variable = { which = eternal_guardian_fleet_id value = root.owner.fleet_id }
								}
								move_to = this
								wait = 15
							}
							failed = {
								effect = {
									id = ag_kae_ge_invasion.218.e13
									ROOT = { set_fleet_flag = eternal_findout_path }
								}
								wait = 200
							}
						}
					}
				}
			}
		}
	}
}

# Guardian variable remove
country_event = {
	id = ag_kae_ge_invasion.219
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_country_type = eternal_support_guadian
		fromfrom = { has_fleet_flag = eternal_support_guadian_fleet }
	}
	immediate = {
		random_system = {
			limit = { check_variable = { which = eternal_guardian_fleet_id value = root.fromfrom.fleet_id } }
			set_variable = { which = eternal_guardian_fleet_id value = 0 }
		}
	}
}

# Crisis' after effects.
# Special project completed, crisis Ends.
country_event = {
	id = ag_kae_ge_invasion.220
	title = "ag_kae_ge_invasion.220.name"
	desc = "ag_kae_ge_invasion.220.desc"
	picture_event_data = { room = metropolis_room }
	show_sound = event_celebration
	diplomatic = yes
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	is_triggered_only = yes
	immediate = {
		set_global_flag = ag_kae_ge_invasion_ended
		set_country_flag = ag_kae_ge_invasion_killer
		event_target:ag_kae_ge_invasion_country = { destroy_country = yes }
		event_target:eternal_support_country = {
			set_country_type = eternal_support
			clear_variable = fleet_id
			every_controlled_fleet = {
				limit = { NOT = { has_fleet_flag = eternal_support_country_starbase } }
				clear_fleet_actions = this
				clear_orders = yes
				remove_fleet_flag = eternal_support_guadian_fleet
				destroy_fleet = this
				clear_variable = fleet_id
			}
			set_faction_hostility = {
				target = root
				set_friendly = yes set_hostile = no set_neutral = no
			}
			every_system = { clear_variable = fleet_id }
		}
		country_event = { id = ag_kae_ge_invasion.223 days = 1 random = 1 }
	}
	after = { hidden_effect = {
		every_country = {
			limit = { NOT = { is_same_value = root } }
			abort_special_project = { type = "ag_kae_end_ge_invasion_project" }
		}
		remove_country_flag = ag_kae_ge_invasion_209_mutex
	} }
	option = { name = "ag_kae_ge_invasion.220.a" }
}
# Crisis Reward.
country_event = {
	id = ag_kae_ge_invasion.221
	title = "ag_kae_ge_invasion.221.name"
	desc = "ag_kae_ge_invasion.221.desc"
	picture_event_data = { room = satellite_in_orbit_room }
	show_sound = event_sensor_ping
	diplomatic = yes
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"

	fire_only_once = yes
	mean_time_to_happen = { years = 3 }
	trigger = {
		has_global_flag = ag_kae_ge_invasion_ended
		has_country_flag = ag_kae_ge_invasion_killer
	}

	option = {
		name = "ag_kae_ge_invasion.221.a"
		capital_scope = { enable_special_project = {
			name = "ag_kae_ge_invasion_reward_project"
			owner = root
			location = this
		} }
	}

	option = { name = "ag_kae_ge_invasion.221.b" }
}
country_event = {
	id = ag_kae_ge_invasion.222
	title = "ag_kae_ge_invasion.222.name"
	desc = "ag_kae_ge_invasion.222.desc"
	picture_event_data = { room = automated_dreadnought_room }
	show_sound = event_mystic_reveal
	diplomatic = yes
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	is_triggered_only = yes
	immediate = { kuat_origin_give_all_ship_and_tech = yes }
	option = {
		name = "ag_kae_ge_invasion.222.a"
		#add_relic = ag_kae_ge_invasion_relic
	}
}

country_event = {
	id = ag_kae_ge_invasion.223
	title = "ag_kae_ge_invasion.223.title"
	desc = "ag_kae_ge_invasion.223.desc"
	diplomatic = yes
	picture_event_data = {
		portrait = root.ruler
		room = Eternal_Empire_room
	}
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	show_sound = event_wind_ruins
	is_triggered_only = yes
	option = { 
		name = ag_kae_ge_invasion.223.a 
		is_dialog_only = yes
		response_text = ag_kae_ge_invasion.223.a.resp 
	}
	option = { 
		name = ag_kae_ge_invasion.223.b 
		is_dialog_only = yes
		response_text = ag_kae_ge_invasion.223.b.resp 
	}
	option = { 
		name = ag_kae_ge_invasion.223.c 
		is_dialog_only = yes
		response_text = ag_kae_ge_invasion.223.c.resp 
	}
	option = { 
		name = ag_kae_ge_invasion.223.d 
		is_dialog_only = yes
		response_text = ag_kae_ge_invasion.223.d.resp 
	}
	option = { 
		name = ag_kae_ge_invasion.223.e
		response_text = ag_kae_ge_invasion.223.e.resp 
	}
}

# Crisis' counters & bombardment effect.
# on_ship_destroyed_perp, Ship destroy counter.
country_event = {
    id = ag_kae_ge_invasion.230
    hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = ag_kae_ge_invasion_begin
		NOT = { has_global_flag = ag_kae_ge_invasion_ended }
		OR = {
			is_country_type = ag_kae_ge_invasion_country
			from = { is_country_type = ag_kae_ge_invasion_country }
		}
	}
	immediate = {
		if = {
			limit = { is_country_type = ag_kae_ge_invasion_country }
			every_country = {
				limit = { has_event_chain = "ag_kae_ge_invasion_chain" }
				add_event_chain_counter = { event_chain = "ag_kae_ge_invasion_chain" counter = ag_kae_ge_invasion_victim amount = 1 }
			}
		}
		else = {
			if = {
				limit = { has_event_chain = "ag_kae_ge_invasion_chain" }
				add_event_chain_counter = { event_chain = "ag_kae_ge_invasion_chain" counter = ag_kae_ge_invasion_ship_kill_by_us amount = 1 }
			}
			every_country = {
				limit = { has_event_chain = "ag_kae_ge_invasion_chain" NOT = { is_same_value = root } }
				add_event_chain_counter = { event_chain = "ag_kae_ge_invasion_chain" counter = ag_kae_ge_invasion_ship_kill_by_other amount = 1 }
			}
		}
	}
}
# on_planet_bombarded, Bombardment effect, destroy planet.
planet_event = {
	id = ag_kae_ge_invasion.231
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = ag_kae_ge_invasion_begin
		NOT = { has_global_flag = ag_kae_ge_invasion_ended }
		OR = {
			planet_devastation >= 100
			num_pops < 2
		}
		from = { is_country_type = ag_kae_ge_invasion_country }
	}
	immediate = {
		owner = { country_event = { id = ag_kae_ge_invasion.232 } }
		add_threat = { who = from amount = 2 }
		add_planet_devastation = -100
		every_owned_pop = { kill_pop = yes }
		remove_all_buildings = yes
		remove_all_districts = yes
		clear_deposits = yes
		destroy_colony = yes
		if = {
			limit = { kuat_is_ringworld = yes }
			spawn_ringworld_cracker_effect = yes
			change_pc = pc_ringworld_habitable_damaged
			set_planet_entity = { entity = ringworld_habitable_damaged_entity }
		}
		else_if = {
			limit = { kuat_is_habitat = yes }
			spawn_habitat_cracker_effect = yes
			remove_planet = yes
		}
		else_if = {
			limit = { has_modifier = "holy_planet" }
			change_pc = pc_shattered
			remove_modifier = "holy_planet"
			add_modifier = { modifier = "ag_shattered_holy_planet" }
		}
		else = { change_pc = pc_broken }
		every_country = {
			limit = { has_event_chain = "ag_kae_ge_invasion_chain" }
			add_event_chain_counter = { event_chain = "ag_kae_ge_invasion_chain" counter = ag_kae_ge_invasion_planet_destroyed amount = 1 }
		}
		solar_system = {
			every_fleet_in_system = {
				limit = {
					exists = owner
					owner = { is_country_type = ag_kae_ge_invasion_country }
					has_fleet_flag = ag_kae_ge_assault_fleet
					OR = {
						AND = {
							exists = orbit
							orbit = { is_same_value = root }
						}
						AND = {
							is_fleet_idle = yes
							NAND = {
								exists = orbit
								orbit = {
									NOT = { is_star = yes }
									exists = owner
									owner = { is_hostile = event_target:ag_kae_ge_invasion_country }
								}
							}
						}
					}
				}
				clear_orders = yes
				clear_fleet_actions = this
				fleet_event = { id = ag_kae_ge_invasion.241 days = 1 random = 2 }
			}
		}	
	}
}
country_event = {
	id = ag_kae_ge_invasion.232
	title = "ag_kae_ge_invasion.232.name"
	desc = {
		trigger = { from = { kuat_is_event_borderment_ringworld = no } }
		text = "ag_kae_ge_invasion.232.a.desc"
	}
	desc = {
		trigger = { from = { kuat_is_ringworld = yes } }
		text = "ag_kae_ge_invasion.232.b.desc"
	}
	desc = {
		trigger = { from = { is_planet_class = pc_habitat } }
		text = "ag_kae_ge_invasion.232.c.desc"
	}
	desc = {
		trigger = { from = { kuat_is_holy_world_planet = yes } }
		text = "ag_kae_ge_invasion.232.d.desc"
	}
	diplomatic = yes
	picture_event_data = { room = nuclear_explosion_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_super_explosion
	is_triggered_only = yes
	option = { name = "ag_kae_ge_invasion.232.a" }
}
# Crisis reinforcement.
country_event = {
	id = ag_kae_ge_invasion.233
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		exists = this
		has_global_flag = ag_kae_ge_invasion_begin
		NOT = { has_global_flag = ag_kae_ge_invasion_ended }
	}
	immediate = {
		every_controlled_fleet = {
			limit = {
				is_in_combat = no
				OR = {
					has_fleet_flag = ag_kae_ge_primary_portal
					has_fleet_flag = ag_kae_ge_secondary_portal
				}
			}
			ag_kae_ge_invasion_assault_fleet_spawn = yes
		}
		country_event = { id = ag_kae_ge_invasion.233 days = @ag_kae_ge_invasion_reinforcement_time random = @ag_kae_ge_invasion_reinforcement_random }
	}
}

# on_ship_destroyed_victim, Portal destroyed.
country_event = {
	id = ag_kae_ge_invasion.234
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_country_type = ag_kae_ge_invasion_country
		fromfrom.fleet = { OR = {
			has_fleet_flag = ag_kae_ge_primary_portal
			has_fleet_flag = ag_kae_ge_secondary_portal
		} }
	}
	immediate = {
		if = {
			limit = { fromfrom.fleet = { has_fleet_flag = ag_kae_ge_primary_portal } }
			fromfrom.solar_system.star = { save_event_target_as = ag_kae_target_planet }
		}
		event_target:ag_kae_ge_invasion_country = {
			change_variable = { which = ag_kae_ge_invasion_num_portals_destroyed value = 1 }
		}
		every_country = {
			limit = { NOT = { is_same_value = root } }
			if = {
				limit = { has_event_chain = "ag_kae_ge_invasion_chain" }
				add_event_chain_counter = { event_chain = "ag_kae_ge_invasion_chain" counter = ag_kae_ge_invasion_portal amount = -1 }
				root.fromfrom = {
					if = { limit = { has_fleet_flag = ag_kae_ring_struct_1 } prev = { remove_point_of_interest = ag_kae_ge_invasion_secondary_portal_poi_1 } }
					else_if = { limit = { has_fleet_flag = ag_kae_ring_struct_2 } prev = { remove_point_of_interest = ag_kae_ge_invasion_secondary_portal_poi_2 } }
					else_if = { limit = { has_fleet_flag = ag_kae_ring_struct_3 } prev = { remove_point_of_interest = ag_kae_ge_invasion_secondary_portal_poi_3 } }
					else_if = { limit = { has_fleet_flag = ag_kae_ring_struct_4 } prev = { remove_point_of_interest = ag_kae_ge_invasion_secondary_portal_poi_4 } }
					else_if = { limit = { has_fleet_flag = ag_kae_ring_struct_5 } prev = { remove_point_of_interest = ag_kae_ge_invasion_secondary_portal_poi_5 } }
					else_if = { limit = { has_fleet_flag = ag_kae_ring_struct_6 } prev = { remove_point_of_interest = ag_kae_ge_invasion_secondary_portal_poi_6 } }
				}
			}
			if = {
				limit = { is_same_value = root.from }
				if = {
					limit = { fromfrom.fleet = { has_fleet_flag = ag_kae_ge_secondary_portal } }
					country_event = { id = ag_kae_ge_invasion.235 }
				}
				else = { country_event = { id = ag_kae_ge_invasion.237 } }
			}
			else = {
				if = {
					limit = { fromfrom.fleet = { has_fleet_flag = ag_kae_ge_secondary_portal } }
					country_event = { id = ag_kae_ge_invasion.236 days = 2 random = 2 }
				}
				else = { country_event = { id = ag_kae_ge_invasion.238 days = 2 random = 2 } }
			}
		}
	}
}
# Notification, secondary portal destroyed, for killer.
country_event = {
	id = ag_kae_ge_invasion.235
	title = "ag_kae_ge_invasion.235.name"
	desc = "ag_kae_ge_invasion.235.desc"
	picture_event_data = { room = Eternal_Empire_room }
	show_sound = event_space_battle
	diplomatic = yes
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	is_triggered_only = yes
	option = { name = "ag_kae_ge_invasion.235.a" }
}
# Notification, secondary portal destroyed, for others.
country_event = {
	id = ag_kae_ge_invasion.236
	title = "ag_kae_ge_invasion.236.name"
	desc = "ag_kae_ge_invasion.236.desc"
	picture_event_data = { room = Eternal_Empire_room }
	show_sound = event_space_battle
	diplomatic = yes
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	is_triggered_only = yes
	option = { name = "ag_kae_ge_invasion.236.a" }
}
# Notification, primary destroyed, for killer.
country_event = {
	id = ag_kae_ge_invasion.237
	title = "ag_kae_ge_invasion.237.name"
	desc = "ag_kae_ge_invasion.237.desc"
	picture_event_data = { room = Eternal_Empire_room }
	show_sound = event_space_battle
	diplomatic = yes
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	is_triggered_only = yes
	option = {
		name = "ag_kae_ge_invasion.237.a"
		event_target:ag_kae_target_planet = { enable_special_project = {
			name = "ag_kae_end_ge_invasion_project"
			owner = root.from
			location = this
		} }
	}
}
# Notification, primary destroyed, for others.
country_event = {
	id = ag_kae_ge_invasion.238
	title = "ag_kae_ge_invasion.238.name"
	desc = "ag_kae_ge_invasion.238.desc"
	picture_event_data = { room = Eternal_Empire_room }
	show_sound = event_space_battle
	diplomatic = yes
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	is_triggered_only = yes
	option = {
		name = "ag_kae_ge_invasion.238.a"
		event_target:ag_kae_target_planet = { enable_special_project = {
			name = "ag_kae_end_ge_invasion_project"
			owner = root.from
			location = this
		} }
	}
}

# Crisis' fleet action.
fleet_event = {
	id = ag_kae_ge_invasion.241
	hide_window = yes
	is_triggered_only = yes
	trigger = { has_fleet_flag = ag_kae_ge_assault_fleet }
	immediate = { clear_orders = yes clear_fleet_actions = this ag_kae_ge_assault_fleet_action = yes }
}

# on_monthly_pulse, Failsafe for fleet stoped for unknown reasons.
event = {
	id = ag_kae_ge_invasion.242
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		has_global_flag = ag_kae_ge_invasion_begin
		NOT = { has_global_flag = ag_kae_ge_invasion_ended }
		exists = event_target:ag_kae_ge_invasion_country
	}
	immediate = { event_target:ag_kae_ge_invasion_country = {
		every_controlled_fleet = {
			limit = {
				has_fleet_flag = ag_kae_ge_assault_fleet
				is_fleet_idle = yes
				NAND = {
					exists = orbit
					orbit = {
						NOT = { is_star = yes }
						exists = owner
						owner = { is_hostile = event_target:ag_kae_ge_invasion_country }
					}
				}
			}
			fleet_event = { id = ag_kae_ge_invasion.241 days = 2 random = 2 }
		}
	} }
}

# on_fleet_auto_move_arrival, Reset targets.
country_event = {
    id = ag_kae_ge_invasion.243
    hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = ag_kae_ge_invasion_begin
		NOT = { has_global_flag = ag_kae_ge_invasion_ended }
		has_country_flag = ag_kae_ge_invasion_country
		from = { has_fleet_flag = ag_kae_ge_assault_fleet }
		fromfrom = { exists = this OR = { is_star = yes NOT = { exists = owner } } }
	}
	immediate = { from = { fleet_event = { id = ag_kae_ge_invasion.241 days = 2 random = 2 } } }
}
