namespace = exe_return_invasion
#Gatekeeper, fire when Kuat destroyed. 
event = {
	id = exe_return_invasion.1
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = enbale_last_invasion
		NOT = { has_global_flag = exe_return_invasion_seed }
	}
	immediate = {
		if = {
			limit = { any_country = { has_origin = origin_kuat_apocalyptic } }
			remove_global_flag = disable_modifer_check
			set_global_flag = enable_modifer_check
			set_global_flag = difficult_exe_invasion
			event_target:global_event_country = { 
				set_variable = { which = exe_invasion_difficult_global_var value = 3 } 
				if = {
					limit = { has_global_flag = enable_modifer_check }
					multiply_variable = { which = exe_invasion_difficult_global_var value = 2 }
				}
				if = {
					limit = { has_global_flag = kuat_impulse_mod_settings }
					multiply_variable = { which = exe_invasion_difficult_global_var value = 3 }
				}
			}
		}
		event_target:global_event_country = { set_variable = { which = count_destroy_eternal_fleet value = 0 } }
		remove_global_flag = can_win_the_fleet
		set_timed_global_flag = { flag = exe_invasion_signs_cooldown days = 360 }
		every_playable_country = { country_event = { id = exe_return_invasion.2 days = 1 random = 2 } }
		set_global_flag = exe_return_invasion_seed
	}
}

#Notification: Tachyon signal. 
country_event = {
	id = exe_return_invasion.2
	title = "exe_invasion.2.name"
	desc = "exe_invasion.2.desc"
	diplomatic = yes
	picture_event_data = { room = satellite_in_orbit_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_sensor_ping
	location = root.capital_scope
	is_triggered_only = yes
	immediate = { set_country_flag = exe_return_invasion_2_fired }
	option = { name = "exe_invasion.2.a" }
}

#Energy readings. 
event = {
	id = exe_return_invasion.3
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = exe_return_invasion_seed
		NOT = { has_global_flag = exe_invasion_signs_cooldown }
		NOT = { has_global_flag = exe_return_invasion_3_fired }
	}
	immediate = {
		set_global_flag = exe_return_invasion_3_fired
		set_timed_global_flag = { flag = exe_invasion_signs_cooldown days = 360 }
		every_playable_country = { country_event = { id = exe_return_invasion.4 days = 1 random = 2 } }
	}
}

#Notification: Energy readings. 
country_event = {
	id = exe_return_invasion.4
	title = "exe_invasion.4.name"
	desc = {
		trigger = { has_country_flag = exe_return_invasion_2_fired }
		text = "exe_invasion.4.a.desc"
	}
	desc = {
		trigger = {
			NOT = { has_country_flag = exe_return_invasion_2_fired }
		}
		text = "exe_invasion.4.b.desc"
	}
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_yellow_alert
	location = root.capital_scope
	is_triggered_only = yes
	option = { name = "exe_invasion.4.a" }
}

#Hyperspace echo. 
event = {
	id = exe_return_invasion.5
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = exe_return_invasion_3_fired
		NOT = { has_global_flag = exe_invasion_signs_cooldown }
		NOT = { has_global_flag = exe_return_invasion_5_fired }
	}
	immediate = {
		set_global_flag = exe_return_invasion_5_fired
		set_timed_global_flag = { flag = exe_invasion_signs_cooldown days = 360 }
		every_playable_country = { country_event = { id = exe_return_invasion.6 days = 1 random = 2 } }
	}
}

#Notification: Hyperspace echo. 
country_event = {
	id = exe_return_invasion.6
	title = "exe_invasion.6.name"
	desc = "exe_invasion.6.desc"
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire2_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_sensor_ping
	location = root.capital_scope
	is_triggered_only = yes
	option = { name = "exe_invasion.6.a" }
}

#Approaching rim system. 
event = {
	id = exe_return_invasion.7
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = exe_return_invasion_5_fired
		NOT = { has_global_flag = exe_invasion_signs_cooldown }
		NOT = { has_global_flag = exe_return_invasion_7_fired }
	}
	immediate = {
		set_global_flag = exe_return_invasion_7_fired
		set_timed_global_flag = { flag = exe_invasion_signs_cooldown days = 360 }
		every_playable_country = { country_event = { id = exe_return_invasion.8 days = 1 random = 2 } }
	}
}

#Notification: Approaching rim system. 
country_event = {
	id = exe_return_invasion.8
	title = "exe_return_invasion.8.name"
	desc = "exe_return_invasion.8.desc"
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire5_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_yellow_alert
	location = root.capital_scope
	is_triggered_only = yes
	option = { name = "exe_return_invasion.8.a" }
}

#Invasion begin. 
event = {
	id = exe_return_invasion.9
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = exe_return_invasion_7_fired
		NOT = { has_global_flag = exe_invasion_signs_cooldown }
		NOT = { has_global_flag = exe_return_invasion_begin }
	}
	immediate = {
		set_update_modifiers_batch = begin
		set_global_flag = eternal_spawnd
		set_global_flag = exe_return_invasion_begin
		create_country = {
			name = "Eternal Fleet"
			name_list = Eternal_Fleet
			type = eternal_fleet_country
			flag = {
				icon = {
					category = "exe_invasion"
					file = "ge_o.dds"
				}
				background = {
					category = "backgrounds"
					file = "00_solid.dds"
				}
				colors = { "yellow" "black" "null" "null" }
			}
			ignore_initial_colony_error = yes
		}
		set_global_flag = eternal_return_fleet_debug_check
		last_created_country = { if = {
			limit = { OR = {
				exists = event_target:wg_crisis_country
				exists = event_target:monolith_crisis_country
				exists = event_target:return_kuat_awakening_country
			} }
			set_faction_hostility = {
				target = event_target:monolith_crisis_country
				set_hostile = no set_friendly = yes
			} set_faction_hostility = {
				target = event_target:wg_crisis_country
				set_hostile = no set_friendly = yes
			} set_faction_hostility = {
				target = event_target:return_kuat_awakening_country
				set_hostile = no set_friendly = yes
			} }
			save_global_event_target_as = eternal_fleet_country
			set_country_flag = eternal_fleet_country
			remove_global_flag = has_eternal_fleet_country
			set_global_flag = has_eternal_fleet_country
			set_graphical_culture = fallen_empire_kuat_01
			create_ship_design = { design = "NAME_EXE_Starbase" }
			add_ship_design = last_created_design
			create_ship_design = { design = "NAME_EXE_Starbase_Construction" }
			add_ship_design = last_created_design
			add_modifier = { modifier = Elternal_creating }
		}
		while = { count = 4 random_rim_system = {
			limit = {
				kuat_is_exe_return_invasion_system = no
				NOT = { has_star_flag = eternal_starbase_megastructure_in_system }
			}
			create_eternal_defensive_fleet = yes
			create_elternal_system_warbase = { LOCK = yes }
			system_star = {
				if = {
					limit = { any_country = { is_ai = no OR = {
						has_origin = origin_kuat_apocalyptic
						has_origin = origin_eternalthrone
					} } }
					if = {
						limit = { event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value <= 1 }
						} }
						planet_event = { id = exe_return_invasion.11 days = 10 }
					}
					else_if = {
						limit = { event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value = 2 }
						} }
						planet_event = { id = exe_return_invasion.11 days = 10 }
						planet_event = { id = exe_return_invasion.11 days = 20 }
					}
					else_if = {
						limit = { event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value = 3 }
						} }
						planet_event = { id = exe_return_invasion.11 days = 10 }
						planet_event = { id = exe_return_invasion.11 days = 20 }
						planet_event = { id = exe_return_invasion.11 days = 30 }
					}
					else_if = {
						limit = { event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value = 4 }
						} }
						planet_event = { id = exe_return_invasion.11 days = 10 }
						planet_event = { id = exe_return_invasion.11 days = 20 }
						planet_event = { id = exe_return_invasion.11 days = 30 }
						planet_event = { id = exe_return_invasion.11 days = 40 }
					}
					else_if = {
						limit = { event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value = 5 }
						} }
						planet_event = { id = exe_return_invasion.11 days = 10 }
						planet_event = { id = exe_return_invasion.11 days = 20 }
						planet_event = { id = exe_return_invasion.11 days = 30 }
						planet_event = { id = exe_return_invasion.11 days = 40 }
						planet_event = { id = exe_return_invasion.11 days = 50 }
					}
					else_if = {
						limit = { event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value = 6 }
						} }
						planet_event = { id = exe_return_invasion.11 days = 10 }
						planet_event = { id = exe_return_invasion.11 days = 20 }
						planet_event = { id = exe_return_invasion.11 days = 30 }
						planet_event = { id = exe_return_invasion.11 days = 40 }
						planet_event = { id = exe_return_invasion.11 days = 50 }
						planet_event = { id = exe_return_invasion.11 days = 55 }
					}
					else_if = {
						limit = { event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value = 7 }
						} }
						planet_event = { id = exe_return_invasion.11 days = 10 }
						planet_event = { id = exe_return_invasion.11 days = 20 }
						planet_event = { id = exe_return_invasion.11 days = 30 }
						planet_event = { id = exe_return_invasion.11 days = 40 }
						planet_event = { id = exe_return_invasion.11 days = 50 }
						planet_event = { id = exe_return_invasion.11 days = 55 }
						planet_event = { id = exe_return_invasion.11 days = 60 }
					}
					else_if = {
						limit = { event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value = 8 }
						} }
						planet_event = { id = exe_return_invasion.11 days = 10 }
						planet_event = { id = exe_return_invasion.11 days = 20 }
						planet_event = { id = exe_return_invasion.11 days = 30 }
						planet_event = { id = exe_return_invasion.11 days = 40 }
						planet_event = { id = exe_return_invasion.11 days = 50 }
						planet_event = { id = exe_return_invasion.11 days = 55 }
						planet_event = { id = exe_return_invasion.11 days = 60 }
						planet_event = { id = exe_return_invasion.11 days = 65 }
					}
					else_if = {
						limit = { event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value = 9 }
						} }
						planet_event = { id = exe_return_invasion.11 days = 10 }
						planet_event = { id = exe_return_invasion.11 days = 20 }
						planet_event = { id = exe_return_invasion.11 days = 30 }
						planet_event = { id = exe_return_invasion.11 days = 40 }
						planet_event = { id = exe_return_invasion.11 days = 50 }
						planet_event = { id = exe_return_invasion.11 days = 55 }
						planet_event = { id = exe_return_invasion.11 days = 60 }
						planet_event = { id = exe_return_invasion.11 days = 65 }
						planet_event = { id = exe_return_invasion.11 days = 70 }
					}
					else_if = {
						limit = { event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value >= 10 }
						} }
						planet_event = { id = exe_return_invasion.11 days = 10 }
						planet_event = { id = exe_return_invasion.11 days = 20 }
						planet_event = { id = exe_return_invasion.11 days = 30 }
						planet_event = { id = exe_return_invasion.11 days = 40 }
						planet_event = { id = exe_return_invasion.11 days = 50 }
						planet_event = { id = exe_return_invasion.11 days = 55 }
						planet_event = { id = exe_return_invasion.11 days = 60 }
						planet_event = { id = exe_return_invasion.11 days = 65 }
						planet_event = { id = exe_return_invasion.11 days = 70 }
						planet_event = { id = exe_return_invasion.11 days = 75 }
					}
				}
				else = {
					planet_event = { id = exe_return_invasion.11 days = 10 }
					planet_event = { id = exe_return_invasion.11 days = 20 }
					planet_event = { id = exe_return_invasion.11 days = 30 }
					planet_event = { id = exe_return_invasion.11 days = 40 }
					planet_event = { id = exe_return_invasion.11 days = 50 }
				}
			}
		} }
		event_target:eternal_fleet_country = { country_event = { id = exe_return_invasion.19 days = 100 } }
		every_country = {
			limit = { is_eternal_faction = no }
			establish_communications_no_message = event_target:eternal_fleet_country
			country_event = { id = exe_return_invasion.10 }
		}
		every_country = {
			limit = { has_special_project = exe_invasion_lock_outer_gate }
			abort_special_project = { type = exe_invasion_lock_outer_gate }
		}
		set_update_modifiers_batch = end
	}
}

#Notification: Invasion begin. 
country_event = {
	id = exe_return_invasion.10
	title = "exe_return_invasion.10.name"
	desc = "exe_return_invasion.10.a.desc"
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire4_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_red_alert
	location = root.capital_scope
	is_triggered_only = yes
	option = {
		name = "exe_return_invasion.10.a"
		hidden_effect = { country_event = { id = exe_return_invasion.102 days = 1 } }
	}
}

country_event = {
	id = exe_return_invasion.102
	title = "exe_return_invasion.102.name"
	desc = { trigger = {
		success_text = {
			NOR = {
				has_country_flag = fired_exe_return_invasion.102.b
				has_country_flag = fired_exe_return_invasion.102.c
			}
			text = "exe_return_invasion.102.desc"
		}
		success_text = {
			has_country_flag = fired_exe_return_invasion.102.b
			text = "exe_return_invasion.102.b.desc"
		}
		success_text = {
			has_country_flag = fired_exe_return_invasion.102.c
			text = "exe_return_invasion.102.c.desc"
		}
	} }
	diplomatic = yes
	picture_event_data = { 
		room = Eternal_Empire_room
		portrait = event_target:UTS02_LEADER
	}
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	show_sound = event_red_alert
	location = root.capital_scope
	is_triggered_only = yes
	immediate = {  
		begin_event_chain = { event_chain = ag_exe_invasion_chain }
		if = {
			limit = { has_event_chain = ag_return_eternal_chain }
			add_event_chain_counter = { event_chain = ag_return_eternal_chain counter = ag_return_eternal_amount amount = 1 }
		}
	}
	option = {
		name = exe_return_invasion.102.b
		hidden_effect = { 
			set_country_flag = fired_exe_return_invasion.102.b
			remove_country_flag = fired_exe_return_invasion.102.c
			country_event = { id = exe_return_invasion.102 } 
		}
	}
	option = {
		name = exe_return_invasion.102.c
		hidden_effect = { 
			set_country_flag = fired_exe_return_invasion.102.c
			remove_country_flag = fired_exe_return_invasion.102.b
			country_event = { id = exe_return_invasion.102 } 
		}
	}
	option = { name = exe_return_invasion.102.a ai_chance = { weight = 100 } }
}

#contact within eternal fleet
country_event = {
	id = exe_return_invasion.20
	title = "exe_return_invasion.20.name"
	desc = "exe_return_invasion.20.desc"
	diplomatic = yes
	picture_event_data = { room = no_video_feed_room }
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	show_sound = event_red_alert
	location = root.capital_scope
	fire_only_once = yes
	trigger = { has_global_flag = exe_return_invasion_begin }
	mean_time_to_happen = { 
		years = 1
		modifier = { factor = 0.20 retrun_first_station_check = yes }
		modifier = { factor = 0.15 retrun_second_station_check = yes }
		modifier = { factor = 0.10 retrun_third_station_check = yes }
	}
	option = {
		name = "exe_return_invasion.20.a"
		hidden_effect = { add_modifier = { modifier = final_eternal_fleet days = -1 } }
	}
}

#find station
country_event = {
	id = exe_return_invasion.24
	title = "exe_return_invasion.24.name"
	desc = "exe_return_invasion.24.desc"
	diplomatic = yes
	picture_event_data = { room = ancient_databank_room }
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	show_sound = event_red_alert
	location = root.capital_scope
	trigger = {
		has_global_flag = exe_return_invasion_begin
		is_player_country = yes
		retrun_first_station_check = yes
		NOT = { any_country = { has_country_flag = fire_first_find } }
	}
	mean_time_to_happen = { months = 3 }
	immediate = { 
		set_country_flag = fire_first_find 
		begin_event_chain = { event_chain = ag_find_invasion_chain }
		save_global_event_target_as = return_instersting_country
	}
	option = {
		name = "exe_return_invasion.24.a"
		enable_special_project = {
			name = exe_return_invasion_project
			owner = root location = root.capital_star
		}
	}
}

country_event = {
	id = exe_return_invasion.25
	title = "exe_return_invasion.24.name"
	desc = "exe_return_invasion.25.desc"
	diplomatic = yes
	picture_event_data = { room = ancient_databank_room }
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	show_sound = event_red_alert
	location = root.capital_scope
	trigger = {
		has_global_flag = exe_return_invasion_begin
		is_player_country = yes
		retrun_second_station_check = yes
		has_country_flag = fire_first_find
		NOT = { has_country_flag = second_first_find }
		check_variable = { which = num_finish value = 1 } 
	}
	mean_time_to_happen = { months = 3 }
	immediate = { set_country_flag = second_first_find }
	option = {
		name = "exe_return_invasion.24.a"
		enable_special_project = {
			name = exe_return_invasion_project
			owner = root location = root.capital_star
		}
	}
}

country_event = {
	id = exe_return_invasion.26
	title = "exe_return_invasion.24.name"
	desc = "exe_return_invasion.26.desc"
	diplomatic = yes
	picture_event_data = { room = ancient_databank_room }
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	show_sound = event_red_alert
	location = root.capital_scope
	trigger = {
		has_global_flag = exe_return_invasion_begin
		is_player_country = yes
		retrun_third_station_check = yes
		has_country_flag = second_first_find
		NOT = { has_country_flag = third_first_find }
		check_variable = { which = num_finish value = 2 } 
	}
	mean_time_to_happen = { months = 3 }
	immediate = { set_country_flag = third_first_find }
	option = {
		name = "exe_return_invasion.24.a"
		enable_special_project = {
			name = exe_return_invasion_project
			owner = root location = root.capital_star
		}
	}
}

ship_event = {
	id = exe_return_invasion.27
	title = "exe_return_invasion.27.name"
	desc = "exe_return_invasion.27.desc"
	diplomatic = yes
	picture_event_data = { room = ancient_databank_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	is_triggered_only = yes
	immediate = { 
		owner = { 
			change_variable = { which = num_vaild_system value = 1 } 
			abort_special_project = { type = exe_return_invasion_project }
		} 
	}
	option = {
		name = exe_return_invasion.27.a
		trigger = { owner = { check_variable = { which = num_vaild_system value = 1 } } }
		hidden_effect = {
			set_spawn_system_batch = begin
			owner = {
				random_system = {
					limit = { 
						is_capital_system = no
						kuat_is_kuat_system = no 
						NOR = {
							has_star_flag = final_1_system
							has_star_flag = final_2_system
							has_star_flag = final_3_system
						}
					}
					spawn_system = { initializer = exe_first_invasion_system hyperlane = no }
				}
			}
			set_spawn_system_batch = end
		}
	}
	option = {
		name = exe_return_invasion.27.b
		trigger = { owner = { check_variable = { which = num_vaild_system value = 2 } } }
		hidden_effect = {
			set_spawn_system_batch = begin
			owner = {
				random_system = {
					limit = { 
						is_capital_system = no
						kuat_is_kuat_system = no 
						NOR = {
							has_star_flag = final_1_system
							has_star_flag = final_2_system
							has_star_flag = final_3_system
						}
					}
					spawn_system = { initializer = exe_second_invasion_system hyperlane = no }
				}
			}
			set_spawn_system_batch = end
		}
	}
	option = {
		name = exe_return_invasion.27.c
		trigger = { owner = { check_variable = { which = num_vaild_system value >= 3 } } }
		hidden_effect = {
			set_spawn_system_batch = begin
			owner = {
				random_system = {
					limit = { 
						is_capital_system = no
						kuat_is_kuat_system = no 
						NOR = {
							has_star_flag = final_1_system
							has_star_flag = final_2_system
							has_star_flag = final_3_system
						}
					}
					spawn_system = { initializer = exe_third_invasion_system hyperlane = no }
				}
			}
			set_spawn_system_batch = end
		}
	}
}

ship_event = {
	id = exe_return_invasion.28
	title = "exe_return_invasion.28.name"
	desc = "exe_return_invasion.28.desc"
	diplomatic = yes
	picture_event_data = { room = star_neutron_room }
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	is_triggered_only = yes
	trigger = {
		owner = { is_variable_set = num_vaild_system }
		from = { OR = {
			has_star_flag = final_1_system
			has_star_flag = final_2_system
			has_star_flag = final_3_system
		} }
	}
	immediate = {
		from = { system_star = { enable_special_project = {
			name = exe_return_invasion_exploring_project
			owner = root.owner
			location = this
		} } }
	}
	option = { name = exe_return_invasion.28.a }
}

ship_event = {
	id = exe_return_invasion.29
	title = "exe_return_invasion.27.name"
	desc = "exe_return_invasion.29.desc"
	diplomatic = yes
	picture_event_data = { room = star_neutron_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	is_triggered_only = yes
	immediate = { owner = { abort_special_project = { type = exe_return_invasion_exploring_project } } }
	option = {
		name = exe_return_invasion.29.a
		trigger = { owner = { check_variable = { which = num_vaild_system value = 1 } } }
		solar_system = { every_system_ambient_object = {
			limit = { is_ambient_object_type = kuat_gateway_entity_object }
			destroy_ambient_object = this
			prev.star = { create_ambient_object = {
				type = kuat_gateway_disbale_entity_object
				location = this
				use_3d_location = yes
				entity_offset = { min = 0 max = 0 }
				entity_offset_angle = { min = 0 max = 0 }
				entity_offset_height = { min = 0 max = 0 }
				scale = 1
			} }
		} }
		if = {
			limit = { owner = { has_origin = origin_kuat_apocalyptic } }
			owner = { 
				add_random_research_option = { add_progress = 1 } 
				hidden_effect = { change_variable = { which = num_finish value = 1 } }
				add_event_chain_counter = { event_chain = ag_find_invasion_chain counter = ag_legacy_system_amount amount = 1 }
			}
		}
		else = { owner = { start_situation = {
			type = situation_unlocked_the_first_station
			target = event_target:eternal_fleet_country
		} } }
	}
	option = {
		name = exe_return_invasion.29.a
		trigger = { owner = { check_variable = { which = num_vaild_system value = 2 } } }
		solar_system = { every_system_ambient_object = {
			limit = { is_ambient_object_type = kuat_gateway_entity_object }
			destroy_ambient_object = this
			prev.star = { create_ambient_object = {
				type = kuat_gateway_disbale_entity_object
				location = this
				use_3d_location = yes
				entity_offset = { min = 0 max = 0 }
				entity_offset_angle = { min = 0 max = 0 }
				entity_offset_height = { min = 0 max = 0 }
				scale = 1
			} }
		} }
		if = {
			limit = { owner = { has_origin = origin_kuat_apocalyptic } }
			owner = { 
				add_random_research_option = { add_progress = 1 } 
				hidden_effect = { change_variable = { which = num_finish value = 1 } }
				add_event_chain_counter = { event_chain = ag_find_invasion_chain counter = ag_legacy_system_amount amount = 1 }
			}
		}
		else = { owner = { start_situation = {
			type = situation_unlocked_the_second_station
			target = event_target:eternal_fleet_country
		} } }
	}
	option = {
		name = exe_return_invasion.29.a
		trigger = { owner = { check_variable = { which = num_vaild_system value >= 3 } } }
		set_update_modifiers_batch = begin
		solar_system = { every_system_ambient_object = {
			limit = { is_ambient_object_type = kuat_gateway_entity_object }
			destroy_ambient_object = this
			prev.star = { create_ambient_object = {
				type = kuat_gateway_disbale_entity_object
				location = this
				use_3d_location = yes
				entity_offset = { min = 0 max = 0 }
				entity_offset_angle = { min = 0 max = 0 }
				entity_offset_height = { min = 0 max = 0 }
				scale = 1
			} }
		} }
		if = {
			limit = { owner = { has_origin = origin_kuat_apocalyptic } }
			owner = { 
				add_random_research_option = { add_progress = 1 } 
				hidden_effect = { change_variable = { which = num_finish value = 1 } }
				add_event_chain_counter = { event_chain = ag_find_invasion_chain counter = ag_legacy_system_amount amount = 1 }
			}
			event_target:eternal_fleet_country = {
				if = {
					limit = { NOT = { any_owned_fleet = { has_fleet_flag = ag_kuat_invasion_fleet } } }
					random_system_within_border = {
						limit = { has_star_flag = eternal_starbase_megastructure_in_system }
						system_star = { create_exe_retrun_invasion_fleet_detail = yes }
					}
				}
			}
			every_playable_country = { country_event = { id = exe_return_invasion.33 } }
		}
		else = { owner = { start_situation = {
			type = situation_unlocked_the_third_station
			target = event_target:eternal_fleet_country
		} } }
		set_update_modifiers_batch = end
	}
}

country_event = {
	id = exe_return_invasion.33
	title = "exe_return_invasion.33.name"
	desc = "exe_return_invasion.33.desc"
	diplomatic = yes
	picture_event_data = { room = star_neutron_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	is_triggered_only = yes
	trigger = { check_variable = { which = num_vaild_system value >= 3 } }
	option = {
		name = exe_return_invasion.33.a
		custom_tooltip = exe_return_invasion.33.tooltip
		end_event_chain = ag_find_invasion_chain
		hidden_effect = { 
			set_global_flag = can_win_the_fleet 
			event_target:eternal_fleet_country = { country_event = { id = exe_return_invasion.37 days = 30 } }
		}
	}
	after = { if = { limit = { has_origin = origin_eternalthrone has_country_flag = eternal_fleet_ennded_A } country_event = { id = kuat_facility_return_invasion.22 days = 2 random = 3 } } }
}

#on entering system but starbase not enable 
fleet_event = {
	id = exe_return_invasion.333
	title = "exe_return_invasion.333.name"
	desc = "exe_return_invasion.333.desc"
	diplomatic = yes
	picture_event_data = { room = star_neutron_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	is_triggered_only = yes
	fire_only_once = yes
	trigger = { 
		NOT = { has_global_flag = enable_the_eternal_starbase } 
		has_global_flag = exe_return_invasion_begin
		from = { any_fleet_in_system = { has_fleet_flag = ag_kuat_invasion_starbase } }
		exists = owner owner = { is_ai = no }
	}

	option = {
		name = "exe_return_invasion.333.a"
		hidden_effect = { owner = { every_owned_fleet = {
			limit = { exists = solar_system solar_system = { is_same_value = root.from } }
			set_location = prev.capital_scope
		} } }
		default_hide_option = yes
	}
	option = { name = "exe_return_invasion.333.b" }
}

#Eternal starbase destroy
country_event = {
	id = exe_return_invasion.17
	hide_window = yes
	is_triggered_only = yes
	trigger = { 
		has_global_flag = exe_return_invasion_begin
		has_global_flag = can_win_the_fleet
		fromfromfrom = { 
			has_fleet_flag = ag_kuat_invasion_starbase 
			NOT = { has_fleet_flag = ag_kuat_invasion_starbase_disable }
		}
		from = { is_eternal_faction = yes }
	}
	immediate = { 
		set_update_modifiers_batch = begin
		fromfromfrom = { solar_system = {
			remove_star_flag = eternal_starbase_megastructure_in_system
			set_star_class = sc_black_hole
			star = {
				create_ambient_object = { type = "star_explosion" play_animation_once = yes location = this }
				last_created_ambient_object = { set_location = { target = prev distance = 0 angle = random } }
				create_ambient_object = { type = "destroyed_system" location = this }
				last_created_ambient_object = { set_ambient_object_flag = destroyed_system_effect set_location = { target = prev  distance = 0  angle = random  } }
				change_pc = pc_black_hole
				set_planet_size = 18
			}
			every_fleet_in_system = {
				limit = { exists = owner owner = { is_eternal_faction = no } }
				every_owned_ship = { kuat_reduce_hp_percent = { value = 75 } }
			}
			random_ambient_object = {
				limit = { has_ambient_object_flag = space_storm_object }
				destroy_ambient_object = this
			}
			if = {
				limit = { NOT = { has_star_flag = fire_only_once_temple } }
				set_timed_star_flag = { flag = fire_only_once_temple days = 1 }
				event_target:eternal_fleet_country = { change_variable = { which = ag_kuat_invasion_starbase_arrived value = 1 } }
			}
		} }
		every_playable_country = { 
			limit = { NOT = { has_country_flag = fire_only_once_temple } } 
			country_event = { id = exe_return_invasion.18 } set_timed_country_flag = { flag = fire_only_once_temple days = 1 }
		}
		set_update_modifiers_batch = end
	}
}

#notice everyone starbase destroy
country_event = {
	id = exe_return_invasion.18
	title = "exe_return_invasion.18.name"
	desc = "exe_return_invasion.18.desc"
	diplomatic = yes
	picture_event_data = { room = black_hole_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_sensor_ping
	is_triggered_only = yes
	option = { name = exe_return_invasion.29.a }
}

#Invasion fleet arrived. 
planet_event = {
	id = exe_return_invasion.11
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = exe_return_invasion_begin
		NOT = { has_global_flag = exe_return_invasion_ended }
	}
	immediate = {
		set_update_modifiers_batch = begin
		event_target:eternal_fleet_country = { change_variable = { which = ag_kuat_invasion_fleet_arrived value = 1 } }
		create_exe_retrun_invasion_fleet_detail = yes
		every_country = {
			limit = { has_event_chain = ag_exe_invasion_chain }
			add_event_chain_counter = { event_chain = ag_exe_invasion_chain counter = ag_exe_invasion_fleet amount = 1 }
		}
		event_target:eternal_fleet_country = {
			if = {
				limit = { any_country = { is_ai = no OR = {
					has_origin = origin_kuat_apocalyptic
					has_origin = origin_eternalthrone
				} } }
				if = {
					limit = { 
						event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value <= 1 }
						}
						check_variable = { which = ag_kuat_invasion_fleet_arrived value = 4 }
					}
					every_owned_fleet = {
						limit = { has_fleet_flag = ag_kuat_invasion_fleet }
						fleet_event = { id = exe_return_invasion.12 days = 1 random = 2 }
					}
					set_global_flag = can_win_the_fleet_stage_1
				}
				else_if = {
					limit = { 
						event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value = 2 }
						}
						check_variable = { which = ag_kuat_invasion_fleet_arrived value = 8 }
					}
					every_owned_fleet = {
						limit = { has_fleet_flag = ag_kuat_invasion_fleet }
						fleet_event = { id = exe_return_invasion.12 days = 1 random = 2 }
					}
					set_global_flag = can_win_the_fleet_stage_1
				}
				else_if = {
					limit = { 
						event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value = 3 }
						}
						check_variable = { which = ag_kuat_invasion_fleet_arrived value = 12 }
					}
					every_owned_fleet = {
						limit = { has_fleet_flag = ag_kuat_invasion_fleet }
						fleet_event = { id = exe_return_invasion.12 days = 1 random = 2 }
					}
					set_global_flag = can_win_the_fleet_stage_1
				}
				else_if = {
					limit = { 
						event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value = 4 }
						}
						check_variable = { which = ag_kuat_invasion_fleet_arrived value = 16 }
					}
					every_owned_fleet = {
						limit = { has_fleet_flag = ag_kuat_invasion_fleet }
						fleet_event = { id = exe_return_invasion.12 days = 1 random = 2 }
					}
					set_global_flag = can_win_the_fleet_stage_1
				}
				else_if = {
					limit = { 
						event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value = 5 }
						}
						check_variable = { which = ag_kuat_invasion_fleet_arrived value = 20 }
					}
					every_owned_fleet = {
						limit = { has_fleet_flag = ag_kuat_invasion_fleet }
						fleet_event = { id = exe_return_invasion.12 days = 1 random = 2 }
					}
					set_global_flag = can_win_the_fleet_stage_1
				}
				else_if = {
					limit = { 
						event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value = 6 }
						}
						check_variable = { which = ag_kuat_invasion_fleet_arrived value = 24 }
					}
					every_owned_fleet = {
						limit = { has_fleet_flag = ag_kuat_invasion_fleet }
						fleet_event = { id = exe_return_invasion.12 days = 1 random = 2 }
					}
					set_global_flag = can_win_the_fleet_stage_1
				}
				else_if = {
					limit = { 
						event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value = 7 }
						}
						check_variable = { which = ag_kuat_invasion_fleet_arrived value = 28 }
					}
					every_owned_fleet = {
						limit = { has_fleet_flag = ag_kuat_invasion_fleet }
						fleet_event = { id = exe_return_invasion.12 days = 1 random = 2 }
					}
					set_global_flag = can_win_the_fleet_stage_1
				}
				else_if = {
					limit = { 
						event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value = 8 }
						}
						check_variable = { which = ag_kuat_invasion_fleet_arrived value = 32 }
					}
					every_owned_fleet = {
						limit = { has_fleet_flag = ag_kuat_invasion_fleet }
						fleet_event = { id = exe_return_invasion.12 days = 1 random = 2 }
					}
					set_global_flag = can_win_the_fleet_stage_1
				}
				else_if = {
					limit = { 
						event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value = 9 }
						}
						check_variable = { which = ag_kuat_invasion_fleet_arrived value = 36 }
					}
					every_owned_fleet = {
						limit = { has_fleet_flag = ag_kuat_invasion_fleet }
						fleet_event = { id = exe_return_invasion.12 days = 1 random = 2 }
					}
					set_global_flag = can_win_the_fleet_stage_1
				}
				else_if = {
					limit = { 
						event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value >= 10 }
						}
						check_variable = { which = ag_kuat_invasion_fleet_arrived value = 40 }
					}
					every_owned_fleet = {
						limit = { has_fleet_flag = ag_kuat_invasion_fleet }
						fleet_event = { id = exe_return_invasion.12 days = 1 random = 2 }
					}
					set_global_flag = can_win_the_fleet_stage_1
				}
			}
			else = { if = {
				limit = { check_variable = { which = ag_kuat_invasion_fleet_arrived value = 20 } }
				every_owned_fleet = { limit = { has_fleet_flag = ag_kuat_invasion_fleet } fleet_event = { id = exe_return_invasion.12 days = 1 random = 2 } }
				set_global_flag = can_win_the_fleet_stage_1
			} } 
		}
		set_update_modifiers_batch = end
	}
}

#recycle reinforcement
country_event = {
	id = exe_return_invasion.19
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		exists = event_target:eternal_fleet_country
		is_eternal_faction = yes
		NOT = { has_global_flag = can_win_the_fleet }
		has_global_flag = can_win_the_fleet_stage_1
	}
	immediate = {
		set_update_modifiers_batch = begin
		if = {
			limit = { 
				if = {
					limit = { any_country = { is_ai = no OR = {
						has_origin = origin_kuat_apocalyptic
						has_origin = origin_eternalthrone
					} } }
					if = {
						limit = { event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value <= 1 }
						} }
						count_owned_fleet = { limit = { has_fleet_flag = ag_kuat_invasion_fleet } count < 4 }
					}
					else_if = {
						limit = { event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value = 2 }
						} }
						count_owned_fleet = { limit = { has_fleet_flag = ag_kuat_invasion_fleet } count < 8 }
					}
					else_if = {
						limit = { event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value = 3 }
						} }
						count_owned_fleet = { limit = { has_fleet_flag = ag_kuat_invasion_fleet } count < 12 }
					}
					else_if = {
						limit = { event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value = 4 }
						} }
						count_owned_fleet = { limit = { has_fleet_flag = ag_kuat_invasion_fleet } count < 16 }
					}
					else_if = {
						limit = { event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value = 5 }
						} }
						count_owned_fleet = { limit = { has_fleet_flag = ag_kuat_invasion_fleet } count < 20 }
					}
					else_if = {
						limit = { event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value = 6 }
						} }
						count_owned_fleet = { limit = { has_fleet_flag = ag_kuat_invasion_fleet } count < 24 }
					}
					else_if = {
						limit = { event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value = 7 }
						} }
						count_owned_fleet = { limit = { has_fleet_flag = ag_kuat_invasion_fleet } count < 28 }
					}
					else_if = {
						limit = { event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value = 8 }
						} }
						count_owned_fleet = { limit = { has_fleet_flag = ag_kuat_invasion_fleet } count < 32 }
					}
					else_if = {
						limit = { event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value = 9 }
						} }
						count_owned_fleet = { limit = { has_fleet_flag = ag_kuat_invasion_fleet } count < 36 }
					}
					else_if = {
						limit = { event_target:global_event_country = {
							check_variable = { which = eternal_fleet_return_index value >= 10 }
						} }
						count_owned_fleet = { limit = { has_fleet_flag = ag_kuat_invasion_fleet } count < 40 }
					}
				}
				else = { count_owned_fleet = { limit = { has_fleet_flag = ag_kuat_invasion_fleet } count < 20 } }
			}
			every_rim_system = {
				limit = { has_star_flag = eternal_starbase_megastructure_in_system }
				system_star = { create_exe_retrun_invasion_fleet_detail = yes }
			}
			every_country = {
				limit = { has_event_chain = ag_exe_invasion_chain }
				add_event_chain_counter = { event_chain = ag_exe_invasion_chain counter = ag_exe_invasion_fleet amount = 4 }
			}
		}
		country_event = { id = exe_return_invasion.19 days = 180 }
		set_update_modifiers_batch = end
	}
}

#Invasion fleet action. 
fleet_event = {
	id = exe_return_invasion.12
	hide_window = yes
	is_triggered_only = yes
	trigger = { exists = this }
	immediate = { ag_exe_invasion_fleet_action = yes }
}

#Invasion fleet action on win a space battle. 
country_event = {
	id = exe_return_invasion.13
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_eternal_faction = yes
		fromfrom = { fleet = { has_fleet_flag = ag_kuat_invasion_fleet } }
		fromfromfrom = { OR = {
			is_ship_class = shipclass_starbase
			is_ship_class = shipclass_military
		} }
	}
	after = {
		fromfrom = {
			solar_system = {
				every_fleet_in_system = {
					limit = {
						exists = owner
						owner = { is_eternal_faction = yes }
						has_fleet_flag = ag_kuat_invasion_fleet
					}
					clear_orders = yes
					clear_fleet_actions = this
					fleet_event = { id = exe_return_invasion.12 days = 3 random = 2 }
				}
			}
		}
	}
}

#Invasion fleet action on orbit planet. 
country_event = {
	id = exe_return_invasion.14
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_eternal_faction = yes
		from = { has_fleet_flag = ag_kuat_invasion_fleet }
		fromfrom = { OR = {
			is_star = yes
			NOT = { exists = owner }
		} }
	}
	immediate = {
		from = {
			clear_orders = yes
			clear_fleet_actions = this
			fleet_event = { id = exe_return_invasion.12 days = 3 random = 2 }
		}
	}
}

#Reset invasion fleet action if two fleet in same system. 
fleet_event = {
	id = exe_return_invasion.15
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_fleet_flag = ag_kuat_invasion_fleet
		from = {
			NOR = {
				kuat_is_kuat_system = yes
				has_star_flag = kuat_military_base_local_home
				has_star_flag = kuat_military_sublocal_home
			}
			any_fleet_in_system = {
				NOT = { is_same_value = root }
				has_fleet_flag = ag_kuat_invasion_fleet
			}
		}
	}
	immediate = {
		clear_orders = yes
		clear_fleet_actions = this
		from = {
			random_neighbor_system = {
				system_star = { root = { auto_move_to_planet = { target = prev clear_auto_move_on_arrival = yes } } }
			}
		}
	}
}

#Check every month to prevent bugs.
event = {
	id = exe_return_invasion.16
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = exe_return_invasion_begin
		NOT = { has_global_flag = exe_return_invasion_ended }
		exists = event_target:eternal_fleet_country
		event_target:eternal_fleet_country = {
			any_owned_fleet = {
				exists = this
				is_fleet_idle = yes
				has_fleet_flag = ag_kuat_invasion_fleet
				NAND = {
					exists = orbit
					orbit = {
						NOT = { is_star = yes }
						exists = owner
						owner = { is_hostile = event_target:eternal_fleet_country }
						exists = controller
						controller = { is_hostile = event_target:eternal_fleet_country }
					}
				}
			}
		}
	}
	immediate = {
		event_target:eternal_fleet_country = {
			every_owned_fleet = {
				limit = {
					exists = this
					is_fleet_idle = yes
					has_fleet_flag = ag_kuat_invasion_fleet
					NAND = {
						exists = orbit
						orbit = {
							NOT = { is_star = yes }
							exists = owner
							owner = { is_hostile = event_target:eternal_fleet_country }
							exists = controller
							controller = { is_hostile = event_target:eternal_fleet_country }
						}
					}
				}
				clear_orders = yes
				clear_fleet_actions = this
				fleet_event = { id = exe_return_invasion.12 days = 3 random = 2 }
			}
		}
	}
}

#Invasion fleet bombard a planet. 
planet_event = {
	id = exe_return_invasion.21
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		exists = owner
		has_global_flag = exe_return_invasion_begin
		NOT = { has_global_flag = exe_return_invasion_ended }
		planet_devastation = 100
		from = { is_eternal_faction = yes }
	}
	immediate = { 
		reset_planet = yes
		destroy_colony = yes
		owner = { country_event = { id = exe_return_invasion.34 } } 
		if = {
			limit = { kuat_is_ringworld = yes }
			spawn_ringworld_cracker_effect = yes
			change_pc = pc_ringworld_habitable_damaged
			set_planet_entity = { entity = ringworld_habitable_damaged_entity }
		}
		else_if = {
			limit = { kuat_is_habitat = yes }
			spawn_habitat_cracker_effect = yes
			remove_planet = yes
		}
		else_if = {
			limit = { has_modifier = "holy_planet" }
			change_pc = pc_shattered
			remove_modifier = "holy_planet"
			add_modifier = { modifier = "ag_shattered_holy_planet" }
		}
		else = { change_pc = pc_broken }
		every_country = {
			limit = {
				NOT = { is_same_value = event_target:eternal_fleet_country }
				has_event_chain = ag_exe_invasion_chain
			}
			add_event_chain_counter = { event_chain = ag_exe_invasion_chain counter = ag_exe_invasion_planet_destroyed amount = 1 }
			if = {
				limit = { has_event_chain = ag_return_eternal_chain }
				add_event_chain_counter = { event_chain = ag_return_eternal_chain counter = ag_exe_invasion_planet_destroyed amount = 1 }
			}
		}
		solar_system = {
			every_fleet_in_system = {
				limit = {
					exists = owner
					owner = { is_eternal_faction = yes }
					has_fleet_flag = ag_kuat_invasion_fleet
					OR = {
						AND = { exists = orbit orbit = { is_same_value = root } }
						AND = {
							is_fleet_idle = yes
							NAND = {
								exists = orbit
								orbit = {
									NOT = { is_star = yes }
									exists = owner
									owner = { is_hostile = event_target:eternal_fleet_country }
								}
							}
						}
					}
				}
				clear_orders = yes
				clear_fleet_actions = this
				fleet_event = { id = exe_return_invasion.12 days = 1 random = 2 }
			}
		}	
	}
}

country_event = {
	id = exe_return_invasion.34
	title = "exe_invasion.21.name"
	desc = {
		trigger = { from = { kuat_is_event_borderment_ringworld = no } }
		text = "exe_invasion.21.a.desc"
	}
	desc = {
		trigger = { from = { kuat_is_ringworld = yes } }
		text = "exe_invasion.21.b.desc"
	}
	desc = {
		trigger = { from = { is_planet_class = pc_habitat } }
		text = "exe_invasion.21.c.desc"
	}
	desc = {
		trigger = { from = { kuat_is_holy_world_planet = yes } }
		text = "exe_invasion.21.d.desc"
	}
	diplomatic = yes
	picture_event_data = { room = nuclear_explosion_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_super_explosion
	is_triggered_only = yes
	option = { name = "exe_invasion.21.a" ai_chance = { weight = 100 } }
}

#Invasion fleet killed counter. 
country_event = {
	id = exe_return_invasion.22
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = exe_return_invasion_begin
		is_eternal_faction = yes
	}
	immediate = {
		from = {
			add_event_chain_counter = { event_chain = ag_exe_invasion_chain counter = ag_exe_invasion_ship_kill_by_us amount = 1 }
			if = {
				limit = { has_event_chain = ag_return_eternal_chain }
				add_event_chain_counter = { event_chain = ag_return_eternal_chain counter = ag_exe_invasion_ship_kill_by_us amount = 1 }
			}
		}
		every_country = {
			limit = {
				has_event_chain = ag_exe_invasion_chain
				NOT = { is_same_value = from }
			}
			add_event_chain_counter = { event_chain = ag_exe_invasion_chain counter = ag_exe_invasion_ship_kill_by_other amount = 1 }
			if = {
				limit = { has_event_chain = ag_return_eternal_chain }
				add_event_chain_counter = { event_chain = ag_return_eternal_chain counter = ag_exe_invasion_ship_kill_by_other amount = 1 }
			}
		}
	}
}

#Invasion fleet victim counter.
country_event = {
	id = exe_return_invasion.23
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = exe_return_invasion_begin
		is_eternal_faction = yes
		from = { is_eternal_faction = no }
	}
	immediate = {
		every_country = {
			limit = {
				NOT = { is_same_value = event_target:eternal_fleet_country }
				has_event_chain = ag_exe_invasion_chain
			}
			add_event_chain_counter = { event_chain = ag_exe_invasion_chain counter = ag_exe_invasion_victim amount = 1 }
			if = {
				limit = { has_event_chain = ag_return_eternal_chain }
				add_event_chain_counter = { event_chain = ag_return_eternal_chain counter = ag_exe_invasion_victim amount = 1 }
			}
		}
		from = { change_variable = { which = eternal_bornus_var value = 1 } }
	}
}

#An invasion fleet has been destroyed. 
country_event = {
	id = exe_return_invasion.31
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = exe_return_invasion_begin
		from = { is_eternal_faction = yes }
		fromfromfrom = { has_fleet_flag = ag_kuat_invasion_fleet }
	}
	immediate = {
		fromfromfrom = { if = {
			limit = { NOT = { has_fleet_flag = fire_only_once_temple } }
			set_timed_fleet_flag = { flag = fire_only_once_temple days = 1 }
			every_country = {
				limit = { has_event_chain = ag_exe_invasion_chain }
				add_event_chain_counter = { event_chain = ag_exe_invasion_chain counter = ag_exe_invasion_fleet amount = -1 }
			}
			event_target:global_event_country = { change_variable = { which = count_destroy_eternal_fleet value = 1 } }
		} }
	}
}

#All invasion fleet destroyed, invasion end. 
country_event = {
	id = exe_return_invasion.30
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = exe_return_invasion_begin
		from = {
			is_eternal_faction = yes
			count_owned_fleet = {
				count = 0
				limit = { has_fleet_flag = ag_kuat_invasion_fleet NOT = { is_same_value = root.fromfromfrom } }
			}
		}
		fromfromfrom = { has_fleet_flag = ag_kuat_invasion_fleet }
		has_global_flag = can_win_the_fleet
	}
	immediate = {
		set_global_flag = enable_the_eternal_starbase
		from = { every_owned_fleet = { limit = { has_fleet_flag = ag_kuat_invasion_starbase } set_event_locked = no } }
	}
}

country_event = {
	id = exe_return_invasion.37
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = can_win_the_fleet
		any_owned_fleet = { has_fleet_flag = ag_kuat_invasion_starbase }
	}
	immediate = {
		if = {
			limit = { NOT = {
				any_owned_fleet = { has_fleet_flag = ag_kuat_invasion_fleet }
			} }
			set_global_flag = enable_the_eternal_starbase
			every_owned_fleet = {
				limit = { has_fleet_flag = ag_kuat_invasion_starbase }
				set_event_locked = no
			}
		}
		else = { country_event = { id = exe_return_invasion.37 days = 30 } }
	}
}

#All invasion starbase destroyed, invasion end. 
country_event = {
	id = exe_return_invasion.32
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = exe_return_invasion_begin
		from = {
			is_eternal_faction = yes
			count_owned_fleet = {
				count = 0
				limit = { 
					has_fleet_flag = ag_kuat_invasion_starbase 
					NOT = { has_fleet_flag = ag_kuat_invasion_starbase_disable }
					NOT = { is_same_value = root.fromfromfrom } 
				}
			}
		}
		has_global_flag = enable_the_eternal_starbase
		fromfromfrom = { 
			has_fleet_flag = ag_kuat_invasion_starbase 
			NOT = { has_fleet_flag = ag_kuat_invasion_starbase_disable }
		}
		event_target:eternal_fleet_country = { check_variable = { which = ag_kuat_invasion_starbase_arrived value = 4 } }
	}
	immediate = {
		every_country = {
			limit = { NOR = { 
				is_same_value = event_target:eternal_fleet_country 
				has_country_flag = trigger_ended_event_temple
			} }
			set_timed_country_flag = { flag = trigger_ended_event_temple days = 1 }
			country_event = { id = exe_return_invasion.35 }
		}
		add_threat = { who = root amount = 50 }
		set_global_flag = exe_return_invasion_ended
		remove_global_flag = eternal_return_fleet_debug_check
		remove_global_flag = ai_fighting_with_player_against_eternal
		from = { destroy_country = yes }
	}
}

#Notification: Invasion end. 
country_event = {
	id = exe_return_invasion.35
	title = "exe_return_invasion.35.name"
	desc = {
		trigger = { kuat_is_enable_shadow_origin = yes }
		text = "exe_return_invasion.35.desc"
	}
	desc = {
		trigger = { has_origin = origin_kuat_apocalyptic }
		text = "exe_return_invasion.36.desc"
	}
	desc = {
		trigger = { has_origin = origin_eternalthrone }
		text = "kuat_facility_return_invasion.36.desc"
	}
	diplomatic = yes
	picture_event_data = { room = Eternal_Empire_room }
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	show_sound = event_wind_ruins
	is_triggered_only = yes
	immediate = { 
		remove_global_flag = eternal_return_fleet_debug_check 
		remove_global_flag = ai_fighting_with_player_against_eternal
	}
	option = { 
		name = "exe_return_invasion.35.b" 
		ai_chance = { weight = 5 }
		hidden_effect = {
			if = {
				limit = { is_ai = no kuat_is_enable_shadow_origin = yes }
				set_country_flag = kuat_can_buid_kuat_building
				set_country_flag = kuat_debug_give_all_tech_flag
				add_research_option = tech_kuat_ground_yards
				add_research_option = tech_kuat_megastructrue
				add_research_option = tech_kuat_resource_center
				add_research_option = tech_kuat_command_center
				country_event = { id = exe_return_invasion.38 days = 30 random = 2 }
			}
			if = {
				limit = { is_ai = no has_origin = origin_kuat_apocalyptic }
				event_target:global_event_country = { change_variable = { which = eternal_fleet_return_index value = 3 } }
				change_variable = { which = eternal_bornus_var value = 12000 }
				reset_return_eternal_fleet = yes
			}
			if = {
				limit = { is_ai = no has_origin = origin_eternalthrone  }
				remove_global_flag = disable_kuat_by_passed
				set_global_flag = enable_attack_facility_Area
				if = {
					limit = { has_country_flag = eternal_fleet_ennded_A }
					country_event = { id = kuat_facility_return_invasion.21 days = 2 random = 2 }
				}
				else_if = {
					limit = { has_country_flag = eternal_fleet_ennded_B }
					country_event = { id = kuat_facility_return_invasion.24 days = 2 random = 2 }
				}
			}
			set_country_flag = kuat_can_buid_kuat_building_T2
		}
		end_event_chain = ag_exe_invasion_chain
	}
}

#Spawn starbase
fleet_event = {
	id = exe_return_invasion.36
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		exists = this
		exists = owner
		owner = { is_eternal_crisis = yes }
		from = { NOT = { exists = starbase } }
	}
	immediate = {
		if = {
			limit = { exists = from from = {
				NOR = {
					exists = starbase
					any_fleet_in_system = { exists = owner owner = { is_hostile = root.owner } }
					any_system_planet = { exists = owner owner = { is_hostile = root.owner } }
				}
			} }
			from = { create_starbase = { size = exe_starbase owner = root.owner } }
		}
	}
}

#after crisis
country_event = {
	id = exe_return_invasion.38
	title = "exe_return_invasion.38.title"
	desc = {
		trigger = { has_country_flag = fire_once_contact }
		text = "exe_return_invasion.38.fdesc"
	}
	desc = {
		trigger = { NOT = { has_country_flag = fire_once_contact } }
		text = "exe_return_invasion.38.desc"
	}
	diplomatic = yes
	picture_event_data = {
		portrait = event_target:kuat_player_target_species
		room = kuat_mega_shipyard_room
	}
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	show_sound = event_wind_ruins
	is_triggered_only = yes
	trigger = { NOT = { has_event_chain = ag_exe_invasion_chain } }
	option = { 
		name = exe_return_invasion.38.a 
		is_dialog_only = yes
		hidden_effect = { set_country_flag = fire_once_contact }
		response_text = exe_return_invasion.38.a.resp 
	}
	option = { 
		name = exe_return_invasion.38.b 
		is_dialog_only = yes
		hidden_effect = { set_country_flag = fire_once_contact }
		response_text = exe_return_invasion.38.b.resp 
	}
	#
	option = { 
		name = exe_return_invasion.38.c 
		is_dialog_only = yes
		hidden_effect = { set_country_flag = fire_once_contact }
		response_text = exe_return_invasion.38.c.resp 
	}
	#
	option = { 
		name = exe_return_invasion.38.d 
		is_dialog_only = yes
		hidden_effect = { set_country_flag = fire_once_contact }
		response_text = exe_return_invasion.38.d.resp 
	}
	#
	option = { 
		name = exe_return_invasion.38.e
		response_text = exe_return_invasion.38.e.resp 
	}
}

event = {
	id = exe_return_invasion.39
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_global_flag = eternal_return_fleet_debug_check
		NOT = { exists = event_target:eternal_fleet_country }
		has_global_flag = exe_return_invasion_begin
		NOT = { has_global_flag = exe_return_invasion_ended }
	}
	immediate = {
		every_country = {
			remove_country_flag = fire_first_find
			remove_country_flag = second_first_find
			remove_country_flag = third_first_find
			clear_variable = num_vaild_system
			clear_variable = num_finish
		}
		every_system = {
			limit = { OR = {
				has_star_flag = final_1_system
				has_star_flag = final_2_system
				has_star_flag = final_3_system
			} }
			remove_star_flag = final_1_system
			remove_star_flag = final_2_system
			remove_star_flag = final_3_system
		}
		remove_global_flag = can_win_the_fleet_stage_1
		remove_global_flag = can_win_the_fleet
		remove_global_flag = exe_return_invasion_begin
		remove_global_flag = eternal_return_fleet_debug_check
		remove_global_flag = ai_fighting_with_player_against_eternal
		remove_global_flag = exe_invasion_signs_cooldown
		set_global_flag = exe_return_invasion_7_fired
	}
}