namespace = kuat_final_crisis_events

#kuat_final_crisis_events.5 6 7 8 				NOTIFIACTION FOR CRISIS ARRIVED												（危机抵达）
#kuat_final_crisis_events.10      				BOMBARMENT COLONY EVENT														（轰炸殖民地）
#kuat_final_crisis_events.14 141 142 143 		COMMON LOOPING RAINFORCEMENT 												（循环刷进攻部队）
#kuat_final_crisis_events.102 103 104 105		DEFENCED FLEET GENRAL LOOPING TRIGGER EVENT 								（循环刷新防御舰队的总控制）
#kuat_final_crisis_events.400 500 600 700		DEFENCED FLEET GENERAL EVENT 												（循环刷新防御舰队效果）
#kuat_final_crisis_events.4 41 42 43 			INITIAL COMMON ATTACK FLEET GENERAL EVENT									（预设舰队生成）
#kuat_final_crisis_events.401					DEFENCED FLEET BEEN ATTACK FLEET LONG TIME AGO								（在很久以后将防御舰队转化为进攻舰队离开星系）
#kuat_final_crisis_events.11					RAKATA CRISIS BASE DESTROYED TRIGGER 										（拉卡塔据点被摧毁的控制事件）
#kuat_final_crisis_events.101					ALL RAKATA BASE BEEN DESTROYED EFFECT 										（所有的拉卡塔据点被摧毁以后的效果）
#kuat_final_crisis_events.12					ALL RAKATA BASE BEEN DESTROYED NOTIFICATION 								（所有的拉卡塔据点被摧毁以后的通知）
#kuat_final_crisis_events.13					DEBUG CHECK WHEN ALL BASE BEEN DESTROYED BUT CRISIS NOT END 				（DEBUG检测，防止所有单位被消灭了但危机没有结束）
#kuat_final_crisis_events.3						GENERAL INFINITE FIRST BASE													 (第一行动基地)
#kuat_final_crisis_events.15					GENERAL INFINITE SHIPYARD SYSTEM 											 (无限构筑厂)
#kuat_final_crisis_events.16					GENERAL INFINITE SECOND BASE												 (第二行动基地)
#kuat_final_crisis_events.17					GENERAL THE LAST BASE 														 (最后一个星门/第三行动基地)
#kuat_final_crisis_events.20					DIPLOMAY TO INFINITE EMPIRE 												（玩家联系拉卡塔帝国，外交）
#kuat_final_crisis_events.40					ATTACK FLEET QUEUE ACTION 													（舰队脚本）
#kuat_final_crisis_events.46					RESET FLEET ACTION AND VARIABLE 											（脚本变量清理）
#kuat_final_crisis_events.47					BOMBARMENT NON_COLONY EVENT 												（轰炸非殖民，实际表现不明）
#kuat_final_crisis_events.44 45					EVENTCHAIN COUNT KILLED AND KILL 											（事件链内计数）
#kuat_final_crisis_events.50 51	53				ENDED AND CRISIS OVER 														（危机结束）
#kuat_final_crisis_events.54 55 56				CREATE 3 15 16 17 SYSTEM INTERESTING POI 									（据点刷新的时候得兴趣点）
#kuat_final_crisis_events.57 58 61				LINK TO 54 55 56 FOR INFINITE DIPLOMACY										（兴趣点出现以后无限帝国叫嚣）
#kuat_final_crisis_events.998					TRUE ENDED NOW EVERYTHING WILL FINISH 										（危机完全结束）
#kuat_final_crisis_events.59 60 				INFINITE STARBASE PROTECTION												 (事件机制)

@rakata_guradian_fleet_count = 2
# rakata invasion begin
country_event = {
	id = kuat_final_crisis_events.3
	hide_window = yes
	fire_only_once = yes
	is_triggered_only = yes
	trigger = { NOT = { has_global_flag = Kuat_Rakata_invasion_happened	} }
	immediate = {
		set_update_modifiers_batch = begin
		set_global_flag = Kuat_Rakata_invasion_happened
		initialize_Rakata_crisis_system_select = yes
		random_system = {
			limit = { NOT = { has_star_flag = forbit_spawn_system } }
			set_star_flag = Kuat_Rakata_first_warp_portal_system
			save_global_event_target_as = Kuat_Rakata_first_warp_portal_system
			random_system_planet = {
				create_country = {
					name = "Infinite Empire"
					type = "Infinite_empire"
					species = root
					flag = {
						icon = {
							category = "Kuat"
							file = "Inf_flag_01.dds"
						}
						background = {
							category = "backgrounds"
							file = "00_solid.dds"
						}
						colors= { "white" "black" "null" "null" }
					}
					effect = {
						set_country_flag = protected_from_queen_storm
						set_country_flag = Infinite_empire
						save_global_event_target_as = Infinite_empire
						set_global_flag = Kuat_Rakata_first_warp_portal_opened
						set_graphical_culture = fallen_empire_kuat_01
						create_ship_design = { design = "NAME_EXE_Starbase" }
						add_ship_design = last_created_design
						add_modifier = { modifier = Elternal_creating }
						create_ship_design = { design = "NAME_EXE_Starbase_Construction" }
						add_ship_design = last_created_design
					}
				}
				PREV = {
					if = {
						limit = { exists = starbase }
						starbase = { fleet = { destroy_fleet = this } }
					}
					create_starbase = {
						size = exe_starbase
						owner = event_target:Infinite_empire
					}
					set_star_flag = Kuat_Rakata_first_warp_portal
					save_global_event_target_as = Kuat_Rakata_first_warp_portal_system_for_door
				}
				event_target:Infinite_empire = {
					country_event = { id = kuat_final_crisis_events.4  days = 2 }
					country_event = { id = kuat_final_crisis_events.4  days = 4 }
					country_event = { id = kuat_final_crisis_events.102 days = 720 }
					country_event = { id = kuat_final_crisis_events.14 days = 360 }
				}
				while = {
					count = @rakata_guradian_fleet_count
					create_Kuat_Rakata_crisis_greater_fleet = yes
				}
			}
		}
		every_playable_country = {
			if = {
				limit = { intel_level = { level = high system = event_target:Kuat_Rakata_first_warp_portal_system } }
				country_event = { id = kuat_final_crisis_events.5 }
			}
			if = {
				limit = { NOT = { intel_level = { level = high system = event_target:Kuat_Rakata_first_warp_portal_system } } }
				country_event = { id = kuat_final_crisis_events.6 }
			}
		}
		set_update_modifiers_batch = end
	}
}

# notification (have system intel high level)
country_event = {
	id = kuat_final_crisis_events.5
	title = "kuat_final_crisis_events.5.name"
	desc = "kuat_final_crisis_events.5.desc"
	diplomatic = yes
	picture_event_data = { room = fallen_empire_awakes_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_ex_started
	location = event_target:Kuat_Rakata_first_warp_portal_system
	is_triggered_only = yes
	after = {
		begin_event_chain = {
			event_chain = "kuat_rakata_invasion_chain"
			target = ROOT
		}
		create_point_of_interest = {
			id = Kuat_Rakata_invasion_poi.1
			name = "Kuat_Rakata_invasion_1_poi"
			desc = "Kuat_Rakata_invasion_1_poi_desc"
			event_chain = "kuat_rakata_invasion_chain"
			location = event_target:Kuat_Rakata_first_warp_portal_system
		}
		hidden_effect = { country_event = { id = kuat_final_crisis_events.8 } }
	}
	option = { name = kuat_final_crisis_events.5.a }
}

# notification (have system intel low level)
country_event = {
	id = kuat_final_crisis_events.6
	title = "kuat_final_crisis_events.6.name"
	desc = "kuat_final_crisis_events.6.desc"
	diplomatic = yes
	picture_event_data = { room = ancient_databank_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_alien_signal
	is_triggered_only = yes
	option = {
		name = kuat_final_crisis_events.6.a
		hidden_effect = { country_event = { id = kuat_final_crisis_events.7 days = 30 } }
	}
}

# second notification (have system intel low level)
country_event = {
	id = kuat_final_crisis_events.7
	title = "kuat_final_crisis_events.7.name"
	desc = "kuat_final_crisis_events.7.desc"
	diplomatic = yes
	picture_event_data = { room = fallen_empire_awakes_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_ex_started
	location = event_target:Kuat_Rakata_first_warp_portal_system
	is_triggered_only = yes
	after = {
		begin_event_chain = {
			event_chain = "kuat_rakata_invasion_chain"
			target = ROOT
		}
		create_point_of_interest = {
			id = Kuat_Rakata_invasion_poi.1
			name = "Kuat_Rakata_invasion_1_poi"
			desc = "Kuat_Rakata_invasion_1_poi_desc"
			event_chain = "kuat_rakata_invasion_chain"
			location = event_target:Kuat_Rakata_first_warp_portal_system
		}
		hidden_effect = { country_event = { id = kuat_final_crisis_events.8 } }
	}
	option = { name = kuat_final_crisis_events.5.a }
}

## final notification (invasion established)
country_event = {
	id = kuat_final_crisis_events.8
	title = "kuat_final_crisis_events.8.name"
	desc = "kuat_final_crisis_events.8.desc"
	diplomatic = yes
	picture_event_data = { 
		portrait = event_target:kuat_astral_rift_event_leader_rakata
		room = root 
	}
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	is_triggered_only = yes
	immediate = { establish_communications_no_message = event_target:Infinite_empire }
	option = { name = kuat_final_crisis_events.8.a }
	after = { event_target:Eternalempire = { country_event = { id = ag_kae_ge_invasion.255 days = 2 } } }
}

# bombarment planet
planet_event = {
	id = kuat_final_crisis_events.10
	title = "kuat_final_crisis_events.10.name"
	desc = "kuat_final_crisis_events.10.desc"
	diplomatic = yes
	picture_event_data = { room = nuclear_explosion_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_ghost_town
	is_triggered_only = yes
	trigger = {
		planet_devastation = 100
		FROM = { is_infinite_faction = yes }
	}
	immediate = {
		reset_planet = yes
		destroy_colony = yes
		if = {
			limit = { kuat_is_ringworld = yes }
			spawn_ringworld_cracker_effect = yes
			change_pc = pc_ringworld_habitable_damaged
			set_planet_entity = { entity = ringworld_habitable_damaged_entity }
		}
		else_if = {
			limit = { kuat_is_habitat = yes }
			spawn_habitat_cracker_effect = yes
			remove_planet = yes
		}
		else_if = {
			limit = { has_modifier = "holy_planet" }
			change_pc = pc_shattered
			remove_modifier = "holy_planet"
			add_modifier = { modifier = "ag_shattered_holy_planet" }
		}
		else = { change_pc = pc_broken }
		if = {
			limit = {
				FROM = { is_infinite_faction = yes }
			}
			every_country = {
				limit = { has_event_chain = "kuat_rakata_invasion_chain" }
				add_event_chain_counter = {
					event_chain = "kuat_rakata_invasion_chain"
					counter = "kuat_rakata_invastor_planets"
					amount = 1
				}
			}
		}	
	}
	option = { name = kuat_final_crisis_events.10.a }
}

# looping reinforcement attack fleet first door
country_event = {
	id = kuat_final_crisis_events.14
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_infinite_faction = yes
		NOT = { has_global_flag = Kuat_Rakata_first_warp_portal_destroyed }
	}
	immediate = {
		if = {
			limit = {  
				has_global_flag = Kuat_Rakata_total_warp_portal_opened
				NOT = { has_global_flag = Kuat_Rakata_total_warp_portal_destroyed }
			}
			if = {
				limit = { num_ships > 3000 }
				country_event = { id = kuat_final_crisis_events.14 days = 60 random = 30 }
			}
			else = {
				event_target:Kuat_Rakata_first_warp_portal_system = {
					random_system_planet = { create_Kuat_Rakata_crisis_fleet_and_admiral = yes }
				}
				country_event = { id = kuat_final_crisis_events.14 days = 60 }
			}
		}
		else = {
			if = {
				limit = { num_ships > 1500 }
				country_event = { id = kuat_final_crisis_events.14 days = 120 random = 60 }
			}
			else = {
				event_target:Kuat_Rakata_first_warp_portal_system = {
					random_system_planet = { create_Kuat_Rakata_crisis_fleet_and_admiral = yes }
				}
				country_event = { id = kuat_final_crisis_events.14 days = 120 }
			}
		}
	}
}

# looping reinforcement attack fleet second door
country_event = {
	id = kuat_final_crisis_events.141
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_infinite_faction = yes
		NOT = { has_global_flag = Kuat_Rakata_second_warp_portal_destroyed }
	}
	immediate = {
		if = {
			limit = {  
				has_global_flag = Kuat_Rakata_total_warp_portal_opened
				NOT = { has_global_flag = Kuat_Rakata_total_warp_portal_destroyed }
			}
			if = {
				limit = { num_ships > 3000 }
				country_event = { id = kuat_final_crisis_events.141 days = 60 random = 30 }
			}
			else = {
				event_target:Kuat_Rakata_second_warp_portal_system = {
					random_system_planet = { create_Kuat_Rakata_crisis_fleet_and_admiral = yes }
				}
				country_event = { id = kuat_final_crisis_events.141 days = 60 }
			}
		}
		else = {
			if = {
				limit = { num_ships > 1500 }
				country_event = { id = kuat_final_crisis_events.141 days = 120 random = 60 }
			}
			else = {
				event_target:Kuat_Rakata_second_warp_portal_system = {
					random_system_planet = { create_Kuat_Rakata_crisis_fleet_and_admiral = yes }
				}
				country_event = { id = kuat_final_crisis_events.141 days = 120 }
			}
		}
	}
}

# looping reinforcement attack fleet third door
country_event = {
	id = kuat_final_crisis_events.142
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_infinite_faction = yes
		NOT = { has_global_flag = Kuat_Rakata_third_warp_portal_destroyed }
	}
	immediate = {
		if = {
			limit = {  
				has_global_flag = Kuat_Rakata_total_warp_portal_opened
				NOT = { has_global_flag = Kuat_Rakata_total_warp_portal_destroyed }
			}
			if = {
				limit = { num_ships > 3000 }
				country_event = { id = kuat_final_crisis_events.142 days = 60 random = 30 }
			}
			else = {
				event_target:Kuat_Rakata_third_warp_portal_system = {
					random_system_planet = { create_Kuat_Rakata_crisis_fleet_and_admiral = yes }
				}
				country_event = { id = kuat_final_crisis_events.142 days = 60 }
			}
		}
		else = {
			if = {
				limit = { num_ships > 1500 }
				country_event = { id = kuat_final_crisis_events.142 days = 120 random = 60 }
			}
			else = {
				event_target:Kuat_Rakata_third_warp_portal_system = {
					random_system_planet = { create_Kuat_Rakata_crisis_fleet_and_admiral = yes }
				}
				country_event = { id = kuat_final_crisis_events.142 days = 120 }
			}
		}
	}
}

# looping reinforcement attack fleet total door
country_event = {
	id = kuat_final_crisis_events.143
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_infinite_faction = yes
		NOT = { has_global_flag = Kuat_Rakata_total_warp_portal_destroyed }
	}
	immediate = {
		if = {
			limit = {  
				has_global_flag = Kuat_Rakata_total_warp_portal_opened
				NOT = { has_global_flag = Kuat_Rakata_total_warp_portal_destroyed }
			}
			if = {
				limit = { num_ships > 3000 }
				country_event = { id = kuat_final_crisis_events.143 days = 60 random = 30 }
			}
			else = {
				event_target:Kuat_Rakata_total_warp_portal_system = {
					random_system_planet = { create_Kuat_Rakata_crisis_fleet_and_admiral = yes }
				}
				country_event = { id = kuat_final_crisis_events.143 days = 60 }
			}
		}
		else = {
			if = {
				limit = { num_ships > 1500 }
				country_event = { id = kuat_final_crisis_events.143 days = 120 random = 60 }
			}
			else = {
				event_target:Kuat_Rakata_total_warp_portal_system = {
					random_system_planet = { create_Kuat_Rakata_crisis_fleet_and_admiral = yes }
				}
				country_event = { id = kuat_final_crisis_events.143 days = 120 }
			}
		}
	}
}

# looping reinforcement defence fleet first door section1
country_event = {
	id = kuat_final_crisis_events.102
	is_triggered_only = yes
	hide_window = yes
	trigger = {
		event_target:Kuat_Rakata_first_warp_portal_system = {
			exists = starbase
			starbase = { owner = { is_infinite_faction = yes } }
		}
	}
	immediate = {
		event_target:Kuat_Rakata_first_warp_portal_system = {
			random_system_planet = {
				planet_event = { id = kuat_final_crisis_events.400 days = 90 }
				planet_event = { id = kuat_final_crisis_events.400 days = 790 }
				planet_event = { id = kuat_final_crisis_events.400 days = 1490 }
				planet_event = { id = kuat_final_crisis_events.400 days = 2190 }
				ROOT = { country_event = { id = kuat_final_crisis_events.102 days = 3600 } }
			}
		}
	}
}

# looping reinforcement defence fleet second door section1
country_event = {
	id = kuat_final_crisis_events.103
	is_triggered_only = yes
	hide_window = yes
	trigger = {
		event_target:Kuat_Rakata_second_warp_portal_system = {
			exists = starbase
			starbase = { owner = { is_infinite_faction = yes } }
		}
	}
	immediate = {
		event_target:Kuat_Rakata_second_warp_portal_system = {
			random_system_planet = {
				planet_event = { id = kuat_final_crisis_events.500 days = 90 }
				planet_event = { id = kuat_final_crisis_events.500 days = 790 }
				planet_event = { id = kuat_final_crisis_events.500 days = 1490 }
				planet_event = { id = kuat_final_crisis_events.500 days = 2190 }
				ROOT = { country_event = { id = kuat_final_crisis_events.103 days = 2400 } }
			}
		}
	}
}

# looping reinforcement defence fleet third door section1
country_event = {
	id = kuat_final_crisis_events.104
	is_triggered_only = yes
	hide_window = yes
	trigger = {
		event_target:Kuat_Rakata_third_warp_portal_system = {
			exists = starbase
			starbase = { owner = { is_infinite_faction = yes } }
		}
	}
	immediate = {
		event_target:Kuat_Rakata_third_warp_portal_system = {
			random_system_planet = {
				planet_event = { id = kuat_final_crisis_events.600 days = 90 }
				planet_event = { id = kuat_final_crisis_events.600 days = 790 }
				planet_event = { id = kuat_final_crisis_events.600 days = 1490 }
				planet_event = { id = kuat_final_crisis_events.600 days = 2190 }
				ROOT = { country_event = { id = kuat_final_crisis_events.104 days = 2400 } }
			}
		}
	}
}

# looping reinforcement defence fleet total door section1
country_event = {
	id = kuat_final_crisis_events.105
	is_triggered_only = yes
	hide_window = yes
	trigger = {
		event_target:Kuat_Rakata_total_warp_portal_system = {
			exists = starbase
			starbase = { owner = { is_infinite_faction = yes } }
		}
	}
	immediate = {
		event_target:Kuat_Rakata_total_warp_portal_system = {
			random_system_planet = {
				planet_event = { id = kuat_final_crisis_events.700 days = 90 }
				planet_event = { id = kuat_final_crisis_events.700 days = 790 }
				planet_event = { id = kuat_final_crisis_events.700 days = 1490 }
				planet_event = { id = kuat_final_crisis_events.700 days = 2190 }
				ROOT = { country_event = { id = kuat_final_crisis_events.105 days = 2400 } }
			}
		}
	}
}

# initial attack fleet first door
country_event = {
	id = kuat_final_crisis_events.4
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		event_target:Kuat_Rakata_first_warp_portal_system = {
			exists = starbase
			starbase = { owner = { is_infinite_faction = yes } }
		}
	}
	immediate = {
		event_target:Kuat_Rakata_first_warp_portal_system = {
			random_system_planet = { create_Kuat_Rakata_crisis_fleet_and_admiral = yes }
		}
	}
}

# initial attack fleet second door
country_event = {
	id = kuat_final_crisis_events.41
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		event_target:Kuat_Rakata_second_warp_portal_system = {
			exists = starbase
			starbase = { owner = { is_infinite_faction = yes } }
		}
	}
	immediate = {
		event_target:Kuat_Rakata_second_warp_portal_system = {
			random_system_planet = { create_Kuat_Rakata_crisis_fleet_and_admiral = yes }
		}
	}
}

# initial attack fleet third door
country_event = {
	id = kuat_final_crisis_events.42
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		event_target:Kuat_Rakata_third_warp_portal_system = {
			exists = starbase
			starbase = { owner = { is_infinite_faction = yes } }
		}
	}
	immediate = {
		event_target:Kuat_Rakata_third_warp_portal_system = {
			random_system_planet = { create_Kuat_Rakata_crisis_fleet_and_admiral = yes }
		}
	}
}

# initial attack fleet total door
country_event = {
	id = kuat_final_crisis_events.43
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		event_target:Kuat_Rakata_total_warp_portal_system = {
			exists = starbase
			starbase = { owner = { is_infinite_faction = yes } }
		}
	}
	immediate = {
		event_target:Kuat_Rakata_total_warp_portal_system = {
			random_system_planet = { create_Kuat_Rakata_crisis_fleet_and_admiral = yes }
		}
	}
}

# looping reinforcement defence fleet first door section2
planet_event = {
	id = kuat_final_crisis_events.400
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		event_target:Infinite_empire = {
			count_owned_ship = {
				limit = { is_ship_size = exe_starbase }
				count > 0
			}
		}
		event_target:Kuat_Rakata_first_warp_portal_system = {
			exists = starbase
			starbase = { owner = { is_infinite_faction = yes } }
		}
	}
	immediate = {
		event_target:Kuat_Rakata_first_warp_portal_system = {
			random_system_planet = {
				create_Kuat_Rakata_crisis_greater_fleet = yes
				last_created_fleet = {
					set_name = "Name_DFLEET"
					set_timed_fleet_flag = { flag = Kuat_Rakata_defence_fleet days = 720 }
					fleet_event = { id = kuat_final_crisis_events.401 days = 721 }
				}
			}
		}
	}
}

# looping reinforcement defence fleet second door section2
planet_event = {
	id = kuat_final_crisis_events.500
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		event_target:Infinite_empire = {
			count_owned_ship = {
				limit = { is_ship_size = exe_starbase }
				count > 0
			}
		}
		event_target:Kuat_Rakata_second_warp_portal_system = {
			exists = starbase
			starbase = { owner = { is_infinite_faction = yes } }
		}
	}
	immediate = {
		event_target:Kuat_Rakata_second_warp_portal_system = {
			random_system_planet = {
				create_Kuat_Rakata_crisis_greater_fleet = yes
				last_created_fleet = {
					set_name = "Name_DFLEET"
					set_timed_fleet_flag = { flag = Kuat_Rakata_defence_fleet days = 720 }
					fleet_event = { id = kuat_final_crisis_events.401 days = 721 }
				}
			}
		}
	}
}

# looping reinforcement defence fleet third door section2
planet_event = {
	id = kuat_final_crisis_events.600
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		event_target:Infinite_empire = {
			count_owned_ship = {
				limit = { is_ship_size = exe_starbase }
				count > 0
			}
		}
		event_target:Kuat_Rakata_third_warp_portal_system = {
			exists = starbase
			starbase = { owner = { is_infinite_faction = yes } }
		}
	}
	immediate = {
		event_target:Kuat_Rakata_third_warp_portal_system = {
			random_system_planet = {
				create_Kuat_Rakata_crisis_greater_fleet = yes
				last_created_fleet = {
					set_name = "Name_DFLEET"
					set_timed_fleet_flag = { flag = Kuat_Rakata_defence_fleet days = 720 }
					fleet_event = { id = kuat_final_crisis_events.401 days = 721 }
				}
			}
		}
	}
}

# looping reinforcement defence fleet total door section2
planet_event = {
	id = kuat_final_crisis_events.700
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		event_target:Infinite_empire = {
			count_owned_ship = {
				limit = { is_ship_size = exe_starbase }
				count > 0
			}
		}
		event_target:Kuat_Rakata_total_warp_portal_system = {
			exists = starbase
			starbase = { owner = { is_infinite_faction = yes } }
		}
	}
	immediate = {
		event_target:Kuat_Rakata_total_warp_portal_system = {
			random_system_planet = {
				create_Kuat_Worldship_Rakata_crisis_greater_fleet = yes
				last_created_fleet = {
					set_name = "Name_DFLEET"
					set_timed_fleet_flag = { flag = Kuat_Rakata_defence_fleet days = 720 }
					fleet_event = { id = kuat_final_crisis_events.401 days = 721 }
				}
			}
		}
	}
}

# defence fleet being attacker
fleet_event = {
	id = kuat_final_crisis_events.401
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		set_name = "Name_DFLEET_II"
		remove_fleet_flag = Kuat_Rakata_defence_fleet
		set_fleet_flag = Kuat_Rakata_attack_fleet
		owner = { change_variable = { which = "fleet_id" value = 1 } }
		if = {
			limit = { is_scope_type = fleet }
			set_variable = { which = "fleet_id" value = owner.fleet_id }
		}
		fleet_event = { id = kuat_final_crisis_events.40 }
	}
}

# starbase destroyed trigger
country_event = {
	id = kuat_final_crisis_events.11
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_infinite_faction = yes
		FROMFROM = { is_ship_size = exe_starbase }
	}
	immediate = {
		FROMFROM.FLEET = {
			if = {
				# 第一节点被破坏
				limit = {
					solar_system = { is_same_value = event_target:Kuat_Rakata_total_warp_portal_system_for_door }
					event_target:Kuat_Rakata_first_warp_portal_system_for_door = { has_star_flag = Kuat_Rakata_first_warp_portal }
				}
				set_global_flag = Kuat_Rakata_first_warp_portal_destroyed
				event_target:Kuat_Rakata_first_warp_portal_system_for_door = { remove_star_flag = Kuat_Rakata_first_warp_portal }
				clear_global_event_target = Kuat_Rakata_first_warp_portal_system_for_door
				every_country = {
					limit = { has_point_of_interest = { poi = Kuat_Rakata_invasion_poi.1 } }
					remove_point_of_interest = Kuat_Rakata_invasion_poi.1
				}
				if = {
					# 第二节点未出现则马上刷出
					limit = { NOT = { has_global_flag = Kuat_Rakata_second_warp_portal_opened } }
					event_target:Infinite_empire = { country_event = { id = kuat_final_crisis_events.16 } }
				}
				if = {
					# 所有节点被破坏
					limit = {
						has_global_flag = Kuat_Rakata_second_warp_portal_destroyed
						has_global_flag = Kuat_Rakata_third_warp_portal_destroyed
						has_global_flag = Kuat_Rakata_total_warp_portal_destroyed
					}
					event_target:Kuat_Rakata_first_warp_portal_system = { save_event_target_as = Rakat_last_warp_portal_system }
					ROOT.FROM = { country_event = { id = kuat_final_crisis_events.101 } }
				} 
				else = {
					# 尚有其他节点
					event_target:Kuat_Rakata_first_warp_portal_system = { save_event_target_as = kuat_rakata_destroyed_warp_portal_system }
					every_playable_country = { country_event = { id = kuat_final_crisis_events.53 } }
				}
			}
			else_if = {
				# 第二节点被破坏
				limit = {
					solar_system = { is_same_value = event_target:Kuat_Rakata_total_warp_portal_system_for_door }
					event_target:Kuat_Rakata_second_warp_portal_system_for_door = { has_star_flag = Kuat_Rakata_second_warp_portal }
				}
				set_global_flag = Kuat_Rakata_second_warp_portal_destroyed
				event_target:Kuat_Rakata_second_warp_portal_system_for_door = { remove_star_flag = Kuat_Rakata_second_warp_portal }
				clear_global_event_target = Kuat_Rakata_second_warp_portal_system_for_door
				every_country = {
					limit = { has_point_of_interest = { poi = Kuat_Rakata_invasion_poi.2 } }
					remove_point_of_interest = Kuat_Rakata_invasion_poi.2
				}
				if = {
					# 若第一节点被破坏，特殊节点未出现，则马上刷出特殊节点
					limit = {
						has_global_flag = Kuat_Rakata_first_warp_portal_destroyed
						NOT = { has_global_flag = Kuat_Rakata_total_warp_portal_opened }
					}
					event_target:Infinite_empire = { country_event = { id = kuat_final_crisis_events.15 } }
				}
				if = {
					# 所有节点被破坏
					limit = {
						has_global_flag = Kuat_Rakata_first_warp_portal_destroyed
						has_global_flag = Kuat_Rakata_third_warp_portal_destroyed
						has_global_flag = Kuat_Rakata_total_warp_portal_destroyed
					}
					event_target:Kuat_Rakata_second_warp_portal_system = { save_event_target_as = Rakat_last_warp_portal_system }
					ROOT.FROM = { country_event = { id = kuat_final_crisis_events.101 } }
				} 
				else = {
					# 尚有其他节点
					event_target:Kuat_Rakata_second_warp_portal_system = { save_event_target_as = kuat_rakata_destroyed_portal_system }
					every_playable_country = { country_event = { id = kuat_final_crisis_events.53 } }
				}
			}
			else_if = {
				# 特殊节点被破坏
				limit = {
					solar_system = { is_same_value = event_target:Kuat_Rakata_total_warp_portal_system_for_door }
					event_target:Kuat_Rakata_total_warp_portal_system_for_door = { has_star_flag = Kuat_Rakata_total_warp_portal }
				}
				set_global_flag = Kuat_Rakata_total_warp_portal_destroyed
				event_target:Kuat_Rakata_total_warp_portal_system_for_door = { remove_star_flag = Kuat_Rakata_total_warp_portal }
				clear_global_event_target = Kuat_Rakata_total_warp_portal_system_for_door
				every_country = {
					limit = { has_point_of_interest = { poi = Kuat_Rakata_invasion_poi.4 } }
					remove_point_of_interest = Kuat_Rakata_invasion_poi.4
				}
				if = {
					# 若特殊节点被破坏，第三节点未出现，则马上刷出第三节点
					limit = {
						has_global_flag = Kuat_Rakata_first_warp_portal_destroyed
						has_global_flag = Kuat_Rakata_second_warp_portal_destroyed
						NOT = { has_global_flag = Kuat_Rakata_third_warp_portal_opened }
					}
					event_target:Infinite_empire = { country_event = { id = kuat_final_crisis_events.17 } }
				}
				if = {
					# 所有节点被破坏
					limit = {
						has_global_flag = Kuat_Rakata_first_warp_portal_destroyed
						has_global_flag = Kuat_Rakata_second_warp_portal_destroyed
						has_global_flag = Kuat_Rakata_third_warp_portal_destroyed
					}
					event_target:Kuat_Rakata_total_warp_portal_system = { save_event_target_as = Rakat_last_warp_portal_system }
					ROOT.FROM = { country_event = { id = kuat_final_crisis_events.101 } }
				} 
				else = {
					# 尚有其他节点
					event_target:Kuat_Rakata_total_warp_portal_system = { save_event_target_as = kuat_rakata_destroyed_portal_system }
					every_playable_country = { country_event = { id = kuat_final_crisis_events.53 } }
				}
			}
			else_if = {
				# 第三节点被破坏
				limit = {
					solar_system = { is_same_value = event_target:Kuat_Rakata_total_warp_portal_system_for_door }
					event_target:Kuat_Rakata_third_warp_portal_system_for_door = { has_star_flag = Kuat_Rakata_third_warp_portal }
				}
				set_global_flag = Kuat_Rakata_third_warp_portal_destroyed
				event_target:Kuat_Rakata_third_warp_portal_system_for_door = { remove_star_flag = Kuat_Rakata_third_warp_portal }
				clear_global_event_target = Kuat_Rakata_second_warp_portal_system_for_door
				every_country = {
					limit = { has_point_of_interest = { poi = Kuat_Rakata_invasion_poi.3 } }
					remove_point_of_interest = Kuat_Rakata_invasion_poi.3
				}
				if = {
					# 所有节点被破坏
					limit = {
						has_global_flag = Kuat_Rakata_first_warp_portal_destroyed
						has_global_flag = Kuat_Rakata_second_warp_portal_destroyed
					}
					event_target:Kuat_Rakata_third_warp_portal_system = { save_event_target_as = Rakat_last_warp_portal_system }
					ROOT.FROM = {
						save_event_target_as = Kuat_Rakata_portal_killer
						country_event = { id = kuat_final_crisis_events.101 }
					}
				} 
				else = {
					# 尚有其他节点
					event_target:Kuat_Rakata_first_warp_portal_system = { save_event_target_as = kuat_rakata_destroyed_warp_portal_system }
					every_playable_country = { country_event = { id = kuat_final_crisis_events.53 } }
				}
			}
		}
	}
}

# destroyed all starbase give modfier
country_event = {
	id = kuat_final_crisis_events.101
	is_triggered_only = yes
	hide_window = yes
	fire_only_once = yes
	immediate = {
		set_global_flag = kuat_all_warp_portal_destroyed
		event_target:Eternalempire = { country_event = { id = ag_kae_ge_invasion.256 days = 5 random = 2 } }
		every_playable_country = {
			add_modifier = { modifier = "extradimensionals_defeated" days = 360 }
			country_event = { id = kuat_final_crisis_events.12 }
		}
		event_target:Eternalempire = { country_event = { id = ag_kae_ge_invasion.257 days = 1 random = 2 } }
	}
}

# notification(starbase destoryed)
country_event = {
	id = kuat_final_crisis_events.12
	title = "kuat_final_crisis_events.12.name"
	desc = "kuat_final_crisis_events.12.desc"
	diplomatic = yes
	picture_event_data = { room = exploding_ship_room }
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	show_sound = event_super_explosion
	is_triggered_only = yes
	option = { name = kuat_final_crisis_events.12.a }
}

# on_monthly_purly debug check(over the crisis)
event = {
	id = kuat_final_crisis_events.13
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		exists = event_target:Infinite_empire
		has_global_flag = Kuat_Rakata_invasion_happened
		event_target:Infinite_empire = {
			count_owned_ship = {
				limit = { is_ship_size = exe_starbase }
				count < 1
			}
		}
		has_global_flag = Kuat_Rakata_first_warp_portal_destroyed
		has_global_flag = Kuat_Rakata_second_warp_portal_destroyed
		has_global_flag = Kuat_Rakata_third_warp_portal_destroyed
		has_global_flag = Kuat_Rakata_total_warp_portal_destroyed
	}
	immediate = {
		if = {
			limit = { any_country = {
				is_infinite_faction = yes
				count_owned_ship = { count < 10 }
			} }
			random_country = {
				limit = { is_infinite_faction = yes }
				every_owned_fleet = { destroy_fleet = this }
				country_event = { id = kuat_final_crisis_events.50 }
			}
		}
	}
}

# mtth 6 years total door created
country_event = {
	id = kuat_final_crisis_events.15
	hide_window = yes
	trigger = {
		is_infinite_faction = yes
		has_global_flag = Kuat_Rakata_first_warp_portal_opened
		NOT = { has_global_flag = Kuat_Rakata_total_warp_portal_opened }
	}
	mean_time_to_happen = { months = 12 }
	fire_only_once = yes
	immediate = {
		set_global_flag = Kuat_Rakata_total_warp_portal_opened
		initialize_Rakata_crisis_system_select = yes
		initialize_Kuat_Rakata_total_warp_portal_system_select = yes
		random_system = {
			limit = { has_star_flag = kuat_rakata_hole_system_1 }
			set_star_flag = Kuat_Rakata_total_warp_portal_system
			save_global_event_target_as = Kuat_Rakata_total_warp_portal_system
			set_variable = {
				which = Kuat_Rakata_total_warp_portal_system_var
				value = event_target:global_event_country.exe_invasion_difficult_global_var
			}
			floor_variable = Kuat_Rakata_total_warp_portal_system_var
			if = {
				limit = { check_variable = { which = Kuat_Rakata_total_warp_portal_system_var value < 6 } }
				set_variable = { which = Kuat_Rakata_total_warp_portal_system_var value = 6 }
			}
			random_system_planet = {
				spawn_rakata_fleets_insane_total = yes
				ROOT = {
					while = {
						count = prevprev.Kuat_Rakata_total_warp_portal_system_var
						country_event = { id = kuat_final_crisis_events.43 days = 16 }
					}
					country_event = { id = kuat_final_crisis_events.105 days = 720 } #循环刷辅助守家舰队
					country_event = { id = kuat_final_crisis_events.143 days = 360 }
				}
			}
			if = {
				limit = { exists = starbase }
				starbase = { fleet = { destroy_fleet = this } }
			}
			create_starbase = {
				size = exe_starbase
				owner = event_target:Infinite_empire
			}
			set_star_flag = Kuat_Rakata_total_warp_portal
			save_global_event_target_as = Kuat_Rakata_total_warp_portal_system_for_door
		}
		every_playable_country = {
			limit = { is_ai = no }
			country_event = { id = kuat_final_crisis_events.56 }
		}
	}
}

# mtth 6 years second door created
country_event = {
	id = kuat_final_crisis_events.16
	hide_window = yes
	trigger = {
		is_infinite_faction = yes
		has_global_flag = Kuat_Rakata_first_warp_portal_opened
		NOT = { has_global_flag = Kuat_Rakata_second_warp_portal_opened }
	}
	mean_time_to_happen = { months = 6 }
	fire_only_once = yes
	immediate = {
		set_global_flag = Kuat_Rakata_second_warp_portal_opened
		initialize_Rakata_crisis_system_select = yes
		initialize_Kuat_Rakata_second_warp_portal_system_select = yes
		random_system = {
			limit = { NOT = { has_star_flag = forbit_spawn_system } }
			set_star_flag = Kuat_Rakata_second_warp_portal_system
			save_global_event_target_as = Kuat_Rakata_second_warp_portal_system
			random_system_planet = {
				spawn_rakata_fleets_insane_1 = yes
				ROOT = {
					country_event = { id = kuat_final_crisis_events.41 days = 2 }
					country_event = { id = kuat_final_crisis_events.41 days = 4 }
					country_event = { id = kuat_final_crisis_events.103 days = 720 } #循环刷辅助守家舰队
					country_event = { id = kuat_final_crisis_events.141 days = 360 }
				}
			}
			if = {
				limit = { exists = starbase }
				starbase = { fleet = { destroy_fleet = this } }
			}
			create_starbase = {
				size = exe_starbase
				owner = event_target:Infinite_empire
			}
			set_star_flag = Kuat_Rakata_second_warp_portal
			save_global_event_target_as = Kuat_Rakata_second_warp_portal_system_for_door
		}
		every_playable_country = {
			limit = { is_ai = no }
			country_event = { id = kuat_final_crisis_events.54 }
		}
	}
}

# third door created
country_event = {
	id = kuat_final_crisis_events.17
	hide_window = yes
	trigger = {
		is_infinite_faction = yes
		has_global_flag = Kuat_Rakata_first_warp_portal_opened
		NOT = { has_global_flag = Kuat_Rakata_third_warp_portal_opened }
	}
	mean_time_to_happen = { months = 18 }
	fire_only_once = yes
	immediate = {
		set_global_flag = Kuat_Rakata_third_warp_portal_opened
		initialize_Rakata_crisis_system_select = yes
		initialize_Kuat_Rakata_second_warp_portal_system_select = yes
		initialize_Kuat_Rakata_third_warp_portal_system_select = yes
		random_system = {
			limit = { NOT = { has_star_flag = forbit_spawn_system } }
			set_star_flag = Kuat_Rakata_third_warp_portal_system
			save_global_event_target_as = Kuat_Rakata_third_warp_portal_system
			random_system_planet = {
				spawn_rakata_fleets_insane_2 = yes
				ROOT = {
					country_event = { id = kuat_final_crisis_events.42 days = 2 }
					country_event = { id = kuat_final_crisis_events.42 days = 4 }
					country_event = { id = kuat_final_crisis_events.104 days = 720 } #循环刷辅助守家舰队
					country_event = { id = kuat_final_crisis_events.142 days = 360 }
				}
			}
			if = {
				limit = { exists = starbase }
				starbase = { fleet = { destroy_fleet = this } }
			}
			create_starbase = {
				size = exe_starbase
				owner = event_target:Infinite_empire
			}
			set_star_flag = Kuat_Rakata_third_warp_portal
			save_global_event_target_as = Kuat_Rakata_third_warp_portal_system_for_door
		}
		every_playable_country = {
			limit = { is_ai = no }
			country_event = { id = kuat_final_crisis_events.55 }
		}
	}
}

# Diplomacy with infinite empire
country_event = {
	id = kuat_final_crisis_events.20
	title = "TRANSMISSION"
	desc = "kuat_final_crisis_events.20.desc"
	diplomatic = yes
	picture_event_data = { 
		portrait = event_target:kuat_astral_rift_event_leader_rakata
		room = root 
	}
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	is_triggered_only = yes
	trigger = { FROM = { is_infinite_faction = yes } }
	option = {
		name = kuat_final_crisis_events.20.a
		is_dialog_only = yes
		response_text = kuat_final_crisis_events.20.a.response
	}
	option = {
		name = kuat_final_crisis_events.20.b
		response_text = kuat_final_crisis_events.20.b.response
	}
}

# fleet main action
fleet_event = {
	id = kuat_final_crisis_events.40
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		exists = this
		has_global_flag = Kuat_Rakata_invasion_happened
		has_fleet_flag = Kuat_Rakata_attack_fleet
		owner = { is_infinite_faction = yes }
	}
	immediate = {
		queue_actions = {
			repeat = {
				effect = {
					id = kuat_final_crisis_events.40.jump
					if = {
						limit = { count_system = { 
							limit = { check_variable = { which = Rakata_crisis_fleet_id value > 0 } } 
							count = all 
						} }
						every_system = { 
							set_variable = { which = Rakata_crisis_fleet_id value = 0 } 
							clear_variable = Rakata_crisis_fleet_id 
						}
					}
					if = {
						limit = { has_fleet_flag = kuat_cannot_find_path }
						random_system = {
							limit = {
								check_variable = { which = Rakata_crisis_fleet_id value < 1 }
								OR = {
									any_system_planet = { OR = { is_colony = yes is_colonizable = yes } }
									any_fleet_in_system = { exists = owner owner = { is_hostile = event_target:Infinite_empire } }
								}
							}
							closest_system = {
								min_steps = 1
								system_star = { ROOT = { set_location = { target = PREV distance = 5 angle = random } } }
							}
						} 
						set_timed_fleet_flag = { flag = ag_jump_drive_cooldown days = 200 }
						remove_fleet_flag = kuat_cannot_find_path
					}
				}
				find_closest_system = {
					trigger = {
						id = kuat_final_crisis_events.40.find5
						OR = {
							any_fleet_in_system = { exists = owner owner = { is_hostile = event_target:Infinite_empire } }
							any_system_planet = { 
								OR = { is_colony = yes is_colonizable = yes } 
								NOT = { any_fleet_in_orbit = {
									exists = controller
									is_ship_class = shipclass_military
									controller = { is_same_value = event_target:Infinite_empire }
								} }
							}
						}
						distance = { source = root type = hyperlane max_jumps = 10 }
						ROOT = { can_access_system = prev }
						check_variable = { which = Rakata_crisis_fleet_id value < 1 }
					}
					found_system = {
						effect = {
							id = kuat_final_crisis_events.40.move5
							set_variable = { which = Rakata_crisis_fleet_id value = root.fleet_id }
						}
						move_to = this
						repeat = {
							while = {
								id = kuat_final_crisis_events.40.find5planetwhile
								any_system_planet = { 
									OR = { is_colony = yes is_colonizable = yes } 
									NOT = { any_fleet_in_orbit = {
										exists = controller
										is_ship_class = shipclass_military
										controller = { is_same_value = event_target:Infinite_empire }
									} }
								}
							}
							find_closest_planet = {
								trigger = {
									id = kuat_final_crisis_events.40.find5planet
									OR = { is_colony = yes is_colonizable = yes }
									NOT = { any_fleet_in_orbit = {
										exists = controller
										is_ship_class = shipclass_military
										controller = { is_same_value = event_target:Infinite_empire }
									} }
								}
								found_planet = {
									orbit_planet = this
									effect = {
										id = kuat_final_crisis_events.40.move5planet
										ROOT = { set_fleet_flag = Rakata_bombarding_planet }
										if = {
											limit = { is_colony = no is_colonizable = yes }
											set_planet_flag = Rakata_crisis_target_planet
											planet_event = { id = kuat_final_crisis_events.47 days = 30 }
										}
									}
									repeat = {
										while = {
											id = kuat_final_crisis_events.40.bombardment5while
											ROOT = { has_fleet_flag = Rakata_bombarding_planet }
										}
										effect = {
											id = kuat_final_crisis_events.40.bombardment5action
											if = {
												limit = { is_colony = no is_colonizable = no }
												ROOT = { remove_fleet_flag = Rakata_bombarding_planet }
											}
										} 
										wait = { duration = 5 random = 1 }
									}
								}
							}
							move_to = this							# move away from the planet
							wait = { duration = 5 random = 10 }
						} 
						wait = { duration = 5 random = 10 }
					}					
					failed = { find_closest_system = {
						trigger = {
							id = kuat_final_crisis_events.40.find10
							ROOT = { can_access_system = prev }
							OR = {
								any_fleet_in_system = { exists = owner owner = { is_hostile = event_target:Infinite_empire } }
								any_system_planet = { 
									OR = { is_colony = yes is_colonizable = yes } 
									NOT = { any_fleet_in_orbit = {
										exists = controller
										is_ship_class = shipclass_military
										controller = { is_same_value = event_target:Infinite_empire }
									} }
								}
							}
							distance = { source = root type = hyperlane max_jumps = 20 }
							check_variable = { which = Rakata_crisis_fleet_id value < 1 }
						}
						found_system = {
							effect = {
								id = kuat_final_crisis_events.40.move10
								set_variable = { which = Rakata_crisis_fleet_id value = root.fleet_id }
							}
							move_to = this
							repeat = {
								while = {
									id = kuat_final_crisis_events.40.find10planetwhile
									any_system_planet = { 
										OR = { is_colony = yes is_colonizable = yes } 
										NOT = { any_fleet_in_orbit = {
											exists = controller
											is_ship_class = shipclass_military
											controller = { is_same_value = event_target:Infinite_empire }
										} }
									}
								}
								find_closest_planet = {
									trigger = {
										id = kuat_final_crisis_events.40.find10planet
										OR = { is_colony = yes is_colonizable = yes }
										NOT = { any_fleet_in_orbit = {
											exists = controller
											is_ship_class = shipclass_military
											controller = { is_same_value = event_target:Infinite_empire }
										} }
									}
									found_planet = {
										orbit_planet = this
										effect = {
											id = kuat_final_crisis_events.40.move10planet
											ROOT = { set_fleet_flag = Rakata_bombarding_planet }
											if = {
												limit = { is_colony = no is_colonizable = yes }
												set_planet_flag = Rakata_crisis_target_planet
												planet_event = { id = kuat_final_crisis_events.47 days = 30 }
											}
										}
										repeat = {
											while = {
												id = kuat_final_crisis_events.40.bombardment10while
												ROOT = { has_fleet_flag = Rakata_bombarding_planet }
											}
											effect = {
												id = kuat_final_crisis_events.40.bombardment10action
												if = {
													limit = { is_colony = no is_colonizable = no }
													ROOT = { remove_fleet_flag = Rakata_bombarding_planet }
												}
											} 
											wait = { duration = 5 random = 1 }
										}
									}
								}
								move_to = this											# move away from the planet
								wait = { duration = 5 random = 10 }
							} 
							wait = { duration = 5 random = 10 }
						}
						failed = { 
							effect = { 
								id = kuat_final_crisis_events.40.jumptrigger 
								root = { if = {
									limit = { NOT = { has_fleet_flag = ag_jump_drive_cooldown } }
									set_fleet_flag = kuat_cannot_find_path
								} }
							} 
							wait = { duration = 5 random = 10 } 
						}
					} }
				}
			}
		}
	}
}

# reset fleet action variable
country_event = {
	id = kuat_final_crisis_events.46
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_infinite_faction = yes
		FROMFROM = { has_fleet_flag = Kuat_Rakata_attack_fleet }
	}
	immediate = {
		random_system = {
			limit = { check_variable = { which = Rakata_crisis_fleet_id value = FROMFROM.fleet_id } }
			set_variable = { which = Rakata_crisis_fleet_id value = 0 }
		}
	}
}

# bomborment(uncolony)
planet_event = {
	id = kuat_final_crisis_events.47
	hide_window = yes
	is_triggered_only = yes
	pre_triggers = { has_owner = no }
	trigger = {
		OR = {
			is_colonizable = yes
			has_planet_flag = phaseshifting_active
		}
		has_planet_flag = Rakata_crisis_target_planet
		any_fleet_in_orbit = {
			owner = {
				is_infinite_faction = yes
			}
			has_fleet_flag = Kuat_Rakata_attack_fleet
		}
	}
	immediate = {
		if = {
			limit = {
				has_planet_flag = phaseshifting_active
			}
			remove_planet_flag = phaseshifting_active
			remove_modifier = phaseshifted
		}
		remove_planet_flag = Rakata_crisis_target_planet
		if = {
			limit = { kuat_is_ringworld = yes }
			spawn_ringworld_cracker_effect = yes
			change_pc = pc_ringworld_habitable_damaged
			reset_planet = yes
		}
		else_if = {
			limit = { kuat_is_habitat = yes }
			spawn_habitat_cracker_effect = yes
			remove_planet = yes
		}
		else = { change_pc = pc_shattered }
		every_fleet_in_orbit = { remove_fleet_flag = Rakata_bombarding_planet }
		every_country = {
			limit = { has_event_chain = "kuat_rakata_invasion_chain" }
			add_event_chain_counter = { event_chain = "kuat_rakata_invasion_chain" counter = "kuat_rakata_invastor_planets" amount = 1 }
		}
	}
}

# kill count
country_event = {
	id = kuat_final_crisis_events.44
	hide_window = yes
	is_triggered_only = yes
	trigger = { is_infinite_faction = yes }
	immediate = {
		if = {
			limit = {
				FROM = { has_event_chain = "kuat_rakata_invasion_chain" }
			}
			FROM = {
				add_event_chain_counter = {
					event_chain = "kuat_rakata_invasion_chain"
					counter = "kuat_rakata_invastor_kills_us"
					amount = 1
				}
			}
		} 
		else = { every_country = {
			limit = {
				has_event_chain = "kuat_rakata_invasion_chain"
				NOT = { is_same_value = FROM }
			}
			add_event_chain_counter = {
				event_chain = "kuat_rakata_invasion_chain"
				counter = "kuat_rakata_invastor_kills_others"
				amount = 1
			}
		} }
	}
}

# kill count 
country_event = {
	id = kuat_final_crisis_events.45
	hide_window = yes
	is_triggered_only = yes
	trigger = { is_infinite_faction = yes }
	immediate = {
		every_country = {
			limit = { has_event_chain = "kuat_rakata_invasion_chain" }
			add_event_chain_counter = {
				event_chain = "kuat_rakata_invasion_chain"
				counter = "kuat_rakata_invastor_victims"
				amount = 1
			}
		}
	}
}

# crisis destroyed
country_event = {
	id = kuat_final_crisis_events.50
	hide_window = yes
	is_triggered_only = yes
	fire_only_once = yes
	trigger = { is_infinite_faction = yes }
	immediate = {
		if = {
			limit = { exists = event_target:Infinite_empire }
			destroy_country = yes
		}
		every_playable_country = { country_event = { id = kuat_final_crisis_events.51 } }
	}
}

# notification(crisis destroyed)
country_event = {
	id = kuat_final_crisis_events.51
	title = kuat_final_crisis_events.51.name
	desc = kuat_final_crisis_events.51.desc
	is_triggered_only = yes
	diplomatic = yes
	custom_gui = "kuat_event_window"
	custom_gui_option = "kuat_event_option"
	picture_event_data = { room = satellite_in_orbit_room }
	show_sound = event_celebration
	fire_only_once = yes
	immediate = { event_target:Eternalempire = { country_event = { id = kuat_final_crisis_events.998 days = 10 random = 3 } } }
	option = {
		# Spiritualist Response
		name = crisis.1271.a
		add_monthly_resource_mult = {
			resource = unity
			value = @tier5unityreward
		}
	}
	option = {
		# Spiritualist Response
		name = crisis.1271.a
		trigger = {
			has_spiritualist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
		add_monthly_resource_mult = {
			resource = unity
			value = @tier5unityreward
		}
	}
	option = {
		# Militarist Response
		name = crisis.1271.b
		trigger = {
			has_militarist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
		add_monthly_resource_mult = {
			resource = unity
			value = @tier5unityreward
		}
	}
	option = {
		# Materialist Response
		name = crisis.1271.c
		trigger = {
			has_materialist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
		add_monthly_resource_mult = {
			resource = unity
			value = @tier5unityreward
		}
	}
	option = {
		# Pacifist Response
		name = crisis.1271.d
		trigger = {
			has_pacifist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
		add_monthly_resource_mult = {
			resource = unity
			value = @tier5unityreward
		}
	}
	option = {
		# Corporate Response
		name = crisis.1271.e
		trigger = {
			has_government = gov_megacorporation
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
		add_monthly_resource_mult = {
			resource = unity
			value = @tier5unityreward
		}
	}
	option = {
		# Default Response
		name = crisis.211.f
		trigger = {
			OR = {
				has_generic_government = yes
				has_government = gov_enlightened_monarchy
				has_government = gov_elective_monarchy
				has_government = gov_hive_mind
				has_authority = auth_machine_intelligence
			}
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
		add_monthly_resource_mult = {
			resource = unity
			value = @tier5unityreward
		}
	}
	option = {
		# Xenophobe Response
		name = crisis.1271.g
		trigger = {
			has_ethic = "ethic_fanatic_xenophobe"
		}
		add_monthly_resource_mult = {
			resource = unity
			value = @tier5unityreward
		}
	}
	option = {
		# Xenophile Response
		name = crisis.1271.h
		trigger = {
			has_ethic = "ethic_fanatic_xenophile"
		}
		add_monthly_resource_mult = {
			resource = unity
			value = @tier5unityreward
		}
	}
}

# finial door destroyed
country_event = {
	id = kuat_final_crisis_events.53
	title = kuat_final_crisis_events.53.name
	desc = kuat_final_crisis_events.53.desc
	diplomatic = yes
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	picture_event_data = { room = satellite_in_orbit_room }
	is_triggered_only = yes
	show_sound = event_sensor_ping
	option = { name = EXCELLENT }
}

# set the second door poi
country_event = {
	id = kuat_final_crisis_events.54
	title = "kuat_final_crisis_events.54.name"
	desc = "kuat_final_crisis_events.54.desc"
	diplomatic = yes
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	picture_event_data = { room = satellite_in_orbit_room }
	show_sound = event_ex_started
	location = event_target:Kuat_Rakata_second_warp_portal_system
	is_triggered_only = yes
	after = {
		create_point_of_interest = {
			id = Kuat_Rakata_invasion_poi.2
			name = "Kuat_Rakata_invasion_2_poi"
			desc = "Kuat_Rakata_invasion_2_poi_desc"
			event_chain = "kuat_rakata_invasion_chain"
			location = event_target:Kuat_Rakata_second_warp_portal_system
		}
		country_event = { id = kuat_final_crisis_events.57 days = 3 }
	}
	option = {
		name = kuat_final_crisis_events.54.a
		custom_tooltip = kuat_final_crisis_events.54.a.tooltip
	}
}

# set the third door poi
country_event = {
	id = kuat_final_crisis_events.55
	title = "kuat_final_crisis_events.55.name"
	desc = "kuat_final_crisis_events.55.desc"
	diplomatic = yes
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	picture_event_data = { room = satellite_in_orbit_room }
	show_sound = event_ex_started
	location = event_target:Kuat_Rakata_third_warp_portal_system
	is_triggered_only = yes
	after = {
		create_point_of_interest = {
			id = Kuat_Rakata_invasion_poi.3
			name = "Kuat_Rakata_invasion_3_poi"
			desc = "Kuat_Rakata_invasion_3_poi_desc"
			event_chain = "kuat_rakata_invasion_chain"
			location = event_target:Kuat_Rakata_third_warp_portal_system
		}
		country_event = { id = kuat_final_crisis_events.58 days = 3 }
	}
	option = {
		name = kuat_final_crisis_events.55.a
		custom_tooltip = kuat_final_crisis_events.55.a.tooltip
	}
}

# set the total door poi
country_event = {
	id = kuat_final_crisis_events.56
	title = "kuat_final_crisis_events.56.name"
	desc = "kuat_final_crisis_events.56.desc"
	diplomatic = yes
	custom_gui = "kuat_event_m_window"
	custom_gui_option = "kuat_event_m_option"
	picture_event_data = { room = satellite_in_orbit_room }
	show_sound = event_ex_started
	location = event_target:Kuat_Rakata_total_warp_portal_system
	is_triggered_only = yes
	after = {
		create_point_of_interest = {
			id = Kuat_Rakata_invasion_poi.4
			name = "Kuat_Rakata_invasion_4_poi"
			desc = "Kuat_Rakata_invasion_4_poi_desc"
			event_chain = "kuat_rakata_invasion_chain"
			location = event_target:Kuat_Rakata_total_warp_portal_system
		}
		country_event = { id = kuat_final_crisis_events.61 days = 3 }
	}
	option = {
		name = kuat_final_crisis_events.56.a
		custom_tooltip = kuat_final_crisis_events.56.a.tooltip
	}
}

# notification(second poi)
country_event = {
	id = kuat_final_crisis_events.57
	title = "TRANSMISSION"
	diplomatic = yes
	picture_event_data = { 
		portrait = event_target:kuat_astral_rift_event_leader_rakata
		room = root 
	}
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	is_triggered_only = yes
	desc = "kuat_final_crisis_events.57.desc"
	option = { 
		name = kuat_final_crisis_events.57.a 
		response_text = kuat_final_crisis_events.57.a.response
	}
}

# notification(third poi)
country_event = {
	id = kuat_final_crisis_events.58
	title = "TRANSMISSION"
	diplomatic = yes
	picture_event_data = { 
		portrait = event_target:kuat_astral_rift_event_leader_rakata
		room = root 
	}
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	is_triggered_only = yes
	desc = "kuat_final_crisis_events.58.desc"
	option = {
		name = kuat_final_crisis_events.58.a
		response_text = kuat_final_crisis_events.58.a.response
	}
}

# notification(third poi)
country_event = {
	id = kuat_final_crisis_events.61
	title = "TRANSMISSION"
	diplomatic = yes
	picture_event_data = { 
		portrait = event_target:kuat_astral_rift_event_leader_rakata
		room = root 
	}
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	is_triggered_only = yes
	desc = "kuat_final_crisis_events.61.desc"
	option = {
		name = kuat_final_crisis_events.61.a
		response_text = kuat_final_crisis_events.61.a.response
	}
}

# End
country_event = {
	id = kuat_final_crisis_events.998
	title = "kuat_final_crisis_events.998.name"
	desc = "kuat_final_crisis_events.998.desc"
	diplomatic = yes
	picture_event_data = { 
		portrait = event_target:kuat_astral_rift_event_leader_rakata
		room = root
	 }
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	show_sound = event_ship_bridge
	is_triggered_only = yes
	fire_only_once = yes
	immediate = { every_country = { end_event_chain = kuat_rakata_invasion_chain } }
	option = {
		name = "kuat_final_crisis_events.998.a"
		owner = { add_resource = { influence = 1000 } }
		#end_event_chain = ag_legacy_invasion_chain
	}
	after = { 
		country_event = { id = ag_kae_ge_invasion.258 days = 2 random = 1 } 
		event_target:kuat_astral_rift_event_leader_rakata = { kill_leader = { show_notification = no } }
	}
}

# starbase battle event
country_event = {
	id = kuat_final_crisis_events.59
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		fromfrom = { any_owned_ship = { is_ship_size = exe_starbase } }
		is_infinite_faction = yes
	}

	immediate = {
		fromfrom = { if = {
			limit = { 
				NOT = { has_fleet_flag = exe_starbase_invisible_@this }
				any_owned_ship = { is_ship_size = exe_starbase }
				solar_system = { count_fleet_in_system = { count > 2
					limit = { owner = { is_infinite_faction = yes } } 
				} }
			}
			set_fleet_flag = exe_starbase_invisible_@this
			random_owned_ship = {
				limit = { is_ship_size = exe_starbase }
				set_ship_flag = kuat_executor_checkpoint
				eternal_increase_executor_power = { DAYS = -1 TYPE = kt }
				ship_event = { id = kuat_final_crisis_events.60 }
			}
		} }
	}
}

ship_event = {
	id = kuat_final_crisis_events.60
	hide_window = yes
	is_triggered_only = yes
	
	trigger = { exists = this }

	immediate = {
		if = {
			limit = { 
				has_ship_flag = kuat_executor_checkpoint
				solar_system = { count_fleet_in_system = { count > 2 limit = { 
					any_owned_ship = { NOT = { is_ship_size = Infinite_Mothership } }
					owner = { is_infinite_faction = yes } 
				} } } 
				is_in_combat = yes 
			}
			repair_ship = yes  ship_event = { id = kuat_final_crisis_events.60 days = 1 }
		}
		else = { remove_executor_power = yes remove_ship_flag = kuat_executor_checkpoint }
	}
}