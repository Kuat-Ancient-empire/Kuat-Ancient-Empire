namespace = ai_action
#WAR
country_event = {
	id = ai_action.1
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_country_flag = fallen_empire_kuat
		is_at_war = yes
		NOT = { any_owned_fleet = { has_fleet_flag = first_attack_fleet } }
		NOR = {
			has_global_flag = wind_up_for_attack_fleet
			has_global_flag = wind_up_for_kuat_fleet
		}
	}
	immediate = {
		random_country = {
			limit = { 
				is_ai = no
				is_at_war_with = event_target:fallen_empire_kuat 
			}
			set_country_flag = kuat_warning_country
			save_global_event_target_as = kuat_warning_country
		}
		if = {
			limit = {
				NOT = { has_global_flag = wind_up_for_attack_fleet }
			}
			create_kuat_defender_and_attack_fleet = yes
			set_timed_global_flag = { flag = wind_up_for_attack_fleet days = 360 }
		}	
		event_target:fallen_empire_kuat_fleet = {
			every_system_within_border = { save_event_target_as = begin_kuat_fleet_system }
			set_country_type = kuat_fleet_hostile
			if = {
				limit = { NOT = { has_global_flag = wind_up_for_kuat_fleet } }
				create_kuat_millatery_defender_and_attack_fleet = yes
				set_timed_global_flag = { flag = wind_up_for_kuat_fleet days = 360 }
			}
		}
	}
}

planet_event = { 
	id = ai_action.2
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_planet_flag = ruins_planet
		planet_devastation = 100
	}
	immediate = {
		set_update_modifiers_batch = begin
		if = {
			limit = { 
				exists = event_target:Eternalempire
				exists = event_target:eternal_support_country
			}
			owner = { add_static_war_exhaustion = {
				attacker = event_target:Eternalempire
				location = root
				value_for_planet_destruction = 1.0
			} }
		}
		else = { owner = { add_static_war_exhaustion = {
			attacker = from
			location = root
			value_for_planet_destruction = 1.0
		} } }
		if = {
			limit = { has_planet_flag = phaseshifting_active }
			remove_planet_flag = phaseshifting_active
			remove_modifier = phaseshifted
		}
		if = {
			limit = { kuat_is_ringworld = yes }
			spawn_ringworld_cracker_effect = yes
			change_pc = pc_ringworld_habitable_damaged
			set_planet_entity = { entity = ringworld_habitable_damaged_entity }
		}
		else_if = {
			limit = { kuat_is_habitat = yes }
			spawn_habitat_cracker_effect = yes
			remove_planet = yes
		}
		else = { change_pc = pc_shattered }
		remove_planet_flag = ruins_planet
		reset_planet = yes
		destroy_colony = yes
		remove_modifier = "natural_beauty"
		remove_modifier = "atmospheric_aphrodisiac"
		remove_modifier = "atmospheric_hallucinogen"
		remove_modifier = "lush_planet"		
		remove_modifier = "dangerous_wildlife"
		#recall fleet
		if = {
			limit = {
				exists = event_target:kuat_warning_country
				event_target:kuat_warning_country = {
					OR = {
						count_owned_planet = {
							limit = { NOT = { is_same_value = root } }
							count < 1
						}
						NOT = { is_at_war_with = event_target:fallen_empire_kuat }
					}
				}
			}
			every_country = {
				limit = { has_country_flag = kuat_warning_country }
				remove_country_flag = kuat_warning_country
				clear_global_event_target = kuat_warning_country
			}
			event_target:fallen_empire_kuat = {
				every_owned_fleet = {
					limit = { has_fleet_flag = first_attack_fleet }
					clear_fleet_actions = this
					clear_orders = yes
					destroy_fleet = { target = this destroy_template = yes kill_leader = yes }
				}
			}
			event_target:fallen_empire_kuat_fleet = {
				every_owned_fleet = {
					limit = { has_fleet_flag = second_attack_fleet }
					clear_fleet_actions = this
					clear_orders = yes
					destroy_fleet = { target = this destroy_template = yes kill_leader = yes }
				}
				set_country_type = kuat_fleet
			}
		}
		else_if = {
			limit = {
				exists = event_target:kuat_Annihilate_country
				event_target:kuat_Annihilate_country = {
					OR = {
						count_owned_planet = {
							limit = { NOT = { is_same_value = root } }
							count < 1
						}
						NOT = { is_at_war_with = event_target:return_kuat_awakening_country }
					}
				}
			}
			every_country = {
				limit = { has_country_flag = kuat_Annihilate_country }
				remove_country_flag = kuat_Annihilate_country
				clear_global_event_target = kuat_Annihilate_country
			}
			event_target:return_kuat_awakening_country = {
				every_owned_fleet = {
					limit = { has_fleet_flag = third_attack_fleet }
					clear_fleet_actions = this
					clear_orders = yes
					destroy_fleet = { target = this destroy_template = yes kill_leader = yes }
				}
			}
		}
		set_update_modifiers_batch = end
	}
}

country_event = {
	id = ai_action.5
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		if = {
			limit = {
				has_country_flag = kuat_warning_country
				NOT = { is_at_war_with = event_target:fallen_empire_kuat }
			}
			remove_country_flag = kuat_warning_country
			clear_global_event_target = kuat_warning_country
			event_target:fallen_empire_kuat = {
				every_owned_fleet = {
					limit = { has_fleet_flag = first_attack_fleet }
					clear_fleet_actions = this
					clear_orders = yes
					destroy_fleet = { target = this destroy_template = yes kill_leader = yes }
				}
			}
			event_target:fallen_empire_kuat_fleet = {
				every_owned_fleet = {
					limit = { has_fleet_flag = second_attack_fleet }
					clear_fleet_actions = this
					clear_orders = yes
					destroy_fleet = { target = this destroy_template = yes kill_leader = yes }
				}
				set_country_type = kuat_fleet
			}
		}
		else_if = {
			limit = {
				has_country_flag = kuat_Annihilate_country
				NOT = { is_at_war_with = event_target:return_kuat_awakening_country }
			}
			remove_country_flag = kuat_Annihilate_country
			clear_global_event_target = kuat_Annihilate_country
			event_target:return_kuat_awakening_country = {
				every_owned_fleet = {
					limit = { has_fleet_flag = third_attack_fleet }
					clear_fleet_actions = this
					clear_orders = yes
					destroy_fleet = { target = this destroy_template = yes kill_leader = yes }
				}
			}
		}
	}
}

country_event = {
	id = ai_action.7
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		AND = {
			exists = event_target:wg_crisis_country
			has_global_flag = wg_crisis_insane
			has_global_flag = activated_uf_hidden_diff
		}
		is_at_war = no
		NOT = { any_owned_fleet = { has_fleet_flag = defensive_galaxy_fleet } }
		has_country_flag = fallen_empire_kuat
		NOT = { has_global_flag = wind_up_for_defensive_fleet }
	}
	immediate = {
		create_kuat_defender_and_attack_crisis_fleet = yes
		set_timed_global_flag = { flag = wind_up_for_defensive_fleet days = 360 }
	}
}

country_event = {
	id = ai_action.8
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_at_war = no
		exists = fromfrom
		fromfrom = { fleet = { has_fleet_flag = defensive_galaxy_fleet } }
		from = { count_owned_ship = { limit = { NOT = { is_same_value = root.fromfromfrom } } count < 1 } }
	}
	immediate = {
		event_target:fallen_empire_kuat = {
			every_owned_fleet = {
				limit = { has_fleet_flag = defensive_galaxy_fleet }
				clear_fleet_actions = this
				clear_orders = yes
				destroy_fleet = { target = this destroy_template = yes kill_leader = yes }
			}
		}
	}
}

#United fleet against
country_event = {
	id = ai_action.10
	title = ai.7.title
	desc = ai.7.desc
	diplomatic = yes
	picture_event_data = {
		portrait = event_target:kuat_player_target_species
		planet_background = pc_ringworld_habitable
		graphical_culture = fallen_empire_01
		city_level = event_target:fallen_empire_kuat
		room = personality_fallen_empire_cyan_room
	}
	custom_gui = "kuat_event_diplomacy_window"
	custom_gui_option = "kuat_event_diplomacy_option"
	is_triggered_only = yes
	trigger = { has_global_flag = wg_crisis_insane }
	option = { name = ai.7.title.a }
}

country_event = {
	id = ai_action.11
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		is_kuat_fallen_empire = yes
		FROMFROM = { 
			OR = {
				has_fleet_flag = defensive_galaxy_fleet
				has_fleet_flag = first_attack_fleet
				has_fleet_flag = second_attack_fleet
				has_fleet_flag = third_attack_fleet
			}
		}
	}
	immediate = {
		FROMFROM = { save_event_target_as = destroyed_fleet }
		random_system = {
			limit = { check_variable = { which = kuat_fleet_id value = event_target:destroyed_fleet.fleet_id } }
			set_variable = { which = kuat_fleet_id value = 0 } clear_variable = kuat_fleet_id 
		}
	}
}

fleet_event = {
	id = ai_action.12
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		exists = this
		owner = { is_kuat_fallen_empire = yes }
		owner = { is_at_war = yes }
		OR = {
			has_fleet_flag = first_attack_fleet
			has_fleet_flag = second_attack_fleet
			has_fleet_flag = third_attack_fleet
		}
	}
	immediate = { 
		if = {
			limit = { owner = { is_same_value = event_target:fallen_empire_kuat } }
			fleet_execute_order_1 = { TARGET = event_target:kuat_warning_country  OWNER_TARGET = event_target:fallen_empire_kuat }
		}
		else_if = {
			limit = { owner = { is_same_value = event_target:fallen_empire_kuat_fleet } }
			fleet_execute_order_1 = { TARGET = event_target:kuat_warning_country  OWNER_TARGET = event_target:fallen_empire_kuat_fleet }
		}
		else_if = {
			limit = { owner = { is_same_value = event_target:return_kuat_awakening_country } }
			fleet_execute_order_1 = { TARGET = event_target:kuat_Annihilate_country OWNER_TARGET = event_target:return_kuat_awakening_country }
		}
	}
}